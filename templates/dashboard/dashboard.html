{% extends "base.html" %}
{% load static %}

{% block title %}{% block dashboard_title %}Dashboard{% endblock %} - KoopTimizer{% endblock %}

{% block extra_head %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'frontend/dashboard.css' %}">
{% endblock %}

{% block header %}{% endblock %}
{% block footer %}{% endblock %}

{% block main_body %}
<div class="dashboard-layout">

    <nav class="sidebar">
        <div class="logo-area">
            <img src="{% static 'frontend/images/Logo.png' %}" alt="Logo" class="sidebar-logo">
            <h3 class="logo-text">KoopTimizer</h3>
        </div>

        <ul class="nav-links">
            {% if request.session.role == 'admin' %}
                <li>
                    <a href="{% url 'dashboard:admin_dashboard' %}" class="nav-item active">
                        <i class="bi bi-grid-fill"></i> <span class="nav-text">Dashboard</span>
                    </a>
                </li>
            {% elif request.session.role == 'staff' %}
                <li>
                    <a href="{% url 'dashboard:staff_dashboard' %}" class="nav-item active">
                        <i class="bi bi-grid-fill"></i> <span class="nav-text">Dashboard</span>
                    </a>
                </li>
            {% elif request.session.role == 'officer' %}
                <li>
                    <a href="{% url 'dashboard:cooperative_dashboard' %}" class="nav-item active">
                        <i class="bi bi-grid-fill"></i> <span class="nav-text">Dashboard</span>
                    </a>
                </li>
            {% endif %}

            <li class="nav-section-title"><span class="nav-text">Modules</span></li>

            {% if request.session.role == 'admin' or request.session.role == 'staff' %}
                <li>
                    <a href="{% url 'account_management:account_management' %}" class="nav-item">
                        <i class="bi bi-people-fill"></i> <span class="nav-text">Accounts</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'databank:databank_management' %}" class="nav-item">
                        <i class="bi bi-database-fill"></i> <span class="nav-text">Data Bank</span>
                    </a>
                </li>
            {% endif %}

            {% if request.session.role == 'officer' %}
                <li>
                    <a href="{% url 'cooperatives:profile_form' %}" class="nav-item">
                        <i class="bi bi-building"></i> <span class="nav-text">Profile</span>
                    </a>
                </li>
            {% endif %}

            <li>
                <a href="{% url 'communications:message' %}" class="nav-item">
                    <i class="bi bi-chat-dots-fill"></i> <span class="nav-text">Messages</span>
                </a>
            </li>
            
            {% if request.session.role == 'admin' or request.session.role == 'staff' %}
            <li>
                <a href="{% url 'communications:announcement_form' %}" class="nav-item">
                    <i class="bi bi-megaphone-fill"></i> <span class="nav-text">Announcements</span>
                </a>
            </li>
            {% endif %}
        </ul>

        <div class="sidebar-widgets">
            
            <div class="mini-widget">
                <h4>
                    <span class="nav-text">Calendar</span> 
                    <i class="bi bi-calendar4-week"></i>
                </h4>
                <div class="mini-calendar-box">
                    <div class="mini-date" id="current-date">{% now "M d" %}</div>
                    <div class="mini-day" id="current-day">{% now "l" %}</div>
                    <div class="mini-time" id="current-time" style="font-size: 14px; font-weight: 600; color: #a91e2c; margin-top: 8px;"></div>
                </div>
            </div>

            <div class="mini-widget">
                <h4><span class="nav-text">Activity</span></h4>
    
                <div class="mini-activity-list" id="sidebar-activity-list">
                    <div class="mini-activity-item">
                        <div class="mini-activity-text">
                            <span style="font-size: 0.75rem; color: #aaa;">Checking for updates...</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        
        <button id="sidebar-close-btn" class="d-md-none sidebar-close"><i class="bi bi-x-lg"></i></button>
    </nav>

    <main class="main-content-wrapper">
        
        <header class="top-bar">
            <div class="top-left">
                <button id="sidebar-toggle-btn" class="d-md-none"><i class="bi bi-list"></i></button>
                <div class="page-title">{% block page_header %}Dashboard Overview{% endblock %}</div>
            </div>
            
            <!-- Search box removed per UX request -->

            <div class="user-menu">
                <div class="user-info">
                    <span class="u-name">{{ request.session.username }}</span>
                    <span class="u-role">{{ request.session.role|capfirst }}</span>
                </div>
                <div class="avatar">
                    {{ request.session.username|first|upper }}
                </div>

                <!-- FAQ button: opens FAQs modal -->
                <a href="#" id="open-faq-btn" class="faq-btn-mini" title="FAQs">
                    <i class="bi bi-question-circle"></i>
                    <span style="font-size: 0.75rem; display: block; margin-top: 2px;">FAQs</span>
                </a>

                <a href="{% url 'users:profile_settings' %}" class="settings-btn-mini" title="Settings">
                    <i class="bi bi-three-dots-vertical"></i>
                </a>

                <a href="#" data-bs-toggle="modal" data-bs-target="#logoutModal" class="logout-btn-mini" title="Logout">
                    <i class="bi bi-box-arrow-right"></i>
                </a>
            </div>
        </header>

        <div class="content-scrollable">
            {% block dashboard_content %}
                <div class="welcome-banner">
                    <h2>Welcome back, {{ request.session.username }}!</h2>
                    <p>Here is what's happening with your cooperative today.</p>
                </div>
            {% endblock %}
        </div>
    </main>

</div>

<div class="sidebar-overlay"></div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const toggleBtn = document.getElementById('sidebar-toggle-btn');
        const closeBtn = document.getElementById('sidebar-close-btn');
        const overlay = document.querySelector('.sidebar-overlay');
        const body = document.body;

        function toggleSidebar() {
            body.classList.toggle('sidebar-open');
        }

        if(toggleBtn) toggleBtn.addEventListener('click', toggleSidebar);
        if(closeBtn) closeBtn.addEventListener('click', toggleSidebar);
        if(overlay) overlay.addEventListener('click', toggleSidebar);
        
        // Real-time clock
        function updateClock() {
            const now = new Date();
            let hours = now.getHours();
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; // the hour '0' should be '12'
            
            const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')} ${ampm}`;
            
            const timeElement = document.getElementById('current-time');
            if (timeElement) {
                timeElement.textContent = timeString;
            }
        }
        
        updateClock();
        setInterval(updateClock, 1000);
    });
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // 1. Select the container
    const activityContainer = document.getElementById('sidebar-activity-list');

    function loadRecentActivity() {
        // DEBUG: Check if script runs
        // console.log("Fetching activity..."); 

        fetch("{% url 'communications:api_recent_activity' %}")
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // DEBUG: See what data came back
                // console.log("Data received:", data);

                if (data.status === 'success') {
                    if (data.activities.length > 0) {
                        // WE HAVE MESSAGES: Build the list
                        let html = '';
                        data.activities.forEach(activity => {
                            html += `
                            <div class="mini-activity-item">
                                <div class="mini-activity-text">
                                    <strong style="color: #2B3674; font-size: 0.85rem;">${activity.title}</strong>
                                    <span style="font-size: 0.7rem; color: #707EAE; display:block; margin-top:2px;">${activity.sender}</span>
                                    <span style="font-size: 0.65rem; color: #A3AED0; margin-top:2px;">${activity.time}</span>
                                </div>
                            </div>`;
                        });
                        
                        // Update the HTML only if it changed (prevents flickering)
                        if (activityContainer.innerHTML !== html) {
                            activityContainer.innerHTML = html;
                        }

                    } else {
                        // NO MESSAGES: Update text to say so
                        activityContainer.innerHTML = `
                            <div class="mini-activity-item">
                                <div class="mini-activity-text">
                                    <span style="font-size: 0.75rem; color: #A3AED0;">No recent messages</span>
                                </div>
                            </div>`;
                    }
                }
            })
            .catch(error => {
                console.error('Error loading activity:', error);
                activityContainer.innerHTML = `
                    <div class="mini-activity-item">
                        <div class="mini-activity-text">
                            <span style="font-size: 0.75rem; color: red;">Error loading data</span>
                        </div>
                    </div>`;
            });
    }

    // Load immediately
    loadRecentActivity();

    // Refresh every 2 seconds
    setInterval(loadRecentActivity, 2000);
});
</script>

<!-- FAQ Modal + mini-chat FAQ -->
<div class="modal fade" id="faqModal" tabindex="-1" aria-labelledby="faqModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="faqModalLabel">Frequently Asked Questions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="list-group" id="faq-list" role="tablist">
                            <!-- Static FAQs inserted here -->
                            <button type="button" class="list-group-item list-group-item-action" data-answer="To reset your password, go to Settings → Password Reset and follow the instructions.">How do I reset my password?</button>
                            <button type="button" class="list-group-item list-group-item-action" data-answer="To create an announcement, go to Announcements in the sidebar and click 'New Announcement'.">How do I post an announcement?</button>
                            <button type="button" class="list-group-item list-group-item-action" data-answer="Messages appear in real-time; mark them as seen in the conversation to clear activities.">Why are some activities still showing?</button>
                            <button type="button" class="list-group-item list-group-item-action" data-answer="For support, email support@kooptimizer@gmail.com or use the contact form under About → Contact.">How do I contact support?</button>
                            <button type="button" class="list-group-item list-group-item-action" data-answer="Access your profile by clicking on your avatar in the top-right corner and selecting 'Settings'.">How do I edit my profile?</button>
                            <button type="button" class="list-group-item list-group-item-action" data-answer="Admins and staff manage accounts in the Accounts module. Officers can view their own profile in the Profile section.">Who can manage user accounts?</button>
                            <button type="button" class="list-group-item list-group-item-action" data-answer="The Data Bank module stores cooperative information and records. Access it from the sidebar under Modules.">What is the Data Bank?</button>
                            <button type="button" class="list-group-item list-group-item-action" data-answer="Messages are sent and received through the Messages module in the sidebar. You'll receive notifications for new messages.">How do I send messages?</button>
                            <button type="button" class="list-group-item list-group-item-action" data-answer="Your activity feed updates automatically every 2 seconds. Check the Activity widget in the sidebar.">How often does my activity update?</button>
                            <button type="button" class="list-group-item list-group-item-action" data-answer="To log out, click the logout button (arrow icon) in the top-right corner and confirm in the modal.">How do I log out?</button>
                        </div>
                    </div>

                    <div class="col-md-8">
                        <div id="faq-chat" style="min-height:300px; border:1px solid #e9ecef; border-radius:6px; padding:12px; background:#f8fafc; display:flex; flex-direction:column;">
                            <div id="faq-messages" style="flex:1; overflow:auto; margin-bottom:8px;"></div>
                            <div id="faq-controls" style="display:flex; gap:8px; align-items:center;">
                                <input id="faq-input-preview" class="form-control" placeholder="Selected question answer will type here..." readonly />
                                <button id="faq-clear" class="btn btn-outline-secondary">Clear</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <small class="text-muted">Click a question to see an automatic typed answer.</small>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
        const openFaqBtn = document.getElementById('open-faq-btn');
        const faqModalEl = document.getElementById('faqModal');
        const faqModal = faqModalEl ? new bootstrap.Modal(faqModalEl) : null;
        const faqList = document.getElementById('faq-list');
        const faqMessages = document.getElementById('faq-messages');
        const faqInput = document.getElementById('faq-input-preview');
        const faqClear = document.getElementById('faq-clear');

        function appendMessage(text, from='system'){
                const wrap = document.createElement('div');
                wrap.style.margin = '6px 0';
                const bubble = document.createElement('div');
                bubble.style.display = 'inline-block';
                bubble.style.padding = '8px 12px';
                bubble.style.borderRadius = '18px';
                bubble.style.maxWidth = '85%';
                bubble.style.boxShadow = '0 1px 2px rgba(0,0,0,0.05)';
                if(from === 'user'){
                        bubble.style.background = '#e7f3ff';
                        bubble.style.alignSelf = 'flex-end';
                        bubble.style.marginLeft = 'auto';
                } else {
                        bubble.style.background = '#ffffff';
                        bubble.style.alignSelf = 'flex-start';
                }
                bubble.textContent = text;
                wrap.appendChild(bubble);
                faqMessages.appendChild(wrap);
                faqMessages.scrollTop = faqMessages.scrollHeight;
        }

        function typeIntoPreview(text, speed=25){
                faqInput.value = '';
                let i = 0;
                const interval = setInterval(() => {
                        faqInput.value = text.slice(0, i+1);
                        i++;
                        if(i >= text.length){
                                clearInterval(interval);
                                // Append final bubble to messages
                                appendMessage(text, 'system');
                        }
                }, speed);
        }

        if(openFaqBtn && faqModal){
                openFaqBtn.addEventListener('click', function(e){
                        e.preventDefault();
                        // reset preview + messages
                        faqInput.value = '';
                        faqMessages.innerHTML = '';
                        document.getElementById('faq-list').querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                        faqModal.show();
                });
        }

        if(faqList){
                faqList.addEventListener('click', function(e){
                        const btn = e.target.closest('button');
                        if(!btn) return;
                        // mark active
                        faqList.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
                        btn.classList.add('active');

                        // show user question as a small user bubble
                        appendMessage(btn.textContent.trim(), 'user');

                        // animate typing of answer in preview then append
                        const answer = btn.getAttribute('data-answer') || 'Sorry, no answer available.';
                        typeIntoPreview(answer);
                });
        }

        if(faqClear){
                faqClear.addEventListener('click', function(){
                        faqMessages.innerHTML = '';
                        faqInput.value = '';
                });
        }
});
</script>
{% endblock %}
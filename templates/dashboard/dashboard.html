{% extends "base.html" %}
{% load static %}

{% block title %}{% block dashboard_title %}Dashboard{% endblock %} - KoopTimizer{% endblock %}

{% block extra_head %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'frontend/dashboard.css' %}">
{% endblock %}

{% block header %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
{% endblock %}
{% block footer %}{% endblock %}

{% block main_body %}
<div class="dashboard-layout">

    <nav class="sidebar" id="main-sidebar">
        <script>
            (function() {
                const s = document.getElementById('main-sidebar');
                if (localStorage.getItem('sidebar-state') === 'expanded') {
                    s.classList.add('expanded');
                }
            })();
        </script>

        <div class="logo-area">
            <div class="logo-content">
                <img src="{% static 'frontend/images/Logo.png' %}" alt="Logo" class="sidebar-logo">
                <h3 class="logo-text">KoopTimizer</h3>
            </div>
            <button id="desktop-sidebar-toggle" class="sidebar-toggle-btn" title="Toggle Sidebar">
                <i class="bi bi-layout-sidebar"></i>
            </button>
        </div>

        <ul class="nav-links">
            {# Capture the current view name to compare against links #}
            {% with route_name=request.resolver_match.view_name %}

            {% if request.session.role == 'admin' %}
                <li>
                    <a href="{% url 'dashboard:admin_dashboard' %}" 
                       class="nav-item {% if route_name == 'dashboard:admin_dashboard' %}active{% endif %}">
                        <i class="bi bi-grid-fill"></i> <span class="nav-text">Dashboard</span>
                    </a>
                </li>
            {% elif request.session.role == 'staff' %}
                <li>
                    <a href="{% url 'dashboard:staff_dashboard' %}" 
                       class="nav-item {% if route_name == 'dashboard:staff_dashboard' %}active{% endif %}">
                        <i class="bi bi-grid-fill"></i> <span class="nav-text">Dashboard</span>
                    </a>
                </li>
            {% elif request.session.role == 'officer' %}
                <li>
                    <a href="{% url 'dashboard:cooperative_dashboard' %}" 
                       class="nav-item {% if route_name == 'dashboard:cooperative_dashboard' %}active{% endif %}">
                        <i class="bi bi-grid-fill"></i> <span class="nav-text">Dashboard</span>
                    </a>
                </li>
            {% endif %}

            <li class="nav-section-title"><span class="nav-text">Modules</span></li>

            {% if request.session.role == 'admin' or request.session.role == 'staff' %}
                <li>
                    <a href="{% url 'account_management:account_management' %}" 
                       class="nav-item {% if 'account_management' in route_name %}active{% endif %}">
                        <i class="bi bi-people-fill"></i> <span class="nav-text">Accounts</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'databank:databank_management' %}" 
                       class="nav-item {% if 'databank' in route_name %}active{% endif %}">
                        <i class="bi bi-database-fill"></i> <span class="nav-text">Data Bank</span>
                    </a>
                </li>
            {% endif %}

            {% if request.session.role == 'officer' %}
                <li>
                    <a href="{% url 'cooperatives:profile_form' %}" 
                       class="nav-item {% if 'cooperatives' in route_name %}active{% endif %}">
                        <i class="bi bi-building"></i> <span class="nav-text">Profile</span>
                    </a>
                </li>
            {% endif %}

            <li>
                <a href="{% url 'communications:message' %}" 
                   class="nav-item {% if 'communications:message' in route_name %}active{% endif %}">
                    <i class="bi bi-chat-dots-fill"></i> <span class="nav-text">Messages</span>
                </a>
            </li>
            
            {% if request.session.role == 'admin' or request.session.role == 'staff' %}
            <li>
                <a href="{% url 'communications:announcement_form' %}" 
                   class="nav-item {% if 'communications:announcement' in route_name %}active{% endif %}">
                    <i class="bi bi-megaphone-fill"></i> <span class="nav-text">Announcements</span>
                </a>
            </li>
            {% endif %}
            
            {% endwith %}
        </ul>

        <div class="sidebar-widgets">

            <div class="mini-widget">
                <h4 id="calendarTrigger" style="cursor: pointer;">
                    <span class="nav-text">Calendar</span> 
                    <i class="bi bi-calendar4-week"></i>
                </h4>
                <div class="mini-calendar-box">
                    <div class="mini-date" id="current-date">{% now "M d" %}</div>
                    <div class="mini-day" id="current-day">{% now "l" %}</div>
                    <div class="mini-time" id="current-time" style="font-size: 14px; font-weight: 600; color: #a91e2c; margin-top: 8px;"></div>
                </div>
            </div>

            <div class="mini-widget" id="sidebar-faq-widget">
                <h4>
                    <i class="bi bi-question-circle"></i>
                    <span class="nav-text" style="margin-left:8px;">FAQs</span>
                </h4>
                <div style="padding:8px 12px;">
                    <div style="font-size:0.9rem; color:var(--text-gray); margin-bottom:6px;">Quick help</div>
                    <button id="open-faq-from-sidebar" class="btn btn-outline-secondary btn-sm" style="width:100%; text-align:left;">Open FAQs</button>
                </div>
            </div>

        </div>
        
        <button id="sidebar-close-btn" class="d-md-none sidebar-close"><i class="bi bi-x-lg"></i></button>
    </nav>

    <main class="main-content-wrapper">
        
        <header class="top-bar">
            <div class="top-left">
                <button id="sidebar-toggle-btn" class="d-md-none"><i class="bi bi-list"></i></button>
                <div class="page-title">{% block page_header %}Dashboard Overview{% endblock %}</div>
            </div>
            
            <div class="user-menu">
                <div class="user-info">
                    <span class="u-name">{{ request.session.username }}</span>
                    <span class="u-role">{{ request.session.role|capfirst }}</span>
                </div>
                <div class="avatar">
                    {{ request.session.username|first|upper }}
                </div>

                    <div class="notification-bell" id="notification-bell" style="position:relative;">
                        <button id="bell-btn" class="btn" title="Activity" style="background:transparent; border:none; color:var(--text-gray); font-size:1.3rem;">
                            <i class="bi bi-bell-fill"></i>
                            <span id="activity-badge" class="activity-badge" style="display:none;">0</span>
                        </button>
                        <div id="activity-dropdown" class="activity-dropdown" style="display:none; position:absolute; right:0; top:36px; background:white; border:1px solid #eee; border-radius:8px; box-shadow:0 8px 20px rgba(0,0,0,0.08); width:320px; z-index:120;">
                            <div style="padding:8px 12px; border-bottom:1px solid #f5f5f5; font-weight:700;">Recent Activity</div>
                            <div id="activity-dropdown-list" style="max-height:260px; overflow:auto;"></div>
                            <div style="padding:8px 12px; border-top:1px solid #f5f5f5; text-align:center;"><a href="#" class="small">View all</a></div>
                        </div>
                    </div>

                <a href="{% url 'users:profile_settings' %}" class="settings-btn-mini" title="Settings">
                    <i class="bi bi-three-dots-vertical"></i>
                </a>

                <a href="#" data-bs-toggle="modal" data-bs-target="#logoutModal" class="logout-btn-mini" title="Logout">
                    <i class="bi bi-box-arrow-right"></i>
                </a>
            </div>
        </header>

        <div class="content-scrollable">
            {% block dashboard_content %}
                <div class="welcome-banner">
                    <h2>Welcome back, {{ request.session.username }}!</h2>
                    <p>Here is what's happening with your cooperative today.</p>
                </div>
            {% endblock %}
        </div>
    </main>

</div>

<div id="myCalendarModal" class="custom-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>My Schedule</h2>
      <span class="close-btn">&times;</span>
    </div>
    
    <div id="calendar"></div>
  </div>
</div>

<div id="eventFormModal" class="custom-modal" style="z-index: 10000;">
  <div class="modal-content" style="max-width: 500px;">
    <div class="modal-header">
      <h3 style="margin:0;">Add New Event</h3>
      <span class="close-form-btn" style="cursor:pointer; font-size:24px;">&times;</span>
    </div>
    
    <div class="modal-body" style="padding-top: 15px;">
      <form id="addEventForm">
        
        <div class="modal-input-group">
          <label>Event Title *</label>
          <input type="text" id="eventTitle" placeholder="Ex: General Assembly" required>
        </div>

        <div class="modal-input-group">
          <label>Description (Optional)</label>
          <textarea id="eventDesc" placeholder="Enter details..." style="height: 80px;"></textarea>
        </div>

        <div class="modal-input-group">
          <label>Start Date (Optional)</label>
          <input type="datetime-local" id="eventStart">
        </div>

        <div class="modal-input-group">
          <label>End Date (Optional)</label>
          <input type="datetime-local" id="eventEnd">
        </div>

        <input type="hidden" id="defaultStart">
        <input type="hidden" id="defaultEnd">

        <div style="text-align: right; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
          <button type="button" class="cancel-btn">Cancel</button>
          <button type="submit" style="background-color: #A91B0D; color: white; padding: 8px 25px; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">Save Event</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="sidebar-overlay"></div>

<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    
    var calendarModal = document.getElementById("myCalendarModal");
    var formModal = document.getElementById("eventFormModal");
    var btn = document.getElementById("calendarTrigger");
    
    // Close Buttons
    var closeCalendarBtn = document.getElementsByClassName("close-btn")[0];
    var closeFormBtn = document.getElementsByClassName("close-form-btn")[0];
    var cancelFormBtn = document.querySelector(".cancel-btn");
    
    var calendarEl = document.getElementById('calendar');
    var calendar = null;

    function initCalendar() {
       calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth' },
        height: 500,
        selectable: true,
        displayEventTime: false, 
        eventColor: '#A91B0D',
        events: '/users/all_events/', 

        select: function(info) {
           // 1. SAVE THE CLICKED DATE AS DEFAULT
           // info.startStr is what they clicked (e.g., "2025-11-28")
           document.getElementById('defaultStart').value = info.startStr;
           document.getElementById('defaultEnd').value = info.endStr;

           // 2. Pre-fill visual inputs (Optional - you can leave these blank if you prefer)
           // I'm leaving them blank so the user sees they are optional
           document.getElementById('eventStart').value = ""; 
           document.getElementById('eventEnd').value = "";
           
           document.getElementById('eventTitle').value = "";
           document.getElementById('eventDesc').value = "";
           
           formModal.style.display = "block";
        }
      });
      calendar.render();
    }

    // HANDLE FORM SUBMISSION
    document.getElementById('addEventForm').addEventListener('submit', function(e) {
        e.preventDefault();

        var title = document.getElementById('eventTitle').value;
        var desc = document.getElementById('eventDesc').value;
        
        // --- SMART DATE LOGIC ---
        // Get input values
        var inputStart = document.getElementById('eventStart').value;
        var inputEnd = document.getElementById('eventEnd').value;
        
        // Get default (clicked) values
        var defaultStart = document.getElementById('defaultStart').value;
        var defaultEnd = document.getElementById('defaultEnd').value;

        // Logic: If input is empty, use default. 
        // Note: We might need to append time if default is just a date (YYYY-MM-DD)
        var finalStart = inputStart ? inputStart : defaultStart;
        var finalEnd = inputEnd ? inputEnd : defaultEnd;

        if (!title) { alert("Title is required"); return; }

        var eventData = { 
            title: title, 
            description: desc, 
            start: finalStart, 
            end: finalEnd 
        };

        fetch('/users/add_event/', {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(eventData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                calendar.refetchEvents(); 
                formModal.style.display = "none";
                alert('Event Saved!');
            } else {
                alert('Error: ' + data.message);
            }
        });
    });

    // CONTROLS
    if(btn) { btn.onclick = function() { calendarModal.style.display = "block"; setTimeout(function(){ if (!calendar) { initCalendar(); } else { calendar.render(); } }, 100); } }
    if(closeCalendarBtn) closeCalendarBtn.onclick = function() { calendarModal.style.display = "none"; }
    if(closeFormBtn) closeFormBtn.onclick = function() { formModal.style.display = "none"; }
    if(cancelFormBtn) cancelFormBtn.onclick = function() { formModal.style.display = "none"; }
    window.onclick = function(event) { if (event.target == calendarModal) calendarModal.style.display = "none"; }
  });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const desktopToggle = document.getElementById('desktop-sidebar-toggle');
        const sidebar = document.getElementById('main-sidebar');

        // 1. ENABLE ANIMATIONS 
        // We wait a tiny bit to ensure the initial paint is done, then enable transitions
        // This ensures the "load" was static, but future "clicks" will slide.
        setTimeout(() => {
            if(sidebar) sidebar.classList.add('sidebar-animated');
        }, 100);

        // 2. TOGGLE HANDLER
        if (desktopToggle && sidebar) {
            desktopToggle.addEventListener('click', function(e) {
                e.preventDefault(); 
                
                sidebar.classList.toggle('expanded');

                // Save New State
                if (sidebar.classList.contains('expanded')) {
                    localStorage.setItem('sidebar-state', 'expanded');
                } else {
                    localStorage.setItem('sidebar-state', 'collapsed');
                }
            });
        }
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const toggleBtn = document.getElementById('sidebar-toggle-btn');
        const closeBtn = document.getElementById('sidebar-close-btn');
        const overlay = document.querySelector('.sidebar-overlay');
        const body = document.body;

        function toggleSidebar() {
            body.classList.toggle('sidebar-open');
        }

        if(toggleBtn) toggleBtn.addEventListener('click', toggleSidebar);
        if(closeBtn) closeBtn.addEventListener('click', toggleSidebar);
        if(overlay) overlay.addEventListener('click', toggleSidebar);
        
        // Real-time clock
        function updateClock() {
            const now = new Date();
            let hours = now.getHours();
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; 
            
            const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')} ${ampm}`;
            
            const timeElement = document.getElementById('current-time');
            if (timeElement) {
                timeElement.textContent = timeString;
            }
        }
        
        updateClock();
        setInterval(updateClock, 1000);
    });
</script>

<script>
// Activity Dropdown Script (Kept same as before)
document.addEventListener('DOMContentLoaded', function() {
    const activityBadge = document.getElementById('activity-badge');
    const dropdownList = document.getElementById('activity-dropdown-list');
    const bellBtn = document.getElementById('bell-btn');
    const activityDropdown = document.getElementById('activity-dropdown');

    function buildActivityHtml(activities){
        if(!activities || activities.length === 0){
            return `<div style="padding:12px; color:#A3AED0;">No recent messages</div>`;
        }
        let html = '';
        activities.forEach(act => {
            html += `<div style="padding:10px 12px; border-bottom:1px solid #f5f5f5;">
                        <div style="font-weight:600; color:var(--text-dark);">${act.title}</div>
                        <div style="font-size:0.8rem; color:#707EAE; margin-top:4px;">${act.sender} · ${act.time}</div>
                     </div>`;
        });
        return html;
    }

    function setBadge(count){
        if(!activityBadge) return;
        if(count && count > 0){
            activityBadge.textContent = count > 99 ? '99+' : count;
            activityBadge.style.display = 'inline-block';
        } else {
            activityBadge.style.display = 'none';
        }
    }

    function loadRecentActivity(){
        fetch("{% url 'communications:api_recent_activity' %}")
            .then(r => { if(!r.ok) throw new Error('Network'); return r.json(); })
            .then(data => {
                if(data.status === 'success'){
                    const activities = data.activities || [];
                    const count = activities.length;
                    setBadge(count);
                    const html = buildActivityHtml(activities.slice(0,6));
                    if(dropdownList && dropdownList.innerHTML !== html) dropdownList.innerHTML = html;
                }
            })
            .catch(err => {
                console.error('Activity load error', err);
                if(dropdownList) dropdownList.innerHTML = `<div style="padding:12px; color:red;">Error loading activity</div>`;
                setBadge(0);
            });
    }

    if(bellBtn && activityDropdown){
        bellBtn.addEventListener('click', function(e){
            e.stopPropagation();
            const isOpen = activityDropdown.style.display === 'block';
            if(!isOpen){
                loadRecentActivity();
                activityDropdown.style.display = 'block';
            } else {
                activityDropdown.style.display = 'none';
            }
        });

        document.addEventListener('click', function(e){
            if(!activityDropdown.contains(e.target) && e.target !== bellBtn && !bellBtn.contains(e.target)){
                activityDropdown.style.display = 'none';
            }
        });
    }
});
</script>

<div class="modal fade" id="faqModal" tabindex="-1" aria-labelledby="faqModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="faqModalLabel">Frequently Asked Questions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="list-group" id="faq-list" role="tablist">
                            <button type="button" class="list-group-item list-group-item-action" data-answer="To reset your password, go to Settings → Password Reset and follow the instructions.">How do I reset my password?</button>
                            <button type="button" class="list-group-item list-group-item-action" data-answer="To create an announcement, go to Announcements in the sidebar and click 'New Announcement'.">How do I post an announcement?</button>
                            <button type="button" class="list-group-item list-group-item-action" data-answer="Messages appear in real-time; mark them as seen in the conversation to clear activities.">Why are some activities still showing?</button>
                            <button type="button" class="list-group-item list-group-item-action" data-answer="For support, email support@kooptimizer@gmail.com or use the contact form under About → Contact.">How do I contact support?</button>
                            <button type="button" class="list-group-item list-group-item-action" data-answer="Access your profile by clicking on your avatar in the top-right corner and selecting 'Settings'.">How do I edit my profile?</button>
                            <button type="button" class="list-group-item list-group-item-action" data-answer="Admins and staff manage accounts in the Accounts module. Officers can view their own profile in the Profile section.">Who can manage user accounts?</button>
                            <button type="button" class="list-group-item list-group-item-action" data-answer="The Data Bank module stores cooperative information and records. Access it from the sidebar under Modules.">What is the Data Bank?</button>
                            <button type="button" class="list-group-item list-group-item-action" data-answer="Messages are sent and received through the Messages module in the sidebar. You'll receive notifications for new messages.">How do I send messages?</button>
                            <button type="button" class="list-group-item list-group-item-action" data-answer="Your activity feed updates automatically every 2 seconds. Check the Activity widget in the sidebar.">How often does my activity update?</button>
                            <button type="button" class="list-group-item list-group-item-action" data-answer="To log out, click the logout button (arrow icon) in the top-right corner and confirm in the modal.">How do I log out?</button>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div id="faq-chat" style="min-height:300px; border:1px solid #e9ecef; border-radius:6px; padding:12px; background:#f8fafc; display:flex; flex-direction:column;">
                            <div id="faq-messages" style="flex:1; overflow:auto; margin-bottom:8px;"></div>
                            <div id="faq-controls" style="display:flex; gap:8px; align-items:center;">
                                <input id="faq-input-preview" class="form-control" placeholder="Selected question answer will type here..." readonly />
                                <button id="faq-clear" class="btn btn-outline-secondary">Clear</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <small class="text-muted">Click a question to see an automatic typed answer.</small>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
// FAQ Script (Kept same as before)
document.addEventListener('DOMContentLoaded', function() {
        const openFaqBtn = document.getElementById('open-faq-btn');
        const openFaqSidebarBtn = document.getElementById('open-faq-from-sidebar');
        const faqModalEl = document.getElementById('faqModal');
        const faqModal = faqModalEl ? new bootstrap.Modal(faqModalEl) : null;
        const faqList = document.getElementById('faq-list');
        const faqMessages = document.getElementById('faq-messages');
        const faqInput = document.getElementById('faq-input-preview');
        const faqClear = document.getElementById('faq-clear');

        function appendMessage(text, from='system'){
                const wrap = document.createElement('div');
                wrap.style.margin = '6px 0';
                const bubble = document.createElement('div');
                bubble.style.display = 'inline-block';
                bubble.style.padding = '8px 12px';
                bubble.style.borderRadius = '18px';
                bubble.style.maxWidth = '85%';
                bubble.style.boxShadow = '0 1px 2px rgba(0,0,0,0.05)';
                if(from === 'user'){
                        bubble.style.background = '#e7f3ff';
                        bubble.style.alignSelf = 'flex-end';
                        bubble.style.marginLeft = 'auto';
                } else {
                        bubble.style.background = '#ffffff';
                        bubble.style.alignSelf = 'flex-start';
                }
                bubble.textContent = text;
                wrap.appendChild(bubble);
                faqMessages.appendChild(wrap);
                faqMessages.scrollTop = faqMessages.scrollHeight;
        }

        function typeIntoPreview(text, speed=25){
                faqInput.value = '';
                let i = 0;
                const interval = setInterval(() => {
                        faqInput.value = text.slice(0, i+1);
                        i++;
                        if(i >= text.length){
                                clearInterval(interval);
                                appendMessage(text, 'system');
                        }
                }, speed);
        }

        function openFaqModalReset(){
            faqInput.value = '';
            faqMessages.innerHTML = '';
            document.getElementById('faq-list').querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            if(faqModal) faqModal.show();
        }

        if(openFaqBtn) openFaqBtn.addEventListener('click', function(e){ e.preventDefault(); openFaqModalReset(); });
        if(openFaqSidebarBtn) openFaqSidebarBtn.addEventListener('click', function(e){ e.preventDefault(); openFaqModalReset(); });

        if(faqList){
                faqList.addEventListener('click', function(e){
                        const btn = e.target.closest('button');
                        if(!btn) return;
                        faqList.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
                        btn.classList.add('active');
                        appendMessage(btn.textContent.trim(), 'user');
                        const answer = btn.getAttribute('data-answer') || 'Sorry, no answer available.';
                        typeIntoPreview(answer);
                });
        }

        if(faqClear){
                faqClear.addEventListener('click', function(){
                        faqMessages.innerHTML = '';
                        faqInput.value = '';
                });
        }
});
</script>
{% endblock %}
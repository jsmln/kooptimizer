{% extends 'dashboard/dashboard.html' %}
{% load static %}

{% block dashboard_title %}Cooperative Dashboard{% endblock %}

{% block extra_head %}
    {{ block.super }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="{% static 'frontend/cooperative_dashboard.css' %}">
{% endblock %}

{% block dashboard_content %}
{% if not has_profile_data %}
<!-- Blocking Modal - No Profile Data -->
<div id="noProfileModal" class="modal-overlay-blocking" style="display: flex;">
    <div class="modal-content-blocking">
        <div class="modal-header-blocking">
            <h2><i class="bi bi-exclamation-triangle-fill"></i> Profile Data Required</h2>
        </div>
        <div class="modal-body-blocking">
            <p class="modal-message">
                Your cooperative profile has not been submitted yet. Please complete your profile data before accessing the dashboard.
            </p>
            <p class="modal-submessage">
                You need to submit your cooperative profile information to continue.
            </p>
        </div>
        <div class="modal-footer-blocking">
            <a href="{% url 'cooperatives:profile_form' %}" class="btn-modal-primary">
                <i class="bi bi-file-earmark-text"></i> Go to Profile Management
            </a>
            <a href="{% url 'communications:message' %}" class="btn-modal-secondary">
                <i class="bi bi-envelope"></i> Go to Messages
            </a>
        </div>
    </div>
</div>
{% endif %}

<div class="coop-dashboard-container" {% if not has_profile_data %}style="display: none;"{% endif %}>
    
    <div class="dashboard-header">
        <div>
            <h4 class="subtitle">Cooperative Overview</h4>
            <h1>Welcome, {{ request.session.username|default:'Officer' }}!</h1>
        </div>
    </div>

    <div class="hero-card">
        <div class="hero-header">
            <div class="coop-identity">
                <div class="hero-avatar">
                    {{ cooperative.cooperative_name|first|default:"C" }}
                </div>
                <div>
                    <h2>{% if cooperative %}{{ cooperative.cooperative_name }}{% else %}Consumer Cooperative{% endif %}</h2>
                    <p class="coop-address"><i class="bi bi-geo-alt-fill"></i> {% if cooperative and cooperative.address %}{{ cooperative.address }}{% else %}Address not available{% endif %}</p>
                </div>
            </div>
            <div class="compliance-badges">
                {% if cooperative and cooperative.lccdc_membership %}
                <div class="status-badge success">
                    <i class="bi bi-patch-check-fill"></i> LCCDC Member
                </div>
                {% endif %}
                {% if cooperative and not cooperative.coc_renewal or not cooperative.cote_renewal %}
                <div class="status-badge warning">
                    <i class="bi bi-file-earmark-text"></i> Report Due Soon
                </div>
                {% endif %}
            </div>
        </div>
        
        <hr class="divider">

        <div class="hero-details-grid">
            <div class="detail-item">
                <label>CDA Registration No.</label>
                <p>{% if cooperative.cda_registration_number %}{{ cooperative.cda_registration_number }}{% else %}N/A{% endif %}</p>
            </div>
            <div class="detail-item">
                <label>CDA Registration Date</label>
                <p>{% if cooperative.cda_registration_date %}{{ cooperative.cda_registration_date|date:"M d, Y" }}{% else %}N/A{% endif %}</p>
            </div>
            <div class="detail-item">
                <label>LCCDC Membership Date</label>
                <p>{% if cooperative.lccdc_membership_date %}{{ cooperative.lccdc_membership_date|date:"M d, Y" }}{% else %}N/A{% endif %}</p>
            </div>
            <div class="detail-item">
                <label>Business Activity</label>
                <p>{% if cooperative.business_activity %}{{ cooperative.business_activity }}{% else %}N/A{% endif %}</p>
            </div>
        </div>
    </div>

    <!-- KPI Cards Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="card-icon red-bg"><i class="bi bi-person-badge-fill"></i></div>
            <div class="card-content">
                <p class="label">Total Officers</p>
                <h3 class="value" id="stat-officers">0</h3>
                <small class="text-muted">Active officers</small>
            </div>
        </div>

        <div class="stat-card">
            <div class="card-icon blue-bg"><i class="bi bi-people-fill"></i></div>
            <div class="card-content">
                <p class="label">Total Members</p>
                <h3 class="value" id="stat-members">0</h3>
                <small class="text-muted">Registered members</small>
            </div>
        </div>

        <div class="stat-card">
            <div class="card-icon green-bg"><i class="bi bi-briefcase-fill"></i></div>
            <div class="card-content">
                <p class="label">Employees</p>
                <h3 class="value" id="stat-employees">0</h3>
                <small class="text-muted">Salaried staff</small>
            </div>
        </div>

        <div class="stat-card">
            <div class="card-icon orange-bg"><i class="bi bi-person-badge"></i></div>
            <div class="card-content">
                <p class="label">Board of Directors</p>
                <h3 class="value" id="stat-board-directors">0</h3>
                <small class="text-muted">Board members</small>
            </div>
        </div>

        <div class="stat-card">
            <div class="card-icon purple-bg"><i class="bi bi-wallet2"></i></div>
            <div class="card-content">
                <p class="label">Total Assets</p>
                <h3 class="value" id="stat-assets">₱0</h3>
                <small class="text-muted" id="stat-assets-year">Latest financial year</small>
            </div>
        </div>

        <div class="stat-card">
            <div class="card-icon teal-bg"><i class="bi bi-graph-up-arrow"></i></div>
            <div class="card-content">
                <p class="label">Net Surplus</p>
                <h3 class="value" id="stat-surplus">₱0</h3>
                <small class="text-muted" id="stat-surplus-year">Latest financial year</small>
            </div>
        </div>
    </div>

    <!-- Member Gender Distribution Card -->
    <div class="card-section" style="margin-top: 1.5rem; margin-bottom: 1.5rem;">
        <div class="card-header-custom">
            <h3>Member Gender Distribution</h3>
        </div>
        <div style="display: flex; gap: 30px; align-items: center;">
            <!-- Progress Bars on Left -->
            <div class="gender-breakdown-full" id="genderBreakdown" style="flex: 1;">
                <div class="gender-item">
                    <div class="gender-label"><i class="bi bi-gender-male"></i> Male</div>
                    <div class="gender-bar-container">
                        <div class="gender-bar male-bar" id="maleBar" style="width: 0%;"></div>
                    </div>
                    <span class="gender-count" id="maleCount">0</span>
                </div>
                <div class="gender-item">
                    <div class="gender-label"><i class="bi bi-gender-female"></i> Female</div>
                    <div class="gender-bar-container">
                        <div class="gender-bar female-bar" id="femaleBar" style="width: 0%;"></div>
                    </div>
                    <span class="gender-count" id="femaleCount">0</span>
                </div>
                <div class="gender-item">
                    <div class="gender-label"><i class="bi bi-gender-ambiguous"></i> Others</div>
                    <div class="gender-bar-container">
                        <div class="gender-bar others-bar" id="othersBar" style="width: 0%;"></div>
                    </div>
                    <span class="gender-count" id="othersCount">0</span>
                </div>
            </div>
            
            <!-- Donut Chart on Right -->
            <div class="chart-container-small" style="flex: 1; max-width: 300px;">
                <canvas id="genderRatioChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Year-over-Year Growth Chart - Separate Row -->
    <div class="card-section chart-container" style="margin-top: 1.5rem; margin-bottom: 1.5rem;">
        <div class="card-header-custom">
            <h3>Year-over-Year Growth</h3>
            <div style="display: flex; align-items: center; gap: 10px;">
                <span id="financeCurrentView" class="current-view-badge">All Data</span>
                <div class="chart-filter-wrapper">
                    <button id="financeFilterToggle" class="filter-icon-btn" type="button" title="Filter Metrics">
                        <i class="bi bi-funnel"></i>
                    </button>
                    <div id="financeFilterControls" class="chart-filter-dropdown" style="display: none;">
                        <div class="dropdown-header-text">Select View:</div>
                        <div class="filter-option active" onclick="applyFinancialFilter('all', this)">
                            <span>All Data</span>
                            <i class="bi bi-check-lg check-icon"></i>
                        </div>
                        <div class="filter-option" onclick="applyFinancialFilter('assets', this)">
                            <span><span class="dot asset-dot"></span> Assets</span>
                            <i class="bi bi-check-lg check-icon"></i>
                        </div>
                        <div class="filter-option" onclick="applyFinancialFilter('capital', this)">
                            <span><span class="dot capital-dot"></span> Paid-Up Capital</span>
                            <i class="bi bi-check-lg check-icon"></i>
                        </div>
                        <div class="filter-option" onclick="applyFinancialFilter('surplus', this)">
                            <span><span class="dot surplus-dot"></span> Net Surplus</span>
                            <i class="bi bi-check-lg check-icon"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="chart-legend-inline">
            <span class="legend-item"><span class="dot asset-dot"></span> Assets</span>
            <span class="legend-item"><span class="dot capital-dot"></span> Paid-Up Capital</span>
            <span class="legend-item"><span class="dot surplus-dot"></span> Net Surplus</span>
        </div>
        <div class="chart-wrapper" style="height: 350px;">
            <canvas id="financialTrendChart"></canvas>
        </div>
    </div>

    <!-- Quick Actions and Recent Activity -->
    <div class="content-split" style="margin-top: 1.5rem; margin-bottom: 1.5rem;">
        <div class="card-section">
            <div class="section-header">
                <h3>Quick Actions</h3>
            </div>
            <div class="action-grid">
                <a href="{% url 'cooperatives:profile_form' %}" class="action-btn" id="viewProfileBtn" style="text-decoration: none; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px;">
                    <i class="bi bi-eye-fill"></i>
                    <span>View Cooperative Profile</span>
                </a>
                
                <a href="{% url 'cooperatives:profile_form' %}#edit" class="action-btn" id="updateProfileBtn" style="text-decoration: none; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px;">
                    <i class="bi bi-pencil-square"></i>
                    <span>Update Profile</span>
                </a>
            </div>
        </div>

        <div class="card-section">
            <div class="section-header">
                <h3>Recent Activity</h3>
            </div>
            <div class="timeline" id="coopActivityTimeline">
                <div class="text-center text-muted p-3">Loading activities...</div>
            </div>
        </div>
    </div>

    <div class="content-split" style="margin-top: 1.5rem;">
        <!-- Document Status and Gender Demographics -->
        <div style="display: flex; flex-direction: column; gap: 25px;">
            <!-- Document Status -->
            <div class="card-section">
                <div class="card-header-custom">
                    <h3>Document Status</h3>
                </div>
                <div class="compliance-list" id="documentStatusList">
                    <div class="compliance-item clickable-compliance" data-doc-type="coc" style="cursor: pointer;">
                        <div class="compliance-info">
                            <span class="compliance-label">Certificate of Compliance (COC)</span>
                            <small class="text-muted">Required for operation</small>
                        </div>
                        <span class="status-pill" id="cocStatus">Loading...</span>
                    </div>
                    <div class="compliance-item clickable-compliance" data-doc-type="cote" style="cursor: pointer;">
                        <div class="compliance-info">
                            <span class="compliance-label">Tax Exemption (COTE)</span>
                            <small class="text-muted">Bureau of Internal Revenue</small>
                        </div>
                        <span class="status-pill" id="coteStatus">Loading...</span>
                    </div>
                    <div class="compliance-item clickable-compliance" data-doc-type="lccdc" style="cursor: pointer;">
                        <div class="compliance-info">
                            <span class="compliance-label">LCCDC Membership</span>
                            <small class="text-muted">Council Membership</small>
                        </div>
                        <span class="status-pill" id="lccdcStatus">Loading...</span>
                    </div>
                </div>
            </div>

        </div>

        <!-- Officers List -->
        <div class="card-section">
            <div class="card-header-custom">
                <h3>Officers</h3>
            </div>
            <div class="table-responsive">
                <table class="simple-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Position</th>
                        </tr>
                    </thead>
                    <tbody id="officersTableBody">
                        <tr><td colspan="2" class="text-center text-muted">Loading officers...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="profile-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-top-bar">
            <h3>Cooperative Profile</h3>
            <div class="modal-actions">
                <button class="pdf-btn" id="download-pdf-btn" title="Download as PDF">
                    <i class="bi bi-file-earmark-pdf-fill"></i> <span>Download Profile</span>
                </button>
                <button class="modal-close-btn">&times;</button>
            </div>
        </div>
        
        <div class="modal-scroll-area">
            <div id="printable-area">
                <div class="modal-header-section">
                    <div class="coop-avatar">{{ cooperative.cooperative_name|first|default:"C" }}</div>
                    <div class="coop-title-info">
                        <h4 id="modal-coop-name">{{ cooperative.cooperative_name|default:"Consumer Cooperative" }}</h4>
                        <span class="badge-cda">CDA: {{ cooperative.cda_registration_number|default:"1414-060923055" }}</span>
                        <div class="update-info">Last Updated: {{ cooperative.updated_at|default:"Sept 30, 2025" }}</div>
                    </div>
                </div>

                <div class="modal-body">
                    <section class="info-section">
                        <h5 class="section-title">Cooperative General Information</h5>
                        <div class="info-grid two-col">
                            <div class="info-item"><label>Cooperative Name</label><p>{{ cooperative.cooperative_name|default:"Consumer Cooperative" }}</p></div>
                            <div class="info-item"><label>Address</label><p>{{ cooperative.address|default:"Sabang, Lipa City, Batangas" }}</p></div>
                            <div class="info-item"><label>Contact Number</label><p>{{ cooperative.contact_number|default:"09929380925" }}</p></div>
                            <div class="info-item"><label>Email Address</label><p>{{ cooperative.email|default:"consumercoop@gmail.com" }}</p></div>
                            <div class="info-item"><label>CDA Reg. No.</label><p>{{ cooperative.cda_registration_number|default:"1414-060923055" }}</p></div>
                            <div class="info-item"><label>CDA Reg. Date</label><p>{{ cooperative.cda_registration_date|default:"09-06-2005" }}</p></div>
                            <div class="info-item"><label>LCCDC Membership</label><p>{{ cooperative.lccdc_membership_date|default:"09-14-2014" }}</p></div>
                            <div class="info-item"><label>Area of Operation</label><p>{{ cooperative.area_operation|default:"Consumer" }}</p></div>
                            <div class="info-item"><label>Business Activity</label><p>{{ cooperative.business_activity|default:"Supply and demand" }}</p></div>
                            <div class="info-item"><label>Board Directors</label><p>{{ cooperative.bod_count|default:"3" }}</p></div>
                            <div class="info-item"><label>Salaried Employees</label><p>{{ cooperative.employee_count|default:"14" }}</p></div>
                            <div class="info-item"><label>Compliance Cert.</label><p><span class="status-yes">Yes</span></p></div>
                            <div class="info-item"><label>Tax Exemption</label><p><span class="status-yes">Yes</span></p></div>
                        </div>
                    </section>

                    <section class="info-section">
                        <h5 class="section-title">Financial Records</h5>
                        <div class="info-grid three-col">
                            <div class="info-item"><label>2022 Assets</label><p>₱ 142,657.00</p></div>
                            <div class="info-item"><label>2023 Assets</label><p>₱ 258,843.00</p></div>
                            <div class="info-item"><label>2024 Assets</label><p>₱ 356,964.68</p></div>
                            <div class="info-item"><label>Paid Up Capital</label><p>₱ 108,243.78</p></div>
                            <div class="info-item"><label>Net Surplus</label><p>₱ 10,653.54</p></div>
                        </div>
                    </section>

                    <section class="info-section">
                        <h5 class="section-title">Cooperative Officers</h5>
                        <div class="modal-table-wrapper">
                            <table class="modal-table">
                                <thead>
                                    <tr><th>Name</th><th>Position</th><th>Gender</th><th>Mobile</th><th>Email</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>Isabel Delacion</td><td>Chairperson</td><td>Female</td><td>0917-123-4567</td><td>isabel.d@email.com</td></tr>
                                    <tr><td>Jasmin Esperida</td><td>Vice Chairperson</td><td>Female</td><td>0918-234-5678</td><td>jasmin.e@email.com</td></tr>
                                    <tr><td>Art Delos Reyes</td><td>BOD Member</td><td>Male</td><td>0919-345-6789</td><td>art.dr@email.com</td></tr>
                                    <tr><td>Maria Lopez</td><td>Secretary</td><td>Female</td><td>0921-567-8901</td><td>maria.l@email.com</td></tr>
                                    <tr><td>Ramon Santos</td><td>Treasurer</td><td>Male</td><td>0922-678-9012</td><td>ramon.s@email.com</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <section class="info-section">
                        <h5 class="section-title">Cooperative Members</h5>
                        <div class="modal-table-wrapper">
                            <table class="modal-table">
                                <thead>
                                    <tr><th>Name</th><th>Gender</th><th>Mobile</th><th>Email</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>Juan dela Cruz</td><td>Male</td><td>0950-111-2222</td><td>juan.dc@email.com</td></tr>
                                    <tr><td>Maria Clara Santos</td><td>Female</td><td>0950-333-4444</td><td>maria.cs@email.com</td></tr>
                                    <tr><td>Jose Rizalino</td><td>Male</td><td>0950-555-6666</td><td>jose.r@email.com</td></tr>
                                    <tr><td>Andres Bonifacio Jr.</td><td>Male</td><td>0950-777-8888</td><td>andres.b@email.com</td></tr>
                                    <tr><td>Gabriela Silang</td><td>Female</td><td>0950-999-0000</td><td>gabriela.s@email.com</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </section>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="secondary-btn modal-close-btn-bottom">Close</button>
            <a href="{% url 'cooperatives:profile_form' %}" class="primary-btn"><i class="bi bi-pencil-square"></i> Update Info</a>
        </div>
    </div>
</div>

<script>
    let financialChart;
    let genderChart;

    // Global function for financial filter
    window.applyFinancialFilter = function(type, clickedElement) {
        if (!financialChart) return;

        // Visibility Logic
        if (type === 'all') {
            financialChart.getDatasetMeta(0).hidden = false;
            financialChart.getDatasetMeta(1).hidden = false;
            financialChart.getDatasetMeta(2).hidden = false;
        } else if (type === 'assets') {
            financialChart.getDatasetMeta(0).hidden = false;
            financialChart.getDatasetMeta(1).hidden = true;
            financialChart.getDatasetMeta(2).hidden = true;
        } else if (type === 'capital') {
            financialChart.getDatasetMeta(0).hidden = true;
            financialChart.getDatasetMeta(1).hidden = false;
            financialChart.getDatasetMeta(2).hidden = true;
        } else if (type === 'surplus') {
            financialChart.getDatasetMeta(0).hidden = true;
            financialChart.getDatasetMeta(1).hidden = true;
            financialChart.getDatasetMeta(2).hidden = false;
        }

        financialChart.update();

        // UI Updates
        const allOptions = document.querySelectorAll('#financeFilterControls .filter-option');
        allOptions.forEach(opt => opt.classList.remove('active'));
        clickedElement.classList.add('active');

        // Label Update
        const labelMap = { 'all': 'All Data', 'assets': 'Assets', 'capital': 'Paid-Up Capital', 'surplus': 'Net Surplus' };
        document.getElementById('financeCurrentView').textContent = labelMap[type];

        // Close Dropdown
        document.getElementById('financeFilterControls').style.display = 'none';
        document.getElementById('financeFilterToggle').classList.remove('active');
    };

    async function loadCooperativeDashboardData() {
        try {
            // Load stats
            const statsResponse = await fetch('{% url "dashboard:dashboard_stats_api" %}');
            if (!statsResponse.ok) {
                throw new Error(`Stats API error: ${statsResponse.status}`);
            }
            const statsData = await statsResponse.json();
            if (statsData.error) {
                console.error('Stats API error:', statsData.error);
            } else {
                updateCooperativeStats(statsData);
            }

            // Load member demographics
            const demographicsResponse = await fetch('{% url "dashboard:dashboard_member_demographics_api" %}');
            if (!demographicsResponse.ok) {
                throw new Error(`Demographics API error: ${demographicsResponse.status}`);
            }
            const demographicsData = await demographicsResponse.json();
            if (demographicsData.error) {
                console.error('Demographics API error:', demographicsData.error);
            } else {
                updateMemberDemographics(demographicsData);
            }

            // Load officer-specific data (document status, officers, financial growth)
            const officerDataResponse = await fetch('{% url "dashboard:dashboard_officer_data_api" %}');
            if (!officerDataResponse.ok) {
                throw new Error(`Officer Data API error: ${officerDataResponse.status}`);
            }
            const officerData = await officerDataResponse.json();
            if (officerData.error) {
                console.error('Officer Data API error:', officerData.error);
            } else {
                updateDocumentStatus(officerData.document_status);
                updateOfficersList(officerData.officers);
                initializeFinancialChart(officerData.financial_growth);
                updateKPICards(officerData);
            }

            // Load recent activity
            const activityResponse = await fetch('{% url "dashboard:dashboard_recent_activity_api" %}');
            if (activityResponse.ok) {
                const activityData = await activityResponse.json();
                if (!activityData.error) {
                    updateCooperativeActivity(activityData.activities);
                }
            }
        } catch (error) {
            console.error('Error loading cooperative dashboard data:', error);
        }
    }

    function updateCooperativeStats(data) {
        // This function is kept for backward compatibility but may not be used
        // KPI cards are now updated via updateKPICards
    }

    function updateKPICards(data) {
        // Update KPI cards with comprehensive data
        document.getElementById('stat-officers').textContent = data.total_officers || 0;
        document.getElementById('stat-members').textContent = data.total_members || 0;
        document.getElementById('stat-employees').textContent = data.kpi_data?.total_employees || 0;
        document.getElementById('stat-board-directors').textContent = data.kpi_data?.board_directors || 0;
        
        // Format and display financial KPIs
        const assets = parseFloat(data.financial_kpis?.total_assets || 0);
        const surplus = parseFloat(data.financial_kpis?.net_surplus || 0);
        const financialYear = data.financial_kpis?.financial_year || 'N/A';
        
        let assetsText;
        if (assets >= 1000000) {
            assetsText = `₱ ${(assets / 1000000).toFixed(1)}M`;
        } else if (assets >= 1000) {
            assetsText = `₱ ${(assets / 1000).toFixed(0)}K`;
        } else {
            assetsText = `₱ ${assets.toFixed(0)}`;
        }
        
        let surplusText;
        if (Math.abs(surplus) >= 1000000) {
            surplusText = `₱ ${(surplus / 1000000).toFixed(1)}M`;
        } else if (Math.abs(surplus) >= 1000) {
            surplusText = `₱ ${(surplus / 1000).toFixed(0)}K`;
        } else {
            surplusText = `₱ ${surplus.toFixed(0)}`;
        }
        
        document.getElementById('stat-assets').textContent = assetsText;
        document.getElementById('stat-surplus').textContent = surplusText;
        document.getElementById('stat-assets-year').textContent = `Year ${financialYear}`;
        document.getElementById('stat-surplus-year').textContent = `Year ${financialYear}`;
    }

    function updateMemberDemographics(data) {
        const total = data.total || 1;
        const malePercent = total > 0 ? (data.male / total) * 100 : 0;
        const femalePercent = total > 0 ? (data.female / total) * 100 : 0;
        const othersPercent = total > 0 ? (data.others / total) * 100 : 0;

        document.getElementById('maleCount').textContent = data.male || 0;
        document.getElementById('femaleCount').textContent = data.female || 0;
        document.getElementById('othersCount').textContent = data.others || 0;
        document.getElementById('maleBar').style.width = `${malePercent}%`;
        document.getElementById('femaleBar').style.width = `${femalePercent}%`;
        document.getElementById('othersBar').style.width = `${othersPercent}%`;

        // Update gender chart
        const ctxGender = document.getElementById('genderRatioChart');
        if (ctxGender) {
            if (genderChart) genderChart.destroy();
            genderChart = new Chart(ctxGender, {
                type: 'doughnut',
                data: {
                    labels: ['Male', 'Female', 'Others'],
                    datasets: [{
                        data: [data.male || 0, data.female || 0, data.others || 0],
                        backgroundColor: ['#4299e1', '#ed64a6', '#a0aec0'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '70%'
                }
            });
        }
    }

    function updateDocumentStatus(status) {
        // COC Status
        const cocStatusEl = document.getElementById('cocStatus');
        if (status.coc.active) {
            cocStatusEl.textContent = 'Active';
            cocStatusEl.className = 'status-pill success';
        } else {
            cocStatusEl.textContent = 'Needs Renewal';
            cocStatusEl.className = 'status-pill danger';
        }

        // COTE Status
        const coteStatusEl = document.getElementById('coteStatus');
        if (status.cote.active) {
            coteStatusEl.textContent = 'Active';
            coteStatusEl.className = 'status-pill success';
        } else {
            coteStatusEl.textContent = 'Needs Renewal';
            coteStatusEl.className = 'status-pill danger';
        }

        // LCCDC Status
        const lccdcStatusEl = document.getElementById('lccdcStatus');
        if (status.lccdc.active) {
            lccdcStatusEl.textContent = 'Member';
            lccdcStatusEl.className = 'status-pill success';
        } else {
            lccdcStatusEl.textContent = 'Not Member';
            lccdcStatusEl.className = 'status-pill danger';
        }
    }

    function updateOfficersList(officers) {
        const tbody = document.getElementById('officersTableBody');
        if (!tbody) return;

        tbody.innerHTML = '';
        
        if (officers.length === 0) {
            tbody.innerHTML = '<tr><td colspan="2" class="text-center text-muted">No officers found</td></tr>';
            return;
        }

        officers.forEach(officer => {
            const row = document.createElement('tr');
            row.style.cursor = 'pointer';
            row.className = 'officer-row';
            row.innerHTML = `
                <td class="fw-bold">${officer.name}</td>
                <td><span class="badge-position">${officer.position}</span></td>
            `;
            row.addEventListener('click', function() {
                const modal = document.getElementById('profile-modal');
                if (modal) {
                    modal.classList.add('visible');
                }
            });
            tbody.appendChild(row);
        });
    }

    function initializeFinancialChart(financialData) {
        const ctxFinance = document.getElementById('financialTrendChart');
        if (!ctxFinance) return;

        // Prepare data
        const years = Object.keys(financialData.assets || {}).sort();
        const assetsData = years.map(year => financialData.assets[year] || 0);
        const capitalData = years.map(year => financialData.capital[year] || 0);
        const surplusData = years.map(year => financialData.surplus[year] || 0);

        if (financialChart) financialChart.destroy();

        financialChart = new Chart(ctxFinance.getContext('2d'), {
            type: 'line',
            data: {
                labels: years.length > 0 ? years : ['No Data'],
                datasets: [
                    {
                        label: 'Assets',
                        data: assetsData.length > 0 ? assetsData : [0],
                        borderColor: '#2e7d32',
                        backgroundColor: 'rgba(46, 125, 50, 0.1)',
                        tension: 0.3,
                        fill: false,
                        hidden: false
                    },
                    {
                        label: 'Paid-Up Capital',
                        data: capitalData.length > 0 ? capitalData : [0],
                        borderColor: '#1565c0',
                        backgroundColor: 'rgba(21, 101, 192, 0.1)',
                        tension: 0.3,
                        fill: false,
                        hidden: false
                    },
                    {
                        label: 'Net Surplus',
                        data: surplusData.length > 0 ? surplusData : [0],
                        borderColor: '#ef6c00',
                        backgroundColor: 'rgba(239, 108, 0, 0.1)',
                        tension: 0.3,
                        fill: false,
                        hidden: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed.y || 0;
                                return `${context.dataset.label}: ₱${value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { borderDash: [5, 5] },
                        ticks: {
                            callback: function(value) {
                                return '₱' + value.toLocaleString('en-US');
                            }
                        }
                    },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    function updateCooperativeActivity(activities) {
        const timeline = document.getElementById('coopActivityTimeline');
        if (!timeline) return;
        
        timeline.innerHTML = '';
        
        if (activities.length === 0) {
            timeline.innerHTML = '<div class="text-center text-muted p-3">No recent activity</div>';
            return;
        }

        activities.slice(0, 5).forEach(activity => {
            const item = document.createElement('div');
            item.className = 'timeline-item';
            item.style.cursor = 'pointer';
            item.addEventListener('click', function() {
                // Redirect to profile form when activity is clicked
                window.location.href = '{% url "cooperatives:profile_form" %}';
            });
            const timeAgo = activity.time ? getTimeAgo(new Date(activity.time)) : 'Recently';
            const markerClass = activity.color === 'red' ? 'bg-danger' : 
                               activity.color === 'green' ? 'bg-success' : 
                               activity.color === 'blue' ? 'bg-primary' : 'bg-warning';
            item.innerHTML = `
                <div class="timeline-marker ${markerClass}"></div>
                <div class="timeline-content">
                    <p class="text-main">${activity.title}</p>
                    <span class="time">${timeAgo}</span>
                </div>
            `;
            timeline.appendChild(item);
        });
    }

    function getTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        if (seconds < 60) return 'Just now';
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
        const days = Math.floor(hours / 24);
        return `${days} day${days > 1 ? 's' : ''} ago`;
    }

    // Modal Logic and Filter Toggle
    document.addEventListener('DOMContentLoaded', () => {
        loadCooperativeDashboardData();
        
        // Filter Toggle Event
        const filterToggleBtn = document.getElementById('financeFilterToggle');
        const filterDropdown = document.getElementById('financeFilterControls');
        
        if (filterToggleBtn) {
            filterToggleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (filterDropdown.style.display === 'none' || filterDropdown.style.display === '') {
                    filterDropdown.style.display = 'flex';
                    filterToggleBtn.classList.add('active');
                } else {
                    filterDropdown.style.display = 'none';
                    filterToggleBtn.classList.remove('active');
                }
            });
        }

        // Global Close for Dropdown
        document.addEventListener('click', () => {
            if (filterDropdown && filterDropdown.style.display === 'flex') {
                filterDropdown.style.display = 'none';
                if (filterToggleBtn) filterToggleBtn.classList.remove('active');
            }
        });

        if (filterDropdown) filterDropdown.addEventListener('click', (e) => e.stopPropagation());
        
        // Handle document status clicks - redirect to profile form
        document.querySelectorAll('.clickable-compliance').forEach(item => {
            item.addEventListener('click', function() {
                window.location.href = '{% url "cooperatives:profile_form" %}';
            });
        });
        
        // Both buttons are now links, so no JavaScript needed for redirect
        // The links will handle navigation automatically

        // Handle profile modal (if it exists for other purposes)
        const modal = document.getElementById('profile-modal');
        const closeButtons = document.querySelectorAll('.modal-close-btn, .modal-close-btn-bottom');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');

        if (modal) {
            const closeModal = () => {
                modal.classList.remove('visible');
            };

            closeButtons.forEach(btn => {
                btn.addEventListener('click', closeModal);
            });

            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });

            if (downloadPdfBtn) {
                downloadPdfBtn.addEventListener('click', function() {
                    const element = document.getElementById('printable-area');
                    const coopName = document.getElementById('modal-coop-name')?.textContent.trim() || 'Cooperative';
                    
                    const opt = {
                        margin: 0.2,
                        filename: `${coopName}_Profile.pdf`,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2, useCORS: true },
                        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
                    };
                    
                    const originalContent = this.innerHTML;
                    this.innerHTML = '<i class="bi bi-hourglass-split"></i> Generating...';
                    this.disabled = true;

                    html2pdf().set(opt).from(element).save().then(() => {
                        this.innerHTML = originalContent;
                        this.disabled = false;
                    }).catch(err => {
                        console.error(err);
                        this.innerHTML = originalContent;
                        this.disabled = false;
                    });
                });
            }
        }
    });
    
    // --- BLOCKING MODAL FOR NO PROFILE DATA ---
    {% if not has_profile_data %}
    (function() {
        const modal = document.getElementById('noProfileModal');
        if (!modal) return;
        
        // Prevent closing the modal
        modal.addEventListener('click', function(e) {
            // Only allow clicks on the buttons inside the modal
            if (!e.target.closest('.btn-modal-primary') && !e.target.closest('.btn-modal-secondary')) {
                e.stopPropagation();
            }
        });
        
        // Prevent navigation away from the page
        window.addEventListener('beforeunload', function(e) {
            e.preventDefault();
            e.returnValue = 'You need to complete your profile before leaving. Are you sure you want to leave?';
            return e.returnValue;
        });
        
        // Prevent back button
        window.addEventListener('popstate', function(e) {
            history.pushState(null, null, window.location.href);
        });
        
        // Push state to prevent back button
        history.pushState(null, null, window.location.href);
        
        // Disable sidebar navigation
        const sidebarLinks = document.querySelectorAll('.sidebar a, .sidebar button');
        sidebarLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                const href = this.getAttribute('href');
                // Only allow navigation to profile or messages
                if (href && !href.includes('profile_form') && !href.includes('message') && !href.includes('#')) {
                    e.preventDefault();
                    alert('Please complete your profile data first before navigating to other pages.');
                }
            });
        });
    })();
    {% endif %}
</script>
{% endblock %}
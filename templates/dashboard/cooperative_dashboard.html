{% extends 'dashboard/dashboard.html' %}
{% load static %}

{% block dashboard_title %}Cooperative Dashboard{% endblock %}

{% block extra_head %}
    {{ block.super }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="{% static 'frontend/cooperative_dashboard.css' %}">
{% endblock %}

{% block dashboard_content %}
<div class="coop-dashboard-container">
    
    <div class="dashboard-header">
        <div>
            <h4 class="subtitle">Cooperative Overview</h4>
            <h1>Welcome, {{ request.session.username|default:'Officer' }}!</h1>
        </div>
    </div>

    <div class="hero-card">
        <div class="hero-header">
            <div class="coop-identity">
                <div class="hero-avatar">
                    {{ cooperative.cooperative_name|first|default:"C" }}
                </div>
                <div>
                    <h2>{{ cooperative.cooperative_name|default:"Consumer Cooperative" }}</h2>
                    <p class="coop-address"><i class="bi bi-geo-alt-fill"></i> {{ cooperative.address|default:"Sabang, Lipa City, Batangas" }}</p>
                </div>
            </div>
            <div class="compliance-badges">
                <div class="status-badge success">
                    <i class="bi bi-patch-check-fill"></i> LCCDC Member
                </div>
                <div class="status-badge warning">
                    <i class="bi bi-file-earmark-text"></i> Report Due Soon
                </div>
            </div>
        </div>
        
        <hr class="divider">

        <div class="hero-details-grid">
            <div class="detail-item">
                <label>CDA Registration No.</label>
                <p>{{ cooperative.cda_registration_number|default:"1414-060923055" }}</p>
            </div>
            <div class="detail-item">
                <label>CDA Registration Date</label>
                <p>{{ cooperative.cda_registration_date|default:"Sept 06, 2005" }}</p>
            </div>
            <div class="detail-item">
                <label>LCCDC Membership Date</label>
                <p>{{ cooperative.lccdc_membership_date|default:"Sept 14, 2014" }}</p>
            </div>
            <div class="detail-item">
                <label>Business Activity</label>
                <p>{{ cooperative.business_activity|default:"Supply and Demand" }}</p>
            </div>
        </div>
    </div>

    <div class="stats-grid">
        
        <div class="stat-card">
            <div class="card-icon red-bg"><i class="bi bi-person-badge-fill"></i></div>
            <div class="card-content">
                <p class="label">Total Officers</p>
                <h3 class="value" id="stat-officers">0</h3>
            </div>
        </div>

        <div class="stat-card wide-card">
            <div class="card-icon blue-bg"><i class="bi bi-people-fill"></i></div>
            <div class="card-content">
                <p class="label">Total Members</p>
                <h3 class="value" id="stat-members">0</h3>
            </div>
            
            <div class="gender-breakdown" id="genderBreakdown">
                <div class="gender-item">
                    <div class="gender-label"><i class="bi bi-gender-male"></i> Male</div>
                    <div class="gender-bar-container">
                        <div class="gender-bar male-bar" id="maleBar" style="width: 0%;"></div>
                    </div>
                    <span class="gender-count" id="maleCount">0</span>
                </div>
                <div class="gender-item">
                    <div class="gender-label"><i class="bi bi-gender-female"></i> Female</div>
                    <div class="gender-bar-container">
                        <div class="gender-bar female-bar" id="femaleBar" style="width: 0%;"></div>
                    </div>
                    <span class="gender-count" id="femaleCount">0</span>
                </div>
            </div>
        </div>
    </div>

    <div class="content-split">
        
        <div class="card-section">
            <div class="section-header">
                <h3>Quick Actions</h3>
            </div>
            <div class="action-grid">
                <button class="action-btn" id="viewProfileBtn">
                    <i class="bi bi-eye-fill"></i>
                    <span>View Cooperative Profile</span>
                </button>
                
                <a href="{% url 'cooperatives:profile_form' %}" class="action-btn">
                    <i class="bi bi-pencil-square"></i>
                    <span>Update Profile</span>
                </a>
            </div>
        </div>

        <div class="card-section">
            <div class="section-header">
                <h3>Recent Activity</h3>
                <a href="#" class="view-all">View All</a>
            </div>
            <div class="timeline" id="coopActivityTimeline">
                <div class="text-center text-muted p-3">Loading activities...</div>
            </div>
        </div>

    </div>

    <div class="charts-section" style="margin-top: 2rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
        <div class="chart-card" style="min-height: 300px;">
            <div class="card-header-custom">
                <h3>Financial Trend (Last 5 Years)</h3>
            </div>
            <div class="chart-wrapper" style="height: 250px;">
                <canvas id="coopFinancialChart"></canvas>
            </div>
        </div>

        <div class="chart-card" style="min-height: 300px;">
            <div class="card-header-custom">
                <h3>Assets Growth</h3>
            </div>
            <div class="chart-wrapper" style="height: 250px;">
                <canvas id="coopAssetsChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div id="profile-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-top-bar">
            <h3>Cooperative Profile</h3>
            <div class="modal-actions">
                <button class="pdf-btn" id="download-pdf-btn" title="Download as PDF">
                    <i class="bi bi-file-earmark-pdf-fill"></i> <span>Download Profile</span>
                </button>
                <button class="modal-close-btn">&times;</button>
            </div>
        </div>
        
        <div class="modal-scroll-area">
            <div id="printable-area">
                <div class="modal-header-section">
                    <div class="coop-avatar">{{ cooperative.cooperative_name|first|default:"C" }}</div>
                    <div class="coop-title-info">
                        <h4 id="modal-coop-name">{{ cooperative.cooperative_name|default:"Consumer Cooperative" }}</h4>
                        <span class="badge-cda">CDA: {{ cooperative.cda_registration_number|default:"1414-060923055" }}</span>
                        <div class="update-info">Last Updated: {{ cooperative.updated_at|default:"Sept 30, 2025" }}</div>
                    </div>
                </div>

                <div class="modal-body">
                    <section class="info-section">
                        <h5 class="section-title">Cooperative General Information</h5>
                        <div class="info-grid two-col">
                            <div class="info-item"><label>Cooperative Name</label><p>{{ cooperative.cooperative_name|default:"Consumer Cooperative" }}</p></div>
                            <div class="info-item"><label>Address</label><p>{{ cooperative.address|default:"Sabang, Lipa City, Batangas" }}</p></div>
                            <div class="info-item"><label>Contact Number</label><p>{{ cooperative.contact_number|default:"09929380925" }}</p></div>
                            <div class="info-item"><label>Email Address</label><p>{{ cooperative.email|default:"consumercoop@gmail.com" }}</p></div>
                            <div class="info-item"><label>CDA Reg. No.</label><p>{{ cooperative.cda_registration_number|default:"1414-060923055" }}</p></div>
                            <div class="info-item"><label>CDA Reg. Date</label><p>{{ cooperative.cda_registration_date|default:"09-06-2005" }}</p></div>
                            <div class="info-item"><label>LCCDC Membership</label><p>{{ cooperative.lccdc_membership_date|default:"09-14-2014" }}</p></div>
                            <div class="info-item"><label>Area of Operation</label><p>{{ cooperative.area_operation|default:"Consumer" }}</p></div>
                            <div class="info-item"><label>Business Activity</label><p>{{ cooperative.business_activity|default:"Supply and demand" }}</p></div>
                            <div class="info-item"><label>Board Directors</label><p>{{ cooperative.bod_count|default:"3" }}</p></div>
                            <div class="info-item"><label>Salaried Employees</label><p>{{ cooperative.employee_count|default:"14" }}</p></div>
                            <div class="info-item"><label>Compliance Cert.</label><p><span class="status-yes">Yes</span></p></div>
                            <div class="info-item"><label>Tax Exemption</label><p><span class="status-yes">Yes</span></p></div>
                        </div>
                    </section>

                    <section class="info-section">
                        <h5 class="section-title">Financial Records</h5>
                        <div class="info-grid three-col">
                            <div class="info-item"><label>2022 Assets</label><p>₱ 142,657.00</p></div>
                            <div class="info-item"><label>2023 Assets</label><p>₱ 258,843.00</p></div>
                            <div class="info-item"><label>2024 Assets</label><p>₱ 356,964.68</p></div>
                            <div class="info-item"><label>Paid Up Capital</label><p>₱ 108,243.78</p></div>
                            <div class="info-item"><label>Net Surplus</label><p>₱ 10,653.54</p></div>
                        </div>
                    </section>

                    <section class="info-section">
                        <h5 class="section-title">Cooperative Officers</h5>
                        <div class="modal-table-wrapper">
                            <table class="modal-table">
                                <thead>
                                    <tr><th>Name</th><th>Position</th><th>Gender</th><th>Mobile</th><th>Email</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>Isabel Delacion</td><td>Chairperson</td><td>Female</td><td>0917-123-4567</td><td>isabel.d@email.com</td></tr>
                                    <tr><td>Jasmin Esperida</td><td>Vice Chairperson</td><td>Female</td><td>0918-234-5678</td><td>jasmin.e@email.com</td></tr>
                                    <tr><td>Art Delos Reyes</td><td>BOD Member</td><td>Male</td><td>0919-345-6789</td><td>art.dr@email.com</td></tr>
                                    <tr><td>Maria Lopez</td><td>Secretary</td><td>Female</td><td>0921-567-8901</td><td>maria.l@email.com</td></tr>
                                    <tr><td>Ramon Santos</td><td>Treasurer</td><td>Male</td><td>0922-678-9012</td><td>ramon.s@email.com</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <section class="info-section">
                        <h5 class="section-title">Cooperative Members</h5>
                        <div class="modal-table-wrapper">
                            <table class="modal-table">
                                <thead>
                                    <tr><th>Name</th><th>Gender</th><th>Mobile</th><th>Email</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>Juan dela Cruz</td><td>Male</td><td>0950-111-2222</td><td>juan.dc@email.com</td></tr>
                                    <tr><td>Maria Clara Santos</td><td>Female</td><td>0950-333-4444</td><td>maria.cs@email.com</td></tr>
                                    <tr><td>Jose Rizalino</td><td>Male</td><td>0950-555-6666</td><td>jose.r@email.com</td></tr>
                                    <tr><td>Andres Bonifacio Jr.</td><td>Male</td><td>0950-777-8888</td><td>andres.b@email.com</td></tr>
                                    <tr><td>Gabriela Silang</td><td>Female</td><td>0950-999-0000</td><td>gabriela.s@email.com</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </section>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="secondary-btn modal-close-btn-bottom">Close</button>
            <a href="{% url 'cooperatives:profile_form' %}" class="primary-btn"><i class="bi bi-pencil-square"></i> Update Info</a>
        </div>
    </div>
</div>

<script>
    let coopFinancialChart, coopAssetsChart;

    async function loadCooperativeDashboardData() {
        try {
            // Load stats
            const statsResponse = await fetch('{% url "dashboard:dashboard_stats_api" %}');
            const statsData = await statsResponse.json();
            updateCooperativeStats(statsData);

            // Load member demographics
            const demographicsResponse = await fetch('{% url "dashboard:dashboard_member_demographics_api" %}');
            const demographicsData = await demographicsResponse.json();
            updateMemberDemographics(demographicsData);

            // Load charts data
            const chartsResponse = await fetch('{% url "dashboard:dashboard_charts_api" %}');
            const chartsData = await chartsResponse.json();
            initializeCooperativeCharts(chartsData);

            // Load recent activity
            const activityResponse = await fetch('{% url "dashboard:dashboard_recent_activity_api" %}');
            const activityData = await activityResponse.json();
            updateCooperativeActivity(activityData.activities);
        } catch (error) {
            console.error('Error loading cooperative dashboard data:', error);
        }
    }

    function updateCooperativeStats(data) {
        document.getElementById('stat-officers').textContent = data.total_officers || 0;
        document.getElementById('stat-members').textContent = data.total_members || 0;
    }

    function updateMemberDemographics(data) {
        const total = data.total || 1;
        const malePercent = total > 0 ? (data.male / total) * 100 : 0;
        const femalePercent = total > 0 ? (data.female / total) * 100 : 0;

        document.getElementById('maleCount').textContent = data.male || 0;
        document.getElementById('femaleCount').textContent = data.female || 0;
        document.getElementById('maleBar').style.width = `${malePercent}%`;
        document.getElementById('femaleBar').style.width = `${femalePercent}%`;
    }

    function initializeCooperativeCharts(data) {
        // Financial Trend Chart
        const ctxFin = document.getElementById('coopFinancialChart');
        if (ctxFin) {
            const trend = data.financial_trend || {};
            const trendLabels = Object.keys(trend).sort();
            const trendValues = trendLabels.map(year => (trend[year] || 0) / 1000000);
            
            if (coopFinancialChart) coopFinancialChart.destroy();
            coopFinancialChart = new Chart(ctxFin.getContext('2d'), {
                type: 'line',
                data: {
                    labels: trendLabels.length > 0 ? trendLabels : ['No Data'],
                    datasets: [{
                        label: 'Net Surplus (M)',
                        data: trendValues.length > 0 ? trendValues : [0],
                        borderColor: '#1a237e',
                        backgroundColor: 'rgba(26, 35, 126, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true }, x: { grid: { display: false } } }
                }
            });
        }

        // Assets Growth Chart
        const ctxAssets = document.getElementById('coopAssetsChart');
        if (ctxAssets) {
            const trend = data.financial_trend || {};
            const trendLabels = Object.keys(trend).sort();
            // Get assets data (we'll need to add this to the API, for now use net surplus as proxy)
            const assetsValues = trendLabels.map(year => {
                // This is a placeholder - ideally we'd have separate assets data
                return ((trend[year] || 0) * 10) / 1000000; // Approximate
            });
            
            if (coopAssetsChart) coopAssetsChart.destroy();
            coopAssetsChart = new Chart(ctxAssets.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: trendLabels.length > 0 ? trendLabels : ['No Data'],
                    datasets: [{
                        label: 'Assets (M)',
                        data: assetsValues.length > 0 ? assetsValues : [0],
                        backgroundColor: '#a91e2c',
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true }, x: { grid: { display: false } } }
                }
            });
        }
    }

    function updateCooperativeActivity(activities) {
        const timeline = document.getElementById('coopActivityTimeline');
        if (!timeline) return;
        
        timeline.innerHTML = '';
        
        if (activities.length === 0) {
            timeline.innerHTML = '<div class="text-center text-muted p-3">No recent activity</div>';
            return;
        }

        activities.slice(0, 5).forEach(activity => {
            const item = document.createElement('div');
            item.className = 'timeline-item';
            const timeAgo = activity.time ? getTimeAgo(new Date(activity.time)) : 'Recently';
            const markerClass = activity.color === 'red' ? 'bg-danger' : 
                               activity.color === 'green' ? 'bg-success' : 
                               activity.color === 'blue' ? 'bg-primary' : 'bg-warning';
            item.innerHTML = `
                <div class="timeline-marker ${markerClass}"></div>
                <div class="timeline-content">
                    <p class="text-main">${activity.title}</p>
                    <span class="time">${timeAgo}</span>
                </div>
            `;
            timeline.appendChild(item);
        });
    }

    function getTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        if (seconds < 60) return 'Just now';
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
        const days = Math.floor(hours / 24);
        return `${days} day${days > 1 ? 's' : ''} ago`;
    }

    // Modal Logic
    document.addEventListener('DOMContentLoaded', () => {
        loadCooperativeDashboardData();
        
        const viewProfileBtn = document.getElementById('viewProfileBtn');
        const modal = document.getElementById('profile-modal');
        const closeButtons = document.querySelectorAll('.modal-close-btn, .modal-close-btn-bottom');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');

        if (modal && viewProfileBtn) {
            viewProfileBtn.addEventListener('click', () => {
                modal.classList.add('visible');
            });

            const closeModal = () => {
                modal.classList.remove('visible');
            };

            closeButtons.forEach(btn => {
                btn.addEventListener('click', closeModal);
            });

            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });

            if (downloadPdfBtn) {
                downloadPdfBtn.addEventListener('click', function() {
                    const element = document.getElementById('printable-area');
                    const coopName = document.getElementById('modal-coop-name')?.textContent.trim() || 'Cooperative';
                    
                    const opt = {
                        margin: 0.2,
                        filename: `${coopName}_Profile.pdf`,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2, useCORS: true },
                        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
                    };
                    
                    const originalContent = this.innerHTML;
                    this.innerHTML = '<i class="bi bi-hourglass-split"></i> Generating...';
                    this.disabled = true;

                    html2pdf().set(opt).from(element).save().then(() => {
                        this.innerHTML = originalContent;
                        this.disabled = false;
                    }).catch(err => {
                        console.error(err);
                        this.innerHTML = originalContent;
                        this.disabled = false;
                    });
                });
            }
        }
    });
</script>
{% endblock %}
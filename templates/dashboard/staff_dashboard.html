{% extends 'dashboard/dashboard.html' %}
{% load static %}

{% block dashboard_title %}Staff Dashboard{% endblock %}

{% block extra_head %}
    {{ block.super }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{% static 'frontend/staff_dashboard.css' %}">
{% endblock %}

{% block dashboard_content %}
<div class="staff-dashboard-container">
    
    <div class="dashboard-header">
        <div>
            <h4 class="subtitle">Workload Overview</h4>
            <h1>Welcome back, {{ request.session.username|default:'Staff' }}!</h1>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card clickable" data-bs-toggle="modal" data-bs-target="#assignedCoopsModal">
            <div class="icon-box red-box">
                <i class="bi bi-briefcase-fill"></i>
            </div>
            <div class="stat-info">
                <p>Assigned Cooperatives</p>
                <h3 id="stat-assigned-coops">0</h3>
                <span class="link-text">View List <i class="bi bi-arrow-right"></i></span>
            </div>
        </div>

        <div class="stat-card">
            <div class="icon-box green-box">
                <i class="bi bi-check-circle-fill"></i>
            </div>
            <div class="stat-info">
                <p>Updated Profiles</p>
                <h3 id="stat-updated-profiles">0</h3>
                <small class="text-muted">Recently updated by coops</small>
            </div>
        </div>

        <div class="stat-card">
            <div class="icon-box orange-box">
                <i class="bi bi-exclamation-triangle-fill"></i>
            </div>
            <div class="stat-info">
                <p>Pending Submission</p>
                <h3 id="stat-pending-submission">0</h3>
                <small class="text-muted">Profiles not yet submitted</small>
            </div>
        </div>
    </div>

    <div class="charts-section" style="margin-top: 2rem;">
        <div class="chart-card" style="flex: 1; min-width: 300px;">
            <div class="card-header-custom">
                <h3>Assigned Cooperatives by Category</h3>
            </div>
            <div class="chart-wrapper" style="height: 250px;">
                <canvas id="staffCategoryChart"></canvas>
            </div>
        </div>

        <div class="chart-card" style="flex: 1; min-width: 300px;">
            <div class="card-header-custom">
                <h3>Compliance Status</h3>
            </div>
            <div class="chart-wrapper" style="height: 250px;">
                <canvas id="staffComplianceChart"></canvas>
            </div>
        </div>
    </div>

    <div class="content-split">
        
        <div class="card-section main-list">
            <div class="card-header-custom">
                <h3>My Assigned Cooperatives</h3>
                <div class="header-actions" style="display:flex;align-items:center;gap:8px;">

                    <div style="display:flex;align-items:center;gap:6px;">
                        <button id="filterToggleStaff" class="filter-toggle-btn" title="Toggle filters">
                            <i class="bi bi-funnel"></i> <span>Filter</span>
                        </button>

                        <div id="filterControlsStaff" class="filter-controls" style="display:none; gap:6px; align-items:center;">
                            <select class="form-select-sm" id="categoryFilterStaff" style="min-width:110px;">
                                <option value="">All Categories</option>
                                <option value="Micro">Micro</option>
                                <option value="Small">Small</option>
                                <option value="Medium">Medium</option>
                                <option value="Large">Large</option>
                            </select>
                            <select class="form-select-sm" id="districtFilterStaff" style="min-width:110px;">
                                <option value="">All Districts</option>
                                <option value="East">East</option>
                                <option value="West">West</option>
                                <option value="North">North</option>
                                <option value="South">South</option>
                                <option value="Urban">Urban</option>
                            </select>
                        </div>
                    </div>
                </div>
             </div>
            
            <div class="table-responsive">
                <table class="staff-table">
                    <thead>
                        <tr>
                            <th>Cooperative Name</th>
                            <th>Category</th>
                            <th>District</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="staffCoopTableBody">
                        <tr><td colspan="4" class="text-center text-muted p-3">Loading cooperatives...</td></tr>
                    </tbody>
                  </table>
                <div id="noResultsMessageStaff" style="display:none;padding:12px;text-align:center;color:#6c757d;">
                    No cooperatives found matching the selected filters.
                </div>
             </div>
        </div>

        <div class="card-section activity-feed">
            <div class="card-header-custom">
                <h3>Recent Updates</h3>
            </div>
            <div class="timeline" id="recentActivityTimeline">
                <div class="text-center text-muted p-3">Loading activities...</div>
            </div>
        </div>

    </div>
</div>

<div class="modal fade" id="coopProfileModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cooperative Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <div class="avatar-circle mb-2">C</div>
                    <h4>Consumer Cooperative</h4>
                    <span class="badge bg-success">Updated</span>
                    <p class="text-muted mt-2">Sabang, Lipa City, Batangas</p>
                </div>

                <div class="info-grid">
                    <div><strong>CDA No:</strong> 1414-060923055</div>
                    <div><strong>Category:</strong> Micro</div>
                    <div><strong>Assets:</strong> â‚± 356,964.68</div>
                    <div><strong>Members:</strong> 120</div>
                </div>

                <div class="mt-4 text-end">
                    <button class="btn btn-sm btn-outline-secondary">Download PDF</button>
                    <button class="btn btn-sm btn-danger">Edit Details</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="assignedCoopsModal" tabindex="-1" aria-labelledby="assignedCoopsLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assignedCoopsLabel">Assigned Cooperatives</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body p-0">
                <div class="table-responsive">
                    <table class="modal-table" id="assignedCoopsTable">
                        <thead>
                            <tr>
                                <th>Cooperative Name</th>
                                <th>Address</th>
                                <th>Email</th>
                                <th>CDA Registration No.</th>
                            </tr>
                        </thead>
                        <tbody id="assignedCoopsTableBody">
                            <tr><td colspan="4" class="text-center text-muted p-3">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    let staffCategoryChart, staffComplianceChart;

    async function loadStaffDashboardData() {
        try {
            // Load stats
            const statsResponse = await fetch('{% url "dashboard:dashboard_stats_api" %}');
            const statsData = await statsResponse.json();
            updateStaffStats(statsData);

            // Load charts data
            const chartsResponse = await fetch('{% url "dashboard:dashboard_charts_api" %}');
            const chartsData = await chartsResponse.json();
            initializeStaffCharts(chartsData);

            // Load cooperatives list
            const coopsResponse = await fetch('{% url "dashboard:dashboard_cooperatives_list_api" %}');
            const coopsData = await coopsResponse.json();
            updateStaffCooperativesList(coopsData.cooperatives);

            // Load recent activity
            const activityResponse = await fetch('{% url "dashboard:dashboard_recent_activity_api" %}');
            const activityData = await activityResponse.json();
            updateRecentActivity(activityData.activities);
        } catch (error) {
            console.error('Error loading staff dashboard data:', error);
        }
    }

    function updateStaffStats(data) {
        document.getElementById('stat-assigned-coops').textContent = data.total_cooperatives || 0;
        // Calculate updated profiles (profiles with recent updates)
        document.getElementById('stat-updated-profiles').textContent = data.total_cooperatives || 0;
        // Calculate pending submissions
        document.getElementById('stat-pending-submission').textContent = data.pending_users || 0;
    }

    function initializeStaffCharts(data) {
        // Category Chart
        const ctxCat = document.getElementById('staffCategoryChart');
        if (ctxCat) {
            const categoryLabels = Object.keys(data.categories || {});
            const categoryValues = Object.values(data.categories || {});
            const categoryColors = ['#a91e2c', '#e57373', '#42a5f5', '#26a69a', '#ff9800'];
            
            if (staffCategoryChart) staffCategoryChart.destroy();
            staffCategoryChart = new Chart(ctxCat.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: categoryLabels.length > 0 ? categoryLabels : ['No Data'],
                    datasets: [{
                        data: categoryValues.length > 0 ? categoryValues : [0],
                        backgroundColor: categoryColors.slice(0, categoryLabels.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { boxWidth: 10 } } }
                }
            });
        }

        // Compliance Chart
        const ctxComp = document.getElementById('staffComplianceChart');
        if (ctxComp) {
            const compliance = data.compliance || {coc: {active: 0, inactive: 0}, cote: {active: 0, inactive: 0}};
            
            if (staffComplianceChart) staffComplianceChart.destroy();
            staffComplianceChart = new Chart(ctxComp.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['COC', 'COTE'],
                    datasets: [
                        { 
                            label: 'Active', 
                            data: [compliance.coc.active || 0, compliance.cote.active || 0], 
                            backgroundColor: '#4caf50', 
                            barThickness: 20 
                        },
                        { 
                            label: 'Inactive', 
                            data: [compliance.coc.inactive || 0, compliance.cote.inactive || 0], 
                            backgroundColor: '#ef5350', 
                            barThickness: 20 
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, indexAxis: 'y',
                    scales: { x: { stacked: true, display: false }, y: { stacked: true, grid: { display: false } } },
                    plugins: { legend: { display: false } }
                }
            });
        }
    }

    function updateStaffCooperativesList(cooperatives) {
        const tbody = document.getElementById('staffCoopTableBody');
        const modalTbody = document.getElementById('assignedCoopsTableBody');
        
        if (tbody) {
            tbody.innerHTML = '';
            cooperatives.forEach(coop => {
                const row = document.createElement('tr');
                row.setAttribute('data-category', coop.category || '');
                row.setAttribute('data-district', coop.district || '');
                row.setAttribute('data-bs-toggle', 'modal');
                row.setAttribute('data-bs-target', '#coopProfileModal');
                const initials = (coop.name || 'C').substring(0, 1).toUpperCase();
                const status = coop.approval_status === 'approved' ? 'success' : 'warning';
                const statusText = coop.approval_status === 'approved' ? 'Updated' : 'Pending';
                
                row.innerHTML = `
                    <td>
                        <div class="coop-cell">
                            <div class="avatar-sm">${initials}</div>
                            <div>
                                <span class="fw-bold">${coop.name}</span>
                                <small class="d-block text-muted">${coop.address || 'N/A'}</small>
                            </div>
                        </div>
                    </td>
                    <td>${coop.category || 'N/A'}</td>
                    <td>${coop.district || 'N/A'}</td>
                    <td><span class="badge-status ${status}">${statusText}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        if (modalTbody) {
            modalTbody.innerHTML = '';
            cooperatives.forEach(coop => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${coop.name}</td>
                    <td>${coop.address || 'N/A'}</td>
                    <td>${coop.email || 'N/A'}</td>
                    <td>${coop.cda_number || 'N/A'}</td>
                `;
                modalTbody.appendChild(row);
            });
        }
    }

    function updateRecentActivity(activities) {
        const timeline = document.getElementById('recentActivityTimeline');
        if (!timeline) return;
        
        timeline.innerHTML = '';
        
        if (activities.length === 0) {
            timeline.innerHTML = '<div class="text-center text-muted p-3">No recent activity</div>';
            return;
        }

        activities.slice(0, 5).forEach(activity => {
            const item = document.createElement('div');
            item.className = 'timeline-item';
            const timeAgo = activity.time ? getTimeAgo(new Date(activity.time)) : 'Recently';
            item.innerHTML = `
                <div class="timeline-icon bg-${activity.color || 'blue'}">
                    <i class="bi bi-${activity.icon || 'circle'}"></i>
                </div>
                <div class="timeline-content">
                    <p class="text-dark fw-bold">${activity.title}</p>
                    <p class="text-muted small">${activity.description}</p>
                    <span class="time-ago">${timeAgo}</span>
                </div>
            `;
            timeline.appendChild(item);
        });
    }

    function getTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        if (seconds < 60) return 'Just now';
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
        const days = Math.floor(hours / 24);
        return `${days} day${days > 1 ? 's' : ''} ago`;
    }

    // Filter functionality
    document.addEventListener('DOMContentLoaded', () => {
        loadStaffDashboardData();
        
        const toggle = document.getElementById('filterToggleStaff');
        const controls = document.getElementById('filterControlsStaff');
        const category = document.getElementById('categoryFilterStaff');
        const district = document.getElementById('districtFilterStaff');
        const noResults = document.getElementById('noResultsMessageStaff');

        function applyStaffFilters() {
            const catVal = (category?.value || '').trim();
            const distVal = (district?.value || '').trim();
            const rows = document.querySelectorAll('#staffCoopTableBody tr');
            let found = false;

            rows.forEach(r => {
                const rCat = (r.dataset.category || '').trim();
                const rDist = (r.dataset.district || '').trim();

                const matches = (catVal === '' || rCat === catVal)
                    && (distVal === '' || rDist === distVal);

                r.style.display = matches ? '' : 'none';
                if (matches) found = true;
            });

            if (noResults) {
                noResults.style.display = found ? 'none' : 'block';
            }
        }

        toggle?.addEventListener('click', (e) => {
            e.stopPropagation();
            if (!controls) return;
            controls.style.display = (controls.style.display === 'flex') ? 'none' : 'flex';
            toggle.setAttribute('aria-expanded', String(controls.style.display === 'flex'));
        });

        document.addEventListener('click', (ev) => {
            if (!controls || !toggle) return;
            if (!controls.contains(ev.target) && !toggle.contains(ev.target)) {
                controls.style.display = 'none';
                toggle.setAttribute('aria-expanded', 'false');
            }
        });

        [category, district].forEach(el => el?.addEventListener('change', applyStaffFilters));
    });
</script>
{% endblock %}
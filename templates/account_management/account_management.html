{% extends "dashboard/dashboard.html" %}
{% load static %}

{% block title %} Account Management - KoopTimizer{% endblock %}

{% block page_header %}Account Management{% endblock %}

{% block extra_head %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'frontend/account_management.css' %}">
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
<style>
    .action-buttons {
        display: none;
        gap: 10px;
        margin-top: 15px;
    }

    /* Selected row highlighting */
    tbody tr.selected {
        background-color: #e3f2fd !important;
    }

    /* Modal overlay */
    .modal-overlay {
        display: flex;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .modal-overlay.hidden {
        display: none;
    }

    /* Cursor pointer for clickable rows */
    tbody tr {
        cursor: pointer;
    }

    tbody tr:hover {
        background-color: #f5f5f5;
    }

    .ts-control {
        border-radius: 5px;
        padding: 10px;
        border: 1px solid #ddd;
    }

    .ts-wrapper.multi .ts-control>div {
        background: #e3f2fd;
        border: 1px solid #90caf9;
        color: #0d47a1;
        border-radius: 3px;
    }

    .ts-dropdown .option.disabled {
        display: none !important;
    }

    .account-header {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
    }

    .table-controls {
        max-width: 100%;
    }

    .table-wrapper {
        overflow-x: auto;
        /* Enables horizontal scroll if table is too wide */
        -webkit-overflow-scrolling: touch;
        /* Smooth scrolling on mobile */
        margin-bottom: 20px;
        border: 1px solid #eee;
        /* Optional frame */
        border-radius: 8px;
    }

    /* Ensure table respects fixed layout */
    .table-wrapper table {
        width: 100%;
        table-layout: fixed;
        border-collapse: collapse;
    }

    /* Ensure proper alignment between header and body cells */
    .table-wrapper th,
    .table-wrapper td {
        padding: 12px 16px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: left;
        font-size: 0.9rem;
        vertical-align: middle;
    }
</style>
{% endblock %}

{% block dashboard_content %}
<div class="account-management-container">
    <div class="account-header">
        <div class="tab-buttons">
            {% if request.session.role == 'admin' %}
            <button class="tab-btn" data-target="all-users">ALL</button>
            <button class="tab-btn" data-target="admins">Admins</button>
            <button class="tab-btn active" data-target="staffs">Staffs</button>
            <button class="tab-btn" data-target="officers">Officers</button>
            <button class="tab-btn" data-target="deactivated">Deactivated</button>
            {% elif request.session.role == 'staff' %}
            <button class="tab-btn active" data-target="officers">Officers</button>
            {% endif %}
        </div>

        <div id="table-controls" class="table-controls">
            <input type="text" id="user-search" class="search-input" placeholder="Search users...">
        </div>

        {% if request.session.role == 'admin' %}
        <div class="add-section" id="staff-add-section">
            <p class="total-label">Total Staffs: <span class="count" id="staff-count">{{ staffs|length }}</span></p>
            <button class="add-btn" data-account-type="staff" id="onboard-staff-btn"><i class="bi bi-plus-circle"></i>
                Add</button>
        </div>
        <div class="add-section hidden" id="admin-add-section">
            <p class="total-label">Total Admins: <span class="count" id="admin-count">{{ admins|length }}</span></p>
            <button class="add-btn" data-account-type="admin" id="onboard-admin-btn"><i class="bi bi-plus-circle"></i>
                Add</button>
        </div>
        <div class="add-section hidden" id="all-users-section">
            <p class="total-label">Total Users: <span class="count" id="all-user-count">0</span></p>
        </div>
        <div class="add-section hidden" id="officer-add-section">
            <p class="total-label">Total Officers: <span class="count" id="officer-count">{{ officers|length }}</span>
            </p>
            <button class="add-btn" data-account-type="officer" id="onboard-officer-btn"><i
                    class="bi bi-plus-circle"></i> Add</button>
        </div>
        <div class="add-section hidden" id="deactivated-add-section">
            <p class="total-label">Total Deactivated: <span class="count"id="deactivated-count">{{deactivated_accounts|length }}</span></p>
        </div>
        {% elif request.session.role == 'staff' %}
        <div class="add-section" id="officer-add-section">
            <p class="total-label">Total Officers: <span class="count" id="officer-count">{{ officers|length }}</span>
            </p>
            <button class="add-btn" data-account-type="officer" id="onboard-officer-btn"><i
                    class="bi bi-plus-circle"></i> Add</button>
        </div>
        {% endif %}
    </div>

    {% if request.session.role == 'admin' %}
    <div class="table-section" id="all-users">
        <h2>All User Accounts</h2>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Full Name</th>
                        <th>Email Address</th>
                        <th>Contact Number</th>
                        <th>Position</th>
                        <th>Cooperative</th>
                        <th>Account Type</th>
                    </tr>
                </thead>
                <tbody id="all-users-table-body"></tbody>
            </table>
        </div>
        <div class="action-buttons">
            <button class="edit-btn"><i class="bi bi-pencil"></i> Edit</button>
            <button class="delete-btn"><i class="bi bi-trash"></i> Delete</button>
        </div>
    </div>

    <div class="table-section" id="admins">
        <h2>Admin User Accounts</h2>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Admin Name</th>
                        <th>Email Address</th>
                        <th>Contact Number</th>
                        <th>Position</th>
                    </tr>
                </thead>
                <tbody id="admin-table-body">
                    {% for admin in admins %}
                    <tr data-type="admin" data-user-id="{{ admin.user_id }}" data-profile-id="{{ admin.profile_id }}">
                        <td>{{ forloop.counter }}</td>
                        <td>{{ admin.fullname }}</td>
                        <td>{{ admin.email }}</td>
                        <td>{{ admin.contact }}</td>
                        <td>{{ admin.position }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" style="text-align:center;">No admin accounts found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="action-buttons">
            <button class="edit-btn"><i class="bi bi-pencil"></i> Edit</button>
            <button class="delete-btn"><i class="bi bi-trash"></i> Delete</button>
        </div>
    </div>

    <div class="table-section active" id="staffs">
        <h2>Staff User Accounts</h2>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Staff Name</th>
                        <th>Position</th>
                        <th>Email Address</th>
                        <th>Contact Number</th>
                        <th>Cooperative Assigned</th>
                    </tr>
                </thead>
                <tbody id="staff-table-body">
                    {% for staff in staffs %}
                    <tr data-type="staff" data-user-id="{{ staff.user_id }}" data-profile-id="{{ staff.profile_id }}">
                        <td>{{ forloop.counter }}</td>
                        <td>{{ staff.fullname }}</td>
                        <td>{{ staff.position }}</td>
                        <td>{{ staff.email }}</td>
                        <td>{{ staff.contact }}</td>
                        <td>{{ staff.coop_name }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" style="text-align:center;">No staff accounts found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="action-buttons">
            <button class="edit-btn"><i class="bi bi-pencil"></i> Edit</button>
            <button class="delete-btn"><i class="bi bi-trash"></i> Delete</button>
        </div>
    </div>
    {% endif %}

    <div class="table-section {% if request.session.role == 'staff' %}active{% endif %}" id="officers">
        <h2>Officer User Accounts</h2>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Officer-in-charge</th>
                        <th>Cooperative Name</th>
                        <th>Email Address</th>
                        <th>Contact Number</th>
                        <th>Position</th>
                    </tr>
                </thead>
                <tbody id="officer-table-body">
                    {% for officer in officers %}
                    <tr data-type="officer" data-user-id="{{ officer.user_id }}"
                        data-profile-id="{{ officer.profile_id }}">
                        <td>{{ forloop.counter }}</td>
                        <td>{{ officer.fullname }}</td>
                        <td>{{ officer.coop_name }}</td>
                        <td>{{ officer.email }}</td>
                        <td>{{ officer.contact }}</td>
                        <td>{{ officer.position }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" style="text-align:center;">No officer accounts found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="action-buttons">
            <button class="edit-btn"><i class="bi bi-pencil"></i> Edit</button>
            <button class="delete-btn"><i class="bi bi-trash"></i> Delete</button>
        </div>
    </div>

    {% if request.session.role == 'admin' %}
    <div class="table-section" id="deactivated">
        <h2>Deactivated User Accounts</h2>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Full Name</th>
                        <th>Email Address</th>
                        <th>Contact Number</th>
                        <th>Role/Perm.</th>
                        <th>Cooperative</th>
                        <th>Type</th>
                    </tr>
                </thead>
                <tbody id="deactivated-table-body">
                    {% for user in deactivated_accounts %}
                    <tr data-type="{{ user.account_type|lower }}" data-user-id="{{ user.user_id }}"
                        data-profile-id="{{ user.profile_id }}">
                        <td>{{ forloop.counter }}</td>
                        <td>{{ user.fullname }}</td>
                        <td>{{ user.email }}</td>
                        <td>{{ user.contact }}</td>
                        <td>{{ user.position }}</td>
                        <td>{{ user.coop_name }}</td>
                        <td>{{ user.account_type }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" style="text-align:center;">No deactivated accounts found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="action-buttons">
            <button class="reactivate-btn"><i class="bi bi-arrow-counterclockwise"></i> Reactivate</button>
        </div>
    </div>
    {% endif %}
</div>

<div class="modal-overlay hidden" id="onboard-staff-modal">
    <div class="onboard-form-container">
        <div class="form-scroll-wrapper">
            <span class="close-btn modal-close">&times;</span>
            <h3 class="modal-title" id="onboard-modal-title">Onboard Staff Account</h3>
            <p class="input-instruction">Please input information</p>

            <form id="onboard-form" action="#" method="POST" class="onboard-form" data-account-type="staff">
                {% csrf_token %}
                <input type="hidden" id="edit-user-id" name="edit_user_id" value="">

                <div class="form-group">
                    <label for="staff-full-name">Full Name</label>
                    <input type="text" id="staff-full-name" name="full_name" placeholder="Firstname M.I. Lastname"
                        required>
                </div>

                <div class="form-group" id="gender-group">
                    <label for="staff-gender">Gender</label>
                    <select id="staff-gender" name="gender" required>
                        <option value="" disabled selected>Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group" id="position-group">
                    <label for="staff-position" id="position-label">Position/Role</label>
                    <input type="text" id="staff-position" name="position" placeholder="Enter position" required>
                </div>

                <div class="form-group">
                    <label for="staff-email">Email Address</label>
                    <input type="email" id="staff-email" name="email" placeholder="sample@gmail.com" required>
                </div>

                <div class="form-group">
                    <label for="staff-contact">Contact Number</label>
                    <input type="tel" id="staff-contact" name="contact" placeholder="09**********" pattern="[0-9]{11}"
                        title="Contact number must be 11 digits" required>
                </div>

                <div class="form-group" id="coop-group">
                    <label for="coop-assigned">Cooperative</label>
                    <select id="coop-assigned" name="coop_assigned" required>
                        <option value="" disabled selected>Choose Cooperatives</option>
                        {% for coop in cooperatives %}
                        <option value="{{ coop.coop_id }}"
                            data-owner-id="{{ coop.staff_user_id|default:'' }}">
                            {{ coop.cooperative_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div id="form-buttons-add">
                    <button type="submit" class="submit-btn">Create Account</button>
                </div>
                <div id="form-buttons-edit" style="display: none;">
                    <button type="submit" class="submit-btn">Save Changes</button>
                    <button type="button" id="edit-cancel-btn" class="cancel-btn">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="confirm-modal">
    <div class="confirm-modal-container">
        <p class="confirm-instruction">Please confirm if all details are correct</p>

        <div class="confirm-data-group">
            <label>Full Name</label>
            <input type="text" id="confirm-name" readonly>
        </div>
        <div class="confirm-data-group">
            <label id="confirm-role-label">Position/Role</label>
            <input type="text" id="confirm-position" readonly>
        </div>
        <div class="confirm-data-group">
            <label>Email Address</label>
            <input type="text" id="confirm-email" readonly>
        </div>
        <div class="confirm-data-group">
            <label>Contact Number</label>
            <input type="text" id="confirm-contact" readonly>
        </div>
        <div class="confirm-data-group hidden" id="confirm-coop-group">
            <label>Cooperative</label>
            <textarea id="confirm-coop" readonly></textarea>
        </div>
        <div class="confirm-data-group hidden" id="confirm-gender-group">
            <label>Gender</label>
            <input type="text" id="confirm-gender" readonly>
        </div>

        <div class="confirm-actions">
            <button id="confirm-btn" class="modal-button primary-btn">Confirm</button>
            <button id="confirm-edit-btn" class="modal-button secondary-btn">Edit</button>
        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="send-credentials-modal">
    <div class="send-cred-modal-container">
        <div class="modal-header">
            <h4>Send Credentials</h4>
            <span class="close-btn modal-close-send">&times;</span>
        </div>
        <div class="modal-body">
            <p><span id="account-type-text">Staff user</span> credentials will be sent through Email Address, confirm if
                the informations are correct before sending.</p>
            <div class="email-display-box">
                <span id="send-name-display"></span>
                <span id="send-email-display"></span>
            </div>
            <button id="send-final-btn" class="modal-button primary-btn full-width-btn">Send</button>
        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="password-verify-modal">
    <div class="confirm-modal-container">
        <h3 id="password-verify-title">Verify Your Password</h3>
        <p id="password-verify-desc">Please enter your password to confirm this action.</p>
        <div style="margin: 20px 0;">
            <input type="password" id="password-verify-input" placeholder="Enter your password" class="form-input"
                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            <p id="password-verify-error" style="color: #dc3545; margin-top: 10px; display: none;"></p>
        </div>
        <div class="confirm-actions">
            <button id="password-verify-confirm-btn" class="modal-button primary-btn">Verify Password</button>
            <button id="password-verify-cancel-btn" class="modal-button secondary-btn">Cancel</button>
        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="deactivate-confirm-modal">
    <div class="confirm-modal-container">
        <h3>Deactivate Account</h3>
        <div
            style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; padding: 10px; margin-bottom: 15px;">
            <p style="color: #155724; margin: 0;">✓ Password Verified</p>
        </div>
        <p id="deactivate-confirm-text">Are you sure you want to deactivate this account?</p>
        <div class="confirm-actions">
            <button id="deactivate-confirm-btn" class="modal-button primary-btn">Deactivate</button>
            <button id="deactivate-cancel-btn" class="modal-button secondary-btn">Cancel</button>
        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="reactivate-confirm-modal">
    <div class="confirm-modal-container">
        <h3>Reactivate Account</h3>
        <div
            style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; padding: 10px; margin-bottom: 15px;">
            <p style="color: #155724; margin: 0;">✓ Password Verified</p>
        </div>
        <p id="reactivate-confirm-text">Are you sure you want to reactivate this account?</p>
        <div class="confirm-actions">
            <button id="reactivate-confirm-btn" class="modal-button primary-btn">Reactivate</button>
            <button id="reactivate-cancel-btn" class="modal-button secondary-btn">Cancel</button>
        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="cancel-edit-modal">
    <div class="confirm-modal-container">
        <h3>Cancel Editing</h3>
        <p>Are you sure you want to cancel editing? Unsaved changes will be lost.</p>
        <div class="confirm-actions">
            <button id="cancel-edit-confirm-btn" class="modal-button primary-btn">Continue</button>
            <button id="cancel-edit-cancel-btn" class="modal-button secondary-btn">Go Back</button>
        </div>
    </div>
</div>

<div id="account-notifications" aria-live="polite" aria-atomic="true"
    style="position: fixed; bottom: 20px; right: 20px; z-index: 10000; max-width: 400px;"></div>

<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

<script>
    (function () {
        'use strict';

        console.log('Account Management Script Loaded');

        // Get user role from session
        const USER_ROLE = '{{ request.session.role }}';

        let allUsersData = [];
        let selectedRowData = {
            element: null,
            userId: null,
            profileId: null,
            type: null,
            name: null,
            roleText: null,
            coopText: null
        };
        let submittedData = {};
        let isEditMode = false;
        let currentAction = null;
        let tempPassword = '';
        let coopTomSelect = null;

        function getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]').value;
        }

        function hasAccessToAccountType(accountType) {
            if (USER_ROLE === 'admin') return true;
            if (USER_ROLE === 'staff') return accountType === 'officer';
            return false;
        }

        function capitalize(s) {
            if (typeof s !== 'string') return '';
            return s.charAt(0).toUpperCase() + s.slice(1);
        }

        // Notification Logic
        function showNotification(message, type = 'info') {
            const container = document.getElementById('account-notifications');
            if (!container) return;
            const notification = document.createElement('div');
            notification.className = `dj-message dj-${type}`;
            notification.innerHTML = `
            <div class="dj-message-left"><div class="dj-message-icon">!</div></div>
            <div class="dj-message-body"><div class="dj-message-text">${message}</div></div>
            <button class="dj-message-close">×</button>
        `;
            container.appendChild(notification);
            notification.querySelector('.dj-message-close').addEventListener('click', () => dismissNotification(notification));
            setTimeout(() => { if (document.body.contains(notification)) dismissNotification(notification); }, 5000);
        }

        function dismissNotification(el) {
            el.style.opacity = '0';
            setTimeout(() => { if (el.parentNode) el.parentNode.removeChild(el); }, 260);
        }

        function initialize() {
            console.log('Initializing...');

            const urlParams = new URLSearchParams(window.location.search);
            const filter = urlParams.get('filter');
            const tab = urlParams.get('tab');

            let defaultTab = 'staffs'; // Default for Admin

            if (USER_ROLE === 'staff') {
                defaultTab = 'officers'; // Default for Staff
            }

            let activeTab = tab || defaultTab;
            // --- FIX END ---

            if (!tab && filter) {
                if (filter === 'deactivated') activeTab = 'deactivated';
                else if (filter === 'all') activeTab = 'all-users';
            }

            // Activate the correct Tab Button
            document.querySelectorAll('.tab-btn').forEach(btn => {
                if (btn.dataset.target === activeTab) btn.classList.add('active');
                else btn.classList.remove('active');
            });

            // Show the correct Table Section
            document.querySelectorAll('.table-section').forEach(section => {
                if (section.id === activeTab) section.classList.add('active');
                else section.classList.remove('active');
            });

            // Add Section Visibility Logic
            document.querySelectorAll('.add-section').forEach(s => s.classList.add('hidden'));

            if (activeTab === 'staffs' && hasAccessToAccountType('staff')) {
                document.getElementById('staff-add-section')?.classList.remove('hidden');
            }
            else if (activeTab === 'officers' && hasAccessToAccountType('officer')) {
                document.getElementById('officer-add-section')?.classList.remove('hidden');
            }
            else if (activeTab === 'admins' && hasAccessToAccountType('admin')) {
                document.getElementById('admin-add-section')?.classList.remove('hidden');
            }
            else if (activeTab === 'deactivated' && USER_ROLE === 'admin') {
                document.getElementById('deactivated-add-section')?.classList.remove('hidden');
            }
            else if (activeTab === 'all-users' && USER_ROLE === 'admin') {
                document.getElementById('all-users-section')?.classList.remove('hidden');
            }

            // Search Input Logic
            const searchInput = document.getElementById('user-search');
            if (searchInput) {
                if (USER_ROLE === 'admin') {
                    searchInput.style.display = activeTab === 'all-users' ? 'block' : 'none';
                } else {
                    searchInput.style.display = 'none';
                }
            }

            const elements = {
                onboardStaffBtn: document.getElementById('onboard-staff-btn'),
                onboardAdminBtn: document.getElementById('onboard-admin-btn'),
                onboardOfficerBtn: document.getElementById('onboard-officer-btn'),
                onboardModal: document.getElementById('onboard-staff-modal'),
                onboardForm: document.getElementById('onboard-form'),
                confirmModal: document.getElementById('confirm-modal'),
                sendCredModal: document.getElementById('send-credentials-modal'),
                passwordVerifyModal: document.getElementById('password-verify-modal'),
                deactivateModal: document.getElementById('deactivate-confirm-modal'),
                reactivateModal: document.getElementById('reactivate-confirm-modal'),
                cancelEditModal: document.getElementById('cancel-edit-modal'),
                formFullName: document.getElementById('staff-full-name'),
                formGender: document.getElementById('staff-gender'),
                formPosition: document.getElementById('staff-position'),
                formEmail: document.getElementById('staff-email'),
                formContact: document.getElementById('staff-contact'),
                formEditUserId: document.getElementById('edit-user-id'),
                coopSelectEl: document.getElementById('coop-assigned'),
                coopGroup: document.getElementById('coop-group'),
                positionLabel: document.getElementById('position-label'),
                formButtonsAdd: document.getElementById('form-buttons-add'),
                formButtonsEdit: document.getElementById('form-buttons-edit'),
                confirmRoleLabel: document.getElementById('confirm-role-label'),
                confirmCoopGroup: document.getElementById('confirm-coop-group'),
                confirmCoopTextarea: document.getElementById('confirm-coop'),
                searchInput: document.getElementById('user-search')
            };

            if (USER_ROLE === 'admin') {
                collectInitialData();
                renderAllUsersTable(allUsersData);
            }

            setupEventListeners(elements);
        }

        function collectInitialData() {
            allUsersData = [];
            const staffTableBody = document.getElementById('staff-table-body');
            const officerTableBody = document.getElementById('officer-table-body');
            const adminTableBody = document.getElementById('admin-table-body');

            /* INDEX MAPPING GUIDE (Based on your screenshot errors):
               Staff Table usually: #, Name, Position, Email, Contact, Coop
            */

            const tables = [
                // STAFF MAPPING
                {
                    body: staffTableBody,
                    type: 'Staff',
                    // Indices: Name(1), Position(2), Email(3), Contact(4), Coop(5)
                    indices: [1, 2, 3, 4, 5],
                    nameIndex: 1,
                    positionIndex: 2, // Capture Position
                    emailIndex: 3,    // Capture Email
                    contactIndex: 4,  // Capture Contact
                    coopIndex: 5      // Capture Coop
                },
                // OFFICER MAPPING
                {
                    body: officerTableBody,
                    type: 'Officer',
                    // Indices: Name(1), Coop(2), Email(3), Contact(4), Position(5)
                    indices: [1, 2, 3, 4, 5],
                    nameIndex: 1,
                    positionIndex: 5, // Position is usually last for officers
                    emailIndex: 3,
                    contactIndex: 4,
                    coopIndex: 2      // Coop is usually 2nd for officers
                },
                // ADMIN MAPPING
                {
                    body: adminTableBody,
                    type: 'Admin',
                    // Indices: Name(1), Email(2), Contact(3), Position(4)
                    indices: [1, 2, 3, 4],
                    nameIndex: 1,
                    positionIndex: 4,
                    emailIndex: 2,
                    contactIndex: 3,
                    coopIndex: -1 // Admin has no coop column
                }
            ];

            tables.forEach(table => {
                if (table.body) {
                    table.body.querySelectorAll('tr').forEach(row => {
                        if (row.cells.length <= 1) return;
                        const cells = Array.from(row.cells).map(cell => cell.textContent.trim());

                        // DATA EXTRACTION
                        const nameText = cells[table.nameIndex] || '';
                        const positionText = cells[table.positionIndex] || '-';
                        const emailText = cells[table.emailIndex] || '';
                        const contactText = cells[table.contactIndex] || '';

                        // Handle Coop Text (with Admin fallback)
                        let coopText = '-';
                        if (table.coopIndex !== -1) {
                            coopText = cells[table.coopIndex];
                        } else {
                            coopText = 'System-Wide'; // Improved Admin UX
                        }

                        allUsersData.push({
                            user_id: row.dataset.userId,
                            profile_id: row.dataset.profileId,
                            name: nameText,
                            email: emailText,
                            contact: contactText,
                            role: positionText,
                            coop: coopText,
                            type: table.type
                        });
                    });
                }
            });

            // Update the counter
            const allUserCountSpan = document.getElementById('all-user-count');
            if (allUserCountSpan) allUserCountSpan.textContent = allUsersData.length;
        }

        function renderAllUsersTable(data) {
            const allUsersTableBody = document.getElementById('all-users-table-body');
            if (!allUsersTableBody) return;
            allUsersTableBody.innerHTML = '';
            if (data.length === 0) {
                allUsersTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No users found.</td></tr>';
                return;
            }
            data.forEach((user, index) => {
                const newRow = document.createElement('tr');
                newRow.dataset.userId = user.user_id;
                newRow.dataset.profileId = user.profile_id;
                newRow.dataset.type = user.type;
                newRow.innerHTML = `
                <td>${index + 1}</td>
                <td>${user.name}</td>
                <td>${user.email}</td>
                <td>${user.contact}</td>
                <td>${user.role}</td>
                <td>${user.coop}</td>
                <td>${user.type}</td>
            `;
                allUsersTableBody.appendChild(newRow);
            });
        }

        function setupEventListeners(el) {
            document.querySelectorAll(".tab-btn").forEach(btn => btn.addEventListener("click", () => handleTabClick(btn)));
            if (USER_ROLE === 'admin' && el.searchInput) el.searchInput.addEventListener('keyup', handleSearch);
            document.querySelectorAll('tbody').forEach(tbody => tbody.addEventListener('click', handleRowClick));

            if (el.onboardStaffBtn && hasAccessToAccountType('staff')) el.onboardStaffBtn.addEventListener('click', () => handleAddButtonClick(el.onboardStaffBtn, el));
            if (el.onboardAdminBtn && hasAccessToAccountType('admin')) el.onboardAdminBtn.addEventListener('click', () => handleAddButtonClick(el.onboardAdminBtn, el));
            if (el.onboardOfficerBtn && hasAccessToAccountType('officer')) el.onboardOfficerBtn.addEventListener('click', () => handleAddButtonClick(el.onboardOfficerBtn, el));

            el.onboardForm.addEventListener('submit', (e) => handleFormSubmit(e, el));
            document.getElementById('confirm-edit-btn').addEventListener('click', () => { closeModal(el.confirmModal); openModal(el.onboardModal); });
            document.getElementById('confirm-btn').addEventListener('click', () => handleConfirmButton(el));
            
            // Use { once: false } but check with guard flag to prevent double submission
            const sendFinalBtn = document.getElementById('send-final-btn');
            if (sendFinalBtn) {
                sendFinalBtn.addEventListener('click', function () { handleSendCredentials(this, el); });
            }

            document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', () => handleEditClick(el)));
            document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', () => handleDeleteClick(el)));
            document.querySelectorAll('.reactivate-btn').forEach(btn => btn.addEventListener('click', () => handleReactivateClick(el)));

            // Password Verify Listeners
            document.getElementById('password-verify-cancel-btn').addEventListener('click', () => {
                closeModal(el.passwordVerifyModal);
                document.getElementById('password-verify-input').value = '';
                document.getElementById('password-verify-error').style.display = 'none';
                tempPassword = ''; // Clear temp password on cancel
            });

            document.getElementById('password-verify-confirm-btn').addEventListener('click', () => {
                handlePasswordVerification(el);
            });

            document.getElementById('password-verify-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') { e.preventDefault(); handlePasswordVerification(el); }
            });

            // Final Confirmation Listeners
            document.getElementById('deactivate-cancel-btn').addEventListener('click', () => {
                closeModal(el.deactivateModal);
                tempPassword = ''; // Clear temp password
            });
            document.getElementById('deactivate-confirm-btn').addEventListener('click', () => handleDeactivateConfirm(el));

            document.getElementById('reactivate-cancel-btn').addEventListener('click', () => {
                closeModal(el.reactivateModal);
                tempPassword = ''; // Clear temp password
            });
            document.getElementById('reactivate-confirm-btn').addEventListener('click', () => handleReactivateConfirm(el));

            // Cancel Edit Listeners
            document.getElementById('edit-cancel-btn').addEventListener('click', () => openModal(el.cancelEditModal));
            document.getElementById('cancel-edit-cancel-btn').addEventListener('click', () => closeModal(el.cancelEditModal));
            document.getElementById('cancel-edit-confirm-btn').addEventListener('click', () => { closeModal(el.cancelEditModal); closeModal(el.onboardModal); });

            document.querySelectorAll('.modal-close, .modal-close-send').forEach(btn => {
                btn.addEventListener('click', () => { closeModal(el.onboardModal); closeModal(el.confirmModal); closeModal(el.sendCredModal); });
            });
        }

        function handleTabClick(btn) {
            const target = btn.dataset.target;
            let filterParam = target === 'deactivated' ? 'deactivated' : (target === 'all-users' ? 'all' : 'active');
            window.location.href = `?filter=${filterParam}&tab=${target}`;
        }

        function handleSearch(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            const filteredData = allUsersData.filter(user => {
                return user.name.toLowerCase().includes(searchTerm) ||
                    user.email.toLowerCase().includes(searchTerm) ||
                    user.contact.toLowerCase().includes(searchTerm) ||
                    user.role.toLowerCase().includes(searchTerm) ||
                    user.coop.toLowerCase().includes(searchTerm) ||
                    user.type.toLowerCase().includes(searchTerm);
            });
            renderAllUsersTable(filteredData);
        }

        function handleRowClick(e) {
            const row = e.target.closest('tr');
            if (!row || row.cells.length <= 1) return;

            const userId = row.dataset.userId;
            const profileId = row.dataset.profileId;
            const type = row.dataset.type;
            const name = row.cells[1].textContent;

            if (!hasAccessToAccountType(type.toLowerCase())) {
                showNotification('You do not have permission to manage this account type.', 'error');
                return;
            }

            let roleText = '';
            let coopText = '';
            const tableId = row.closest('.table-section').id;

            if (tableId === 'admins') {
                roleText = row.cells[4].textContent;
            } else if (tableId === 'staffs') {
                roleText = 'Staff';
                coopText = row.cells[4].textContent;
            } else if (tableId === 'officers') {
                roleText = row.cells[5].textContent;
                coopText = row.cells[2].textContent;
            } else if (tableId === 'deactivated' || tableId === 'all-users') {
                roleText = row.cells[4].textContent;
                coopText = row.cells[5].textContent;
            }

            const currentTableSection = row.closest('.table-section');
            const actionButtons = currentTableSection.querySelector('.action-buttons');

            if (selectedRowData.element === row) {
                row.classList.remove('selected');
                if (actionButtons) actionButtons.style.display = 'none';
                selectedRowData = { element: null, userId: null, profileId: null, type: null, name: null, roleText: null, coopText: null };
            } else {
                if (selectedRowData.element) {
                    selectedRowData.element.classList.remove('selected');
                    const prevTable = selectedRowData.element.closest('.table-section');
                    if (prevTable) prevTable.querySelector('.action-buttons').style.display = 'none';
                }
                row.classList.add('selected');
                if (actionButtons) actionButtons.style.display = 'flex';
                selectedRowData = { element: row, userId, profileId, type, name, roleText, coopText };
            }
        }

        function handleAddButtonClick(btn, el) {
            if (!hasAccessToAccountType(btn.getAttribute('data-account-type'))) { showNotification('Permission denied', 'error'); return; }
            isEditMode = false;
            setupFormForType(btn.getAttribute('data-account-type'), [], el);
            el.onboardForm.reset();

            if (coopTomSelect) {
                coopTomSelect.clear();
            }
            el.formEditUserId.value = '';
            document.getElementById('onboard-modal-title').textContent = `Onboard ${capitalize(btn.getAttribute('data-account-type'))} Account`;
            el.formButtonsAdd.style.display = 'block'; el.formButtonsEdit.style.display = 'none';
            openModal(el.onboardModal);
        }

        function setupFormForType(accountType, assignedCoops, el) {
            const isOfficer = accountType === 'officer';
            const isStaff = accountType === 'staff';

            const currentUserId = el.formEditUserId.value;

            el.onboardForm.setAttribute('data-account-type', accountType);

            // Handle Tom Select Initialization
            if (isStaff || isOfficer) {
                el.coopGroup.style.display = 'block';

                const options = el.coopSelectEl.querySelectorAll('option');
                options.forEach(opt => {
                    // Reset first: Enable everything
                    opt.disabled = false;

                    // Only apply strict filtering for STAFF (Officers can usually join any coop)
                    if (isStaff) {
                        const ownerId = opt.getAttribute('data-owner-id');

                        // If coop has an owner...
                        if (ownerId && ownerId !== 'None' && ownerId !== '') {
                            // If adding new user OR editing a user who is NOT the owner
                            // We disable the option (CSS will hide it)
                            if (ownerId != currentUserId) {
                                opt.disabled = true;
                            }
                        }
                    }
                });
                // Destroy existing instance to re-initialize
                if (coopTomSelect) {
                    coopTomSelect.destroy();
                    coopTomSelect = null;
                }

                // Initialize Tom Select
                coopTomSelect = new TomSelect('#coop-assigned', {
                    plugins: isStaff ? ['remove_button'] : [],
                    maxItems: isStaff ? null : 1, // Null = unlimited for staff, 1 for officer
                    placeholder: isStaff ? 'Select Cooperatives...' : 'Select One Cooperative',
                    persist: false,
                    create: false,
                    onInitialize: function () {
                        if (assignedCoops && assignedCoops.length > 0) {
                            this.setValue(assignedCoops);
                        }
                    }
                });

                el.coopSelectEl.required = true;
            } else {
                // Hide for admins
                el.coopGroup.style.display = 'none';
                if (coopTomSelect) {
                    coopTomSelect.destroy();
                    coopTomSelect = null;
                }
                el.coopSelectEl.required = false;
            }

            el.positionLabel.textContent = (isStaff || isOfficer) ? 'Position/Role' : 'Position';
        }

        function handleFormSubmit(e, el) {
            e.preventDefault();
            const accountType = el.onboardForm.getAttribute('data-account-type');
            if (!hasAccessToAccountType(accountType)) return;
            const isOfficer = accountType === 'officer'; const isStaff = accountType === 'staff';

            let coopId = null;
            let coopText = null;
            let coopIds = [];
            let coopTexts = [];

            // Get values from Tom Select or standard select
            if (isOfficer) {
                coopId = el.coopSelectEl.value;
                const selectedOpt = el.coopSelectEl.querySelector(`option[value="${coopId}"]`);
                coopText = selectedOpt ? selectedOpt.text : '';
            } else if (isStaff) {
                // Array.from works with Tom Select synced options
                coopIds = Array.from(el.coopSelectEl.selectedOptions).map(o => o.value);
                coopTexts = Array.from(el.coopSelectEl.selectedOptions).map(o => o.text);
            }
            submittedData = {
                type: accountType, name: el.formFullName.value, position: el.formPosition.value,
                email: el.formEmail.value, contact: el.formContact.value, gender: el.formGender.value,
                coop: isStaff ? coopIds : coopId, coop_text: isStaff ? coopTexts : coopText
            };

            if (isEditMode) saveChanges(el);
            else {
                document.getElementById('confirm-name').value = submittedData.name;
                document.getElementById('confirm-position').value = submittedData.position;
                document.getElementById('confirm-email').value = submittedData.email;
                document.getElementById('confirm-contact').value = submittedData.contact;
                el.confirmRoleLabel.textContent = (isStaff || isOfficer) ? 'Position/Role' : 'Position';
                if (isStaff || isOfficer) {
                    el.confirmCoopTextarea.value = isStaff ? submittedData.coop_text.join('\n') : submittedData.coop_text;
                    el.confirmCoopGroup.classList.remove('hidden');
                } else el.confirmCoopGroup.classList.add('hidden');
                closeModal(el.onboardModal); openModal(el.confirmModal);
            }
        }

        function handleConfirmButton(el) {
            document.getElementById('send-name-display').textContent = submittedData.name;
            document.getElementById('send-email-display').textContent = submittedData.email;
            document.getElementById('account-type-text').textContent = `${capitalize(submittedData.type)} user`;
            closeModal(el.confirmModal); openModal(el.sendCredModal);
        }

        let isSendingCredentials = false; // Guard flag to prevent double submission
        
        function handleSendCredentials(sendButton, el) {
            // Prevent double submission
            if (isSendingCredentials) {
                console.log('Send credentials already in progress, ignoring duplicate request');
                return;
            }
            
            isSendingCredentials = true;
            sendButton.disabled = true; sendButton.innerHTML = '<span class="spinner"></span> Sending...';
            fetch('/account_management/api/send-credentials/', {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
                body: JSON.stringify(submittedData)
            }).then(r => r.json()).then(data => {
                if (data.status === 'success') {
                    addNewRowToTable(data.user);
                    if (USER_ROLE === 'admin') {
                        allUsersData.push({
                            user_id: data.user.user_id, profile_id: data.user.profile_id,
                            name: data.user.name, email: data.user.email, contact: data.user.contact,
                            role: data.user.position || '-', coop: data.user.coop_name || '-', type: capitalize(data.user.role)
                        });
                        if (document.getElementById('all-user-count')) document.getElementById('all-user-count').textContent = allUsersData.length;
                    }
                    closeModal(el.sendCredModal); el.onboardForm.reset(); showNotification(`Created!`, 'success');
                } else showNotification(data.message, 'error');
            }).catch(e => showNotification(e.message, 'error')).finally(() => { 
                sendButton.disabled = false; 
                sendButton.innerHTML = "Send"; 
                isSendingCredentials = false; // Reset guard flag
            });
        }

        function handleEditClick(el) {
            if (!selectedRowData.userId) return;
            openEditModal(selectedRowData.userId, selectedRowData.type.toLowerCase(), el);
        }

        function generateConfirmationMessage(action, data) {
            const role = capitalize(data.type);
            const name = data.name;
            const coop = data.coopText;
            const actionText = action.toLowerCase();

            let message = `Are you sure you want to ${actionText} the ${role} account of ${name}`;
            if (role === 'Officer' && coop && coop !== '-' && coop !== '...') {
                message += ` from ${coop}`;
            }
            message += '?';
            return message;
        }

        function handleDeleteClick(el) {
            if (!selectedRowData.name) return;

            const accountType = selectedRowData.type.toLowerCase();
            if (!hasAccessToAccountType(accountType)) {
                showNotification('Permission denied.', 'error');
                return;
            }

            currentAction = 'deactivate';

            document.getElementById('password-verify-title').textContent = 'Verify Deactivation';
            document.getElementById('password-verify-desc').textContent = 'Please enter your password to confirm deactivation.';

            document.getElementById('password-verify-input').value = '';
            document.getElementById('password-verify-error').style.display = 'none';
            tempPassword = ''; // Reset temp password
            openModal(el.passwordVerifyModal);
        }

        function handleReactivateClick(el) {
            if (!selectedRowData.userId) {
                showNotification('Please select an account.', 'error');
                return;
            }

            currentAction = 'reactivate';

            document.getElementById('password-verify-title').textContent = 'Verify Reactivation';
            document.getElementById('password-verify-desc').textContent = 'Please enter your password to confirm reactivation.';

            document.getElementById('password-verify-input').value = '';
            document.getElementById('password-verify-error').style.display = 'none';
            tempPassword = ''; // Reset temp password
            openModal(el.passwordVerifyModal);
        }

        // *** UPDATED: Store password in temp variable upon success ***
        function handlePasswordVerification(el) {
            const passwordInput = document.getElementById('password-verify-input');
            const errorEl = document.getElementById('password-verify-error');
            const verifyBtn = document.getElementById('password-verify-confirm-btn');
            const password = passwordInput.value.trim();

            if (!password) { errorEl.textContent = 'Enter password.'; errorEl.style.display = 'block'; return; }

            verifyBtn.disabled = true; verifyBtn.textContent = 'Verifying...'; errorEl.style.display = 'none';

            fetch('/account_management/api/verify-password/', {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
                body: JSON.stringify({ password: password })
            }).then(r => r.json()).then(data => {
                if (data.valid) {
                    // Store password temporarily
                    tempPassword = password;

                    closeModal(el.passwordVerifyModal);
                    passwordInput.value = '';

                    const confirmMessage = generateConfirmationMessage(currentAction, selectedRowData);

                    if (currentAction === 'deactivate') {
                        document.getElementById('deactivate-confirm-text').textContent = confirmMessage;
                        openModal(el.deactivateModal);
                    } else if (currentAction === 'reactivate') {
                        document.getElementById('reactivate-confirm-text').textContent = confirmMessage;
                        openModal(el.reactivateModal);
                    }
                } else {
                    errorEl.textContent = data.message || 'Incorrect password.';
                    errorEl.style.display = 'block';
                    passwordInput.value = '';
                    passwordInput.focus();
                    tempPassword = '';
                }
            }).catch(e => { errorEl.textContent = 'Error occurred.'; errorEl.style.display = 'block'; })
                .finally(() => { verifyBtn.disabled = false; verifyBtn.textContent = 'Verify Password'; });
        }

        // *** UPDATED: Send tempPassword in body ***
        function handleDeactivateConfirm(el) {
            const userId = selectedRowData.userId;
            if (!userId) return;

            // Include password in request body
            fetch(`/account_management/api/deactivate-user/${userId}/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
                body: JSON.stringify({ password: tempPassword })
            }).then(r => r.json()).then(data => {
                if (data.status === 'success') {
                    removeRowFromTable(userId); showNotification('Account deactivated.', 'success');
                } else showNotification(data.message, 'error');
            }).catch(e => showNotification(e.message, 'error'))
                .finally(() => {
                    closeModal(el.deactivateModal);
                    tempPassword = ''; // Clear for security
                });
        }

        // *** UPDATED: Send tempPassword in body ***
        function handleReactivateConfirm(el) {
            const userId = selectedRowData.userId;
            if (!userId) return;

            // Include password in request body
            fetch(`/account_management/api/reactivate-user/${userId}/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
                body: JSON.stringify({ password: tempPassword })
            }).then(r => r.json()).then(data => {
                if (data.status === 'success') {
                    removeRowFromTable(userId);
                    showNotification('Reactivated! Reloading...', 'success');
                    setTimeout(() => window.location.reload(), 1500);
                } else showNotification(data.message, 'error');
            }).catch(e => showNotification(e.message, 'error'))
                .finally(() => {
                    closeModal(el.reactivateModal);
                    tempPassword = ''; // Clear for security
                });
        }

        function openEditModal(userId, type, el) {
            isEditMode = true;

            fetch(`/account_management/api/get-user-details/${userId}/`)
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'success') {
                        const details = data.details;

                        // 1. Get assigned Coops as an array (handles both Staff list and Officer single ID)
                        const assigned = details.assigned_coops || (details.coop_id ? [details.coop_id] : []);

                        // 2. Initialize the form elements and the Tom Select instance
                        setupFormForType(type, assigned, el);

                        // 3. Populate standard form fields
                        el.formFullName.value = details.fullname || '';
                        el.formGender.value = details.gender || '';
                        el.formPosition.value = details.position || '';
                        el.formEmail.value = details.email || '';
                        el.formContact.value = details.mobile_number || '';
                        el.formEditUserId.value = userId;

                        // 4. Update UI Text and Buttons
                        document.getElementById('onboard-modal-title').textContent = `Edit ${capitalize(type)} Account`;
                        el.formButtonsAdd.style.display = 'none';
                        el.formButtonsEdit.style.display = 'block';

                        // 5. Open the Modal
                        openModal(el.onboardModal);

                        // 6. CRITICAL: Explicitly set the Tom Select value to ensure pre-selected items appear
                        if (coopTomSelect) {
                            coopTomSelect.setValue(assigned);
                        }

                    } else {
                        showNotification(data.message, 'error');
                    }
                })
                .catch(e => {
                    console.error('Error fetching user details:', e);
                    showNotification(e.message, 'error');
                });
        }

        {% comment %} function saveChanges(el) {
            const userId = el.formEditUserId.value;
            fetch(`/account_management/api/update-user/${userId}/`, {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
                body: JSON.stringify(submittedData)
            }).then(r => r.json()).then(data => {
                if (data.status === 'success') {
                    updateRowInTable(userId, submittedData); showNotification('Updated.', 'success'); closeModal(el.onboardModal);
                } else showNotification(data.message, 'error');
            }).catch(e => showNotification(e.message, 'error'));
        } {% endcomment %}
        function saveChanges(el) {
            const userId = el.formEditUserId.value;

            // Show loading state on the button
            const submitBtn = el.onboardForm.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            fetch(`/account_management/api/update-user/${userId}/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
                body: JSON.stringify(submittedData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        updateRowInTable(userId, submittedData);
                        showNotification('Account details updated successfully.', 'success');
                        closeModal(el.onboardModal);
                    } else {
                        // --- ERROR HANDLING LOGIC ---
                        let friendlyMessage = data.message;

                        // Check for the specific database error text seen in the screenshot
                        if (friendlyMessage.includes('duplicate key value') ||
                            friendlyMessage.includes('users_username_key') ||
                            friendlyMessage.includes('already exists')) {

                            friendlyMessage = "This email address is already in use by another account. Please use a different email.";
                        }

                        showNotification(friendlyMessage, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('A network error occurred. Please try again.', 'error');
                })
                .finally(() => {
                    // Restore button state
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalBtnText;
                });
        }

        function addNewRowToTable(userData) {
            const type = userData.role;
            const newRow = document.createElement('tr');
            newRow.dataset.userId = userData.user_id; newRow.dataset.profileId = userData.profile_id; newRow.dataset.type = type;
            let targetTableBody = document.getElementById(`${type}-table-body`);
            let targetCountSpan = document.getElementById(`${type}-count`);

            let html = '';
            if (type === 'staff') html = `<td>...</td><td>${userData.name}</td><td>${userData.position}</td><td>${userData.email}</td><td>${userData.contact}</td><td>${userData.coop_name}</td>`;
            else if (type === 'admin') html = `<td>...</td><td>${userData.name}</td><td>${userData.email}</td><td>${userData.contact}</td><td>${userData.position}</td>`;
            else if (type === 'officer') html = `<td>...</td><td>${userData.name}</td><td>${userData.coop_name}</td><td>${userData.email}</td><td>${userData.contact}</td><td>${userData.position}</td>`;

            if (targetTableBody) {
                newRow.innerHTML = html;
                const empty = targetTableBody.querySelector('td[colspan]'); if (empty) empty.parentElement.remove();
                targetTableBody.appendChild(newRow);
                renumberTable(targetTableBody);
                if (targetCountSpan) targetCountSpan.textContent = parseInt(targetCountSpan.textContent) + 1;
            }
        }

        function updateRowInTable(userId, data) {
            const row = document.querySelector(`tr[data-user-id="${userId}"]`); if (!row) return;
            if (data.type === 'staff') { row.cells[1].textContent = data.name; row.cells[2].textContent = data.position; row.cells[3].textContent = data.email; row.cells[4].textContent = data.contact; row.cells[5].textContent = Array.isArray(data.coop_text) ? data.coop_text.join(', ') : data.coop_text; }
            else if (data.type === 'officer') { row.cells[1].textContent = data.name; row.cells[2].textContent = data.coop_text; row.cells[3].textContent = data.email; row.cells[4].textContent = data.contact; row.cells[5].textContent = data.position; }
            else if (data.type === 'admin') { row.cells[1].textContent = data.name; row.cells[2].textContent = data.email; row.cells[3].textContent = data.contact; row.cells[4].textContent = data.position; }

            if (USER_ROLE === 'admin') {
                const entry = allUsersData.find(u => u.user_id == userId);
                if (entry) { entry.name = data.name; entry.email = data.email; entry.contact = data.contact; entry.role = data.position || '-'; entry.coop = Array.isArray(data.coop_text) ? data.coop_text.join(', ') : (data.coop_text || '-'); }
                if (document.getElementById('all-users').classList.contains('active')) renderAllUsersTable(allUsersData);
            }
        }

        function removeRowFromTable(userId) {
            const row = document.querySelector(`tr[data-user-id="${userId}"]`);
            if (row) {
                const tbody = row.closest('tbody'); row.remove(); renumberTable(tbody);
                let countId = selectedRowData.type === 'Staff' ? 'staff-count' : (selectedRowData.type === 'Officer' ? 'officer-count' : 'admin-count');
                let span = document.getElementById(countId); if (span) span.textContent = parseInt(span.textContent) - 1;
            }
            if (USER_ROLE === 'admin') {
                allUsersData = allUsersData.filter(u => u.user_id != userId);
                if (document.getElementById('all-user-count')) document.getElementById('all-user-count').textContent = allUsersData.length;
                if (document.getElementById('all-users').classList.contains('active')) renderAllUsersTable(allUsersData);
            }
            document.querySelectorAll('.action-buttons').forEach(btn => btn.style.display = 'none');
            selectedRowData = { element: null, userId: null, profileId: null, type: null, name: null, roleText: null, coopText: null };
        }

        function renumberTable(tbody) {
            if (!tbody) return;
            tbody.querySelectorAll('tr').forEach((row, index) => { if (row.cells.length > 1) row.cells[0].textContent = index + 1; });
        }

        function openModal(modal) { modal.classList.remove('hidden'); }
        function closeModal(modal) { modal.classList.add('hidden'); }

        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initialize);
        else initialize();
    })();
</script>
{% endblock %}
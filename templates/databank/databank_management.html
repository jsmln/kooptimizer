{% extends 'dashboard/dashboard.html' %}
{% load static %}

{% block dashboard_title %}Data Bank Management{% endblock %}
{% block page_header %}Data Bank Management{% endblock %}

{% block extra_head %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'frontend/databank_management.css' %}">
<link rel="stylesheet" href="{% static 'frontend/profile_form.css' %}">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
    window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
</script>
<style>
    .action-buttons {
        display: none;
        gap: 10px;
        margin-top: 15px;
        justify-content: flex-end;
    }

    tbody tr.selected {
        background-color: #e3f2fd !important;
        border-left: 4px solid #860000;
    }

    tbody tr {
        cursor: pointer;
    }

    .edit-btn,
    .delete-btn,
    .approve-btn,
    .cancel-approve-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
    }

    .edit-btn {
        background: #860000;
        color: white;
    }

    .edit-btn:hover {
        background: #a00000;
    }

    .delete-btn {
        background: #dc3545;
        color: white;
    }

    .delete-btn:hover {
        background: #c82333;
    }

    .approve-btn {
        background: #28a745;
        color: white;
    }

    .approve-btn:hover {
        background: #218838;
    }

    .cancel-approve-btn {
        background: #ffc107;
        color: #212529;
    }

    .cancel-approve-btn:hover {
        background: #e0a800;
    }

    .tab-btn {
        background: #e0e0e0;
        border: none;
        border-radius: 8px;
        padding: 8px 16px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.3s ease, transform 0.2s;
        color: #333;
    }

    .tab-btn:hover {
        background: #ccc;
        transform: translateY(-1px);
    }

    .tab-btn.active {
        background: #860000;
        color: #fff;
        box-shadow: 0 3px 8px rgba(134, 0, 0, 0.3);
    }

    .table-section {
        display: none;
    }

    .table-section.active {
        display: block;
    }

    .reactivate-btn {
        background: #28a745;
        color: white;
        padding: 10px 18px;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .reactivate-btn:hover {
        background: #218838;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.15);
    }
</style>
{% endblock %}

{% block dashboard_content %}

<div class="databank-container">

    {% if error %}
    <div class="alert alert-danger" role="alert">
        <i class="bi bi-exclamation-triangle-fill"></i> <strong>System Error:</strong> {{ error }}
    </div>
    {% endif %}

    <!-- Tab Header -->
    <div class="databank-header-tabs">
        <div class="tab-buttons">
            <button class="tab-btn active" data-target="cooperatives-management">Cooperatives Management</button>
            <button class="tab-btn" data-target="submitted-profiles">Submitted Cooperative Profiles</button>
        </div>
    </div>

    <!-- Tab Content: Cooperatives Management (Default) -->
    <div class="table-section active" id="cooperatives-management">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 15px;">
            <h5 class="section-divider-title" style="margin: 0;">Cooperatives Management</h5>
            {% if user_role == 'admin' %}
            <button class="add-btn" id="addCoopBtn" style="display: {% if current_filter == 'deactivated' %}none{% else %}flex{% endif %} !important; align-items: center; gap: 6px; padding: 10px 20px; font-size: 0.95rem; white-space: nowrap; visibility: visible !important; opacity: 1 !important; z-index: 10; position: relative;">
                <i class="bi bi-plus-circle"></i> Add Cooperative
            </button>
            {% endif %}
        </div>


        {% if user_role == 'admin' %}
        <div class="databank-header" style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <div class="tab-buttons" style="display: flex; gap: 10px; margin-bottom: 0;">
                <button class="tab-btn {% if current_filter == 'active' %}active{% endif %}" data-target="active-coops" data-filter="active">
                    Active
                </button>
                <button class="tab-btn {% if current_filter == 'deactivated' %}active{% endif %}" data-target="deactivated-coops" data-filter="deactivated">
                    Deactivated
                </button>
            </div>
            <div class="table-controls" style="margin-left: 30px; flex: 1 1 250px; min-width: 220px;">
                <input type="text" id="searchCoopInput" class="search-input"placeholder="Search Cooperative Name, Category, District...">
            </div>
        </div>
        {% else %}
        <div class="databank-header" style="margin-bottom: 15px; display: flex; align-items: center; flex-wrap: wrap;">
            <div class="table-controls" style="flex: 1 1 250px; min-width: 200px;">
                <input type="text" id="searchCoopInput" class="search-input"
                    placeholder="Search Cooperative Name, Category, District...">
            </div>
        </div>
        {% endif %}

        <!-- Active Cooperatives Table -->
        <div class="table-section {% if current_filter != 'deactivated' %}active{% endif %}" id="active-coops" style="{% if current_filter == 'deactivated' %}display: none;{% endif %}">
            <div class="table-wrapper summary-wrapper">
                <table id="cooperatives-table">
                    <thead>
                        <tr>
                            <th class="sticky-col">Cooperative Name</th>
                            <th>Category</th>
                            <th>District</th>
                            {% if user_role == 'admin' %}
                            <th>Assigned Staff</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for coop in cooperatives %}
                        <tr data-coop-id="{{ coop.coop_id }}" data-coop-name="{{ coop.cooperative_name }}">
                            <td class="sticky-col"><strong>{{ coop.cooperative_name }}</strong></td>
                            <td>
                                {% if coop.category %}
                                <span class="badge-category">{{ coop.category }}</span>
                                {% else %}
                                <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>{{ coop.district|default:"N/A" }}</td>
                            {% if user_role == 'admin' %}
                            <td>
                                {% if coop.staff_name %}
                                {{ coop.staff_name }}
                                {% else %}
                                <span class="text-muted">Unassigned</span>
                                {% endif %}
                            </td>
                            {% endif %}
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="{% if user_role == 'admin' %}4{% else %}3{% endif %}" class="text-center py-4">No
                                active cooperatives found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="action-buttons" id="coop-action-buttons" style="display: none;">
                <button class="edit-btn"><i class="bi bi-pencil"></i> Edit</button>
                {% if user_role == 'admin' %}
                <button class="delete-btn"><i class="bi bi-trash"></i> Delete</button>
                {% endif %}
            </div>
            <div class="table-footer">
                <div>Showing <strong>{{ cooperatives|length }}</strong> of <strong>{{ total_count }}</strong> active cooperatives
                </div>
            </div>
        </div>

        <!-- Deactivated Cooperatives Table (Admin Only) -->
        {% if user_role == 'admin' %}
        <div class="table-section {% if current_filter == 'deactivated' %}active{% endif %}" id="deactivated-coops" style="{% if current_filter != 'deactivated' %}display: none;{% endif %}">
            <div class="table-wrapper summary-wrapper">
                <table id="deactivated-cooperatives-table">
                    <thead>
                        <tr>
                            <th class="sticky-col">Cooperative Name</th>
                            <th>Category</th>
                            <th>District</th>
                            <th>Assigned Staff</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for coop in deactivated_cooperatives %}
                        <tr data-coop-id="{{ coop.coop_id }}" data-coop-name="{{ coop.cooperative_name }}">
                            <td class="sticky-col"><strong>{{ coop.cooperative_name }}</strong></td>
                            <td>
                                {% if coop.category %}
                                <span class="badge-category">{{ coop.category }}</span>
                                {% else %}
                                <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>{{ coop.district|default:"N/A" }}</td>
                            <td>
                                {% if coop.staff_name %}
                                {{ coop.staff_name }}
                                {% else %}
                                <span class="text-muted">Unassigned</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center py-4">No deactivated cooperatives found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="action-buttons" id="deactivated-coop-action-buttons" style="display: none;">
                <button class="reactivate-btn"><i class="bi bi-arrow-counterclockwise"></i> Reactivate</button>
            </div>
            <div class="table-footer">
                <div>Showing <strong>{{ deactivated_cooperatives|length }}</strong> of <strong>{{ deactivated_count }}</strong> deactivated cooperatives
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Tab Content: Submitted Cooperative Profiles -->
    <div class="table-section" id="submitted-profiles">
        <h5 class="section-divider-title">Submitted Cooperative Profiles</h5>

        <div class="table-controls" style="margin-bottom: 15px;">
            <input type="text" id="searchProfileInput" class="search-input" placeholder="Search Profile Data...">
        </div>

        <div class="table-wrapper detailed-wrapper">
            <table id="profiles-table">
                <thead>
                    <tr>
                        <th class="sticky-col">Cooperative Name</th>
                        <th>Report Year</th>
                        <th>Address</th>
                        <th>Mobile Number</th>
                        <th>Email</th>
                        <th>CDA Registration Number</th>
                        <th>CDA Registration Date</th>
                        <th>LCCDC Membership</th>
                        <th>LCCDC Membership Date</th>
                        <th>Operation Area</th>
                        <th>Business Activity</th>
                        <th>Board of Directors</th>
                        <th>Salaried Employees</th>
                        <th>Approval Status</th>
                        <th>Submitted Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for profile in profiles %}
                    <tr data-profile-id="{{ profile.profile_id }}" data-coop-id="{{ profile.coop_id }}"
                        data-approval-status="{{ profile.approval_status }}">
                        <td class="sticky-col"><strong>{{ profile.cooperative_name }}</strong></td>
                        <td class="text-center">{{ profile.report_year|default:"-" }}</td>
                        <td class="address-cell" title="{{ profile.address }}">{{ profile.address|default:"N/A" }}</td>
                        <td>{{ profile.mobile_number|default:"N/A" }}</td>
                        <td>{{ profile.email_address|default:"N/A" }}</td>
                        <td>{{ profile.cda_registration_number|default:"N/A" }}</td>
                        <td>{{ profile.cda_registration_date|date:"M d, Y"|default:"-" }}</td>
                        <td class="text-center">
                            {% if profile.lccdc_membership %}
                            <i class="bi bi-check-circle-fill text-success"></i>
                            {% else %}
                            <i class="bi bi-x-circle-fill text-danger"></i>
                            {% endif %}
                        </td>
                        <td>{{ profile.lccdc_membership_date|date:"M d, Y"|default:"-" }}</td>
                        <td>{{ profile.operation_area|default:"-" }}</td>
                        <td>{{ profile.business_activity|default:"-" }}</td>
                        <td class="text-center">{{ profile.board_of_directors_count|default:0 }}</td>
                        <td class="text-center">{{ profile.salaried_employees_count|default:0 }}</td>
                        <td>
                            {% if profile.approval_status == 'approved' %}
                            <span class="badge bg-success">Approved</span>
                            {% elif profile.approval_status == 'pending' %}
                            <span class="badge bg-warning text-dark">Pending</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ profile.approval_status|default:"N/A" }}</span>
                            {% endif %}
                        </td>
                        <td>{{ profile.created_at|date:"M d, Y"|default:"-" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="15" class="text-center py-4">No profile data submitted yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="action-buttons" id="profile-action-buttons">
            <button class="approve-btn"><i class="bi bi-check-circle"></i> Approve</button>
            <button class="cancel-approve-btn"><i class="bi bi-x-circle"></i> Cancel Approval</button>
        </div>
        <div class="table-footer">
            <div>Showing <strong>{{ profiles|length }}</strong> profile submissions</div>
        </div>
    </div>
</div>

<!-- Cooperative Add/Edit Modal -->
<div id="coop-modal" class="modal-overlay hidden">
    <div class="onboard-form-container">
        <div class="form-scroll-wrapper">
            <span class="close-btn modal-close">&times;</span>
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                <h3 class="modal-title" id="coop-modal-title" style="margin: 0;">Add Cooperative</h3>
                <button type="button" class="ocr-icon-btn" id="ocrBtnAddCoop" title="Open OCR Assistant">
                    <i class="bi bi-upc-scan"></i>
                </button>
            </div>
            <p class="input-instruction">Please input information</p>

            <form id="coop-form" class="onboard-form">
                {% csrf_token %}
                <input type="hidden" id="coop-id" name="coop_id">

                <div class="form-group">
                    <label for="coop-name">Cooperative Name <span class="text-danger">*</span></label>
                    <input type="text" id="coop-name" name="cooperative_name" placeholder="Enter cooperative name" required>
                </div>

                <div class="form-group">
                    <label for="coop-category">Category</label>
                    <input type="text" id="coop-category" name="category" placeholder="Enter category">
                </div>

                <div class="form-group">
                    <label for="coop-district">District</label>
                    <input type="text" id="coop-district" name="district" placeholder="Enter district">
                </div>

                {% if user_role == 'admin' %}
                <div class="form-group">
                    <label for="coop-staff">Assigned Staff</label>
                    <select id="coop-staff" name="staff_id">
                        <option value="" disabled selected>Choose Staff</option>
                        <option value="">-- Unassigned --</option>
                        {% for staff in staff_list %}
                        <option value="{{ staff.staff_id }}">{% if staff.fullname %}{{ staff.fullname }}{% else %}Staff #{{ staff.staff_id }}{% endif %}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}

                <div id="form-buttons-add">
                    <button type="submit" class="submit-btn">Create Cooperative</button>
                </div>
                <div id="form-buttons-edit" style="display: none;">
                    <button type="submit" class="submit-btn">Save Changes</button>
                    <button type="button" id="edit-cancel-btn" class="cancel-btn">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Password Verification Modal -->
<div class="modal-overlay hidden" id="password-verify-modal">
    <div class="confirm-modal-container">
        <h3 id="password-verify-title">Verify Your Password</h3>
        <p id="password-verify-desc">Please enter your password to confirm this action.</p>
        <div style="margin: 20px 0;">
            <input 
                type="password" 
                id="password-verify-input" 
                placeholder="Enter your password" 
                class="form-input"
                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
            >
            <p id="password-verify-error" style="color: #dc3545; margin-top: 10px; display: none;"></p>
        </div>
        <div class="confirm-actions">
            <button id="password-verify-confirm-btn" class="modal-button primary-btn">Verify Password</button>
            <button id="password-verify-cancel-btn" class="modal-button secondary-btn">Cancel</button>
        </div>
    </div>
</div>

<!-- Deactivate Confirmation Modal -->
<div class="modal-overlay hidden" id="deactivate-confirm-modal">
    <div class="confirm-modal-container">
        <h3>Deactivate Cooperative</h3>
        <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; padding: 10px; margin-bottom: 15px;">
            <p style="color: #155724; margin: 0;">✓ Password Verified</p>
        </div>
        <p id="deactivate-confirm-text">Are you sure you want to deactivate this cooperative?</p>
        <div class="confirm-actions">
            <button id="deactivate-confirm-btn" class="modal-button primary-btn">Deactivate</button>
            <button id="deactivate-cancel-btn" class="modal-button secondary-btn">Cancel</button>
        </div>
    </div>
</div>

<!-- Reactivate Confirmation Modal -->
<div class="modal-overlay hidden" id="reactivate-confirm-modal">
    <div class="confirm-modal-container">
        <h3>Reactivate Cooperative</h3>
        <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; padding: 10px; margin-bottom: 15px;">
            <p style="color: #155724; margin: 0;">✓ Password Verified</p>
        </div>
        <p id="reactivate-confirm-text">Are you sure you want to reactivate this cooperative?</p>
        <div class="confirm-actions">
            <button id="reactivate-confirm-btn" class="modal-button primary-btn">Reactivate</button>
            <button id="reactivate-cancel-btn" class="modal-button secondary-btn">Cancel</button>
        </div>
    </div>
</div>

<!-- Generic Confirmation Modal (Bootstrap style like logout modal) -->
<div class="modal fade" id="genericConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="genericConfirmTitle">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="genericConfirmBody">
                Are you sure you want to proceed?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal" id="genericConfirmCancel">Cancel</button>
                <button type="button" class="btn btn-primary" id="genericConfirmOk">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- Profile View Modal -->
<div id="profile-modal" class="modal-overlay hidden">
    <div class="modal-content" style="max-width: 95%; max-height: 95vh; display: flex; flex-direction: column;">
        <div class="modal-top-bar" style="flex-shrink: 0;">
            <h3>Cooperative Profile</h3>
            <button class="modal-close-btn" id="profile-modal-close">&times;</button>
        </div>
        <div class="modal-scroll-area" style="flex: 1; overflow-y: auto; overflow-x: hidden;">
            <div class="modal-body" id="profile-modal-body" style="padding: 20px;">
                <div class="text-center" style="padding: 40px;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading profile details...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- OCR Assistant Drawer -->
<div class="ocr-drawer-wrapper">
    <div class="ocr-drawer" id="ocrDrawer">
        <div class="ocr-drawer-header">
            <h3><i class="bi bi-upc-scan me-2"></i>OCR Assistant</h3>
            <button class="ocr-drawer-close" id="ocrDrawerClose">&times;</button>
        </div>
        
        <div class="ocr-drawer-body">
            <div id="camera-container" style="display: none; margin-bottom: 20px; text-align: center;">
                <video id="camera-video" autoplay playsinline style="width: 100%; border-radius: 12px; border: 2px solid #a91e2c; background: black;"></video>
                <div style="margin-top: 10px; display: flex; gap: 10px; justify-content: center;">
                    <button id="capture-btn" class="btn-apply" style="padding: 8px 20px;">Capture</button>
                    <button id="cancel-camera-btn" class="btn-clear" style="padding: 8px 20px;">Cancel</button>
                </div>
            </div>


            <div id="upload-container">
                <p class="text-muted small mb-3" style="border-left: 3px solid #a91e2c; padding-left: 10px; background: #fff5f6; padding: 8px; border-radius: 4px;">
                    Scan documents using your phone camera or upload an image to auto-fill forms.
                </p>

                <div class="ocr-upload-area" id="ocrUploadArea">
                    <i class="bi bi-cloud-upload"></i>
                    <h5>Drag & Drop Image</h5>
                    <p class="text-muted small mb-0">or click to browse</p>
                    <input type="file" id="ocrFileInput" accept="image/*" style="display: none;">
                    <input type="file" id="mobileCameraInput" accept="image/*" capture="environment" style="display: none;">
                </div>
                
                <div class="ocr-btn-group">
                    <button class="ocr-action-btn" id="ocrUploadBtn">
                        <i class="bi bi-upload"></i> <span>Upload Image</span>
                    </button>
                    <button class="ocr-action-btn" id="ocrCameraBtn">
                        <i class="bi bi-camera-fill"></i> <span>Scan / Camera</span>
                    </button>
                    <button class="ocr-action-btn" id="ocrPasteBtn">
                        <i class="bi bi-clipboard"></i> <span>Paste</span>
                    </button>
                    <button class="ocr-action-btn" id="ocrScreenshotBtn">
                        <i class="bi bi-display"></i> <span>Screenshot</span>
                    </button>
                </div>
            </div>

            <!-- Saved OCR Sessions - Moved below buttons -->
            <div id="ocr-saved-sessions" style="margin-top: 20px; margin-bottom: 20px;">
                <h6 style="font-size: 14px; font-weight: 600; color: #2B3674; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                    <i class="bi bi-clock-history"></i> Recent Scans
                </h6>
                <div id="ocr-sessions-list" style="max-height: 200px; overflow-y: auto;">
                    <p class="text-muted small" style="text-align: center; padding: 20px;">Loading recent scans...</p>
                </div>
            </div>
            
            <div class="ocr-loading" id="ocrLoading" style="display: none;">
                <div class="spinner-border" role="status"></div>
                <p class="mt-2 text-muted">Scanning text...</p>
                <!-- Progress Bar -->
                <div class="progress" style="margin-top: 16px; height: 8px; border-radius: 4px; background: #e0e0e0;">
                    <div id="ocr-progress-bar" class="progress-bar" role="progressbar" style="width: 0%; background: linear-gradient(135deg, #a91e2c 0%, #8a1824 100%); transition: width 0.3s ease;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <p id="ocr-progress-text" class="mt-2 text-muted small" style="font-weight: 600;">0%</p>
            </div>
            
            <div class="ocr-result-area" id="ocrResultArea" style="display: none;">
                <!-- Image Preview - Moved above extracted text -->
                <div id="ocr-image-preview" style="display: none; margin-bottom: 16px; text-align: center; padding: 12px; background: #f8f9fc; border-radius: 8px; border: 1px solid #edf2f7;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                        <label class="form-label fw-bold" style="margin: 0; font-size: 13px; color: #2B3674;">
                            <span id="ocr-scan-number" style="background: #a91e2c; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-right: 8px;">#1</span>
                            Scanned Image
                        </label>
                        <button type="button" id="ocr-remove-preview" class="btn-clear" style="padding: 4px 8px; font-size: 11px;">
                            <i class="bi bi-x-circle"></i> Remove
                        </button>
                    </div>
                    <img id="ocr-preview-img" src="" alt="Preview" style="max-width: 100%; max-height: 250px; border-radius: 8px; border: 2px solid #a91e2c; object-fit: contain; background: white;">
                </div>
                
                <label class="form-label fw-bold">Extracted Data:</label>
                <textarea class="ocr-result-text" id="ocrResultText"></textarea>
                <div class="ocr-result-actions">
                    <button class="btn-copy" id="ocrCopyBtn" title="Copy to clipboard">
                        <i class="bi bi-clipboard"></i> Copy
                    </button>
                    <button class="btn-clear" id="ocrClearBtn">Clear</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileLabel" aria-hidden="true" style="z-index: 10050;">
    <div class="modal-backdrop fade show" style="z-index: 10040; background-color: rgba(0, 0, 0, 0.7);"></div>
    <div class="modal-dialog modal-xl modal-dialog-scrollable" style="z-index: 10050;">
        <div class="modal-content" style="border-radius: 8px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);">
            <div class="modal-header" style="background: #860000; color: white; border-bottom: 2px solid #6B0000; padding: 1rem 1.5rem;">
                <h5 class="modal-title" id="editProfileLabel" style="font-size: 1.25rem; font-weight: 600; color: white; margin: 0;">
                    <i class="bi bi-pencil-square"></i> Edit Cooperative Profile
                    <span id="edit-profile-year" style="font-size: 0.9rem; font-weight: normal; margin-left: 10px; opacity: 0.9;"></span>
                </h5>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <button type="button" class="ocr-icon-btn-white" id="ocrBtnEditProfile" title="Open OCR Assistant" style="width: 38px; height: 38px; border-radius: 50%; background: rgba(255, 255, 255, 0.2); color: white; border: 1px solid rgba(255, 255, 255, 0.3); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease;">
                        <i class="bi bi-upc-scan" style="font-size: 18px;"></i>
                    </button>
                    <button type="button" class="btn btn-sm" id="undo-btn" title="Undo" disabled 
                            style="background: rgba(255, 255, 255, 0.2); color: white; border: 1px solid rgba(255, 255, 255, 0.3);">
                        <i class="bi bi-arrow-counterclockwise"></i> Undo
                    </button>
                    <button type="button" class="btn btn-sm" id="redo-btn" title="Redo" disabled
                            style="background: rgba(255, 255, 255, 0.2); color: white; border: 1px solid rgba(255, 255, 255, 0.3);">
                        <i class="bi bi-arrow-clockwise"></i> Redo
                    </button>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
            </div>
            <div class="modal-body" style="padding: 1.5rem; background: #F8F9FA; max-height: calc(100vh - 200px); overflow-y: auto;">
                <div class="profile-form-container" id="edit-profile-form-container" style="background: white; padding: 1.5rem; border-radius: 6px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
                    <div class="text-center" style="padding: 40px;">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-3">Loading form...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Edit Modal Overrides */
    #editProfileModal {
        z-index: 10050 !important;
    }
    
    #editProfileModal .modal-backdrop {
        z-index: 10040 !important;
    }
    
    /* Form Styling Improvements */
    #edit-profile-form-container .form-section {
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: white;
        border-radius: 6px;
        border: 1px solid #E0E0E0;
    }
    
    #edit-profile-form-container .section-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #860000;
    }
    
    #edit-profile-form-container .section-header i {
        font-size: 1.25rem;
        color: #860000;
    }
    
    #edit-profile-form-container .section-header h5 {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2B3674;
        margin: 0;
    }
    
    #edit-profile-form-container .form-group {
        margin-bottom: 1.25rem;
    }
    
    #edit-profile-form-container .form-group label {
        font-size: 0.95rem;
        font-weight: 600;
        color: #2B3674;
        margin-bottom: 0.5rem;
        display: block;
    }
    
    #edit-profile-form-container .form-group label.required::after {
        content: " *";
        color: #dc3545;
    }
    
    #edit-profile-form-container .form-group input[type="text"],
    #edit-profile-form-container .form-group input[type="email"],
    #edit-profile-form-container .form-group input[type="tel"],
    #edit-profile-form-container .form-group input[type="date"],
    #edit-profile-form-container .form-group input[type="number"],
    #edit-profile-form-container .form-group select,
    #edit-profile-form-container .form-group textarea {
        width: 100%;
        padding: 0.75rem;
        font-size: 0.95rem;
        color: #2B3674;
        background: white;
        border: 1.5px solid #E0E0E0;
        border-radius: 6px;
        transition: all 0.2s;
    }
    
    #edit-profile-form-container .form-group input:focus,
    #edit-profile-form-container .form-group select:focus,
    #edit-profile-form-container .form-group textarea:focus {
        outline: none;
        border-color: #860000;
        box-shadow: 0 0 0 3px rgba(134, 0, 0, 0.1);
    }
    
    #edit-profile-form-container .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.25rem;
        margin-bottom: 1.25rem;
    }
    
    #edit-profile-form-container .form-check-group {
        display: flex;
        gap: 1.5rem;
        flex-wrap: wrap;
    }
    
    #edit-profile-form-container .radio-container {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.95rem;
        color: #2B3674;
        cursor: pointer;
    }
    
    #edit-profile-form-container .input-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }
    
    #edit-profile-form-container .input-table th {
        background: #860000;
        color: white;
        padding: 0.75rem;
        text-align: left;
        font-size: 0.9rem;
        font-weight: 600;
    }
    
    #edit-profile-form-container .input-table td {
        padding: 0.75rem;
        border-bottom: 1px solid #E0E0E0;
    }
    
    #edit-profile-form-container .input-table td input,
    #edit-profile-form-container .input-table td select {
        width: 100%;
        padding: 0.5rem;
        font-size: 0.9rem;
        border: 1px solid #E0E0E0;
        border-radius: 4px;
    }
    
    #edit-profile-form-container .add-row-btn {
        margin-top: 1rem;
        padding: 0.75rem 1.5rem;
        background: #860000;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    #edit-profile-form-container .add-row-btn:hover {
        background: #6B0000;
    }
    
    #edit-profile-form-container .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 2px solid #E0E0E0;
    }
    
    #edit-profile-form-container .submit-btn {
        padding: 0.75rem 2rem;
        background: #860000;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    #edit-profile-form-container .submit-btn:hover {
        background: #6B0000;
    }
    
    #edit-profile-form-container .input-instruction {
        font-size: 0.9rem;
        color: #6B6B6B;
        margin-bottom: 1rem;
        font-style: italic;
    }
    
    /* File upload styling */
    #edit-profile-form-container .file-upload-area-single,
    #edit-profile-form-container .file-upload-area {
        border: 2px dashed #E0E0E0;
        border-radius: 6px;
        padding: 2rem;
        text-align: center;
        background: #F8F9FA;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    #edit-profile-form-container .file-upload-area-single:hover,
    #edit-profile-form-container .file-upload-area:hover {
        border-color: #860000;
        background: #FFF0F0;
    }
    
    #edit-profile-form-container .upload-text-single,
    #edit-profile-form-container .upload-text {
        font-size: 0.95rem;
        font-weight: 600;
        color: #2B3674;
        margin: 0.5rem 0;
    }
    
    #edit-profile-form-container .upload-hint-single,
    #edit-profile-form-container .upload-hint {
        font-size: 0.85rem;
        color: #6B6B6B;
        margin: 0;
    }
</style>

<!-- File Preview Modal -->
<div id="preview-modal" class="preview-overlay" style="display: none; z-index: 10000;">
    <div class="preview-content">
        <div class="preview-header">
            <div style="display:flex; align-items:center; gap:10px; flex:1;">
                <button id="toggleSidebar" title="Toggle thumbnails" style="border:none; display:inline-flex;"><i
                        class="bi bi-layout-sidebar" style="font-size:1.25rem;"></i></button>
                <div class="preview-title" id="preview-title">Preview</div>
            </div>
            <div class="preview-controls">
                <button id="rotateLeft" title="Rotate left" style="display:inline-flex;"><i
                        class="bi bi-arrow-counterclockwise"></i></button>
                <button id="rotateRight" title="Rotate right" style="display:inline-flex;"><i
                        class="bi bi-arrow-clockwise"></i></button>
                <button id="fitWidth" title="Fit to width" style="display:inline-flex;"><i
                        class="bi bi-arrows-expand"></i></button>
                <button id="fitHeight" title="Fit to height" style="display:inline-flex;"><i
                        class="bi bi-arrows-expand-vertical"></i></button>
                <button id="zoomOut" style="display:inline-flex;">−</button>
                <span class="preview-zoom-level" id="zoomLevel" style="display:inline-block;">100%</span>
                <button id="zoomIn" style="display:inline-flex;">+</button>
                <div id="page-controls" style="display:none; gap:8px; align-items:center;">
                    <button id="prevPage" style="background:#666;">‹</button>
                    <input type="number" id="pageInput" min="1"
                        style="width:50px; padding:4px 6px; border:1px solid #ccc; border-radius:4px; text-align:center; font-size:0.85rem;" />
                    <span class="preview-zoom-level" style="min-width:auto;">of <span id="totalPages">1</span></span>
                    <button id="nextPage" style="background:#666;">›</button>
                </div>
                <a id="preview-download-main" class="btn-download-main" href="#" download>Download</a>
                <button id="preview-close" style="background:#666;">✕</button>
            </div>
        </div>
        <div class="preview-main-container">
            <button id="prev-file-btn" class="file-nav-btn file-nav-prev" style="display:none;" title="Previous file">
                <i class="bi bi-chevron-left"></i>
            </button>
            <button id="next-file-btn" class="file-nav-btn file-nav-next" style="display:none;" title="Next file">
                <i class="bi bi-chevron-right"></i>
            </button>
            <div id="preview-sidebar" class="preview-sidebar" style="display:none;">
                <div id="preview-thumbnails"></div>
            </div>
            <div id="preview-body" class="preview-body"></div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Fix MutationObserver error - ensure elements exist before observing
    if (typeof MutationObserver !== 'undefined' && MutationObserver.prototype) {
        const originalObserve = MutationObserver.prototype.observe;
        if (originalObserve && !MutationObserver.prototype._observePatched) {
            MutationObserver.prototype.observe = function(target, options) {
                if (!target) {
                    console.warn('MutationObserver.observe called with null/undefined target');
                    return;
                }
                if (typeof target.nodeType === 'undefined' || target.nodeType !== Node.ELEMENT_NODE) {
                    console.warn('MutationObserver.observe called with invalid target type:', target);
                    return;
                }
                try {
                    return originalObserve.call(this, target, options);
                } catch (e) {
                    console.warn('MutationObserver.observe error:', e);
                    return;
                }
            };
            MutationObserver.prototype._observePatched = true;
        }
    }
    
    const USER_ROLE = '{{ user_role }}';
    let selectedCoopRow = null;
    let selectedDeactivatedCoopRow = null;
    let selectedProfileRow = null;
    let currentAction = null; // 'deactivate' or 'reactivate'
    let tempPassword = ''; // Store password temporarily after verification
    
    // Modal elements
    const el = {
        passwordVerifyModal: document.getElementById('password-verify-modal'),
        deactivateModal: document.getElementById('deactivate-confirm-modal'),
        reactivateModal: document.getElementById('reactivate-confirm-modal'),
    };
    
    function getCsrfToken() {
        const token = document.querySelector('[name=csrfmiddlewaretoken]');
        return token ? token.value : '';
    }

    // ===== DJANGO MESSAGE NOTIFICATION =====
    function showNotification(message, type = 'info') {
        const container = document.getElementById('django-messages');
        if (!container) {
            console.warn('Django messages container not found');
            return;
        }

        // Map type to dj-message tag
        const tagMap = {
            'success': 'success',
            'error': 'error',
            'warning': 'warning',
            'info': 'info'
        };
        const tag = tagMap[type] || 'info';

        // Create message element
        const messageEl = document.createElement('div');
        messageEl.className = `dj-message dj-${tag}`;
        messageEl.setAttribute('role', 'status');
        messageEl.innerHTML = `
            <div class="dj-message-left">
                <div class="dj-message-icon" aria-hidden="true">!</div>
            </div>
            <div class="dj-message-body">
                <div class="dj-message-text">${message}</div>
            </div>
            <button class="dj-message-close" aria-label="Close message">×</button>
        `;

        // Add dismiss functionality
        const closeBtn = messageEl.querySelector('.dj-message-close');
        function dismiss() {
            messageEl.style.transition = 'opacity 240ms ease, transform 240ms ease';
            messageEl.style.opacity = '0';
            messageEl.style.transform = 'translateX(18px)';
            setTimeout(() => {
                if (messageEl.parentNode) {
                    messageEl.parentNode.removeChild(messageEl);
                }
            }, 260);
        }

        if (closeBtn) {
            closeBtn.addEventListener('click', dismiss);
        }

        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            if (document.body.contains(messageEl)) {
                dismiss();
            }
        }, 5000);

        // Append to container
        container.appendChild(messageEl);
    }

    // ===== MODAL FUNCTIONS =====
    function openModal(modal) {
        if (!modal) return;
        modal.classList.remove('hidden');
    }

    function closeModal(modal) {
        if (!modal) return;
        modal.classList.add('hidden');
    }

    // ===== GENERIC CONFIRMATION MODAL (Bootstrap style like logout) =====
    let currentConfirmCallback = null;
    
    function showConfirmModal(title, message, onConfirm) {
        const modal = document.getElementById('genericConfirmModal');
        const modalTitle = document.getElementById('genericConfirmTitle');
        const modalBody = document.getElementById('genericConfirmBody');
        const confirmBtn = document.getElementById('genericConfirmOk');
        const cancelBtn = document.getElementById('genericConfirmCancel');
        
        if (!modal || !modalTitle || !modalBody || !confirmBtn || !cancelBtn) {
            // Fallback to native confirm if modal elements not found
            if (confirm(message)) {
                onConfirm();
            }
            return;
        }

        // Set modal content
        modalTitle.textContent = title;
        modalBody.textContent = message;

        // Store the callback
        currentConfirmCallback = onConfirm;

        // Show modal using Bootstrap
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
    }

    // Set up event listeners once for the confirmation modal buttons
    document.getElementById('genericConfirmOk')?.addEventListener('click', function() {
        const modal = document.getElementById('genericConfirmModal');
        const bsModal = bootstrap.Modal.getInstance(modal);
        if (bsModal) {
            bsModal.hide();
        }
        if (currentConfirmCallback) {
            currentConfirmCallback();
            currentConfirmCallback = null;
        }
    });

    document.getElementById('genericConfirmCancel')?.addEventListener('click', function() {
        const modal = document.getElementById('genericConfirmModal');
        const bsModal = bootstrap.Modal.getInstance(modal);
        if (bsModal) {
            bsModal.hide();
        }
        currentConfirmCallback = null;
    });

    // ===== MAIN TAB SWITCHING HANDLER (Cooperatives Management / Submitted Profiles) =====
    document.querySelectorAll('.databank-header-tabs .tab-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            // Don't handle if this is a nested tab (has data-filter attribute)
            if (this.dataset.filter) return;
            
            const target = this.dataset.target;
            
            // Update active tab in header
            document.querySelectorAll('.databank-header-tabs .tab-btn').forEach(b => {
                if (!b.dataset.filter) { // Only update main tabs, not nested tabs
                    b.classList.remove('active');
                }
            });
            this.classList.add('active');
            
            // Show/hide main table sections (cooperatives-management, submitted-profiles)
            document.querySelectorAll('#cooperatives-management, #submitted-profiles').forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none';
            });
            
            const targetSection = document.getElementById(target);
            if (targetSection) {
                targetSection.classList.add('active');
                targetSection.style.display = 'flex';
            }
            
            // Clear selected rows when switching tabs
            selectedCoopRow = null;
            selectedDeactivatedCoopRow = null;
            selectedProfileRow = null;
            document.querySelectorAll('.action-buttons').forEach(btn => btn.style.display = 'none');
            document.querySelectorAll('tr.selected').forEach(row => row.classList.remove('selected'));
        });
    });

    // ===== SUB-TAB SWITCHING HANDLER (Active/Deactivated within Cooperatives Management) =====
    if (USER_ROLE === 'admin') {
        document.querySelectorAll('#cooperatives-management .tab-btn[data-target]').forEach(btn => {
            btn.addEventListener('click', function() {
                const target = this.dataset.target;
                const filter = this.dataset.filter;
                
                // Update active sub-tab
                document.querySelectorAll('#cooperatives-management .tab-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // Show/hide sub-table sections (active-coops, deactivated-coops)
                document.querySelectorAll('#active-coops, #deactivated-coops').forEach(section => {
                    section.classList.remove('active');
                    section.style.display = 'none';
                });
                
                const targetSection = document.getElementById(target);
                if (targetSection) {
                    targetSection.classList.add('active');
                    targetSection.style.display = 'flex';
                }
                
                // Show/hide Add button
                const addBtn = document.getElementById('addCoopBtn');
                if (addBtn) {
                    addBtn.style.display = filter === 'deactivated' ? 'none' : 'flex';
                }
                
                // Clear selected rows
                selectedCoopRow = null;
                selectedDeactivatedCoopRow = null;
                document.querySelectorAll('#cooperatives-management .action-buttons').forEach(btn => btn.style.display = 'none');
                document.querySelectorAll('#cooperatives-management tr.selected').forEach(row => row.classList.remove('selected'));
                
                // Reload page with filter parameter
                window.location.href = `?filter=${filter}`;
            });
        });
    }

    // ===== ACTIVE COOPERATIVES TABLE ROW CLICK HANDLER =====
    const coopTableBody = document.querySelector('#cooperatives-table tbody');
    const coopActionButtons = document.getElementById('coop-action-buttons');

        if (coopTableBody) {
            coopTableBody.addEventListener('click', function (e) {
                const row = e.target.closest('tr[data-coop-id]');
                if (!row || row.querySelector('td[colspan]')) return;

                if (selectedCoopRow === row) {
                    row.classList.remove('selected');
                    coopActionButtons.style.display = 'none';
                    selectedCoopRow = null;
                } else {
                    if (selectedCoopRow) {
                        selectedCoopRow.classList.remove('selected');
                    }
                    row.classList.add('selected');
                    coopActionButtons.style.display = 'flex';
                    selectedCoopRow = row;
                }
            });
        }

        // ===== PROFILE TABLE ROW CLICK HANDLER =====
        const profileTableBody = document.querySelector('#profiles-table tbody');
        const profileActionButtons = document.getElementById('profile-action-buttons');
        const profileModal = document.getElementById('profile-modal');

        if (profileTableBody) {
            profileTableBody.addEventListener('click', function (e) {
                const row = e.target.closest('tr[data-profile-id]');
                if (!row || row.querySelector('td[colspan]')) return;

                if (selectedProfileRow === row) {
                    row.classList.remove('selected');
                    profileActionButtons.style.display = 'none';
                    selectedProfileRow = null;
                } else {
                    if (selectedProfileRow) {
                        selectedProfileRow.classList.remove('selected');
                    }
                    row.classList.add('selected');
                    profileActionButtons.style.display = 'flex';
                    selectedProfileRow = row;

                    // Load and show profile modal
                    loadProfileModal(row.dataset.profileId, row.dataset.coopId);
                }
            });
        }

        // ===== LOAD PROFILE MODAL =====
        async function loadProfileModal(profileId, coopId) {
            if (!profileModal) return;

            openModal(profileModal);

            const modalBody = document.getElementById('profile-modal-body');
            modalBody.innerHTML = '<div class="text-center" style="padding: 40px;"><div class="spinner-border text-primary" role="status"></div><p class="mt-3">Loading profile details...</p></div>';

            try {
                const response = await fetch(`/databank/api/get-profile-details/${profileId}/`, {
                    headers: { 'X-CSRFToken': getCsrfToken() }
                });
                const data = await response.json();

                if (data.success) {
                    modalBody.innerHTML = data.html;
                    // Initialize file preview handlers
                    initializeFilePreviewHandlers(coopId);
                } else {
                    modalBody.innerHTML = `<div class="alert alert-danger">Error: ${data.error || 'Failed to load profile'}</div>`;
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                modalBody.innerHTML = `<div class="alert alert-danger">Error loading profile details.</div>`;
            }
        }

        // ===== FILE PREVIEW HANDLERS =====
        function initializeFilePreviewHandlers(coopId) {
            // Remove existing listeners by cloning and replacing buttons
            document.querySelectorAll('.btn-certificate-preview, .btn-preview-docs').forEach(button => {
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
                
                newButton.addEventListener('click', function() {
                    const attachmentType = this.getAttribute('data-attachment-type');
                    const filename = this.getAttribute('data-filename') || 'Document';
                    
                    if (!coopId && !attachmentType) return;

                    // Build preview URL
                    let previewUrl = `/cooperatives/profiles/${coopId}/attachment/${attachmentType}/?preview=true`;
                    
                    // For financial documents, check if year is needed
                    if (attachmentType === 'financial') {
                        const year = document.querySelector('.current-year-badge strong')?.textContent;
                        if (year) {
                            previewUrl += `&year=${year}`;
                        }
                    }

                    // Reset file navigation
                    totalFiles = 0;
                    currentFileIndex = 0;
                    currentPreviewUrl = previewUrl;
                    currentFilename = filename;
                    fileList = [];

                    // Show modal
                    previewModal.style.display = 'flex';
                    setTimeout(() => previewModal.classList.add('show'), 10);
                    previewTitle.textContent = filename;
                    previewDownload.href = previewUrl.replace('?preview=true', '?download=1');
                    previewDownload.download = filename;

                    // Check if file needs conversion
                    const isCsvGz = filename.toLowerCase().endsWith('.csv.gz');
                    const isPdfGz = filename.toLowerCase().endsWith('.pdf.gz');
                    const needsConversion = filename.toLowerCase().match(/\.(docx?|xlsx?|xlsm|xlsb|pptx?|txt|csv)$/i);
                    
                    if (isCsvGz || isPdfGz || needsConversion) {
                        // Show loading message
                        previewBody.innerHTML = '<p style="color:#6c757d; font-size:1rem;">Converting document to PDF...</p>';
                        convertAndPreviewProfile(previewUrl, filename, 0);
                    } else {
                        // Try to load as PDF directly
                        loadPdfPreview(previewUrl, filename, 0);
                    }
                });
            });
        }

        // ===== EDIT COOPERATIVE =====
        document.querySelector('#coop-action-buttons .edit-btn')?.addEventListener('click', function () {
            if (!selectedCoopRow) {
                showNotification('Please select a cooperative first.', 'error');
                return;
            }
            const coopId = selectedCoopRow.dataset.coopId;
            openCoopModal(coopId);
        });

        // ===== DELETE/DEACTIVATE COOPERATIVE =====
        document.querySelector('#coop-action-buttons .delete-btn')?.addEventListener('click', function () {
            if (!selectedCoopRow) {
                showNotification('Please select a cooperative first.', 'error');
                return;
            }

            currentAction = 'deactivate';
            document.getElementById('password-verify-title').textContent = 'Verify Deactivation';
            document.getElementById('password-verify-desc').textContent = 'Please enter your password to confirm deactivation.';
            document.getElementById('password-verify-input').value = '';
            document.getElementById('password-verify-error').style.display = 'none';
            tempPassword = '';
            openModal(document.getElementById('password-verify-modal'));
        });

    // ===== DEACTIVATED COOPERATIVES TABLE ROW CLICK HANDLER =====
    const deactivatedTableBody = document.querySelector('#deactivated-cooperatives-table tbody');
    const deactivatedActionButtons = document.getElementById('deactivated-coop-action-buttons');

    if (deactivatedTableBody) {
        deactivatedTableBody.addEventListener('click', function (e) {
            const row = e.target.closest('tr[data-coop-id]');
            if (!row || row.querySelector('td[colspan]')) return;

            if (selectedDeactivatedCoopRow === row) {
                row.classList.remove('selected');
                deactivatedActionButtons.style.display = 'none';
                selectedDeactivatedCoopRow = null;
            } else {
                if (selectedDeactivatedCoopRow) {
                    selectedDeactivatedCoopRow.classList.remove('selected');
                }
                row.classList.add('selected');
                deactivatedActionButtons.style.display = 'flex';
                selectedDeactivatedCoopRow = row;
            }
        });
    }

    // ===== EDIT DEACTIVATED COOPERATIVE =====
    document.querySelector('#deactivated-coop-action-buttons .edit-btn')?.addEventListener('click', function () {
        if (!selectedDeactivatedCoopRow) {
            showNotification('Please select a deactivated cooperative first.', 'error');
            return;
        }
        const coopId = selectedDeactivatedCoopRow.dataset.coopId;
        openCoopModal(coopId);
    });

    // ===== DELETE DEACTIVATED COOPERATIVE =====
    document.querySelector('#deactivated-coop-action-buttons .delete-btn')?.addEventListener('click', function () {
        if (!selectedDeactivatedCoopRow) {
            showNotification('Please select a deactivated cooperative first.', 'error');
            return;
        }

        currentAction = 'delete';
        document.getElementById('password-verify-title').textContent = 'Verify Deletion';
        document.getElementById('password-verify-desc').textContent = 'Please enter your password to confirm permanent deletion.';
        document.getElementById('password-verify-input').value = '';
        document.getElementById('password-verify-error').style.display = 'none';
        tempPassword = '';
        openModal(el.passwordVerifyModal);
    });

    // ===== REACTIVATE COOPERATIVE =====
    document.querySelector('#deactivated-coop-action-buttons .reactivate-btn')?.addEventListener('click', function () {
        if (!selectedDeactivatedCoopRow) {
            showNotification('Please select a deactivated cooperative first.', 'error');
            return;
        }

        currentAction = 'reactivate';
        document.getElementById('password-verify-title').textContent = 'Verify Reactivation';
        document.getElementById('password-verify-desc').textContent = 'Please enter your password to confirm reactivation.';
        document.getElementById('password-verify-input').value = '';
        document.getElementById('password-verify-error').style.display = 'none';
        tempPassword = '';
        openModal(el.passwordVerifyModal);
    });

    // ===== PASSWORD VERIFICATION HANDLERS =====
    document.getElementById('password-verify-cancel-btn')?.addEventListener('click', () => {
        closeModal(el.passwordVerifyModal);
        document.getElementById('password-verify-input').value = '';
        document.getElementById('password-verify-error').style.display = 'none';
        tempPassword = '';
        currentAction = null;
    });

    document.getElementById('password-verify-confirm-btn')?.addEventListener('click', () => handlePasswordVerification(el));

    document.getElementById('password-verify-input')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            handlePasswordVerification(el);
        }
    });

    // ===== PASSWORD VERIFICATION FUNCTION =====
    function handlePasswordVerification(el) {
        const passwordInput = document.getElementById('password-verify-input');
        const errorEl = document.getElementById('password-verify-error');
        const verifyBtn = document.getElementById('password-verify-confirm-btn');
        const password = passwordInput.value.trim();
        
        if (!password) {
            errorEl.textContent = 'Enter password.';
            errorEl.style.display = 'block';
            return;
        }
        
        verifyBtn.disabled = true;
        verifyBtn.textContent = 'Verifying...';
        errorEl.style.display = 'none';
        
        fetch('/databank/api/verify-password/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({ password: password })
        })
        .then(r => r.json())
        .then(data => {
            if (data.valid) {
                // Store password temporarily
                tempPassword = password;
                
                closeModal(el.passwordVerifyModal);
                passwordInput.value = '';
                
                const selectedRow = currentAction === 'deactivate' ? selectedCoopRow : selectedDeactivatedCoopRow;
                const coopName = selectedRow ? (selectedRow.dataset.coopName || 'this cooperative') : 'this cooperative';
                const confirmMessage = `Are you sure you want to ${currentAction} ${coopName}?`;

                if (currentAction === 'deactivate') {
                    document.getElementById('deactivate-confirm-text').textContent = confirmMessage;
                    openModal(el.deactivateModal);
                } else if (currentAction === 'reactivate') {
                    document.getElementById('reactivate-confirm-text').textContent = confirmMessage;
                    openModal(el.reactivateModal);
                }
            } else {
                errorEl.textContent = data.message || 'Incorrect password.';
                errorEl.style.display = 'block';
                passwordInput.value = '';
                passwordInput.focus();
                tempPassword = '';
            }
        })
        .catch(e => {
            errorEl.textContent = 'Error occurred.';
            errorEl.style.display = 'block';
        })
        .finally(() => {
            verifyBtn.disabled = false;
            verifyBtn.textContent = 'Verify Password';
        });
    }

    // ===== DEACTIVATE CONFIRM HANDLER =====
    document.getElementById('deactivate-confirm-btn')?.addEventListener('click', () => handleDeactivateConfirm(el));
    document.getElementById('deactivate-cancel-btn')?.addEventListener('click', () => {
        closeModal(el.deactivateModal);
        tempPassword = '';
        currentAction = null;
    });

    function handleDeactivateConfirm(el) {
        if (!selectedCoopRow) return;
        
        const coopId = selectedCoopRow.dataset.coopId;
        if (!coopId) return;
        
        fetch(`{% url 'databank:delete_cooperative' 0 %}`.replace('0', coopId), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({ password: tempPassword })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showNotification('Cooperative deactivated successfully', 'success');
                location.reload();
            } else {
                showNotification(data.error || 'Error deactivating cooperative', 'error');
            }
        })
        .catch(e => {
            showNotification('Error deactivating cooperative', 'error');
        })
        .finally(() => {
            closeModal(el.deactivateModal);
            tempPassword = '';
            currentAction = null;
        });
    }

    // ===== REACTIVATE CONFIRM HANDLER =====
    document.getElementById('reactivate-confirm-btn')?.addEventListener('click', () => handleReactivateConfirm(el));
    document.getElementById('reactivate-cancel-btn')?.addEventListener('click', () => {
        closeModal(el.reactivateModal);
        tempPassword = '';
        currentAction = null;
    });

    function handleReactivateConfirm(el) {
        if (!selectedDeactivatedCoopRow) return;
        
        const coopId = selectedDeactivatedCoopRow.dataset.coopId;
        if (!coopId) return;

        fetch(`{% url 'databank:restore_cooperative' 0 %}`.replace('0', coopId), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({ password: tempPassword })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showNotification('Cooperative reactivated successfully', 'success');
                location.reload();
            } else {
                showNotification(data.error || 'Error reactivating cooperative', 'error');
            }
        })
        .catch(e => {
            showNotification('Error reactivating cooperative', 'error');
        })
        .finally(() => {
            closeModal(el.reactivateModal);
            tempPassword = '';
            currentAction = null;
        });
    }

        // ===== APPROVE PROFILE =====
        document.querySelector('#profile-action-buttons .approve-btn')?.addEventListener('click', async function () {
            if (!selectedProfileRow) {
                showNotification('Please select a profile first.', 'error');
                return;
            }

            const profileId = selectedProfileRow.dataset.profileId;
            const currentStatus = selectedProfileRow.dataset.approvalStatus;

            if (currentStatus === 'approved') {
                showNotification('This profile is already approved.', 'info');
                return;
            }

            // Show confirmation modal
            showConfirmModal(
                'Approve Profile',
                'Are you sure you want to approve this cooperative profile?',
                async () => {
                    try {
                const response = await fetch(`/databank/api/approve-profile/${profileId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCsrfToken(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: 'approve' })
                });
                        const result = await response.json();

                        if (result.success) {
                            showNotification('Profile approved successfully', 'success');
                            location.reload();
                        } else {
                            showNotification('Error: ' + (result.error || 'Unknown error'), 'error');
                        }
                    } catch (error) {
                        console.error('Error approving profile:', error);
                        showNotification('Error approving profile', 'error');
                    }
                }
            );
        });

        // ===== CANCEL APPROVAL =====
        document.querySelector('#profile-action-buttons .cancel-approve-btn')?.addEventListener('click', async function () {
            if (!selectedProfileRow) {
                showNotification('Please select a profile first.', 'error');
                return;
            }

            const profileId = selectedProfileRow.dataset.profileId;
            const currentStatus = selectedProfileRow.dataset.approvalStatus;

            if (currentStatus !== 'approved') {
                showNotification('This profile is not approved.', 'info');
                return;
            }

            // Show confirmation modal
            showConfirmModal(
                'Cancel Approval',
                'Are you sure you want to cancel the approval of this cooperative profile?',
                async () => {
                    try {
                const response = await fetch(`/databank/api/approve-profile/${profileId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCsrfToken(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: 'cancel' })
                });
                        const result = await response.json();

                        if (result.success) {
                            showNotification('Approval cancelled successfully', 'success');
                            location.reload();
                        } else {
                            showNotification('Error: ' + (result.error || 'Unknown error'), 'error');
                        }
                    } catch (error) {
                        console.error('Error cancelling approval:', error);
                        showNotification('Error cancelling approval', 'error');
                    }
                }
            );
        });

        // ===== COOPERATIVE MODAL FUNCTIONS =====
        const coopModal = document.getElementById('coop-modal');
        const coopForm = document.getElementById('coop-form');
        const addCoopBtn = document.getElementById('addCoopBtn');

        function openCoopModal(coopId = null) {
            if (coopId) {
                document.getElementById('coop-modal-title').textContent = 'Edit Cooperative';
                document.getElementById('coop-id').value = coopId;
                document.getElementById('form-buttons-add').style.display = 'none';
                document.getElementById('form-buttons-edit').style.display = 'flex';
                loadCooperativeData(coopId);
            } else {
                document.getElementById('coop-modal-title').textContent = 'Add Cooperative';
                document.getElementById('coop-id').value = '';
                document.getElementById('form-buttons-add').style.display = 'block';
                document.getElementById('form-buttons-edit').style.display = 'none';
                coopForm.reset();
            }
            openModal(coopModal);
        }

        function closeCoopModal() {
            closeModal(coopModal);
            coopForm.reset();
        }

        // Close modal on close button click
        document.querySelector('#coop-modal .modal-close')?.addEventListener('click', closeCoopModal);
        document.getElementById('edit-cancel-btn')?.addEventListener('click', closeCoopModal);

        // --- OCR ASSISTANT FUNCTIONALITY ---
        const ocrDrawer = document.getElementById('ocrDrawer');
        const ocrDrawerClose = document.getElementById('ocrDrawerClose');
        const ocrBtnAddCoop = document.getElementById('ocrBtnAddCoop');
        const ocrBtnEditProfile = document.getElementById('ocrBtnEditProfile');
        const uploadContainer = document.getElementById('upload-container');
        const cameraContainer = document.getElementById('camera-container');
        const videoElement = document.getElementById('camera-video');
        const captureBtn = document.getElementById('capture-btn');
        const cancelCameraBtn = document.getElementById('cancel-camera-btn');
        const ocrUploadArea = document.getElementById('ocrUploadArea');
        const ocrFileInput = document.getElementById('ocrFileInput');
        const mobileCameraInput = document.getElementById('mobileCameraInput');
        const ocrUploadBtn = document.getElementById('ocrUploadBtn');
        const ocrCameraBtn = document.getElementById('ocrCameraBtn');
        const ocrPasteBtn = document.getElementById('ocrPasteBtn');
        const ocrLoading = document.getElementById('ocrLoading');
        const ocrResultArea = document.getElementById('ocrResultArea');
        const ocrResultText = document.getElementById('ocrResultText');
        const ocrClearBtn = document.getElementById('ocrClearBtn');
        const ocrCopyBtn = document.getElementById('ocrCopyBtn');

        let videoStream = null;

        function toggleOcrDrawer(open) {
            if (open) {
                ocrDrawer.classList.add('open');
            } else {
                ocrDrawer.classList.remove('open');
                stopCamera();
            }
        }

        // Open OCR drawer from modal buttons
        if (ocrBtnAddCoop) {
            ocrBtnAddCoop.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleOcrDrawer(true);
            });
        }

        if (ocrBtnEditProfile) {
            ocrBtnEditProfile.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleOcrDrawer(true);
            });
        }

        if (ocrDrawerClose) {
            ocrDrawerClose.addEventListener('click', () => toggleOcrDrawer(false));
        }

        // Close drawer when clicking outside
        const ocrDrawerWrapper = document.querySelector('.ocr-drawer-wrapper');
        if (ocrDrawerWrapper) {
            ocrDrawerWrapper.addEventListener('click', (e) => {
                if (e.target === ocrDrawerWrapper) {
                    toggleOcrDrawer(false);
                }
            });
        }

        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        if (ocrCameraBtn) {
            ocrCameraBtn.addEventListener('click', () => {
                if (isMobile) {
                    if (mobileCameraInput) mobileCameraInput.click();
                } else {
                    startWebcam();
                }
            });
        }

        if (mobileCameraInput) {
            mobileCameraInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    showImagePreview(file);
                    processImageFile(file);
                }
            });
        }

        async function startWebcam() {
            try {
                if (uploadContainer) uploadContainer.style.display = 'none';
                if (ocrResultArea) ocrResultArea.style.display = 'none';
                if (cameraContainer) cameraContainer.style.display = 'block';
                videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                if (videoElement) videoElement.srcObject = videoStream;
            } catch (err) {
                alert("Camera access denied.");
                stopCamera();
            }
        }

        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            if (cameraContainer) cameraContainer.style.display = 'none';
            if (uploadContainer) uploadContainer.style.display = 'block';
        }

        if (cancelCameraBtn) {
            cancelCameraBtn.addEventListener('click', stopCamera);
        }

        if (captureBtn && videoElement) {
            captureBtn.addEventListener('click', () => {
                const canvas = document.createElement('canvas');
                canvas.width = videoElement.videoWidth;
                canvas.height = videoElement.videoHeight;
                canvas.getContext('2d').drawImage(videoElement, 0, 0);
                stopCamera();
                const base64 = canvas.toDataURL('image/jpeg');
                // Show preview immediately
                const preview = document.getElementById('ocr-image-preview');
                const previewImg = document.getElementById('ocr-preview-img');
                if (preview && previewImg) {
                    previewImg.src = base64;
                    preview.style.display = 'block';
                }
                processBase64Image(base64);
            });
        }

        if (ocrUploadArea) {
            ocrUploadArea.addEventListener('click', () => {
                if (ocrFileInput) ocrFileInput.click();
            });
        }

        if (ocrUploadBtn) {
            ocrUploadBtn.addEventListener('click', () => {
                if (ocrFileInput) ocrFileInput.click();
            });
        }

        if (ocrFileInput) {
            ocrFileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    showImagePreview(file);
                    processImageFile(file);
                }
            });
        }

        // Remove preview button
        const ocrRemovePreview = document.getElementById('ocr-remove-preview');
        if (ocrRemovePreview) {
            ocrRemovePreview.addEventListener('click', () => {
                removeImagePreview();
            });
        }

        if (ocrPasteBtn) {
            ocrPasteBtn.addEventListener('click', async () => {
                try {
                    const items = await navigator.clipboard.read();
                    for (const item of items) {
                        for (const type of item.types) {
                            if (type.startsWith('image/')) {
                                const blob = await item.getType(type);
                                const reader = new FileReader();
                                reader.onload = (e) => {
                                    const base64 = e.target.result;
                                    // Show preview
                                    const preview = document.getElementById('ocr-image-preview');
                                    const previewImg = document.getElementById('ocr-preview-img');
                                    if (preview && previewImg) {
                                        previewImg.src = base64;
                                        preview.style.display = 'block';
                                    }
                                    processBase64Image(base64);
                                };
                                reader.readAsDataURL(blob);
                                return;
                            }
                        }
                    }
                    alert("No image found.");
                } catch (e) {
                    alert("Clipboard access denied.");
                }
            });
        }

        function compressImage(fileOrBlob, maxWidth = 1000, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(fileOrBlob);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob((blob) => {
                            if (blob) resolve(blob);
                            else reject(new Error("Compression failed"));
                        }, 'image/jpeg', quality);
                    };
                };
            });
        }

        let currentImageFile = null;
        let progressInterval = null;

        function showImagePreview(file) {
            currentImageFile = file;
            const preview = document.getElementById('ocr-image-preview');
            const previewImg = document.getElementById('ocr-preview-img');
            if (preview && previewImg && file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImg.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        function removeImagePreview() {
            currentImageFile = null;
            const preview = document.getElementById('ocr-image-preview');
            if (preview) preview.style.display = 'none';
            const fileInput = document.getElementById('ocrFileInput');
            if (fileInput) fileInput.value = '';
        }

        function showLoading(show) {
            if (show) {
                if (ocrLoading) ocrLoading.style.display = 'block';
                if (ocrResultArea) ocrResultArea.style.display = 'none';
                // Start progress simulation
                startProgressSimulation();
            } else {
                if (ocrLoading) ocrLoading.style.display = 'none';
                stopProgressSimulation();
            }
        }

        function startProgressSimulation() {
            let progress = 0;
            const progressBar = document.getElementById('ocr-progress-bar');
            const progressText = document.getElementById('ocr-progress-text');
            
            if (progressInterval) clearInterval(progressInterval);
            
            progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90; // Don't go to 100% until actually done
                
                if (progressBar) {
                    progressBar.style.width = progress + '%';
                    progressBar.setAttribute('aria-valuenow', progress);
                }
                if (progressText) {
                    progressText.textContent = Math.round(progress) + '%';
                }
            }, 200);
        }

        function stopProgressSimulation() {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
            const progressBar = document.getElementById('ocr-progress-bar');
            const progressText = document.getElementById('ocr-progress-text');
            if (progressBar) {
                progressBar.style.width = '100%';
                progressBar.setAttribute('aria-valuenow', 100);
            }
            if (progressText) {
                progressText.textContent = '100%';
            }
        }

        function displayResult(text, imageUrl = null, scanNumber = null) {
            if (ocrResultText) ocrResultText.value = text;
            if (ocrResultArea) ocrResultArea.style.display = 'block';
            
            // Show image if provided
            if (imageUrl) {
                const preview = document.getElementById('ocr-image-preview');
                const previewImg = document.getElementById('ocr-preview-img');
                const scanNumberEl = document.getElementById('ocr-scan-number');
                if (preview && previewImg) {
                    previewImg.src = imageUrl;
                    preview.style.display = 'block';
                    if (scanNumberEl && scanNumber) {
                        scanNumberEl.textContent = `#${scanNumber}`;
                    }
                }
            }
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        async function processImageFile(file) {
            showImagePreview(file);
            showLoading(true);
            try {
                const compressedBlob = await compressImage(file);
                const formData = new FormData();
                formData.append('image', compressedBlob, "scan.jpg");
                
                const res = await fetch('{% url "databank:process_ocr" %}', {
                    method: 'POST',
                    headers: { 'X-CSRFToken': getCookie('csrftoken') },
                    body: formData
                });
                
                const data = await res.json();
                stopProgressSimulation();
                
                if (data.success) {
                    // Reload saved sessions immediately to show the new scan
                    await loadOCRSessions();
                    
                    // Get the latest session count for numbering
                    const sessionsRes = await fetch('{% url "databank:get_ocr_sessions" %}', {
                        headers: { 'X-CSRFToken': getCookie('csrftoken') },
                        cache: 'no-cache'
                    });
                    const sessionsData = await sessionsRes.json();
                    const scanNumber = sessionsData.success && sessionsData.sessions.length > 0 ? sessionsData.sessions.length : 1;
                    
                    // Show image preview if available, otherwise use the file preview
                    const imageUrl = data.image_url || (currentImageFile ? URL.createObjectURL(currentImageFile) : null);
                    displayResult(data.text, imageUrl, scanNumber);
                    
                    // Update last session count
                    lastSessionCount = sessionsData.success ? sessionsData.sessions.length : 0;
                } else {
                    alert('OCR Failed: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error(e);
                alert('Error processing image.');
            } finally {
                showLoading(false);
            }
        }

        async function processBase64Image(base64) {
            const res = await fetch(base64);
            const blob = await res.blob();
            const file = new File([blob], 'ocr_scan.jpg', { type: 'image/jpeg' });
            processImageFile(file);
        }

        let scanCounter = 0;

        // Load saved OCR sessions
        async function loadOCRSessions() {
            const sessionsList = document.getElementById('ocr-sessions-list');
            if (!sessionsList) return Promise.resolve();

            try {
                const res = await fetch('{% url "databank:get_ocr_sessions" %}', {
                    headers: { 'X-CSRFToken': getCookie('csrftoken') },
                    cache: 'no-cache' // Ensure fresh data
                });
                const data = await res.json();
                
                // Update last session count and IDs
                if (data.success) {
                    lastSessionCount = data.sessions.length;
                    lastSessionIds = new Set(data.sessions.map(s => s.id));
                }
                
                if (data.success && data.sessions.length > 0) {
                    sessionsList.innerHTML = '';
                    // Reverse to show newest first, then number them
                    const reversedSessions = [...data.sessions].reverse();
                    reversedSessions.forEach((session, index) => {
                        const scanNumber = data.sessions.length - index; // Number from highest to lowest
                        const sessionDiv = document.createElement('div');
                        sessionDiv.className = 'ocr-session-item';
                        sessionDiv.style.cssText = 'padding: 12px; margin-bottom: 8px; background: white; border-radius: 8px; border: 1px solid #edf2f7; cursor: pointer; transition: all 0.2s;';
                        sessionDiv.innerHTML = `
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <div style="background: #a91e2c; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 12px; flex-shrink: 0;">${scanNumber}</div>
                                ${session.image_url ? `<img src="${session.image_url}" alt="Scan" style="width: 60px; height: 60px; object-fit: cover; border-radius: 6px; border: 1px solid #e0e0e0;">` : '<div style="width: 60px; height: 60px; background: #f0f0f0; border-radius: 6px; display: flex; align-items: center; justify-content: center;"><i class="bi bi-image" style="font-size: 24px; color: #999;"></i></div>'}
                                <div style="flex: 1; min-width: 0;">
                                    <p style="margin: 0; font-size: 12px; color: #666; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${session.extracted_text.substring(0, 50)}${session.extracted_text.length > 50 ? '...' : ''}</p>
                                    <p style="margin: 4px 0 0 0; font-size: 11px; color: #999;">${new Date(session.created_at).toLocaleString()}</p>
                                </div>
                            </div>
                        `;
                        sessionDiv.addEventListener('click', () => {
                            displayResult(session.extracted_text, session.image_url, scanNumber);
                        });
                        sessionsList.appendChild(sessionDiv);
                    });
                } else {
                    sessionsList.innerHTML = '<p class="text-muted small" style="text-align: center; padding: 20px;">No recent scans</p>';
                    lastSessionCount = 0;
                }
            } catch (e) {
                console.error('Error loading OCR sessions:', e);
                sessionsList.innerHTML = '<p class="text-muted small" style="text-align: center; padding: 20px; color: #dc3545;">Error loading sessions</p>';
            }
            
            return Promise.resolve();
        }

        // Load sessions when drawer opens and poll for updates (real-time)
        let sessionPollInterval = null;
        let lastSessionCount = 0;
        let lastSessionIds = new Set(); // Track session IDs for better change detection
        
        const originalToggleOcrDrawer = toggleOcrDrawer;
        toggleOcrDrawer = function(open) {
            originalToggleOcrDrawer(open);
            if (open) {
                // Load immediately when drawer opens
                loadOCRSessions().then(() => {
                    // Update tracking
                    const sessionsList = document.getElementById('ocr-sessions-list');
                    if (sessionsList) {
                        const sessionItems = sessionsList.querySelectorAll('.ocr-session-item');
                        lastSessionCount = sessionItems.length;
                        lastSessionIds = new Set(Array.from(sessionItems).map((_, idx) => idx));
                    }
                    
                    // Start polling for updates every 1.5 seconds for real-time feel
                    if (sessionPollInterval) clearInterval(sessionPollInterval);
                    sessionPollInterval = setInterval(async () => {
                        const sessionsList = document.getElementById('ocr-sessions-list');
                        if (sessionsList) {
                            try {
                                const res = await fetch('{% url "databank:get_ocr_sessions" %}', {
                                    headers: { 'X-CSRFToken': getCookie('csrftoken') },
                                    cache: 'no-cache'
                                });
                                const data = await res.json();
                                
                                // Reload if count changed or if we detect new sessions
                                if (data.success) {
                                    const currentCount = data.sessions.length;
                                    const currentIds = new Set(data.sessions.map(s => s.id));
                                    
                                    // Check if count changed or if there are new session IDs
                                    const hasNewSessions = data.sessions.some(s => !lastSessionIds.has(s.id));
                                    
                                    if (currentCount !== lastSessionCount || hasNewSessions) {
                                        lastSessionCount = currentCount;
                                        lastSessionIds = currentIds;
                                        await loadOCRSessions();
                                    }
                                }
                            } catch (e) {
                                console.error('Error polling sessions:', e);
                            }
                        }
                    }, 1500); // Poll every 1.5 seconds for real-time updates
                });
            } else {
                // Stop polling when drawer closes
                if (sessionPollInterval) {
                    clearInterval(sessionPollInterval);
                    sessionPollInterval = null;
                }
                lastSessionCount = 0;
                lastSessionIds = new Set();
            }
        };

        if (ocrClearBtn) {
            ocrClearBtn.addEventListener('click', () => {
                if (ocrResultText) ocrResultText.value = '';
                if (ocrResultArea) ocrResultArea.style.display = 'none';
                if (ocrFileInput) ocrFileInput.value = '';
            });
        }

        if (ocrCopyBtn) {
            ocrCopyBtn.addEventListener('click', async () => {
                const extractedText = ocrResultText ? ocrResultText.value : '';
                if (extractedText.trim()) {
                    try {
                        await navigator.clipboard.writeText(extractedText);
                        // Show feedback
                        const originalText = ocrCopyBtn.innerHTML;
                        ocrCopyBtn.innerHTML = '<i class="bi bi-check"></i> Copied!';
                        ocrCopyBtn.style.background = '#28a745';
                        setTimeout(() => {
                            ocrCopyBtn.innerHTML = originalText;
                            ocrCopyBtn.style.background = '';
                        }, 2000);
                        showNotification('OCR text copied to clipboard', 'success');
                    } catch (err) {
                        console.error('Failed to copy:', err);
                        // Fallback for older browsers
                        if (ocrResultText) {
                            ocrResultText.select();
                            document.execCommand('copy');
                            showNotification('OCR text copied to clipboard', 'success');
                        } else {
                            showNotification('Failed to copy text', 'error');
                        }
                    }
                } else {
                    showNotification('No text to copy', 'info');
                }
            });
        }

        function autoFillFormFromOCR(text) {
            // Simple pattern matching to extract common fields
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            
            // Try to find cooperative name (usually first line or contains "cooperative")
            const nameMatch = text.match(/(?:cooperative|coop)[\s:]*([^\n]+)/i) || 
                             lines.find(l => l.length > 5 && l.length < 100);
            if (nameMatch) {
                const name = typeof nameMatch === 'string' ? nameMatch : nameMatch[1] || nameMatch[0];
                const nameValue = name.trim();
                // Try add cooperative form
                if (document.getElementById('coop-name')) {
                    document.getElementById('coop-name').value = nameValue;
                }
                // Try edit profile form
                if (document.getElementById('edit-coop-name')) {
                    document.getElementById('edit-coop-name').value = nameValue;
                }
            }

            // Try to find address
            const addressMatch = text.match(/(?:address|location)[\s:]*([^\n]+)/i);
            if (addressMatch) {
                const addressValue = addressMatch[1].trim();
                if (document.getElementById('edit-coop-address')) {
                    document.getElementById('edit-coop-address').value = addressValue;
                }
            }

            // Try to find category
            const categoryMatch = text.match(/category[\s:]*([^\n]+)/i);
            if (categoryMatch && document.getElementById('coop-category')) {
                document.getElementById('coop-category').value = categoryMatch[1].trim();
            }

            // Try to find district
            const districtMatch = text.match(/district[\s:]*([^\n]+)/i);
            if (districtMatch && document.getElementById('coop-district')) {
                document.getElementById('coop-district').value = districtMatch[1].trim();
            }

            // Try to find area of operation
            const areaMatch = text.match(/(?:area of operation|operation area)[\s:]*([^\n]+)/i);
            if (areaMatch && document.getElementById('edit-area-operation')) {
                document.getElementById('edit-area-operation').value = areaMatch[1].trim();
            }

            // Try to find business activity
            const businessMatch = text.match(/(?:business activity|activity)[\s:]*([^\n]+)/i);
            if (businessMatch && document.getElementById('edit-business-activity')) {
                document.getElementById('edit-business-activity').value = businessMatch[1].trim();
            }

            // Try to find contact number
            const contactMatch = text.match(/(?:contact|phone|mobile|tel)[\s:]*([0-9\s\-\(\)]+)/i);
            if (contactMatch && document.getElementById('edit-coop-contact')) {
                document.getElementById('edit-coop-contact').value = contactMatch[1].trim().replace(/\s+/g, '');
            }

            // Try to find email
            const emailMatch = text.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/i);
            if (emailMatch && document.getElementById('edit-coop-email')) {
                document.getElementById('edit-coop-email').value = emailMatch[1].trim();
            }

            showNotification('OCR data applied to form', 'success');
        }

        async function loadCooperativeData(coopId) {
            try {
                const response = await fetch(`{% url 'databank:get_cooperative' 0 %}`.replace('0', coopId));
                const result = await response.json();
                if (result.success) {
                    const data = result.data;
                    document.getElementById('coop-name').value = data.cooperative_name || '';
                    document.getElementById('coop-category').value = data.category || '';
                    document.getElementById('coop-district').value = data.district || '';
                    if (USER_ROLE === 'admin' && document.getElementById('coop-staff')) {
                        document.getElementById('coop-staff').value = data.staff_id || '';
                    }
                }
            } catch (error) {
                console.error('Error loading cooperative:', error);
                showNotification('Error loading cooperative data', 'error');
            }
        }

        if (addCoopBtn) {
            addCoopBtn.addEventListener('click', () => openCoopModal());
        }

        if (coopForm) {
            coopForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const coopId = document.getElementById('coop-id').value;
                const formData = {
                    cooperative_name: document.getElementById('coop-name').value,
                    category: document.getElementById('coop-category').value,
                    district: document.getElementById('coop-district').value
                };

                if (USER_ROLE === 'admin' && document.getElementById('coop-staff')) {
                    formData.staff_id = document.getElementById('coop-staff').value || null;
                }

                try {
                    let url, method;
                    if (coopId) {
                        url = `{% url 'databank:update_cooperative' 0 %}`.replace('0', coopId);
                        method = 'POST';
                    } else {
                        url = '{% url "databank:add_cooperative" %}';
                        method = 'POST';
                    }

                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'X-CSRFToken': getCsrfToken(),
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });

                    const result = await response.json();
                    if (result.success) {
                        showNotification(result.message || 'Cooperative saved successfully', 'success');
                        closeCoopModal();
                        location.reload();
                    } else {
                        showNotification('Error: ' + (result.error || 'Unknown error'), 'error');
                    }
                } catch (error) {
                    console.error('Error saving cooperative:', error);
                    showNotification('Error saving cooperative', 'error');
                }
            });
        }

        // Close profile modal
        document.getElementById('profile-modal-close')?.addEventListener('click', () => {
            closeModal(profileModal);
        });

        // Close modals (generic handler for modals that don't have specific handlers)
        document.querySelectorAll('.modal-close-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const modal = e.target.closest('.modal-overlay');
                if (modal && modal.id !== 'profile-modal') {
                    closeModal(modal);
                }
            });
        });

        // ===== EDIT PROFILE FUNCTIONALITY =====
        let editProfileHistory = [];
        let editProfileHistoryIndex = -1;
        let currentEditProfileId = null;
        let currentEditFormData = null;

        // Undo/Redo functionality
        function saveFormState() {
            const form = document.getElementById('editProfileForm');
            if (!form) return;
            
            const formData = new FormData(form);
            const state = {};
            for (let [key, value] of formData.entries()) {
                if (key.includes('[]')) {
                    if (!state[key]) state[key] = [];
                    state[key].push(value);
                } else {
                    state[key] = value;
                }
            }
            
            // Also capture file inputs
            const fileInputs = form.querySelectorAll('input[type="file"]');
            fileInputs.forEach(input => {
                if (input.files && input.files.length > 0) {
                    state[input.name + '_files'] = Array.from(input.files).map(f => f.name);
                }
            });
            
            // Remove old future states if we're not at the end
            editProfileHistory = editProfileHistory.slice(0, editProfileHistoryIndex + 1);
            editProfileHistory.push(JSON.parse(JSON.stringify(state)));
            editProfileHistoryIndex = editProfileHistory.length - 1;
            
            // Limit history to 50 states
            if (editProfileHistory.length > 50) {
                editProfileHistory.shift();
                editProfileHistoryIndex--;
            }
            
            updateUndoRedoButtons();
        }

        function restoreFormState(state) {
            const form = document.getElementById('editProfileForm');
            if (!form) return;
            
            Object.keys(state).forEach(key => {
                if (key.endsWith('_files')) return; // Skip file arrays
                
                const elements = form.querySelectorAll(`[name="${key}"]`);
                elements.forEach(el => {
                    if (el.type === 'checkbox' || el.type === 'radio') {
                        el.checked = (el.value === state[key]);
                    } else if (el.tagName === 'SELECT') {
                        el.value = state[key];
                    } else {
                        el.value = state[key];
                    }
                });
            });
        }

        function undoFormState() {
            if (editProfileHistoryIndex > 0) {
                editProfileHistoryIndex--;
                restoreFormState(editProfileHistory[editProfileHistoryIndex]);
                updateUndoRedoButtons();
            }
        }

        function redoFormState() {
            if (editProfileHistoryIndex < editProfileHistory.length - 1) {
                editProfileHistoryIndex++;
                restoreFormState(editProfileHistory[editProfileHistoryIndex]);
                updateUndoRedoButtons();
            }
        }

        function updateUndoRedoButtons() {
            const undoBtn = document.getElementById('undo-btn');
            const redoBtn = document.getElementById('redo-btn');
            if (undoBtn) undoBtn.disabled = editProfileHistoryIndex <= 0;
            if (redoBtn) redoBtn.disabled = editProfileHistoryIndex >= editProfileHistory.length - 1;
        }

        // Handle edit button click (delegated event listener)
        document.addEventListener('click', async function(e) {
            const editBtn = e.target.closest('.edit-profile-btn');
            if (editBtn) {
                const profileId = editBtn.getAttribute('data-profile-id');
                const coopId = editBtn.getAttribute('data-coop-id');
                
                if (!profileId || profileId === '' || profileId === 'None') {
                    console.error('Profile ID not found. Button data:', {
                        profileId: profileId,
                        coopId: coopId,
                        button: editBtn
                    });
                    showNotification('Profile ID not found. Please refresh and try again.', 'error');
                    return;
                }
                
                currentEditProfileId = profileId;
                await loadEditProfileForm(profileId, coopId);
            }
        });

        // Load edit profile form
        async function loadEditProfileForm(profileId, coopId) {
            const editModalElement = document.getElementById('editProfileModal');
            const editModal = new bootstrap.Modal(editModalElement, {
                backdrop: true,
                keyboard: true
            });
            const formContainer = document.getElementById('edit-profile-form-container');
            
            // Ensure modal appears above profile modal
            editModalElement.style.zIndex = '10050';
            
            formContainer.innerHTML = '<div class="text-center" style="padding: 40px;"><div class="spinner-border text-primary" role="status"></div><p class="mt-3">Loading form...</p></div>';
            editModal.show();
            
            // After modal is shown, adjust backdrop z-index
            setTimeout(() => {
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach((backdrop, index) => {
                    if (index === backdrops.length - 1) {
                        // Last backdrop (for edit modal) should be on top
                        backdrop.style.zIndex = '10040';
                    }
                });
            }, 100);
            
            try {
                const response = await fetch(`/databank/api/get-profile-for-edit/${profileId}/`, {
                    headers: { 'X-CSRFToken': getCsrfToken() }
                });
                const data = await response.json();
                
                if (data.success) {
                    // Reset history
                    editProfileHistory = [];
                    editProfileHistoryIndex = -1;
                    
                    // Render form (we'll create this dynamically)
                    renderEditProfileForm(data, coopId);
                    
                    // Initialize form state tracking
                    setTimeout(() => {
                        saveFormState();
                        // Add event listeners for undo/redo
                        const form = document.getElementById('editProfileForm');
                        if (form) {
                            form.addEventListener('input', () => saveFormState());
                            form.addEventListener('change', () => saveFormState());
                        }
                    }, 100);
                } else {
                    formContainer.innerHTML = `<div class="alert alert-danger">Error: ${data.error || 'Failed to load profile'}</div>`;
                }
            } catch (error) {
                console.error('Error loading profile for edit:', error);
                formContainer.innerHTML = `<div class="alert alert-danger">Error loading profile details.</div>`;
            }
        }

        // Render edit profile form (copied from profile_form.html structure)
        function renderEditProfileForm(data, coopId) {
            const formContainer = document.getElementById('edit-profile-form-container');
            const profile = data.profile;
            const financial = data.financial;
            const officers = data.officers;
            const members = data.members;
            
            const yearSpan = document.getElementById('edit-profile-year');
            if (yearSpan && profile.report_year) {
                yearSpan.textContent = `(Year: ${profile.report_year})`;
            }
            
            // Create form HTML (simplified version - you may need to copy the full form structure)
            formContainer.innerHTML = `
                <form method="POST" enctype="multipart/form-data" id="editProfileForm" action="/databank/api/update-profile/${currentEditProfileId}/">
                    <input type="hidden" name="csrfmiddlewaretoken" value="${getCsrfToken()}">
                    <input type="hidden" name="report_year" value="${profile.report_year || ''}">
                    
                    <div class="form-section">
                        <div class="section-header">
                            <i class="bi bi-info-circle"></i>
                            <h5>General Information</h5>
                        </div>
                        
                        <div class="form-group">
                            <label for="edit-coop-name" class="required">Name of Cooperative</label>
                            <input type="text" id="edit-coop-name" name="coop_name" value="${profile.coop_name || ''}" readonly style="background-color: #f8f9fa;">
                        </div>
                        
                        <div class="form-group">
                            <label for="edit-coop-address" class="required">Cooperative Address</label>
                            <input type="text" id="edit-coop-address" name="coop_address" value="${profile.address || ''}" placeholder="Enter Cooperative Address" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-area-operation" class="required">Area of Operation</label>
                                <select id="edit-area-operation" name="area_operation" required>
                                    <option value="">Select area</option>
                                    <option value="city" ${profile.operation_area === 'city' ? 'selected' : ''}>City</option>
                                    <option value="municipal" ${profile.operation_area === 'municipal' ? 'selected' : ''}>Municipal</option>
                                    <option value="provincial" ${profile.operation_area === 'provincial' ? 'selected' : ''}>Provincial</option>
                                    <option value="regional" ${profile.operation_area === 'regional' ? 'selected' : ''}>Regional</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="edit-business-activity" class="required">Business Activity</label>
                                <input type="text" id="edit-business-activity" name="business_activity" value="${profile.business_activity || ''}" placeholder="e.g. Transport, Service" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-coop-contact" class="required">Contact Number</label>
                                <input type="tel" id="edit-coop-contact" name="coop_contact" value="${profile.mobile_number || ''}" placeholder="09*********" required>
                            </div>
                            <div class="form-group">
                                <label for="edit-coop-email" class="required">Email Address</label>
                                <input type="email" id="edit-coop-email" name="coop_email" value="${profile.email_address || ''}" placeholder="sample@gmail.com" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-cda-reg-num" class="required">CDA Registration No.</label>
                                <input type="text" id="edit-cda-reg-num" name="cda_reg_num" value="${profile.cda_registration_number || ''}" placeholder="****-*********" required>
                            </div>
                            <div class="form-group">
                                <label for="edit-cda-reg-date" class="required">Registration Date</label>
                                <input type="date" id="edit-cda-reg-date" name="cda_reg_date" value="${profile.cda_registration_date || ''}" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="required">LCCDC Membership</label>
                                <div class="form-check-group">
                                    <label class="radio-container">Yes
                                        <input type="radio" name="lccdc_membership" value="yes" ${profile.lccdc_membership ? 'checked' : ''} required>
                                        <span class="checkmark"></span>
                                    </label>
                                    <label class="radio-container">No
                                        <input type="radio" name="lccdc_membership" value="no" ${!profile.lccdc_membership ? 'checked' : ''} required>
                                        <span class="checkmark"></span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="form-group lccdc-membership-date" style="display: ${profile.lccdc_membership ? 'block' : 'none'};">
                                <label for="edit-lccdc-membership-date" class="required">LCCDC Membership Date</label>
                                <input type="date" id="edit-lccdc-membership-date" name="lccdc_membership_date" value="${profile.lccdc_membership_date || ''}">
                            </div>
                            
                            <div class="form-group lccdc-not-member" style="display: ${!profile.lccdc_membership ? 'block' : 'none'};">
                                <p style="font-size:0.9rem; font-style:italic; margin:0;">Not an LCCDC member.</p>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-num-bod" class="required">No. of Board Directors</label>
                                <input type="number" id="edit-num-bod" name="num_bod" value="${profile.board_of_directors_count || 0}" placeholder="0" required>
                            </div>
                            <div class="form-group">
                                <label for="edit-num-se" class="required">No. of Salaried Employees</label>
                                <input type="number" id="edit-num-se" name="num_se" value="${profile.salaried_employees_count || 0}" placeholder="0" required>
                            </div>
                        </div>
                        
                        <div class="form-row checkbox-row">
                            <div class="form-group">
                                <label class="required">Certificate of Compliance</label>
                                <div class="form-check-group">
                                    <label class="radio-container">Yes
                                        <input type="radio" name="coc" value="yes" ${profile.coc_renewal ? 'checked' : ''} required>
                                        <span class="checkmark"></span>
                                    </label>
                                    <label class="radio-container">No
                                        <input type="radio" name="coc" value="no" ${!profile.coc_renewal ? 'checked' : ''} required>
                                        <span class="checkmark"></span>
                                    </label>
                                </div>
                                
                                <div class="file-upload-single-modern coc-file-group" style="display: ${profile.coc_renewal ? 'block' : 'none'}; margin-top: 1rem;">
                                    <div class="file-upload-area-single" id="edit-coc-upload-area">
                                        <input type="file" id="edit-coc-file" name="coc_file" class="file-input-hidden" accept=".pdf,image/*,.doc,.docx,.xls,.xlsx" ${profile.coc_attachment_exists ? 'data-has-file="true"' : ''}>
                                        <div class="file-upload-content-single">
                                            <i class="bi bi-file-earmark-pdf"></i>
                                            <p class="upload-text-single">Upload Certificate of Compliance</p>
                                            <p class="upload-hint-single">PDF, DOC, DOCX, XLS, XLSX, Images</p>
                                            ${profile.coc_attachment_exists ? '<p class="upload-note"><i class="bi bi-check-circle"></i> File already uploaded (upload new to replace)</p>' : ''}
                                        </div>
                                    </div>
                                    <div class="file-name-display" id="edit-coc-file-name"></div>
                                    ${profile.coc_attachment_exists ? '<button type="button" class="btn btn-sm btn-danger mt-2" onclick="document.getElementById(\'remove-coc-flag\').value=\'true\'">Remove Current File</button><input type="hidden" id="remove-coc-flag" name="remove_coc" value="false">' : ''}
                                </div>
                                <div class="not-available coc-not-available" style="display: ${!profile.coc_renewal ? 'block' : 'none'}; margin-top:.5rem;">
                                    <p style="font-size:0.9rem; font-style:italic; margin:0;">Please upload renewed certificate ASAP.</p>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="required">Certificate of Tax Exemption</label>
                                <div class="form-check-group">
                                    <label class="radio-container">Yes
                                        <input type="radio" name="cte" value="yes" ${profile.cote_renewal ? 'checked' : ''} required>
                                        <span class="checkmark"></span>
                                    </label>
                                    <label class="radio-container">No
                                        <input type="radio" name="cte" value="no" ${!profile.cote_renewal ? 'checked' : ''} required>
                                        <span class="checkmark"></span>
                                    </label>
                                </div>
                                
                                <div class="file-upload-single-modern cte-file-group" style="display: ${profile.cote_renewal ? 'block' : 'none'}; margin-top: 1rem;">
                                    <div class="file-upload-area-single" id="edit-cte-upload-area">
                                        <input type="file" id="edit-cte-file" name="cte_file" class="file-input-hidden" accept=".pdf,image/*,.doc,.docx,.xls,.xlsx" ${profile.cote_attachment_exists ? 'data-has-file="true"' : ''}>
                                        <div class="file-upload-content-single">
                                            <i class="bi bi-file-earmark-pdf"></i>
                                            <p class="upload-text-single">Upload Certificate of Tax Exemption</p>
                                            <p class="upload-hint-single">PDF, DOC, DOCX, XLS, XLSX, Images</p>
                                            ${profile.cote_attachment_exists ? '<p class="upload-note"><i class="bi bi-check-circle"></i> File already uploaded (upload new to replace)</p>' : ''}
                                        </div>
                                    </div>
                                    <div class="file-name-display" id="edit-cte-file-name"></div>
                                    ${profile.cote_attachment_exists ? '<button type="button" class="btn btn-sm btn-danger mt-2" onclick="document.getElementById(\'remove-cte-flag\').value=\'true\'">Remove Current File</button><input type="hidden" id="remove-cte-flag" name="remove_cte" value="false">' : ''}
                                </div>
                                <div class="not-available cte-not-available" style="display: ${!profile.cote_renewal ? 'block' : 'none'}; margin-top:.5rem;">
                                    <p style="font-size:0.9rem; font-style:italic; margin:0;">Please upload renewed certificate ASAP.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="section-header">
                            <i class="bi bi-currency-dollar"></i>
                            <h5>Financial Records</h5>
                        </div>
                        
                        <div class="form-group">
                            <label class="required">Please upload documents for Assets, Net Surplus, and Paid Up Capital AND enter the amounts below.</label>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="edit-assets-value" class="required">Assets (PHP)</label>
                                    <input type="text" id="edit-assets-value" name="assets_value" value="${financial.assets || '0.00'}" inputmode="decimal" placeholder="0.00" required>
                                </div>
                                <div class="form-group">
                                    <label for="edit-paid-up-capital-value" class="required">Paid Up Capital (PHP)</label>
                                    <input type="text" id="edit-paid-up-capital-value" name="paid_up_capital_value" value="${financial.paid_up_capital || '0.00'}" inputmode="decimal" placeholder="0.00" required>
                                </div>
                                <div class="form-group">
                                    <label for="edit-net-surplus-value" class="required">Net Surplus (PHP)</label>
                                    <input type="text" id="edit-net-surplus-value" name="net_surplus_value" value="${financial.net_surplus || '0.00'}" inputmode="decimal" placeholder="0.00" required>
                                </div>
                            </div>
                            
                            <div class="file-upload-modern">
                                <div class="file-upload-area" id="edit-financial-upload-area">
                                    <input type="file" id="edit-financial-docs" name="financial_documents" class="file-input-hidden" multiple accept=".pdf,image/*,.doc,.docx,.xls,.xlsx">
                                    <div class="file-upload-content">
                                        <i class="bi bi-cloud-upload"></i>
                                        <p class="upload-text">Click to upload or drag and drop</p>
                                        <p class="upload-hint">PDF, DOC, DOCX, XLS, XLSX, Images (Multiple files allowed)</p>
                                        ${financial.financial_attachments_exist ? '<p class="upload-note"><i class="bi bi-info-circle"></i> Previous documents exist. Uploading new files will append to the record.</p>' : ''}
                                    </div>
                                </div>
                                <div id="edit-file-preview-container" class="file-preview-container">
                                    <div class="no-files">No files selected</div>
                                </div>
                                ${financial.financial_attachments_exist ? '<button type="button" class="btn btn-sm btn-danger mt-2" onclick="document.getElementById(\'remove-financial-flag\').value=\'true\'">Remove Current Files</button><input type="hidden" id="remove-financial-flag" name="remove_financial" value="false">' : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="section-header">
                            <i class="bi bi-people"></i>
                            <h5>Cooperative Officers</h5>
                        </div>
                        <p class="input-instruction">These officers are already registered. (Read-only)</p>
                        <div class="input-table-container">
                            <table class="input-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Position</th>
                                        <th>Gender</th>
                                        <th>Mobile Number</th>
                                        <th>Email</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${officers.map(o => `
                                        <tr>
                                            <td><input type="text" value="${o.fullname || ''}" readonly style="background-color: #f8f9fa;"></td>
                                            <td><input type="text" value="${o.position || ''}" readonly style="background-color: #f8f9fa;"></td>
                                            <td><input type="text" value="${o.gender || ''}" readonly style="background-color: #f8f9fa;"></td>
                                            <td><input type="text" value="${o.mobile_number || ''}" readonly style="background-color: #f8f9fa;"></td>
                                            <td><input type="email" value="${o.email || ''}" readonly style="background-color: #f8f9fa;"></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="section-header">
                            <i class="bi bi-person-badge"></i>
                            <h5>Cooperative Members</h5>
                        </div>
                        <p class="input-instruction">List of members. (At least one entry required)</p>
                        <div class="input-table-container">
                            <table class="input-table">
                                <thead>
                                    <tr>
                                        <th class="required">Name</th>
                                        <th class="required">Gender</th>
                                        <th class="required">Mobile Number</th>
                                        <th style="width: 50px; text-align: center;">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="edit-members-tbody">
                                    ${members.map(m => `
                                        <tr>
                                            <td><input type="text" name="member_name[]" value="${m.fullname || ''}" placeholder="Full Name" required></td>
                                            <td>
                                                <select name="member_gender[]" required>
                                                    <option value="">Select</option>
                                                    <option value="Male" ${(m.gender || '').toLowerCase() === 'male' ? 'selected' : ''}>Male</option>
                                                    <option value="Female" ${(m.gender || '').toLowerCase() === 'female' ? 'selected' : ''}>Female</option>
                                                </select>
                                            </td>
                                            <td><input type="text" name="member_mobile[]" value="${m.mobile_number || ''}" placeholder="09xxxxxxxxx" required></td>
                                            <td style="text-align: center;">
                                                <button type="button" class="remove-row-btn" title="Remove row" style="background: #dc3545; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 0.9rem;">
                                                    <i class="bi bi-x-circle"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                    ${members.length === 0 ? `
                                        <tr>
                                            <td><input type="text" name="member_name[]" placeholder="Full Name" required></td>
                                            <td>
                                                <select name="member_gender[]" required>
                                                    <option value="">Select</option>
                                                    <option value="Male">Male</option>
                                                    <option value="Female">Female</option>
                                                </select>
                                            </td>
                                            <td><input type="text" name="member_mobile[]" placeholder="09xxxxxxxxx" required></td>
                                            <td style="text-align: center;">
                                                <button type="button" class="remove-row-btn" title="Remove row" style="background: #dc3545; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 0.9rem;">
                                                    <i class="bi bi-x-circle"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    ` : ''}
                                </tbody>
                            </table>
                            <button type="button" class="add-row-btn"><i class="bi bi-plus-circle"></i> Add Row</button>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="submit-btn" id="saveEditProfileBtn">
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            <i class="bi bi-save"></i> Save Profile
                        </button>
                    </div>
                </form>
            `;
            
            // Initialize form handlers
            initializeEditFormHandlers();
            
            // Also set up event listener for add row button (backup method)
            setTimeout(() => {
                const addRowBtn = document.querySelector('#edit-profile-form-container .add-row-btn');
                if (addRowBtn) {
                    // Remove existing onclick and add event listener
                    addRowBtn.removeAttribute('onclick');
                    addRowBtn.addEventListener('click', function() {
                        window.addMemberRow();
                    });
                }
            }, 100);
        }

        // Make addMemberRow globally accessible
        window.addMemberRow = function() {
            const tbody = document.getElementById('edit-members-tbody');
            if (!tbody) {
                console.error('edit-members-tbody not found');
                return;
            }
            const firstRow = tbody.querySelector('tr');
            if (!firstRow) {
                console.error('No rows found in tbody');
                return;
            }
            const newRow = firstRow.cloneNode(true);
            newRow.querySelectorAll('input').forEach(input => {
                input.value = '';
                // Remove any validation states
                input.classList.remove('is-invalid', 'is-valid');
            });
            newRow.querySelectorAll('select').forEach(select => {
                select.selectedIndex = 0;
                select.classList.remove('is-invalid', 'is-valid');
            });
            // Ensure remove button is present in new row
            const actionCell = newRow.querySelector('td:last-child');
            if (actionCell && !actionCell.querySelector('.remove-row-btn')) {
                actionCell.innerHTML = '<button type="button" class="remove-row-btn" title="Remove row" style="background: #dc3545; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 0.9rem;"><i class="bi bi-x-circle"></i></button>';
                actionCell.style.textAlign = 'center';
            }
            tbody.appendChild(newRow);
            updateRemoveButtonsVisibility(tbody);
        };
        
        // Function to update remove button visibility
        function updateRemoveButtonsVisibility(tbody) {
            const rows = tbody.querySelectorAll('tr');
            const rowCount = rows.length;
            rows.forEach(row => {
                const removeBtn = row.querySelector('.remove-row-btn');
                if (removeBtn) {
                    if (rowCount <= 1) {
                        removeBtn.style.display = 'none';
                    } else {
                        removeBtn.style.display = 'inline-block';
                    }
                }
            });
        }

        function initializeEditFormHandlers() {
            // Add row button event listener (using same approach as profile_form.html)
            const addRowBtn = document.querySelector('#edit-profile-form-container .add-row-btn');
            if (addRowBtn) {
                addRowBtn.addEventListener('click', function() {
                    // Use the same logic as profile_form.html
                    const tableBody = this.previousElementSibling.querySelector('tbody');
                    if (!tableBody) {
                        // Fallback to using the ID
                        const tbody = document.getElementById('edit-members-tbody');
                        if (tbody) {
                            const firstRow = tbody.querySelector('tr');
                            if (firstRow) {
                                const newRow = firstRow.cloneNode(true);
                                newRow.querySelectorAll('input').forEach(input => {
                                    input.value = '';
                                    input.classList.remove('is-invalid', 'is-valid');
                                });
                                newRow.querySelectorAll('select').forEach(select => {
                                    select.selectedIndex = 0;
                                    select.classList.remove('is-invalid', 'is-valid');
                                });
                                // Ensure remove button is present in new row
                                const actionCell = newRow.querySelector('td:last-child');
                                if (actionCell && !actionCell.querySelector('.remove-row-btn')) {
                                    actionCell.innerHTML = '<button type="button" class="remove-row-btn" title="Remove row" style="background: #dc3545; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 0.9rem;"><i class="bi bi-x-circle"></i></button>';
                                    actionCell.style.textAlign = 'center';
                                }
                                tbody.appendChild(newRow);
                                updateRemoveButtonsVisibility(tbody);
                            }
                        }
                        return;
                    }
                    const firstRow = tableBody.querySelector('tr');
                    if (!firstRow) return;
                    
                    const newRow = firstRow.cloneNode(true);
                    newRow.querySelectorAll('input').forEach(input => {
                        input.value = '';
                        input.classList.remove('is-invalid', 'is-valid');
                    });
                    newRow.querySelectorAll('select').forEach(select => {
                        select.selectedIndex = 0;
                        select.classList.remove('is-invalid', 'is-valid');
                    });
                    // Ensure remove button is present in new row
                    const actionCell = newRow.querySelector('td:last-child');
                    if (actionCell && !actionCell.querySelector('.remove-row-btn')) {
                        actionCell.innerHTML = '<button type="button" class="remove-row-btn" title="Remove row" style="background: #dc3545; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 0.9rem;"><i class="bi bi-x-circle"></i></button>';
                        actionCell.style.textAlign = 'center';
                    }
                    tableBody.appendChild(newRow);
                    updateRemoveButtonsVisibility(tableBody);
                });
            }
            
            // LCCDC membership toggle
            const lccdcRadios = document.querySelectorAll('#editProfileForm input[name="lccdc_membership"]');
            const lccdcDateGroup = document.querySelector('#editProfileForm .lccdc-membership-date');
            const lccdcNotMember = document.querySelector('#editProfileForm .lccdc-not-member');
            
            lccdcRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'yes') {
                        if (lccdcDateGroup) lccdcDateGroup.style.display = 'block';
                        if (lccdcNotMember) lccdcNotMember.style.display = 'none';
                    } else {
                        if (lccdcDateGroup) lccdcDateGroup.style.display = 'none';
                        if (lccdcNotMember) lccdcNotMember.style.display = 'block';
                    }
                });
            });
            
            // Certificate toggles
            const cocRadios = document.querySelectorAll('#editProfileForm input[name="coc"]');
            const cocFileGroup = document.querySelector('#editProfileForm .coc-file-group');
            const cocNotAvail = document.querySelector('#editProfileForm .coc-not-available');
            
            cocRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'yes') {
                        if (cocFileGroup) cocFileGroup.style.display = 'block';
                        if (cocNotAvail) cocNotAvail.style.display = 'none';
                    } else {
                        if (cocFileGroup) cocFileGroup.style.display = 'none';
                        if (cocNotAvail) cocNotAvail.style.display = 'block';
                    }
                });
            });
            
            const cteRadios = document.querySelectorAll('#editProfileForm input[name="cte"]');
            const cteFileGroup = document.querySelector('#editProfileForm .cte-file-group');
            const cteNotAvail = document.querySelector('#editProfileForm .cte-not-available');
            
            cteRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'yes') {
                        if (cteFileGroup) cteFileGroup.style.display = 'block';
                        if (cteNotAvail) cteNotAvail.style.display = 'none';
                    } else {
                        if (cteFileGroup) cteFileGroup.style.display = 'none';
                        if (cteNotAvail) cteNotAvail.style.display = 'block';
                    }
                });
            });
            
            // File upload handlers (similar to profile_form.html)
            setupFileUploadHandlers();
            
            // Set up remove row button handlers using event delegation
            const formContainer = document.getElementById('edit-profile-form-container');
            if (formContainer) {
                formContainer.addEventListener('click', function(e) {
                    const removeBtn = e.target.closest('.remove-row-btn');
                    if (removeBtn) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const row = removeBtn.closest('tr');
                        if (!row) return;
                        
                        const tbody = row.closest('tbody');
                        if (!tbody) return;
                        
                        // Check if this is the last row
                        const rowCount = tbody.querySelectorAll('tr').length;
                        if (rowCount <= 1) {
                            showNotification('At least one member is required', 'warning');
                            return;
                        }
                        
                        // Remove the row
                        row.remove();
                        updateRemoveButtonsVisibility(tbody);
                    }
                });
            }
            
            // Update remove button visibility on initial load
            const membersTbody = document.getElementById('edit-members-tbody');
            if (membersTbody) {
                updateRemoveButtonsVisibility(membersTbody);
            }
            
            // Form submission
            const form = document.getElementById('editProfileForm');
            if (form) {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const saveBtn = document.getElementById('saveEditProfileBtn');
                    const spinner = saveBtn.querySelector('.spinner-border');
                    
                    saveBtn.disabled = true;
                    if (spinner) spinner.classList.remove('d-none');
                    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
                    
                    const formData = new FormData(form);
                    
                    try {
                        const response = await fetch(form.action, {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest',
                                'X-CSRFToken': getCsrfToken()
                            },
                            credentials: 'include'
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            showNotification('Profile updated successfully!', 'success');
                            bootstrap.Modal.getInstance(document.getElementById('editProfileModal')).hide();
                            // Reload profile modal if open
                            if (currentEditProfileId) {
                                setTimeout(() => {
                                    loadProfileModal(currentEditProfileId, null);
                                }, 500);
                            }
                            location.reload();
                        } else {
                            showNotification('Error: ' + (data.error || 'Failed to update profile'), 'error');
                            saveBtn.disabled = false;
                            saveBtn.innerHTML = '<i class="bi bi-save"></i> Save Profile';
                            if (spinner) spinner.classList.add('d-none');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        showNotification('An error occurred while saving. Please try again.', 'error');
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = '<i class="bi bi-save"></i> Save Profile';
                        if (spinner) spinner.classList.add('d-none');
                    }
                });
            }
        }

        function setupFileUploadHandlers() {
            // Single file uploads (CoC, CTE) - similar to profile_form.html
            const cocFile = document.getElementById('edit-coc-file');
            const cteFile = document.getElementById('edit-cte-file');
            
            [cocFile, cteFile].forEach(fileInput => {
                if (!fileInput) return;
                const display = fileInput.parentElement.querySelector('.file-name-display');
                
                fileInput.addEventListener('change', function() {
                    if (this.files && this.files.length > 0) {
                        if (display) {
                            display.innerHTML = `
                                <div class="file-name-item">
                                    <div class="file-name-content">
                                        <i class="bi bi-check-circle"></i>
                                        <span class="file-name-text">${this.files[0].name}</span>
                                    </div>
                                    <button type="button" class="remove-single-file-btn" onclick="this.parentElement.parentElement.remove(); this.closest('input[type=file]').value='';">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                            `;
                            display.classList.add('has-file');
                        }
                    }
                });
            });
            
            // Financial documents (multiple files)
            const financialFileInput = document.getElementById('edit-financial-docs');
            const previewContainer = document.getElementById('edit-file-preview-container');
            
            if (financialFileInput && previewContainer) {
                window.editFinancialFiles = [];
                
                financialFileInput.addEventListener('change', function() {
                    const newFiles = Array.from(this.files);
                    newFiles.forEach(file => {
                        if (!window.editFinancialFiles.some(f => f.name === file.name && f.size === file.size)) {
                            window.editFinancialFiles.push(file);
                        }
                    });
                    updateFinancialFileInput();
                    renderFinancialPreviews();
                });
                
                function updateFinancialFileInput() {
                    const dt = new DataTransfer();
                    window.editFinancialFiles.forEach(file => dt.items.add(file));
                    financialFileInput.files = dt.files;
                }
                
                function renderFinancialPreviews() {
                    previewContainer.innerHTML = '';
                    if (window.editFinancialFiles.length === 0) {
                        previewContainer.innerHTML = '<div class="no-files">No files selected</div>';
                        return;
                    }
                    window.editFinancialFiles.forEach((file, index) => {
                        const item = document.createElement('div');
                        item.className = 'file-preview-item';
                        item.innerHTML = `
                            <div class="file-info-wrapper">
                                <i class="bi bi-file-earmark-text"></i>
                                <span class="file-name">${file.name}</span>
                            </div>
                            <button type="button" class="remove-file-btn" data-index="${index}">
                                <i class="bi bi-x"></i>
                            </button>
                        `;
                        const removeBtn = item.querySelector('.remove-file-btn');
                        removeBtn.addEventListener('click', function() {
                            window.editFinancialFiles.splice(parseInt(this.getAttribute('data-index')), 1);
                            updateFinancialFileInput();
                            renderFinancialPreviews();
                        });
                        previewContainer.appendChild(item);
                    });
                }
            }
        }

        // Undo/Redo button handlers
        document.getElementById('undo-btn')?.addEventListener('click', undoFormState);
        document.getElementById('redo-btn')?.addEventListener('click', redoFormState);

        // ===== SEARCH FUNCTIONALITY =====
        const searchCoopInput = document.getElementById('searchCoopInput');
        if (searchCoopInput) {
            searchCoopInput.addEventListener('input', function (e) {
                const searchTerm = e.target.value.toLowerCase();
                
                // Search in active cooperatives table
                const activeRows = document.querySelectorAll('#cooperatives-table tbody tr');
                activeRows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
                
                // Search in deactivated cooperatives table
                const deactivatedRows = document.querySelectorAll('#deactivated-cooperatives-table tbody tr');
                deactivatedRows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });
        }

        const searchProfileInput = document.getElementById('searchProfileInput');
        if (searchProfileInput) {
            searchProfileInput.addEventListener('input', function (e) {
                const searchTerm = e.target.value.toLowerCase();
                const rows = document.querySelectorAll('#profiles-table tbody tr');
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });
        }

        // ===== FILE PREVIEW FUNCTIONALITY (Complete from profile management) =====
        const previewModal = document.getElementById('preview-modal');
        const previewBody = document.getElementById('preview-body');
        const previewTitle = document.getElementById('preview-title');
        const previewClose = document.getElementById('preview-close');
        const previewDownload = document.getElementById('preview-download-main');
        
        let pdfDoc = null;
        let currentPage = 1;
        let totalPages = 0;
        let currentZoom = 100;
        let currentRotation = 0;
        let isPdfOpen = false;
        const previewSidebar = document.getElementById('preview-sidebar');
        const previewThumbnails = document.getElementById('preview-thumbnails');
        
        // Multiple file navigation
        let totalFiles = 0;
        let currentFileIndex = 0;
        let currentPreviewUrl = '';
        let currentFilename = '';
        let fileList = [];

        // Close preview modal
        if (previewClose) {
            previewClose.addEventListener('click', () => {
                previewModal.style.display = 'none';
                previewModal.classList.remove('show');
                if (pdfDoc) {
                    pdfDoc.destroy();
                    pdfDoc = null;
                }
            });
        }

        // Close on overlay click
        if (previewModal) {
            previewModal.addEventListener('click', (e) => {
                if (e.target === previewModal) {
                    previewModal.style.display = 'none';
                    previewModal.classList.remove('show');
                    if (pdfDoc) {
                        pdfDoc.destroy();
                        pdfDoc = null;
                    }
                }
            });
        }

        // Escape key to close
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && previewModal && previewModal.style.display !== 'none') {
                previewModal.style.display = 'none';
                previewModal.classList.remove('show');
                if (pdfDoc) {
                    pdfDoc.destroy();
                    pdfDoc = null;
                }
            }
        });

        // Load PDF with PDF.js
        async function loadPdfPreview(url, title, fileIndex = 0) {
            previewBody.innerHTML = '<p style="color:#6c757d; font-size:1rem;">Loading document...</p>';
            
            try {
                if (!window.pdfjsLib) {
                    throw new Error('PDF.js library not loaded');
                }

                // First, fetch the URL to check if it's accessible
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (!response.ok) {
                    let errorMsg = `Unexpected server response (${response.status})`;
                    try {
                        const text = await response.text();
                        if (text) {
                            try {
                                const data = JSON.parse(text);
                                errorMsg = data.message || errorMsg;
                            } catch (e) {
                                errorMsg = `Server error: ${response.status}`;
                            }
                        }
                    } catch (e) {
                        errorMsg = `Server error: ${response.status}`;
                    }
                    throw new Error(errorMsg);
                }

                // Check content type
                const contentType = response.headers.get('Content-Type') || '';
                if (!contentType.includes('pdf')) {
                    // Try to get blob and create object URL
                    const blob = await response.blob();
                    const blobUrl = URL.createObjectURL(blob);
                    loadPdfFromBlob(blobUrl, title);
                    return;
                }

                // Check for multiple files header
                const fileCount = response.headers.get('X-File-Count');
                const currentIndex = response.headers.get('X-Current-File-Index');
                
                if (fileCount) {
                    totalFiles = parseInt(fileCount);
                    if (currentIndex !== null) {
                        currentFileIndex = parseInt(currentIndex);
                    }
                    updateFileNavigation();
                }

                const loadingTask = window.pdfjsLib.getDocument(url);
                pdfDoc = await loadingTask.promise;
                totalPages = pdfDoc.numPages;
                currentPage = 1;
                currentZoom = 100;
                currentRotation = 0;
                isPdfOpen = true;

                document.getElementById('page-controls').style.display = 'flex';
                document.getElementById('toggleSidebar').style.display = 'inline-flex';
                document.getElementById('rotateLeft').style.display = 'inline-flex';
                document.getElementById('rotateRight').style.display = 'inline-flex';
                document.getElementById('fitWidth').style.display = 'inline-flex';
                document.getElementById('fitHeight').style.display = 'inline-flex';
                document.getElementById('zoomOut').style.display = 'inline-flex';
                document.getElementById('zoomLevel').style.display = 'inline-block';
                document.getElementById('zoomIn').style.display = 'inline-flex';
                document.getElementById('totalPages').textContent = totalPages;
                document.getElementById('pageInput').value = 1;
                document.getElementById('zoomLevel').textContent = '100%';
                
                // Update title if multiple files
                if (totalFiles > 1) {
                    previewTitle.textContent = `${title} (${currentFileIndex + 1} of ${totalFiles})`;
                }

                await renderPdfPage(1);
                await generateThumbnails();
            } catch (error) {
                console.error('PDF loading error:', error);
                previewBody.innerHTML = `
                    <div style="padding: 40px; text-align: center;">
                        <i class="bi bi-exclamation-triangle" style="font-size: 4rem; color: #dc3545; margin-bottom: 20px;"></i>
                        <h4 style="color: #495057; margin-bottom: 10px;">Failed to Load Document</h4>
                        <p style="color: #6c757d; margin-bottom: 20px;">${escapeHtml(error.message)}</p>
                        <a href="${url.replace('?preview=true', '?download=1')}" class="btn btn-primary mt-3" download="${title}">
                            <i class="bi bi-download"></i> Download Instead
                        </a>
                    </div>
                `;
            }
        }

        async function renderPdfPage(pageNum) {
            if (!pdfDoc) return;
            
            try {
                const page = await pdfDoc.getPage(pageNum);
                const baseScale = 1.5;
                const finalScale = (currentZoom / 100) * baseScale;
                const viewport = page.getViewport({ scale: finalScale, rotation: currentRotation });
                
                let canvas = previewBody.querySelector('canvas');
                if (!canvas) {
                    canvas = document.createElement('canvas');
                    previewBody.innerHTML = '';
                    previewBody.appendChild(canvas);
                }
                
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                canvas.style.display = 'block';
                canvas.style.maxWidth = 'none';
                canvas.style.maxHeight = 'none';
                canvas.style.width = viewport.width + 'px';
                canvas.style.height = viewport.height + 'px';
                canvas.style.margin = '20px auto';
                canvas.style.boxShadow = '0 2px 8px rgba(0,0,0,0.3)';
                canvas.style.background = 'white';

                const renderContext = {
                    canvasContext: canvas.getContext('2d'),
                    viewport: viewport
                };

                await page.render(renderContext).promise;
                
                previewBody.scrollTop = 0;
                previewBody.scrollLeft = 0;
                document.getElementById('pageInput').value = pageNum;
                updateThumbnailActive();
            } catch (error) {
                console.error('Page render error:', error);
                previewBody.innerHTML = `<p style="color:#d32f2f;">Error rendering page: ${error.message}</p>`;
            }
        }
        
        function applyZoom() {
            document.getElementById('zoomLevel').textContent = currentZoom + '%';
            if (isPdfOpen && pdfDoc) {
                renderPdfPage(currentPage);
            }
        }
        
        function updateThumbnailActive() {
            if (!previewThumbnails) return;
            const thumbnails = previewThumbnails.querySelectorAll('.thumbnail-item');
            thumbnails.forEach((thumb, index) => {
                if (index + 1 === currentPage) {
                    thumb.classList.add('active');
                } else {
                    thumb.classList.remove('active');
                }
            });
        }
        
        async function generateThumbnails() {
            if (!pdfDoc || !previewThumbnails) return;
            
            previewThumbnails.innerHTML = '';
            
            for (let i = 1; i <= totalPages; i++) {
                try {
                    const page = await pdfDoc.getPage(i);
                    const viewport = page.getViewport({ scale: 0.2 });
                    
                    const canvas = document.createElement('canvas');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    
                    const context = canvas.getContext('2d');
                    await page.render({
                        canvasContext: context,
                        viewport: viewport
                    }).promise;
                    
                    const thumbnail = document.createElement('div');
                    thumbnail.className = 'thumbnail-item';
                    if (i === currentPage) thumbnail.classList.add('active');
                    thumbnail.dataset.page = i;
                    
                    thumbnail.innerHTML = `
                        <div class="thumbnail-number">${i}</div>
                        <img src="${canvas.toDataURL()}" alt="Page ${i}" />
                    `;
                    
                    thumbnail.addEventListener('click', () => {
                        currentPage = i;
                        renderPdfPage(currentPage);
                        updateThumbnailActive();
                    });
                    
                    previewThumbnails.appendChild(thumbnail);
                } catch (error) {
                    console.error(`Error generating thumbnail for page ${i}:`, error);
                }
            }
        }

        // Page navigation
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');
        const pageInput = document.getElementById('pageInput');

        if (prevPageBtn) {
            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderPdfPage(currentPage);
                    updateThumbnailActive();
                }
            });
        }

        if (nextPageBtn) {
            nextPageBtn.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderPdfPage(currentPage);
                    updateThumbnailActive();
                }
            });
        }

        if (pageInput) {
            pageInput.addEventListener('change', () => {
                const page = parseInt(pageInput.value);
                if (page >= 1 && page <= totalPages) {
                    currentPage = page;
                    renderPdfPage(currentPage);
                    updateThumbnailActive();
                } else {
                    pageInput.value = currentPage;
                }
            });
            
            pageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const page = parseInt(pageInput.value);
                    if (page >= 1 && page <= totalPages) {
                        currentPage = page;
                        renderPdfPage(currentPage);
                        updateThumbnailActive();
                    } else {
                        pageInput.value = currentPage;
                    }
                }
            });
        }
        
        // Sidebar toggle
        const toggleSidebarBtn = document.getElementById('toggleSidebar');
        if (toggleSidebarBtn) {
            toggleSidebarBtn.addEventListener('click', () => {
                const icon = toggleSidebarBtn.querySelector('i');
                if (previewSidebar && previewSidebar.style.display === 'none') {
                    previewSidebar.style.display = 'flex';
                    if (icon) icon.className = 'bi bi-layout-sidebar-inset';
                } else if (previewSidebar) {
                    previewSidebar.style.display = 'none';
                    if (icon) icon.className = 'bi bi-layout-sidebar';
                }
            });
        }
        
        // Rotation controls
        const rotateLeftBtn = document.getElementById('rotateLeft');
        const rotateRightBtn = document.getElementById('rotateRight');
        
        if (rotateLeftBtn) {
            rotateLeftBtn.addEventListener('click', () => {
                currentRotation = (currentRotation - 90 + 360) % 360;
                applyZoom();
            });
        }
        
        if (rotateRightBtn) {
            rotateRightBtn.addEventListener('click', () => {
                currentRotation = (currentRotation + 90) % 360;
                applyZoom();
            });
        }
        
        // Zoom controls
        const zoomInBtn = document.getElementById('zoomIn');
        const zoomOutBtn = document.getElementById('zoomOut');
        
        if (zoomInBtn) {
            zoomInBtn.addEventListener('click', () => {
                currentZoom = Math.min(300, currentZoom + 10);
                applyZoom();
            });
        }
        
        if (zoomOutBtn) {
            zoomOutBtn.addEventListener('click', () => {
                currentZoom = Math.max(10, currentZoom - 10);
                applyZoom();
            });
        }
        
        // Fit controls
        const fitWidthBtn = document.getElementById('fitWidth');
        const fitHeightBtn = document.getElementById('fitHeight');
        
        async function fitToWidth() {
            if (isPdfOpen && pdfDoc) {
                const page = await pdfDoc.getPage(currentPage);
                const viewport = page.getViewport({ scale: 1.5, rotation: currentRotation });
                const containerWidth = previewBody.clientWidth - 40;
                const scaleToFit = containerWidth / viewport.width;
                currentZoom = Math.round(scaleToFit * 100);
                currentZoom = Math.max(10, Math.min(300, currentZoom));
                applyZoom();
            }
        }
        
        async function fitToHeight() {
            if (isPdfOpen && pdfDoc) {
                const page = await pdfDoc.getPage(currentPage);
                const viewport = page.getViewport({ scale: 1.5, rotation: currentRotation });
                const containerHeight = previewBody.clientHeight - 40;
                const scaleToFit = containerHeight / viewport.height;
                currentZoom = Math.round(scaleToFit * 100);
                currentZoom = Math.max(10, Math.min(300, currentZoom));
                applyZoom();
            }
        }
        
        if (fitWidthBtn) {
            fitWidthBtn.addEventListener('click', fitToWidth);
        }
        
        if (fitHeightBtn) {
            fitHeightBtn.addEventListener('click', fitToHeight);
        }

        // File navigation buttons
        const prevFileBtn = document.getElementById('prev-file-btn');
        const nextFileBtn = document.getElementById('next-file-btn');
        
        function updateFileNavigation() {
            if (totalFiles > 1) {
                if (prevFileBtn) prevFileBtn.style.display = 'flex';
                if (nextFileBtn) nextFileBtn.style.display = 'flex';
                if (prevFileBtn) prevFileBtn.disabled = currentFileIndex === 0;
                if (nextFileBtn) nextFileBtn.disabled = currentFileIndex === totalFiles - 1;
            } else {
                if (prevFileBtn) prevFileBtn.style.display = 'none';
                if (nextFileBtn) nextFileBtn.style.display = 'none';
            }
        }
        
        function loadFileByIndex(index) {
            if (index < 0 || index >= totalFiles) return;
            
            currentFileIndex = index;
            const url = currentPreviewUrl + (currentPreviewUrl.includes('?') ? '&' : '?') + `file_index=${index}`;
            const filename = fileList[index] || currentFilename;
            
            previewTitle.textContent = totalFiles > 1 ? `${filename} (${index + 1} of ${totalFiles})` : filename;
            previewBody.innerHTML = '<p style="color:#6c757d; font-size:1rem;">Loading document...</p>';
            
            // Check if file needs conversion
            const isCsvGz = filename.toLowerCase().endsWith('.csv.gz');
            const isPdfGz = filename.toLowerCase().endsWith('.pdf.gz');
            const needsConversion = filename.toLowerCase().match(/\.(docx?|xlsx?|xlsm|xlsb|pptx?|txt|csv)$/i);
            
            if (isCsvGz || isPdfGz || needsConversion) {
                convertAndPreviewProfile(url, filename, index);
            } else {
                loadPdfPreview(url, filename, index);
            }
        }
        
        if (prevFileBtn) {
            prevFileBtn.addEventListener('click', () => {
                if (currentFileIndex > 0) {
                    loadFileByIndex(currentFileIndex - 1);
                }
            });
        }
        
        if (nextFileBtn) {
            nextFileBtn.addEventListener('click', () => {
                if (currentFileIndex < totalFiles - 1) {
                    loadFileByIndex(currentFileIndex + 1);
                }
            });
        }

        async function convertAndPreviewProfile(url, title, fileIndex = 0) {
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (!response.ok) {
                    let errorMsg = 'Failed to load document';
                    try {
                        const data = await response.json();
                        errorMsg = data.message || errorMsg;
                    } catch (e) {
                        errorMsg = `Server error: ${response.status}`;
                    }
                    throw new Error(errorMsg);
                }

                // Check for multiple files header
                const fileCount = response.headers.get('X-File-Count');
                const currentIndex = response.headers.get('X-Current-File-Index');
                
                if (fileCount) {
                    totalFiles = parseInt(fileCount);
                    if (currentIndex !== null) {
                        currentFileIndex = parseInt(currentIndex);
                    }
                    updateFileNavigation();
                }

                // Check conversion status
                const conversionStatus = response.headers.get('X-Conversion-Status');
                const blob = await response.blob();
                const blobUrl = URL.createObjectURL(blob);
                const contentType = response.headers.get('Content-Type') || '';
                
                // Check if it's a decompressed or converted PDF
                const isPdfGz = title && title.toLowerCase().endsWith('.pdf.gz');
                const isDecompressedPdf = conversionStatus === 'decompressed' || conversionStatus === 'converted' || isPdfGz;

                // If it's a converted/decompressed PDF, load it
                if (isDecompressedPdf && contentType.includes('pdf')) {
                    const pdfFilename = title.replace(/\.gz$/i, '').replace(/\.[^.]+$/, '.pdf');
                    previewDownload.href = blobUrl;
                    previewDownload.download = pdfFilename;
                    if (totalFiles > 1) {
                        previewTitle.textContent = `${pdfFilename} (${currentFileIndex + 1} of ${totalFiles})`;
                    }
                    loadPdfFromBlob(blobUrl, pdfFilename);
                    return;
                }

                // If conversion failed, show error with download option
                if (conversionStatus === 'failed' || !contentType.includes('pdf')) {
                    previewBody.innerHTML = `
                        <div style="padding: 40px; text-align: center;">
                            <i class="bi bi-file-earmark" style="font-size: 4rem; color: #6c757d; margin-bottom: 20px;"></i>
                            <h4 style="color: #495057; margin-bottom: 10px;">${escapeHtml(title)}</h4>
                            <p style="color: #6c757d; margin-bottom: 20px;">This file cannot be previewed in the browser.</p>
                            <p style="color: #6c757d; font-size: 0.9rem;">Please download the file to view it.</p>
                        </div>
                    `;
                    previewDownload.href = url.replace('?preview=true', '?download=1');
                    previewDownload.download = title;
                    return;
                }

                // Try to load as PDF
                loadPdfFromBlob(blobUrl, title);
            } catch (error) {
                console.error('Conversion error:', error);
                previewBody.innerHTML = `
                    <div style="padding: 40px; text-align: center;">
                        <i class="bi bi-exclamation-triangle" style="font-size: 4rem; color: #dc3545; margin-bottom: 20px;"></i>
                        <h4 style="color: #495057; margin-bottom: 10px;">Failed to Load Document</h4>
                        <p style="color: #6c757d; margin-bottom: 20px;">${escapeHtml(error.message)}</p>
                        <a href="${url.replace('?preview=true', '?download=1')}" class="btn btn-primary mt-3" download="${title}">
                            <i class="bi bi-download"></i> Download Instead
                        </a>
                    </div>
                `;
            }
        }
        
        function loadPdfFromBlob(blobUrl, title) {
            previewBody.innerHTML = '<p style="color:#6c757d; font-size:1rem;">Loading document...</p>';
            
            if (!window.pdfjsLib) {
                previewBody.innerHTML = `
                    <div style="padding: 40px; text-align: center;">
                        <i class="bi bi-exclamation-triangle" style="font-size: 4rem; color: #dc3545; margin-bottom: 20px;"></i>
                        <h4 style="color: #495057; margin-bottom: 10px;">PDF.js library not loaded</h4>
                    </div>
                `;
                return;
            }

            const loadingTask = window.pdfjsLib.getDocument(blobUrl);
            loadingTask.promise.then(doc => {
                pdfDoc = doc;
                totalPages = pdfDoc.numPages;
                currentPage = 1;
                currentZoom = 100;
                currentRotation = 0;
                isPdfOpen = true;

                document.getElementById('page-controls').style.display = 'flex';
                document.getElementById('toggleSidebar').style.display = 'inline-flex';
                document.getElementById('rotateLeft').style.display = 'inline-flex';
                document.getElementById('rotateRight').style.display = 'inline-flex';
                document.getElementById('fitWidth').style.display = 'inline-flex';
                document.getElementById('fitHeight').style.display = 'inline-flex';
                document.getElementById('zoomOut').style.display = 'inline-flex';
                document.getElementById('zoomLevel').style.display = 'inline-block';
                document.getElementById('zoomIn').style.display = 'inline-flex';
                document.getElementById('totalPages').textContent = totalPages;
                document.getElementById('pageInput').value = 1;
                document.getElementById('zoomLevel').textContent = '100%';
                
                // Update title if multiple files
                if (totalFiles > 1) {
                    previewTitle.textContent = `${title} (${currentFileIndex + 1} of ${totalFiles})`;
                }

                renderPdfPage(1).then(() => {
                    generateThumbnails();
                });
            }).catch(error => {
                console.error('PDF loading error:', error);
                previewBody.innerHTML = `
                    <div style="padding: 40px; text-align: center;">
                        <i class="bi bi-exclamation-triangle" style="font-size: 4rem; color: #dc3545; margin-bottom: 20px;"></i>
                        <h4 style="color: #495057; margin-bottom: 10px;">Failed to Load Document</h4>
                        <p style="color: #6c757d;">${error.message}</p>
                        <a href="${blobUrl}" class="btn btn-primary mt-3" download="${title}">
                            <i class="bi bi-download"></i> Download Instead
                        </a>
                    </div>
                `;
            });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    });
</script>
{% endblock %}
{% extends 'dashboard/dashboard.html' %}
{% load static %}

{% block dashboard_title %}Data Bank Management{% endblock %}
{% block page_header %}Data Bank Management{% endblock %}

{% block extra_head %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'frontend/databank_management.css' %}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <style>
        /* --- INTEGRATED PREVIEW MODAL STYLES (From Messages) --- */
        .preview-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.92); display: flex; align-items: center; justify-content: center; z-index: 1200; opacity: 0; transition: opacity 0.3s ease; display: none; }
        .preview-overlay.show { opacity: 1; display: flex; }
        .preview-content { background: #fff; width: 90vw; max-width: 1200px; height: 85vh; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5); }
        .preview-header { background: #f8f9fa; padding: 12px 16px; border-bottom: 1px solid #dee2e6; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
        .preview-title { font-weight: 600; font-size: 0.95rem; color: #2B3674; margin-right: 15px; }
        .preview-body { flex: 1; overflow: auto; display: flex; align-items: flex-start; justify-content: center; background: #f8f9fa; padding: 20px; position: relative; }
        .preview-body canvas { box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
        .preview-controls button { padding: 6px 12px; border: none; border-radius: 8px; background: #6c757d; color: white; cursor: pointer; font-size: 0.85rem; margin-left: 5px; }
        .preview-controls button:hover { background: #5a6268; }
        
        /* Table Attachment Button Style */
        .btn-view-attach {
            padding: 4px 8px;
            font-size: 0.75rem;
            border-radius: 4px;
            border: 1px solid #2B3674;
            color: #2B3674;
            background: transparent;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-view-attach:hover {
            background: #2B3674;
            color: white;
        }
        .status-no { color: #dc3545; font-style: italic; }
    </style>
{% endblock %}

{% block dashboard_content %}

<div class="databank-container">
    
    {% if error %}
    <div class="alert alert-danger" role="alert" style="margin: 20px; padding: 15px; border-radius: 8px; background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;">
        <i class="bi bi-exclamation-triangle-fill"></i> <strong>System Error:</strong> {{ error }}
    </div>
    {% endif %}
    <div class="databank-toolbar">
        <div class="toolbar-left">
            <button class="add-btn" id="addCoopBtn">
                <i class="bi bi-plus-circle"></i> Add Cooperative
            </button>
            <button class="filter-btn" title="Filter">
                <i class="bi bi-funnel"></i> Filter
            </button>
        </div>
        <div class="search-bar">
            <i class="bi bi-search"></i>
            <input type="text" id="searchInput" placeholder="Search cooperatives...">
        </div>
    </div>

    <div class="table-section">
        <div class="table-wrapper">
            <div class="table-scroll">
                <table id="coop-table" role="table" aria-label="Cooperative list">
                    <thead>
                        <tr>
                            <th>Cooperative Name</th>
                            <th>Category</th>
                            <th>District</th>
                            <th>Address</th>
                            <th>Mobile Number</th>
                            <th>Email</th>
                            <th>CDA Registration Number</th>
                            <th>CDA Registration Date</th>
                            <th>LCCDC Membership</th>
                            <th>LCCDC Membership Date</th>
                            <th>Operation Area</th>
                            <th>Business Activity</th>
                            <th>Board of Directors Count</th>
                            <th>Salaried Employees Count</th>
                            <th>COC Attachment</th>
                            <th>COTE Attachment</th>
                            <th>Assets (₱)</th>
                            <th>Paid-Up Capital (₱)</th>
                            <th>Net Surplus (₱)</th>
                            <th>Financial Attachments</th>
                            <th>Reporting Year</th>
                            <th>Approval Status</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for coop in cooperatives %}
                    <tr data-modal-target="profile-modal" data-coop-id="{{ coop.coop_id }}">
                        <td><strong>{{ coop.cooperative_name }}</strong></td>
                        <td>{% if coop.category %}<span class="badge-category">{{ coop.category }}</span>{% else %}<span class="text-muted">N/A</span>{% endif %}</td>
                        <td>{{ coop.district|default:"N/A" }}</td>
                        <td class="address-cell">{{ coop.address|default:"N/A" }}</td>
                        <td class="contact-cell">{{ coop.mobile_number|default:"N/A" }}</td>
                        <td>{{ coop.email|default:"N/A" }}</td>
                        <td>{{ coop.cda_registration_number|default:"N/A" }}</td>
                        <td>{{ coop.cda_registration_date|date:"M d, Y"|default:"-" }}</td>
                        
                        <td class="text-center">
                            {% if coop.lccdc_membership %}
                                <i class="bi bi-check-circle-fill text-success"></i>
                            {% else %}
                                <i class="bi bi-x-circle-fill text-danger"></i>
                            {% endif %}
                        </td>
                        <td>{{ coop.lccdc_membership_date|date:"M d, Y"|default:"-" }}</td>
                        
                        <td>{{ coop.operation_area|default:"-" }}</td>
                        <td>{{ coop.business_activity|default:"-" }}</td>
                        <td class="text-center">{{ coop.board_of_directors_count|default:0 }}</td>
                        <td class="text-center">{{ coop.salaried_employees_count|default:0 }}</td>

                        <td class="text-center">
                            {% if coop.coc_attachment_exists %}
                                <button class="btn-view-attach" 
                                        onclick="event.stopPropagation(); openPreviewDocument('{% url 'databank:view_attachment' coop.coop_id 'coc' %}', 'COC - {{ coop.cooperative_name }}', 'application/pdf')">
                                    <i class="bi bi-eye"></i> View
                                </button>
                            {% else %}
                                <span class="status-no">No File</span>
                            {% endif %}
                        </td>

                        <td class="text-center">
                            {% if coop.cote_attachment_exists %}
                                <button class="btn-view-attach" 
                                        onclick="event.stopPropagation(); openPreviewDocument('{% url 'databank:view_attachment' coop.coop_id 'cote' %}', 'COTE - {{ coop.cooperative_name }}', 'application/pdf')">
                                    <i class="bi bi-eye"></i> View
                                </button>
                            {% else %}
                                <span class="status-no">No File</span>
                            {% endif %}
                        </td>

                        <td class="text-end">{{ coop.assets|default:"0.00" }}</td>
                        <td class="text-end">{{ coop.paid_up_capital|default:"0.00" }}</td>
                        <td class="text-end">{{ coop.net_surplus|default:"0.00" }}</td>

                        <td class="text-center">
                            {% if coop.financial_attachment_exists %}
                                <button class="btn-view-attach" 
                                        onclick="event.stopPropagation(); openPreviewDocument('{% url 'databank:view_attachment' coop.coop_id 'financial' %}', 'Financials - {{ coop.cooperative_name }}', 'application/pdf')">
                                    <i class="bi bi-eye"></i> View
                                </button>
                            {% else %}
                                <span class="status-no">No File</span>
                            {% endif %}
                        </td>

                        <td class="text-center">{{ coop.reporting_year|default:"-" }}</td>
                        <td>
                            {% if coop.approval_status == 'Approved' %}
                                <span class="badge bg-success">Approved</span>
                            {% elif coop.approval_status == 'Pending' %}
                                <span class="badge bg-warning text-dark">Pending</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ coop.approval_status }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="22" class="text-center py-4">No data found in the database.</td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="table-footer">
            <div>Showing <strong>{{ cooperatives|length }}</strong> cooperatives</div>
        </div>
    </div>
</div>

<div id="preview-modal" class="preview-overlay" style="display:none;">
    <div class="preview-content" role="dialog" aria-modal="true">
        <div class="preview-header">
            <div style="display:flex; align-items:center; gap:10px; flex:1;">
                <div class="preview-title" id="preview-title">Preview</div>
            </div>
            <div class="preview-controls">
                <button id="zoomOut">−</button>
                <span id="zoomLevel" style="font-size:0.85rem; min-width:45px; text-align:center;">100%</span>
                <button id="zoomIn">+</button>
                <button id="preview-close" style="background:#dc3545;">✕</button>
            </div>
        </div>
        <div class="preview-body" id="preview-body">
            </div>
    </div>
</div>

<div id="profile-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-top-bar">
            <h3>Cooperative Profile</h3>
            <button class="modal-close-btn">&times;</button>
        </div>
        <div class="modal-body">
            <p class="text-center text-muted">Detailed view logic goes here based on row click.</p>
        </div>
    </div>
</div>

<script>
    // ========================================
    // ATTACHMENT PREVIEW LOGIC
    // ========================================
    const previewModal = document.getElementById('preview-modal');
    const previewBody = document.getElementById('preview-body');
    const previewClose = document.getElementById('preview-close');
    const zoomInBtn = document.getElementById('zoomIn');
    const zoomOutBtn = document.getElementById('zoomOut');
    
    let currentZoom = 100;
    let pdfDoc = null;
    let currentPage = 1;

    // Open Document Function (Called by buttons in table)
    async function openPreviewDocument(src, title, contentType) {
        currentZoom = 100;
        document.getElementById('preview-title').textContent = title;
        document.getElementById('zoomLevel').textContent = '100%';
        
        // Show modal
        previewModal.style.display = 'flex';
        setTimeout(() => previewModal.classList.add('show'), 10);
        
        previewBody.innerHTML = '<p style="color:#6c757d;">Loading...</p>';

        if (contentType === 'application/pdf') {
            loadPdfPreview(src);
        } else if (contentType.startsWith('image/')) {
            previewBody.innerHTML = `<img src="${src}" style="max-width:100%; max-height:100%; object-fit:contain;">`;
        } else {
            // Fallback for others
            previewBody.innerHTML = `<iframe src="${src}" style="width:100%; height:100%; border:0;"></iframe>`;
        }
    }

    // PDF Loading Logic using PDF.js
    async function loadPdfPreview(src) {
        if (window.pdfjsLib) {
            window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            try {
                const loadingTask = window.pdfjsLib.getDocument(src);
                pdfDoc = await loadingTask.promise;
                renderPdfPage(1);
            } catch (err) {
                console.error(err);
                previewBody.innerHTML = `<p class="text-danger">Error loading PDF. <a href="${src}" target="_blank">Download instead</a>.</p>`;
            }
        }
    }

    async function renderPdfPage(num) {
        if (!pdfDoc) return;
        const page = await pdfDoc.getPage(num);
        const scale = currentZoom / 100;
        const viewport = page.getViewport({ scale: scale });

        // prepare canvas
        previewBody.innerHTML = ''; 
        const canvas = document.createElement('canvas');
        previewBody.appendChild(canvas);
        
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        const renderContext = {
            canvasContext: context,
            viewport: viewport
        };
        await page.render(renderContext).promise;
    }

    // Zoom Controls
    zoomInBtn.addEventListener('click', () => {
        currentZoom += 10;
        document.getElementById('zoomLevel').textContent = currentZoom + '%';
        if(pdfDoc) renderPdfPage(1); // Simplistic re-render
        else {
             const img = previewBody.querySelector('img');
             if(img) img.style.transform = `scale(${currentZoom/100})`;
        }
    });

    zoomOutBtn.addEventListener('click', () => {
        if(currentZoom > 10) currentZoom -= 10;
        document.getElementById('zoomLevel').textContent = currentZoom + '%';
        if(pdfDoc) renderPdfPage(1);
        else {
             const img = previewBody.querySelector('img');
             if(img) img.style.transform = `scale(${currentZoom/100})`;
        }
    });

    // Close Modal Logic
    function closePreview() {
        previewModal.classList.remove('show');
        setTimeout(() => {
            previewModal.style.display = 'none';
            previewBody.innerHTML = '';
            pdfDoc = null;
        }, 300);
    }

    previewClose.addEventListener('click', closePreview);
    previewModal.addEventListener('click', (e) => {
        if (e.target === previewModal) closePreview();
    });

    // ========================================
    // ROW CLICK LOGIC (Existing)
    // ========================================
    document.addEventListener('DOMContentLoaded', () => {
        const modal = document.getElementById('profile-modal');
        const closeButtons = document.querySelectorAll('.modal-close-btn');

        if (modal) {
            // Use delegation for table row clicks to avoid binding issues with dynamic data
            document.querySelector('#coop-table tbody').addEventListener('click', function(e) {
                // Prevent opening profile modal if a button inside the row was clicked
                if (e.target.closest('button') || e.target.closest('a')) return;

                const row = e.target.closest('tr[data-modal-target]');
                if (row) {
                    modal.classList.add('visible');
                    // Fetch details via AJAX here using row.dataset.coopId if needed
                }
            });

            closeButtons.forEach(btn => {
                btn.addEventListener('click', () => modal.classList.remove('visible'));
            });
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.classList.remove('visible');
            });
        }
    });
</script>
{% endblock %}
{% extends 'dashboard/dashboard.html' %}
{% load static %}

{% block dashboard_title %}Data Bank Management{% endblock %}
{% block page_header %}Data Bank Management{% endblock %}

{% block extra_head %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'frontend/databank_management.css' %}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
{% endblock %}

{% block dashboard_content %}

<div class="databank-container">
    
    <!-- <div class="databank-header">
        <div class="stat-card">
            <span class="stat-label">Total Cooperatives</span>
            <span class="stat-value">{{ total_count|default:0 }}</span>
        </div>
    </div> -->

    <div class="databank-toolbar">
        <div class="toolbar-left">
            <button class="add-btn" id="addCoopBtn">
                <i class="bi bi-plus-circle"></i>
                Add Cooperative
            </button>
            <button class="filter-btn" title="Filter">
                <i class="bi bi-funnel"></i>
                Filter
            </button>
        </div>
        <div class="search-bar">
            <i class="bi bi-search"></i>
            <input type="text" id="searchInput" placeholder="Search cooperatives...">
        </div>
    </div>

    <div class="table-section">
        <div class="table-wrapper">
            <table id="coop-table">
                <thead>
                    <tr>
                        <th>Cooperative Name</th>
                        <th>Category</th>
                        <th>District</th>
                        <th>Address</th>
                        <th>Contact</th>
                        <th>CDA Registration</th>
                        <th>Assets (₱)</th>
                        <th>Capital (₱)</th>
                        <th>Members</th>
                        <th>Officers</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for coop in cooperatives %}
                    <tr data-coop-id="{{ coop.coop_id }}" data-modal-target>
                        <td><strong>{{ coop.cooperative_name }}</strong></td>
                        <td>
                            {% if coop.category %}
                                <span class="badge-category">{{ coop.category }}</span>
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td>{{ coop.district|default:"N/A" }}</td>
                        <td style="min-width: 180px;">{{ coop.address|default:"N/A" }}</td>
                        <td style="min-width: 200px;">
                            <div class="contact-info">
                                {% if coop.email_address %}
                                    <div><i class="bi bi-envelope"></i> {{ coop.email_address }}</div>
                                {% endif %}
                                {% if coop.mobile_number %}
                                    <div><i class="bi bi-phone"></i> {{ coop.mobile_number }}</div>
                                {% endif %}
                                {% if not coop.email_address and not coop.mobile_number %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            {% if coop.cda_registration_number %}
                                <div>{{ coop.cda_registration_number }}</div>
                                {% if coop.cda_registration_date %}
                                    <small class="text-muted">{{ coop.cda_registration_date }}</small>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td class="text-end">
                            {% if coop.assets %}{{ coop.assets|floatformat:2 }}{% else %}-{% endif %}
                        </td>
                        <td class="text-end">
                            {% if coop.paid_up_capital %}{{ coop.paid_up_capital|floatformat:2 }}{% else %}-{% endif %}
                        </td>
                        <td class="text-center">
                            <span class="badge-count">{{ coop.members_count|default:0 }}</span>
                        </td>
                        <td class="text-center">
                            <span class="badge-count">{{ coop.officers_count|default:0 }}</span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-action btn-view" onclick="event.stopPropagation(); viewCooperativeDetails({{ coop.coop_id }})" title="View">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn-action btn-edit" onclick="event.stopPropagation(); editCooperative({{ coop.coop_id }})" title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn-action btn-delete" onclick="event.stopPropagation(); deleteCooperative({{ coop.coop_id }})" title="Delete">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="11">
                            <div class="empty-state">
                                <i class="bi bi-inbox"></i>
                                <h3>No cooperatives found</h3>
                                <p>Click "Add Cooperative" to get started.</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="table-footer">
            <div>Showing <strong>{{ cooperatives|length }}</strong> of <strong>{{ total_count }}</strong> cooperatives</div>
        </div>
    </div>

</div>

<button class="ocr-toggle-btn" id="ocrToggleBtn" title="Open OCR Assistant">
    <i class="bi bi-upc-scan"></i>
</button>

<div class="ocr-drawer-wrapper">
    <div class="ocr-drawer" id="ocrDrawer">
        <div class="ocr-drawer-header">
            <h3><i class="bi bi-upc-scan me-2"></i>OCR Assistant</h3>
            <button class="ocr-drawer-close" id="ocrDrawerClose">&times;</button>
        </div>
        
        <div class="ocr-drawer-body">
            
            <div id="camera-container" style="display: none; margin-bottom: 20px; text-align: center;">
                <video id="camera-video" autoplay playsinline style="width: 100%; border-radius: 12px; border: 2px solid #a91e2c; background: black;"></video>
                <div style="margin-top: 10px; display: flex; gap: 10px; justify-content: center;">
                    <button id="capture-btn" class="btn-apply" style="padding: 8px 20px;">
                        <i class="bi bi-camera-fill me-2"></i> Capture
                    </button>
                    <button id="cancel-camera-btn" class="btn-clear" style="padding: 8px 20px;">Cancel</button>
                </div>
            </div>

            <div id="upload-container">
                <p class="text-muted small mb-3" style="border-left: 3px solid #a91e2c; padding-left: 10px; background: #fff5f6; padding: 8px; border-radius: 4px;">
                    Scan documents using your phone camera or upload an image to auto-fill forms.
                </p>
                
                <div class="ocr-upload-area" id="ocrUploadArea">
                    <i class="bi bi-cloud-upload"></i>
                    <h5>Drag & Drop Image</h5>
                    <p class="text-muted small mb-0">or click to browse</p>
                    
                    <input type="file" id="ocrFileInput" accept="image/*" style="display: none;">
                    
                    <input type="file" id="mobileCameraInput" accept="image/*" capture="environment" style="display: none;">
                </div>
                
                <div class="ocr-btn-group">
                    <button class="ocr-action-btn" id="ocrUploadBtn">
                        <i class="bi bi-upload"></i>
                        <span>Upload Image</span>
                    </button>
                    
                    <button class="ocr-action-btn" id="ocrCameraBtn">
                        <i class="bi bi-camera-fill"></i>
                        <span>Scan / Camera</span>
                    </button>
                    
                    <button class="ocr-action-btn" id="ocrPasteBtn">
                        <i class="bi bi-clipboard"></i>
                        <span>Paste</span>
                    </button>
                    
                    <button class="ocr-action-btn" id="ocrScreenshotBtn">
                        <i class="bi bi-display"></i>
                        <span>Screenshot</span>
                    </button>
                </div>
            </div>
            
            <div class="ocr-loading" id="ocrLoading">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Processing...</span>
                </div>
                <p class="mt-2 text-muted">Scanning text...</p>
            </div>
            
            <div class="ocr-result-area" id="ocrResultArea" style="display: none;">
                <label class="form-label fw-bold">Extracted Data:</label>
                <textarea class="ocr-result-text" id="ocrResultText" placeholder="Extracted text will appear here..."></textarea>
                
                <div class="ocr-result-actions">
                    <button class="btn-apply" id="ocrApplyBtn">
                        <i class="bi bi-check-circle me-1"></i>Apply to Form
                    </button>
                    <button class="btn-clear" id="ocrClearBtn">
                        <i class="bi bi-x-circle me-1"></i>Clear
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    
    // --- Elements ---
    const ocrToggleBtn = document.getElementById('ocrToggleBtn');
    const ocrDrawer = document.getElementById('ocrDrawer');
    const ocrDrawerClose = document.getElementById('ocrDrawerClose');
    const databankContainer = document.querySelector('.databank-container');
    
    // Camera Elements
    const uploadContainer = document.getElementById('upload-container');
    const cameraContainer = document.getElementById('camera-container');
    const videoElement = document.getElementById('camera-video');
    const captureBtn = document.getElementById('capture-btn');
    const cancelCameraBtn = document.getElementById('cancel-camera-btn');
    
    // Input Elements
    const ocrUploadArea = document.getElementById('ocrUploadArea');
    const ocrFileInput = document.getElementById('ocrFileInput');
    const mobileCameraInput = document.getElementById('mobileCameraInput');
    const ocrUploadBtn = document.getElementById('ocrUploadBtn');
    const ocrCameraBtn = document.getElementById('ocrCameraBtn');
    const ocrPasteBtn = document.getElementById('ocrPasteBtn');
    const ocrScreenshotBtn = document.getElementById('ocrScreenshotBtn');
    
    // Result Elements
    const ocrLoading = document.getElementById('ocrLoading');
    const ocrResultArea = document.getElementById('ocrResultArea');
    const ocrResultText = document.getElementById('ocrResultText');
    const ocrApplyBtn = document.getElementById('ocrApplyBtn');
    const ocrClearBtn = document.getElementById('ocrClearBtn');

    let videoStream = null;

    // --- Drawer Toggle ---
    function toggleDrawer(open) {
        if (open) {
            ocrDrawer.classList.add('open');
        } else {
            ocrDrawer.classList.remove('open');
            stopCamera(); 
        }
    }
    
    if(ocrToggleBtn) ocrToggleBtn.addEventListener('click', () => toggleDrawer(true));
    if(ocrDrawerClose) ocrDrawerClose.addEventListener('click', () => toggleDrawer(false));

    // --- Camera Logic ---
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

    ocrCameraBtn.addEventListener('click', () => {
        if (isMobile) {
            mobileCameraInput.click();
        } else {
            startWebcam();
        }
    });

    mobileCameraInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            processImageFile(e.target.files[0]);
        }
    });

    async function startWebcam() {
        try {
            uploadContainer.style.display = 'none';
            ocrResultArea.style.display = 'none';
            cameraContainer.style.display = 'block';
            
            videoStream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment' } 
            });
            videoElement.srcObject = videoStream;
        } catch (err) {
            console.error("Camera Error:", err);
            alert("Camera access denied or unavailable.");
            stopCamera();
        }
    }

    function stopCamera() {
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
        }
        cameraContainer.style.display = 'none';
        uploadContainer.style.display = 'block';
    }

    cancelCameraBtn.addEventListener('click', stopCamera);

    captureBtn.addEventListener('click', () => {
        const canvas = document.createElement('canvas');
        canvas.width = videoElement.videoWidth;
        canvas.height = videoElement.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(videoElement, 0, 0);
        
        const base64Image = canvas.toDataURL('image/jpeg');
        stopCamera();
        processBase64Image(base64Image);
    });

    // --- Upload Logic ---
    ocrUploadArea.addEventListener('click', () => ocrFileInput.click());
    ocrUploadBtn.addEventListener('click', () => ocrFileInput.click());
    
    ocrFileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) processImageFile(e.target.files[0]);
    });

    if (ocrPasteBtn) {
        ocrPasteBtn.addEventListener('click', async () => {
            try {
                const items = await navigator.clipboard.read();
                for (const item of items) {
                    for (const type of item.types) {
                        if (type.startsWith('image/')) {
                            const blob = await item.getType(type);
                            const reader = new FileReader();
                            reader.onload = (e) => processBase64Image(e.target.result);
                            reader.readAsDataURL(blob);
                            return;
                        }
                    }
                }
                alert("No image found in clipboard.");
            } catch (e) { alert("Clipboard access denied."); }
        });
    }

    // --- IMAGE COMPRESSION LOGIC (THE FIX) ---
    function compressImage(fileOrBlob, maxWidth = 1000, quality = 0.7) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(fileOrBlob);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth) {
                        height = Math.round((height * maxWidth) / width);
                        width = maxWidth;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    canvas.toBlob((blob) => {
                        if (blob) {
                            resolve(blob);
                        } else {
                            reject(new Error("Compression failed"));
                        }
                    }, 'image/jpeg', quality);
                };
                img.onerror = (err) => reject(err);
            };
            reader.onerror = (err) => reject(err);
        });
    }

    // --- PROCESSING ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function showLoading(show) {
        if (show) {
            ocrLoading.classList.add('active');
            ocrResultArea.style.display = 'none';
        } else {
            ocrLoading.classList.remove('active');
        }
    }

    function displayResult(text) {
        ocrResultText.value = text;
        ocrResultArea.style.display = 'block';
    }

    // Updated Process Image File
    async function processImageFile(file) {
        showLoading(true);
        try {
            // 1. Compress before sending
            console.log("Original size:", file.size);
            const compressedBlob = await compressImage(file);
            console.log("Compressed size:", compressedBlob.size);

            const formData = new FormData();
            formData.append('image', compressedBlob, "scan.jpg");
            
            const res = await fetch('{% url "databank:process_ocr" %}', {
                method: 'POST',
                headers: { 'X-CSRFToken': getCookie('csrftoken') },
                body: formData
            });
            
            const data = await res.json();
            if (data.success) displayResult(data.text);
            else alert('OCR Failed: ' + (data.error || 'Unknown error'));
            
        } catch (e) {
            console.error(e);
            alert('Error processing image. Please try a smaller image.');
        } finally { 
            showLoading(false); 
        }
    }

    // Updated Process Base64
    async function processBase64Image(base64) {
        // Convert base64 to blob for compression
        const res = await fetch(base64);
        const blob = await res.blob();
        processImageFile(blob);
    }

    // Apply / Clear Buttons
    ocrApplyBtn.addEventListener('click', () => {
        const text = ocrResultText.value;
        alert("Text copied! (Implement field mapping logic here)");
    });

    ocrClearBtn.addEventListener('click', () => {
        ocrResultText.value = '';
        ocrResultArea.style.display = 'none';
        ocrFileInput.value = '';
        mobileCameraInput.value = '';
    });
    
    // Search Logic
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#coop-table tbody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });
    }
});
</script>

<!-- Modal overlay (copied as requested) -->
<div id="profile-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-top-bar">
            <h3>Cooperative Profile</h3>
            <div class="modal-actions">
                <button class="pdf-btn" id="download-pdf-btn" title="Download as PDF">
                    <i class="bi bi-file-earmark-pdf-fill"></i> <span>Download Profile</span>
                </button>
                <button class="modal-close-btn">&times;</button>
            </div>
        </div>
        
        <div class="modal-scroll-area">
            <div id="printable-area">
                <div class="modal-header-section">
                    <div class="coop-avatar">C</div>
                    <div class="coop-title-info">
                        <h4 id="modal-coop-name">Consumer Cooperative</h4>
                        <span class="badge-cda">CDA: 1414-060923055</span>
                        <div class="update-info">Last Updated: Sept 30, 2025 by Isabel Delacion</div>
                    </div>
                </div>

                <div class="modal-body">
                    <section class="info-section">
                        <h5 class="section-title">Cooperative General Information</h5>
                        <div class="info-grid two-col">
                            <div class="info-item"><label>Cooperative Name</label><p>Consumer Cooperative</p></div>
                            <div class="info-item"><label>Cooperative Address</label><p>Sabang, Lipa City, Batangas</p></div>
                            <div class="info-item"><label>Contact Number</label><p>09929380925</p></div>
                            <div class="info-item"><label>Email Address</label><p>consumercoop@gmail.com</p></div>
                            <div class="info-item"><label>CDA Registration Number</label><p>1414-060923055</p></div>
                            <div class="info-item"><label>CDA Registration Date</label><p>09-06-2005</p></div>
                            <div class="info-item"><label>LCCDC Membership</label><p>09-14-2014</p></div>
                            <div class="info-item"><label>Area of Operation</label><p>Consumer</p></div>
                            <div class="info-item"><label>Business Activity</label><p>Supply and demand</p></div>
                            <div class="info-item"><label>No. of Board Directors</label><p>3</p></div>
                            <div class="info-item"><label>No. of Salaried Employees</label><p>14</p></div>
                            <div class="info-item"><label>Certificate of Compliance</label><p><span class="status-yes">Yes</span></p></div>
                            <div class="info-item"><label>Certificate of Tax Exemption</label><p><span class="status-yes">Yes</span></p></div>
                        </div>
                    </section>

                    <section class="info-section">
                        <h5 class="section-title">Financial Records</h5>
                        <div class="info-grid three-col">
                            <div class="info-item"><label>2022 Assets</label><p>₱ 142,657.00</p></div>
                            <div class="info-item"><label>2023 Assets</label><p>₱ 258,843.00</p></div>
                            <div class="info-item"><label>2024 Assets</label><p>₱ 356,964.68</p></div>
                            <div class="info-item"><label>Total Paid Up Capital</label><p>₱ 108,243.78</p></div>
                            <div class="info-item"><label>Net Surplus/Loss</label><p>₱ 10,653.54</p></div>
                        </div>
                    </section>

                    <section class="info-section">
                        <h5 class="section-title">Cooperative Officers</h5>
                        <div class="modal-table-wrapper">
                            <table class="modal-table">
                                <thead>
                                    <tr><th>Name</th><th>Position</th><th>Gender</th><th>Mobile Number</th><th>Email</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>Isabel Delacion</td><td>Chairperson</td><td>Female</td><td>0917-123-4567</td><td>isabel.d@email.com</td></tr>
                                    <tr><td>Jasmin Esperida</td><td>Vice Chairperson</td><td>Female</td><td>0918-234-5678</td><td>jasmin.e@email.com</td></tr>
                                    <tr><td>Art Delos Reyes</td><td>BOD Member</td><td>Male</td><td>0919-345-6789</td><td>art.dr@email.com</td></tr>
                                    <tr><td>Noe Gonzales</td><td>BOD Member</td><td>Male</td><td>0920-456-7890</td><td>noe.g@email.com</td></tr>
                                    <tr><td>Maria Lopez</td><td>Secretary</td><td>Female</td><td>0921-567-8901</td><td>maria.l@email.com</td></tr>
                                    <tr><td>Ramon Santos</td><td>Treasurer</td><td>Male</td><td>0922-678-9012</td><td>ramon.s@email.com</td></tr>
                                    <tr><td>Luis Fernando</td><td>Credit Comm.</td><td>Male</td><td>0923-789-0123</td><td>luis.f@email.com</td></tr>
                                    <tr><td>Anna Cruz</td><td>Educ. Comm.</td><td>Female</td><td>0924-890-1234</td><td>anna.c@email.com</td></tr>
                                    <tr><td>Pedro Tan</td><td>Manager</td><td>Male</td><td>0925-901-2345</td><td>pedro.t@email.com</td></tr>
                                    <tr><td>Luisa Moreno</td><td>Bookkeeper</td><td>Female</td><td>0926-012-3456</td><td>luisa.m@email.com</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <section class="info-section">
                        <h5 class="section-title">Cooperative Members</h5>
                        <div class="modal-table-wrapper">
                            <table class="modal-table">
                                <thead>
                                    <tr><th>Name</th><th>Gender</th><th>Mobile Number</th><th>Email</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>Juan dela Cruz</td><td>Male</td><td>0950-111-2222</td><td>juan.dc@email.com</td></tr>
                                    <tr><td>Maria Clara Santos</td><td>Female</td><td>0950-333-4444</td><td>maria.cs@email.com</td></tr>
                                    <tr><td>Jose Rizalino</td><td>Male</td><td>0950-555-6666</td><td>jose.r@email.com</td></tr>
                                    <tr><td>Andres Bonifacio Jr.</td><td>Male</td><td>0950-777-8888</td><td>andres.b@email.com</td></tr>
                                    <tr><td>Gabriela Silang</td><td>Female</td><td>0950-999-0000</td><td>gabriela.s@email.com</td></tr>
                                    <tr><td>Emilio Aguinaldo IV</td><td>Male</td><td>0951-111-2222</td><td>emilio.a@email.com</td></tr>
                                    <tr><td>Melchora Aquino</td><td>Female</td><td>0951-333-4444</td><td>melchora.a@email.com</td></tr>
                                    <tr><td>Antonio Luna</td><td>Male</td><td>0951-555-6666</td><td>antonio.l@email.com</td></tr>
                                    <tr><td>Gregorio del Pilar</td><td>Male</td><td>0951-777-8888</td><td>gregorio.dp@email.com</td></tr>
                                    <tr><td>Apolinario Mabini</td><td>Male</td><td>0951-999-0000</td><td>apolinario.m@email.com</td></tr>
                                    <tr><td>Teresa Magbanua</td><td>Female</td><td>0952-111-2222</td><td>teresa.m@email.com</td></tr>
                                    <tr><td>Diego Silang</td><td>Male</td><td>0952-333-4444</td><td>diego.s@email.com</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </section>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="secondary-btn close-modal-trigger">Close</button>
            <button class="primary-btn edit-btn"><i class="bi bi-pencil-square"></i> Edit Profile</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const modal = document.getElementById('profile-modal');
        const tableRows = document.querySelectorAll('tr[data-modal-target]');
        const closeButtons = document.querySelectorAll('.modal-close-btn, .close-modal-trigger');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');

        if (modal) {
            tableRows.forEach(row => {
                row.addEventListener('click', function() {
                    modal.classList.add('visible');
                });
            });

            const closeModal = () => {
                modal.classList.remove('visible');
            };

            closeButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    closeModal();
                });
            });

            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });

            if (downloadPdfBtn) {
                downloadPdfBtn.addEventListener('click', function() {
                    const element = document.getElementById('printable-area');
                    const coopName = document.getElementById('modal-coop-name').textContent.trim();
                    
                    const opt = {
                        margin: 0.2,
                        filename: `${coopName}_Profile.pdf`,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2, useCORS: true },
                        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
                    };
                    
                    const originalContent = this.innerHTML;
                    this.innerHTML = '<i class="bi bi-hourglass-split"></i> Generating...';
                    this.disabled = true;

                    html2pdf().set(opt).from(element).save().then(() => {
                        this.innerHTML = originalContent;
                        this.disabled = false;
                    }).catch(err => {
                        console.error(err);
                        this.innerHTML = originalContent;
                        this.disabled = false;
                    });
                });
            }
        }
    });
</script>
{% endblock %}
{% extends 'dashboard/dashboard.html' %}
{% load static %}

{% block dashboard_title %}Data Bank Management{% endblock %}
{% block page_header %}Data Bank Management{% endblock %}

{% block extra_head %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'frontend/databank_management.css' %}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
{% endblock %}

{% block dashboard_content %}

<div class="databank-container">
    
    {% if error %}
    <div class="alert alert-danger" role="alert">
        <i class="bi bi-exclamation-triangle-fill"></i> <strong>System Error:</strong> {{ error }}
    </div>
    {% endif %}

    <div class="overview-panel">
        
        <div class="databank-header">
            <div class="tab-buttons">
                <button class="add-btn" id="addCoopBtn">
                    <i class="bi bi-plus-circle"></i> Add Cooperative
                </button>
                <button class="filter-btn" title="Filter">
                    <i class="bi bi-funnel"></i> Filter
                </button>
            </div>

            <div class="table-controls">
                <input type="text" id="searchInput" class="search-input" placeholder="Search Name, District, Address...">
            </div>
        </div>

        <div class="table-wrapper summary-wrapper">
            <table id="summary-table">
                <thead>
                    <tr>
                        <th class="sticky-col">Cooperative Name</th>
                        <th>Category</th>
                        <th>District</th>
                        <th>Address</th>
                    </tr>
                </thead>
                <tbody>
                    {% for coop in cooperatives %}
                    <tr class="summary-row" data-modal-target="profile-modal" data-coop-id="{{ coop.coop_id }}">
                        <td class="sticky-col"><strong>{{ coop.cooperative_name }}</strong></td>
                        <td>
                            {% if coop.category %}
                                <span class="badge-category">{{ coop.category }}</span>
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td>{{ coop.district|default:"N/A" }}</td>
                        <td class="address-cell" title="{{ coop.address }}">{{ coop.address|default:"N/A" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center py-4">No data found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="detailed-panel">
        <h5 class="section-divider-title">Detailed Master List</h5>
        
        <div class="table-wrapper detailed-wrapper">
            <table id="coop-table">
                <thead>
                    <tr>
                        <th class="sticky-col">Cooperative Name</th>
                        <th>Category</th>
                        <th>District</th>
                        <th>Address</th>
                        <th>Mobile Number</th>
                        <th>Email</th>
                        <th>CDA Registration Number</th>
                        <th>CDA Registration Date</th>
                        <th>LCCDC Membership</th>
                        <th>LCCDC Membership Date</th>
                        <th>Operation Area</th>
                        <th>Business Activity</th>
                        <th>Board of Directors Count</th>
                        <th>Salaried Employees Count</th>
                        <th>COC Attachment</th>
                        <th>COTE Attachment</th>
                        <th>Assets (₱)</th>
                        <th>Paid-Up Capital (₱)</th>
                        <th>Net Surplus (₱)</th>
                        <th>Financial Attachments</th>
                        <th>Reporting Year</th>
                        <th>Approval Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for coop in cooperatives %}
                    <tr class="detailed-row" data-modal-target="profile-modal" data-coop-id="{{ coop.coop_id }}">
                        <td class="sticky-col"><strong>{{ coop.cooperative_name }}</strong></td>
                        <td>{% if coop.category %}<span class="badge-category">{{ coop.category }}</span>{% else %}<span class="text-muted">N/A</span>{% endif %}</td>
                        <td>{{ coop.district|default:"N/A" }}</td>
                        <td class="address-cell" title="{{ coop.address }}">{{ coop.address|default:"N/A" }}</td>
                        <td class="contact-cell">{{ coop.mobile_number|default:"N/A" }}</td>
                        <td>{{ coop.email|default:"N/A" }}</td>
                        <td>{{ coop.cda_registration_number|default:"N/A" }}</td>
                        <td>{{ coop.cda_registration_date|date:"M d, Y"|default:"-" }}</td>
                        
                        <td class="text-center">
                            {% if coop.lccdc_membership %}
                                <i class="bi bi-check-circle-fill text-success"></i>
                            {% else %}
                                <i class="bi bi-x-circle-fill text-danger"></i>
                            {% endif %}
                        </td>
                        <td>{{ coop.lccdc_membership_date|date:"M d, Y"|default:"-" }}</td>
                        <td>{{ coop.operation_area|default:"-" }}</td>
                        <td>{{ coop.business_activity|default:"-" }}</td>
                        <td class="text-center">{{ coop.board_of_directors_count|default:0 }}</td>
                        <td class="text-center">{{ coop.salaried_employees_count|default:0 }}</td>

                        <td class="text-center">
                            {% if coop.coc_attachment_exists %}
                                <button class="btn-view-attach" onclick="event.stopPropagation(); openPreviewDocument('{% url 'databank:view_attachment' coop.coop_id 'coc' %}', 'COC - {{ coop.cooperative_name }}', 'application/pdf')">
                                    <i class="bi bi-eye"></i> View
                                </button>
                            {% else %}
                                <span class="status-no">No File</span>
                            {% endif %}
                        </td>

                        <td class="text-center">
                            {% if coop.cote_attachment_exists %}
                                <button class="btn-view-attach" onclick="event.stopPropagation(); openPreviewDocument('{% url 'databank:view_attachment' coop.coop_id 'cote' %}', 'COTE - {{ coop.cooperative_name }}', 'application/pdf')">
                                    <i class="bi bi-eye"></i> View
                                </button>
                            {% else %}
                                <span class="status-no">No File</span>
                            {% endif %}
                        </td>

                        <td class="text-end">{{ coop.assets|default:"0.00" }}</td>
                        <td class="text-end">{{ coop.paid_up_capital|default:"0.00" }}</td>
                        <td class="text-end">{{ coop.net_surplus|default:"0.00" }}</td>

                        <td class="text-center">
                            {% if coop.financial_attachment_exists %}
                                <button class="btn-view-attach" onclick="event.stopPropagation(); openPreviewDocument('{% url 'databank:view_attachment' coop.coop_id 'financial' %}', 'Financials - {{ coop.cooperative_name }}', 'application/pdf')">
                                    <i class="bi bi-eye"></i> View
                                </button>
                            {% else %}
                                <span class="status-no">No File</span>
                            {% endif %}
                        </td>

                        <td class="text-center">{{ coop.reporting_year|default:"-" }}</td>
                        <td>
                            {% if coop.approval_status == 'Approved' %}
                                <span class="badge bg-success">Approved</span>
                            {% elif coop.approval_status == 'Pending' %}
                                <span class="badge bg-warning text-dark">Pending</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ coop.approval_status }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="22" class="text-center py-4">No data found in the database.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="table-footer">
            <div>Showing <strong>{{ cooperatives|length }}</strong> of <strong>{{ total_count }}</strong> cooperatives</div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- OCR LOGIC ---
    const ocrToggleBtn = document.getElementById('ocrToggleBtn');
    const ocrDrawer = document.getElementById('ocrDrawer');
    const ocrDrawerClose = document.getElementById('ocrDrawerClose');
    const uploadContainer = document.getElementById('upload-container');
    const cameraContainer = document.getElementById('camera-container');
    const videoElement = document.getElementById('camera-video');
    const captureBtn = document.getElementById('capture-btn');
    const cancelCameraBtn = document.getElementById('cancel-camera-btn');
    const ocrUploadArea = document.getElementById('ocrUploadArea');
    const ocrFileInput = document.getElementById('ocrFileInput');
    const mobileCameraInput = document.getElementById('mobileCameraInput');
    const ocrUploadBtn = document.getElementById('ocrUploadBtn');
    const ocrCameraBtn = document.getElementById('ocrCameraBtn');
    const ocrPasteBtn = document.getElementById('ocrPasteBtn');
    const ocrLoading = document.getElementById('ocrLoading');
    const ocrResultArea = document.getElementById('ocrResultArea');
    const ocrResultText = document.getElementById('ocrResultText');
    const ocrClearBtn = document.getElementById('ocrClearBtn');

    let videoStream = null;

    function toggleDrawer(open) {
        if (open) ocrDrawer.classList.add('open');
        else { ocrDrawer.classList.remove('open'); stopCamera(); }
    }
    
    if(ocrToggleBtn) ocrToggleBtn.addEventListener('click', () => toggleDrawer(true));
    if(ocrDrawerClose) ocrDrawerClose.addEventListener('click', () => toggleDrawer(false));

    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

    if(ocrCameraBtn) ocrCameraBtn.addEventListener('click', () => {
        if (isMobile) mobileCameraInput.click();
        else startWebcam();
    });

    if(mobileCameraInput) mobileCameraInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) processImageFile(e.target.files[0]);
    });

    async function startWebcam() {
        try {
            uploadContainer.style.display = 'none';
            ocrResultArea.style.display = 'none';
            cameraContainer.style.display = 'block';
            videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            videoElement.srcObject = videoStream;
        } catch (err) { alert("Camera access denied."); stopCamera(); }
    }

    function stopCamera() {
        if (videoStream) { videoStream.getTracks().forEach(track => track.stop()); videoStream = null; }
        if(cameraContainer) cameraContainer.style.display = 'none';
        if(uploadContainer) uploadContainer.style.display = 'block';
    }

    if(cancelCameraBtn) cancelCameraBtn.addEventListener('click', stopCamera);

    if(captureBtn) captureBtn.addEventListener('click', () => {
        const canvas = document.createElement('canvas');
        canvas.width = videoElement.videoWidth;
        canvas.height = videoElement.videoHeight;
        canvas.getContext('2d').drawImage(videoElement, 0, 0);
        stopCamera();
        processBase64Image(canvas.toDataURL('image/jpeg'));
    });

    if(ocrUploadArea) ocrUploadArea.addEventListener('click', () => ocrFileInput.click());
    if(ocrUploadBtn) ocrUploadBtn.addEventListener('click', () => ocrFileInput.click());
    if(ocrFileInput) ocrFileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) processImageFile(e.target.files[0]);
    });

    if (ocrPasteBtn) ocrPasteBtn.addEventListener('click', async () => {
        try {
            const items = await navigator.clipboard.read();
            for (const item of items) {
                for (const type of item.types) {
                    if (type.startsWith('image/')) {
                        const blob = await item.getType(type);
                        const reader = new FileReader();
                        reader.onload = (e) => processBase64Image(e.target.result);
                        reader.readAsDataURL(blob);
                        return;
                    }
                }
            }
            alert("No image found.");
        } catch (e) { alert("Clipboard access denied."); }
    });

    function compressImage(fileOrBlob, maxWidth = 1000, quality = 0.7) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(fileOrBlob);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width; let height = img.height;
                    if (width > maxWidth) { height = Math.round((height * maxWidth) / width); width = maxWidth; }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    canvas.toBlob((blob) => { if (blob) resolve(blob); else reject(new Error("Compression failed")); }, 'image/jpeg', quality);
                };
            };
        });
    }

    function showLoading(show) {
        if (show) { ocrLoading.style.display = 'block'; ocrResultArea.style.display = 'none'; }
        else { ocrLoading.style.display = 'none'; }
    }

    function displayResult(text) { ocrResultText.value = text; ocrResultArea.style.display = 'block'; }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    async function processImageFile(file) {
        showLoading(true);
        try {
            const compressedBlob = await compressImage(file);
            const formData = new FormData();
            formData.append('image', compressedBlob, "scan.jpg");
            const res = await fetch('{% url "databank:process_ocr" %}', {
                method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') }, body: formData
            });
            const data = await res.json();
            if (data.success) displayResult(data.text);
            else alert('OCR Failed: ' + (data.error || 'Unknown error'));
        } catch (e) { console.error(e); alert('Error processing image.'); } 
        finally { showLoading(false); }
    }

    async function processBase64Image(base64) {
        const res = await fetch(base64);
        const blob = await res.blob();
        processImageFile(blob);
    }

    if(ocrClearBtn) ocrClearBtn.addEventListener('click', () => {
        ocrResultText.value = ''; ocrResultArea.style.display = 'none';
        if(ocrFileInput) ocrFileInput.value = '';
    });

    // --- TABLE SEARCH ---
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            
            // Filter Function
            const applyFilter = (selector) => {
                const rows = document.querySelectorAll(selector);
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            };

            // Apply to Top Table
            applyFilter('#summary-table tbody tr');
            // Apply to Bottom Table
            applyFilter('#coop-table tbody tr');
        });
    }

    // --- MODAL LOGIC ---
    const profileModal = document.getElementById('profile-modal');
    const previewModal = document.getElementById('preview-modal');
    
    document.querySelectorAll('.modal-close-btn, #preview-close').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const modal = e.target.closest('.modal-overlay') || e.target.closest('.preview-overlay');
            if(modal) { modal.classList.remove('show'); modal.style.display = 'none'; }
        });
    });

    if (profileModal) {
        document.querySelector('#coop-table tbody').addEventListener('click', function(e) {
            if (e.target.closest('button') || e.target.closest('a')) return;
            const row = e.target.closest('tr[data-modal-target]');
            if (row) { profileModal.style.display = 'flex'; setTimeout(() => profileModal.classList.add('show'), 10); }
        });
    }

    // --- PDF PREVIEW ---
    const previewBody = document.getElementById('preview-body');
    const zoomInBtn = document.getElementById('zoomIn');
    const zoomOutBtn = document.getElementById('zoomOut');
    let currentZoom = 100; let pdfDoc = null;

    window.openPreviewDocument = async function(src, title, contentType) {
        currentZoom = 100;
        document.getElementById('preview-title').textContent = title;
        document.getElementById('zoomLevel').textContent = '100%';
        previewModal.style.display = 'flex';
        setTimeout(() => previewModal.classList.add('show'), 10);
        previewBody.innerHTML = '<p style="color:#6c757d;">Loading...</p>';

        if (contentType === 'application/pdf') loadPdfPreview(src);
        else if (contentType.startsWith('image/')) previewBody.innerHTML = `<img src="${src}" style="max-width:100%; max-height:100%; object-fit:contain;">`;
        else previewBody.innerHTML = `<iframe src="${src}" style="width:100%; height:100%; border:0;"></iframe>`;
    };

    async function loadPdfPreview(src) {
        if (window.pdfjsLib) {
            try {
                const loadingTask = window.pdfjsLib.getDocument(src);
                pdfDoc = await loadingTask.promise;
                renderPdfPage(1);
            } catch (err) { previewBody.innerHTML = `<p class="text-danger">Error loading PDF.</p>`; }
        }
    }

    async function renderPdfPage(num) {
        if (!pdfDoc) return;
        const page = await pdfDoc.getPage(num);
        const scale = currentZoom / 100;
        const viewport = page.getViewport({ scale: scale });
        previewBody.innerHTML = ''; 
        const canvas = document.createElement('canvas');
        previewBody.appendChild(canvas);
        const context = canvas.getContext('2d');
        canvas.height = viewport.height; canvas.width = viewport.width;
        await page.render({ canvasContext: context, viewport: viewport }).promise;
    }

    if(zoomInBtn) zoomInBtn.addEventListener('click', () => {
        currentZoom += 10; document.getElementById('zoomLevel').textContent = currentZoom + '%';
        if(pdfDoc) renderPdfPage(1); else { const img = previewBody.querySelector('img'); if(img) img.style.transform = `scale(${currentZoom/100})`; }
    });

    if(zoomOutBtn) zoomOutBtn.addEventListener('click', () => {
        if(currentZoom > 10) currentZoom -= 10;
        document.getElementById('zoomLevel').textContent = currentZoom + '%';
        if(pdfDoc) renderPdfPage(1); else { const img = previewBody.querySelector('img'); if(img) img.style.transform = `scale(${currentZoom/100})`; }
    });
});
</script>
{% endblock %}
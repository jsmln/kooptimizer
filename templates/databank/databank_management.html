{% extends 'dashboard/dashboard.html' %}
{% load static %}

{% block dashboard_title %}Data Bank Management{% endblock %}
{% block page_header %}Data Bank Management{% endblock %}

{% block extra_head %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'frontend/databank_management.css' %}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
{% endblock %}

{% block dashboard_content %}

<div class="databank-container">
    
    <!-- <div class="databank-header">
        <div class="stat-card">
            <span class="stat-label">Total Cooperatives</span>
            <span class="stat-value">{{ total_count|default:0 }}</span>
        </div>
    </div> -->

    <div class="databank-toolbar">
        <div class="toolbar-left">
            <button class="add-btn" id="addCoopBtn">
                <i class="bi bi-plus-circle"></i>
                Add Cooperative
            </button>
            <button class="filter-btn" title="Filter">
                <i class="bi bi-funnel"></i>
                Filter
            </button>
        </div>
        <div class="search-bar">
            <i class="bi bi-search"></i>
            <input type="text" id="searchInput" placeholder="Search cooperatives...">
        </div>
    </div>

    <div class="table-section">
        <div class="table-wrapper">
            <div class="table-scroll">
                <table id="coop-table" role="table" aria-label="Cooperative list">
                    <thead>
                        <tr>
                            <th>Cooperative Name</th>
                            <th>Category</th>
                            <th>District</th>
                            <th>Address</th>
                            <th>Contact No.</th>
                            <th>CDA Registration</th>
                            <th>Assets (₱)</th>
                            <th>Capital (₱)</th>
                            <th>Members</th>
                            <th>Officers</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for coop in cooperatives %}
                    <tr data-modal-target="profile-modal" data-coop-id="{{ coop.coop_id }}" data-detail-url="{% url 'databank:coop_detail' coop.coop_id %}">
                        <td><strong>{{ coop.cooperative_name }}</strong></td>
                        <td>{% if coop.category %}<span class="badge-category">{{ coop.category }}</span>{% else %}<span class="text-muted">N/A</span>{% endif %}</td>
                        <td>{{ coop.district|default:"N/A" }}</td>
                        <td class="address-cell">{{ coop.address|default:"N/A" }}</td>
                        <td class="contact-cell">{{ coop.mobile_number|default:"N/A" }}</td>
                        <td>
                            {% if coop.cda_registration_number %}
                                {{ coop.cda_registration_number }}
                                {% if coop.cda_registration_date %}<div class="text-muted">{{ coop.cda_registration_date }}</div>{% endif %}
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td class="text-end">{{ coop.assets|default:"-" }}</td>
                        <td class="text-end">{{ coop.paid_up_capital|default:"-" }}</td>
                        <td class="text-center">{{ coop.members_count|default:0 }}</td>
                        <td class="text-center">{{ coop.officers_count|default:0 }}</td>
                    </tr>
                    {% empty %}
                    <tr data-modal-target="profile-modal" data-coop-id="sample-001">
                        <td><strong>Sample Cooperative</strong></td>
                        <td><span class="badge-category">consumer</span></td>
                        <td>Sample District</td>
                        <td class="address-cell">123 Sample St., Sample City</td>
                        <td class="contact-cell">0917-000-0000</td>
                        <td>1414-060923055 <div class="text-muted">09-06-2005</div></td>
                        <td class="text-end">356,964.68</td>
                        <td class="text-end">108,243.78</td>
                        <td class="text-center">128</td>
                        <td class="text-center">8</td>
                    </tr>
                    {% endfor %}
                </tbody>
                </table>
            </div>
        </div>

        <div class="table-footer">
            <div>Showing <strong>{{ cooperatives|length }}</strong> of <strong>{{ total_count }}</strong> cooperatives</div>
            {% if cooperatives %}
            <div class="pagination">
                <!-- Pagination will be added here if needed -->
            </div>
            {% endif %}
        </div>
    </div>

</div>

<!-- OCR Toggle button and drawer markup unchanged -->
<button class="ocr-toggle-btn" id="ocrToggleBtn" title="Open OCR Assistant">
    <i class="bi bi-upc-scan"></i>
</button>

<div class="ocr-drawer-wrapper">
    <div class="ocr-drawer" id="ocrDrawer">
        <div class="ocr-drawer-header">
            <h3><i class="bi bi-upc-scan me-2"></i>OCR Assistant</h3>
            <button class="ocr-drawer-close" id="ocrDrawerClose">&times;</button>
        </div>
        
        <div class="ocr-drawer-body">
            <p class="text-muted small mb-3">
                Upload images or screenshots to extract text automatically
            </p>
            
            <div class="ocr-upload-area" id="ocrUploadArea" data-ocr-endpoint="">
                <i class="bi bi-cloud-upload"></i>
                <h5>Drag & Drop Image</h5>
                <p class="text-muted small mb-0">or click to browse</p>
                <input type="file" id="ocrFileInput" accept="image/*" style="display: none;">
            </div>
            
            <div class="ocr-btn-group">
                <button class="ocr-action-btn" id="ocrUploadBtn">
                    <i class="bi bi-upload"></i>
                    <span>Upload Image</span>
                </button>
                
                <button class="ocr-action-btn" id="ocrScreenshotBtn">
                    <i class="bi bi-camera"></i>
                    <span>Take Screenshot</span>
                </button>
                
                <button class="ocr-action-btn" id="ocrPasteBtn">
                    <i class="bi bi-clipboard"></i>
                    <span>Paste from Clipboard</span>
                </button>
                
                <button class="ocr-action-btn" id="ocrDragDropInfo">
                    <i class="bi bi-box-arrow-in-down"></i>
                    <span>Drag & Drop</span>
                </button>
            </div>
            
            <div class="ocr-loading" id="ocrLoading" aria-hidden="true">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Processing...</span>
                </div>
                <p class="mt-2 text-muted">Extracting text from image...</p>
            </div>
            
            <div class="ocr-result-area" id="ocrResultArea">
                <label class="form-label fw-bold">Extracted Text:</label>
                <textarea class="ocr-result-text" id="ocrResultText" placeholder="Extracted text will appear here..."></textarea>
                
                <div class="ocr-result-actions">
                    <button class="btn-apply" id="ocrApplyBtn">
                        <i class="bi bi-check-circle me-1"></i>Apply to Form
                    </button>
                    <button class="btn-clear" id="ocrClearBtn">
                        <i class="bi bi-x-circle me-1"></i>Clear
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Restore OCR behavior: toggles + drag/drop + file upload + clipboard paste + screenshot + client-side OCR via Tesseract.js fallback to backend if configured -->
<script>
(function () {
  const toggleBtn = document.getElementById('ocrToggleBtn');
  const drawer = document.getElementById('ocrDrawer');
  const drawerClose = document.getElementById('ocrDrawerClose');
  const uploadArea = document.getElementById('ocrUploadArea');
  const fileInput = document.getElementById('ocrFileInput');
  const uploadBtn = document.getElementById('ocrUploadBtn');
  const screenshotBtn = document.getElementById('ocrScreenshotBtn');
  const pasteBtn = document.getElementById('ocrPasteBtn');
  const loading = document.getElementById('ocrLoading');
  const resultArea = document.getElementById('ocrResultArea');
  const resultText = document.getElementById('ocrResultText');
  const applyBtn = document.getElementById('ocrApplyBtn');
  const clearBtn = document.getElementById('ocrClearBtn');

  const ocrEndpoint = uploadArea.dataset.ocrEndpoint || ''; // set a backend endpoint by adding data-ocr-endpoint attr to .ocr-upload-area

  function openDrawer() { drawer.classList.add('open'); }
  function closeDrawer() { drawer.classList.remove('open'); }

  toggleBtn.addEventListener('click', openDrawer);
  drawerClose.addEventListener('click', closeDrawer);

  // Drag & drop
  ['dragenter','dragover'].forEach(evt => {
    uploadArea.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); uploadArea.classList.add('dragover'); });
  });
  ['dragleave','drop'].forEach(evt => {
    uploadArea.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); uploadArea.classList.remove('dragover'); });
  });
  uploadArea.addEventListener('drop', function (e) {
    const f = (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0]);
    if (f) processFile(f);
  });

  // Click to browse
  uploadArea.addEventListener('click', () => fileInput.click());
  uploadBtn.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', (e) => {
    const f = e.target.files && e.target.files[0];
    if (f) processFile(f);
    fileInput.value = '';
  });

  // Clipboard paste - listen globally while drawer open
  pasteBtn.addEventListener('click', () => {
    // Focus hint for paste
    resultText.focus();
    resultText.value = 'Press Ctrl+V (Cmd+V on Mac) to paste image from clipboard...';
    document.addEventListener('paste', handlePasteOnce, { once: true });
  });

  function handlePasteOnce(e) {
    const items = (e.clipboardData || e.originalEvent.clipboardData).items;
    for (const it of items) {
      if (it.type && it.type.indexOf('image') !== -1) {
        const blob = it.getAsFile();
        processFile(blob);
        return;
      }
    }
    alert('No image found in clipboard.');
  }

  // Screenshot using Screen Capture API (user will be prompted)
  screenshotBtn.addEventListener('click', async () => {
    try {
      const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
      const track = stream.getVideoTracks()[0];
      const img = await captureFrameFromStream(stream);
      track.stop();
      processBlob(img);
    } catch (err) {
      console.error(err);
      alert('Unable to capture screen. Check permissions or try another method.');
    }
  });

  async function captureFrameFromStream(stream) {
    return new Promise((resolve) => {
      const video = document.createElement('video');
      video.srcObject = stream;
      video.play();
      video.addEventListener('loadeddata', async () => {
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);
        canvas.toBlob(blob => resolve(blob), 'image/png');
      }, { once: true });
    });
  }

  function processBlob(blob) {
    if (!blob) return;
    // convert Blob to File with a name to keep same processing path
    const file = new File([blob], 'screenshot.png', { type: blob.type });
    processFile(file);
  }

  // Core: try backend OCR if endpoint provided; otherwise use Tesseract client-side
  async function processFile(file) {
    resultArea.style.display = 'none';
    loading.classList.add('active');
    loading.setAttribute('aria-hidden', 'false');

    // If backend endpoint is configured, try that first
    if (ocrEndpoint) {
      try {
        const fd = new FormData();
        fd.append('file', file);
        const resp = await fetch(ocrEndpoint, { method: 'POST', body: fd });
        if (resp.ok) {
          const data = await resp.json();
          const text = data.text || data.result || '';
          showResult(text || '(no text detected)');
          return;
        }
      } catch (err) {
        console.warn('Backend OCR failed, falling back to client-side Tesseract', err);
        // fallthrough to client-side
      }
    }

    // Client-side: load Tesseract if not present
    try {
      await loadTesseract();
      const { createWorker } = window.Tesseract;
      const worker = createWorker({
        logger: m => {
          // Optionally: show progress in loading area
          // console.log(m);
        }
      });
      await worker.load();
      await worker.loadLanguage('eng');
      await worker.initialize('eng');
      const { data: { text } } = await worker.recognize(file);
      await worker.terminate();
      showResult(text || '(no text detected)');
    } catch (err) {
      console.error('Client OCR failed', err);
      showResult('(OCR failed — check backend or network).');
    }
  }

  function showResult(text) {
    loading.classList.remove('active');
    loading.setAttribute('aria-hidden', 'true');
    resultArea.style.display = 'block';
    resultText.value = text;
  }

  function loadTesseract() {
    return new Promise((resolve, reject) => {
      if (window.Tesseract) return resolve();
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/tesseract.js@v4.1.1/dist/tesseract.min.js';
      s.onload = () => setTimeout(resolve, 50);
      s.onerror = reject;
      document.head.appendChild(s);
    });
  }

  // Apply: copy to clipboard and dispatch custom event for app-level handlers
  applyBtn.addEventListener('click', async () => {
    const text = resultText.value || '';
    if (!text.trim()) return alert('Nothing to apply.');
    // copy to clipboard
    try {
      await navigator.clipboard.writeText(text);
    } catch (err) {
      // ignore
    }
    // dispatch event so other scripts can listen and populate forms
    const ev = new CustomEvent('ocr:applied', { detail: { text } });
    document.dispatchEvent(ev);
    alert('Extracted text copied to clipboard. Use Paste or listen for ocr:applied event to insert into form.');
  });

  clearBtn.addEventListener('click', () => {
    resultText.value = '';
    resultArea.style.display = 'none';
  });

  // close drawer when clicking outside (optional)
  document.addEventListener('click', (e) => {
    if (!drawer.classList.contains('open')) return;
    if (!drawer.contains(e.target) && !toggleBtn.contains(e.target)) {
      closeDrawer();
    }
  });

  // accessibility: close drawer with Escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeDrawer();
  });

  // allow other parts of app to set a backend endpoint dynamically:
  window.setOcrEndpoint = function(url) {
    uploadArea.dataset.ocrEndpoint = url;
  };

  // expose for debug/testing
  window._ocr = { processFile, processBlob, openDrawer, closeDrawer };

})();
</script>

<!-- Modal overlay (copied as requested) -->
<div id="profile-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-top-bar">
            <h3>Cooperative Profile</h3>
            <div class="modal-actions">
                <button class="pdf-btn" id="download-pdf-btn" title="Download as PDF">
                    <i class="bi bi-file-earmark-pdf-fill"></i> <span>Download Profile</span>
                </button>
                <button class="modal-close-btn">&times;</button>
            </div>
        </div>
        
        <div class="modal-scroll-area">
            <div id="printable-area">
                <div class="modal-header-section">
                    <div class="coop-avatar">C</div>
                    <div class="coop-title-info">
                        <h4 id="modal-coop-name">Consumer Cooperative</h4>
                        <span class="badge-cda">CDA: 1414-060923055</span>
                        <div class="update-info">Last Updated: Sept 30, 2025 by Isabel Delacion</div>
                    </div>
                </div>

                <div class="modal-body">
                    <section class="info-section">
                        <h5 class="section-title">Cooperative General Information</h5>
                        <div class="info-grid two-col">
                            <div class="info-item"><label>Cooperative Name</label><p>Consumer Cooperative</p></div>
                            <div class="info-item"><label>Cooperative Address</label><p>Sabang, Lipa City, Batangas</p></div>
                            <div class="info-item"><label>Contact Number</label><p>09929380925</p></div>
                            <div class="info-item"><label>Email Address</label><p>consumercoop@gmail.com</p></div>
                            <div class="info-item"><label>CDA Registration Number</label><p>1414-060923055</p></div>
                            <div class="info-item"><label>CDA Registration Date</label><p>09-06-2005</p></div>
                            <div class="info-item"><label>LCCDC Membership</label><p>09-14-2014</p></div>
                            <div class="info-item"><label>Area of Operation</label><p>Consumer</p></div>
                            <div class="info-item"><label>Business Activity</label><p>Supply and demand</p></div>
                            <div class="info-item"><label>No. of Board Directors</label><p>3</p></div>
                            <div class="info-item"><label>No. of Salaried Employees</label><p>14</p></div>
                            <div class="info-item"><label>Certificate of Compliance</label><p><span class="status-yes">Yes</span></p></div>
                            <div class="info-item"><label>Certificate of Tax Exemption</label><p><span class="status-yes">Yes</span></p></div>
                        </div>
                    </section>

                    <section class="info-section">
                        <h5 class="section-title">Financial Records</h5>
                        <div class="info-grid three-col">
                            <div class="info-item"><label>2022 Assets</label><p>₱ 142,657.00</p></div>
                            <div class="info-item"><label>2023 Assets</label><p>₱ 258,843.00</p></div>
                            <div class="info-item"><label>2024 Assets</label><p>₱ 356,964.68</p></div>
                            <div class="info-item"><label>Total Paid Up Capital</label><p>₱ 108,243.78</p></div>
                            <div class="info-item"><label>Net Surplus/Loss</label><p>₱ 10,653.54</p></div>
                        </div>
                    </section>

                    <section class="info-section">
                        <h5 class="section-title">Cooperative Officers</h5>
                        <div class="modal-table-wrapper">
                            <table class="modal-table">
                                <thead>
                                    <tr><th>Name</th><th>Position</th><th>Gender</th><th>Mobile Number</th><th>Email</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>Isabel Delacion</td><td>Chairperson</td><td>Female</td><td>0917-123-4567</td><td>isabel.d@email.com</td></tr>
                                    <tr><td>Jasmin Esperida</td><td>Vice Chairperson</td><td>Female</td><td>0918-234-5678</td><td>jasmin.e@email.com</td></tr>
                                    <tr><td>Art Delos Reyes</td><td>BOD Member</td><td>Male</td><td>0919-345-6789</td><td>art.dr@email.com</td></tr>
                                    <tr><td>Noe Gonzales</td><td>BOD Member</td><td>Male</td><td>0920-456-7890</td><td>noe.g@email.com</td></tr>
                                    <tr><td>Maria Lopez</td><td>Secretary</td><td>Female</td><td>0921-567-8901</td><td>maria.l@email.com</td></tr>
                                    <tr><td>Ramon Santos</td><td>Treasurer</td><td>Male</td><td>0922-678-9012</td><td>ramon.s@email.com</td></tr>
                                    <tr><td>Luis Fernando</td><td>Credit Comm.</td><td>Male</td><td>0923-789-0123</td><td>luis.f@email.com</td></tr>
                                    <tr><td>Anna Cruz</td><td>Educ. Comm.</td><td>Female</td><td>0924-890-1234</td><td>anna.c@email.com</td></tr>
                                    <tr><td>Pedro Tan</td><td>Manager</td><td>Male</td><td>0925-901-2345</td><td>pedro.t@email.com</td></tr>
                                    <tr><td>Luisa Moreno</td><td>Bookkeeper</td><td>Female</td><td>0926-012-3456</td><td>luisa.m@email.com</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <section class="info-section">
                        <h5 class="section-title">Cooperative Members</h5>
                        <div class="modal-table-wrapper">
                            <table class="modal-table">
                                <thead>
                                    <tr><th>Name</th><th>Gender</th><th>Mobile Number</th><th>Email</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>Juan dela Cruz</td><td>Male</td><td>0950-111-2222</td><td>juan.dc@email.com</td></tr>
                                    <tr><td>Maria Clara Santos</td><td>Female</td><td>0950-333-4444</td><td>maria.cs@email.com</td></tr>
                                    <tr><td>Jose Rizalino</td><td>Male</td><td>0950-555-6666</td><td>jose.r@email.com</td></tr>
                                    <tr><td>Andres Bonifacio Jr.</td><td>Male</td><td>0950-777-8888</td><td>andres.b@email.com</td></tr>
                                    <tr><td>Gabriela Silang</td><td>Female</td><td>0950-999-0000</td><td>gabriela.s@email.com</td></tr>
                                    <tr><td>Emilio Aguinaldo IV</td><td>Male</td><td>0951-111-2222</td><td>emilio.a@email.com</td></tr>
                                    <tr><td>Melchora Aquino</td><td>Female</td><td>0951-333-4444</td><td>melchora.a@email.com</td></tr>
                                    <tr><td>Antonio Luna</td><td>Male</td><td>0951-555-6666</td><td>antonio.l@email.com</td></tr>
                                    <tr><td>Gregorio del Pilar</td><td>Male</td><td>0951-777-8888</td><td>gregorio.dp@email.com</td></tr>
                                    <tr><td>Apolinario Mabini</td><td>Male</td><td>0951-999-0000</td><td>apolinario.m@email.com</td></tr>
                                    <tr><td>Teresa Magbanua</td><td>Female</td><td>0952-111-2222</td><td>teresa.m@email.com</td></tr>
                                    <tr><td>Diego Silang</td><td>Male</td><td>0952-333-4444</td><td>diego.s@email.com</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </section>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="secondary-btn close-modal-trigger">Close</button>
            <button class="primary-btn edit-btn"><i class="bi bi-pencil-square"></i> Edit Profile</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const modal = document.getElementById('profile-modal');
        const tableRows = document.querySelectorAll('tr[data-modal-target]');
        const closeButtons = document.querySelectorAll('.modal-close-btn, .close-modal-trigger');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');

        if (modal) {
            tableRows.forEach(row => {
                row.addEventListener('click', function() {
                    modal.classList.add('visible');
                });
            });

            const closeModal = () => {
                modal.classList.remove('visible');
            };

            closeButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    closeModal();
                });
            });

            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });

            if (downloadPdfBtn) {
                downloadPdfBtn.addEventListener('click', function() {
                    const element = document.getElementById('printable-area');
                    const coopName = document.getElementById('modal-coop-name').textContent.trim();
                    
                    const opt = {
                        margin: 0.2,
                        filename: `${coopName}_Profile.pdf`,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2, useCORS: true },
                        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
                    };
                    
                    const originalContent = this.innerHTML;
                    this.innerHTML = '<i class="bi bi-hourglass-split"></i> Generating...';
                    this.disabled = true;

                    html2pdf().set(opt).from(element).save().then(() => {
                        this.innerHTML = originalContent;
                        this.disabled = false;
                    }).catch(err => {
                        console.error(err);
                        this.innerHTML = originalContent;
                        this.disabled = false;
                    });
                });
            }
        }
    });
</script>
{% endblock %}

{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>{% block title %}KoopTimizer{% endblock %}</title>
    <link rel="manifest" href="{% static 'manifest.json' %}">
    <meta name="apple-mobile-web-app-status-bar-style" content="#3367D6">
    <link href="{% static 'frontend/base.css' %}" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css" />

    {% block extra_head %}{% endblock %}

</head>
<body>

    <script src="{% static 'main.js' %}"></script>

    <header>
        <div class="logo-title">

            {% if request.session.user_id %}
                <button id="sidebar-toggle-btn" class="sidebar-toggle">
                    <i class="bi bi-list"></i>
                </button>
            {% endif %}

            <img src="{% static 'frontend/images/Logo.png' %}" alt="Kooptimizer Logo" class="logo">
            <h1>KoopTimizer</h1>
        </div>
       <nav>
            <ul>
                {% if request.session.user_id %}
                {% if request.session.role == 'admin' or request.session.role == 'staff' or request.session.role == 'cooperative_officer'%}
                    <li class="logout-button">
                        <a href="#" data-bs-toggle="modal" data-bs-target="#logoutModal">
                            Logout
                        </a>
                    </li>
                {% endif %}
                {% else %}
                    <li><a href="{% url 'home' %}">Home</a></li>
                    <li><a href="{% url 'login' %}">Login</a></li>
                    <li><a href="{% url 'download' %}">Download</a></li>
                    <li><a href="{% url 'about' %}">About</a></li>
                {% endif %}
            </ul>
        </nav>
</header>

    <main>
        {% block content %}
        {% endblock %}
    </main>

    <!-- Global Django messages (bottom-right, styled) -->
    <div id="django-messages" aria-live="polite" aria-atomic="true">
        {% if messages %}
            {% for message in messages %}
                <div class="dj-message dj-{{ message.tags }}" role="status">
                    <div class="dj-message-left">
                        <div class="dj-message-icon" aria-hidden="true">!</div>
                    </div>
                    <div class="dj-message-body">
                        <div class="dj-message-text">{{ message }}</div>
                    </div>
                    <button class="dj-message-close" aria-label="Close message">Ã—</button>
                </div>
            {% endfor %}
        {% endif %}
    </div>

    <script>
        // Floating message behavior: auto-dismiss and manual close with animation
        (function () {
            const container = document.getElementById('django-messages');
            if (!container) return;

            function dismiss(el) {
                el.style.transition = 'opacity 240ms ease, transform 240ms ease';
                el.style.opacity = '0';
                el.style.transform = 'translateX(18px)';
                setTimeout(() => { if (el.parentNode) el.parentNode.removeChild(el); }, 260);
            }

            container.querySelectorAll('.dj-message').forEach((el) => {
                // close button
                const btn = el.querySelector('.dj-message-close');
                if (btn) btn.addEventListener('click', () => dismiss(el));

                // auto-dismiss after 5s
                setTimeout(() => { if (document.body.contains(el)) dismiss(el); }, 5000);
            });
        })();
    </script>
  {% if request.session.user_id %}
    <div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered"> 
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="logoutModalLabel">Logout</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to log out?
                </div>
                <div class="modal-footer">
                    <button id="btn-logout-cancel" type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <a id="btn-logout-confirm" href="{% url 'logout' %}" class="btn btn-primary">Continue Logout</a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <footer>
        <p>&copy; {% now "Y" %} KoopTimizer. All rights reserved.</p>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script>

    <script>
        window.deferredPrompt = null; 

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            
            // 2. Assign the event to the global 'window' variable
            window.deferredPrompt = e; 
            
            const installButton = document.getElementById('install-pwa-button');
            if (installButton) {
                installButton.style.display = 'block';
                {% comment %} document.getElementById('install-instructions').style.display = 'none'; {% endcomment %}
            }
        });

        NProgress.configure({ 
            showSpinner: true, 
            easing: 'ease',    
            speed: 500        
        });
        // Find all links and forms
        const allLinks = document.querySelectorAll('a[href]:not([data-bs-toggle])');
        const allForms = document.querySelectorAll('form');

        // Add click listener to links
        allLinks.forEach(link => {
            link.addEventListener('click', () => {
                NProgress.start();
            });
        });

        // Add submit listener to forms
        allForms.forEach(form => {
            form.addEventListener('submit', () => {
                NProgress.start();
            });
        });

        // This handles stopping NProgress if a user hits the back button
        window.addEventListener('pageshow', (e) => {
            if (e.persisted) { 
                NProgress.done();
            }
        });

        const logoutModal = document.getElementById('logoutModal');
        if (logoutModal) {
            logoutModal.addEventListener('hidden.bs.modal', () => {
                NProgress.done(); // Stop and remove the bar
            });
        }
    </script>
    {% block extra_scripts %}{% endblock %}
</body>
</html>
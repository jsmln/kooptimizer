
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>{% block title %}KoopTimizer{% endblock %}</title>
    
    <!-- Favicons -->
    <link rel="icon" type="image/png" sizes="48x48" href="{% static 'css/images/icon-48x48.png' %}">
    <link rel="icon" type="image/png" sizes="96x96" href="{% static 'css/images/icon-96x96.png' %}">
    <link rel="icon" type="image/png" sizes="192x192" href="{% static 'css/images/icon-192x192.png' %}">
    <link rel="apple-touch-icon" sizes="152x152" href="{% static 'css/images/icon-152x152.png' %}">
    <link rel="apple-touch-icon" sizes="192x192" href="{% static 'css/images/icon-192x192.png' %}">
    
    <link rel="manifest" href="{% static 'manifest.json' %}">
    <meta name="apple-mobile-web-app-status-bar-style" content="#3367D6">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link href="{% static 'frontend/base.css' %}?v=2.7.0" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css" />

    {% block extra_head %}{% endblock %}

</head>
<body>

    <script src="{% static 'main.js' %}"></script>

    {% block header %}
    <header>
        <div class="logo-title">
            {% if request.session.user_id %}
                <button id="sidebar-toggle-btn" class="sidebar-toggle">
                    <i class="bi bi-list"></i>
                </button>
            {% endif %}

            <img src="{% static 'frontend/images/Logo.png' %}" alt="Kooptimizer Logo" class="logo">
            <h1>KoopTimizer</h1>
        </div>
       <nav>
            <ul>
                {% if request.session.user_id and not request.session.pending_verification_user_id %}
                {% if request.session.role == 'admin' or request.session.role == 'staff' or request.session.role == 'officer'%}
                    <li class="logout-button">
                        <a href="#" data-bs-toggle="modal" data-bs-target="#logoutModal">Logout</a>
                    </li>
                {% endif %}
                {% elif not request.session.pending_verification_user_id %}
                    <li><a href="{% url 'home' %}" class="{% if request.resolver_match.url_name == 'home' %}active{% endif %}">Home</a></li>
                    <li><a href="{% url 'login' %}" class="{% if request.resolver_match.url_name == 'login' %}active{% endif %}">Login</a></li>
                    <li><a href="{% url 'download' %}" class="{% if request.resolver_match.url_name == 'download' %}active{% endif %}">Download</a></li>
                    <li><a href="{% url 'about' %}" class="{% if request.resolver_match.url_name == 'about' %}active{% endif %}">About</a></li>
                {% endif %}
            </ul>
        </nav>
    </header>
    {% endblock %}

    {% block main_body %}
    <main>
        {% block content %}
        {% endblock %}
    </main>
    {% endblock %}

    <div id="django-messages" aria-live="polite" aria-atomic="true">
        {% if messages %}
            {% for message in messages %}
                <div class="dj-message dj-{{ message.tags }}" role="status">
                    <div class="dj-message-left">
                        <div class="dj-message-icon" aria-hidden="true">!</div>
                    </div>
                    <div class="dj-message-body">
                        <div class="dj-message-text">{{ message }}</div>
                    </div>
                    <button class="dj-message-close" aria-label="Close message">Ã—</button>
                </div>
            {% endfor %}
        {% endif %}
    </div>

    {% block footer %}
    <footer>
        <p>&copy; {% now "Y" %} KoopTimizer. All rights reserved.</p>
    </footer>
    {% endblock %}

    <script>
        // Floating message behavior
        (function () {
            const container = document.getElementById('django-messages');
            if (!container) return;
            function dismiss(el) {
                el.style.transition = 'opacity 240ms ease, transform 240ms ease';
                el.style.opacity = '0';
                el.style.transform = 'translateX(18px)';
                setTimeout(() => { if (el.parentNode) el.parentNode.removeChild(el); }, 260);
            }
            container.querySelectorAll('.dj-message').forEach((el) => {
                const btn = el.querySelector('.dj-message-close');
                if (btn) btn.addEventListener('click', () => dismiss(el));
                setTimeout(() => { if (document.body.contains(el)) dismiss(el); }, 5000);
            });
        })();
    </script>

    {% if request.session.user_id and not request.session.pending_verification_user_id %}
    <div class="modal fade" id="logoutModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered"> 
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Logout</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">Are you sure you want to log out?</div>
                <div class="modal-footer">
                    <button id="btn-logout-cancel" type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <a id="btn-logout-confirm" href="{% url 'users:logout' %}" class="btn btn-primary">Continue Logout</a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script>

    <script>
        // NProgress Logic
        NProgress.configure({ showSpinner: true, easing: 'ease', speed: 500 });
        const allLinks = document.querySelectorAll('a[href]:not([data-bs-toggle])');
        const allForms = document.querySelectorAll('form');
        allLinks.forEach(link => link.addEventListener('click', () => NProgress.start()));
        allForms.forEach(form => form.addEventListener('submit', () => NProgress.start()));
        window.addEventListener('pageshow', (e) => { if (e.persisted) NProgress.done(); });
    </script>

    {% if request.session.user_id and not request.session.pending_verification_user_id %}
    <script>
        // ====================================================================
        // SESSION TIMEOUT & BROWSER CLOSE DETECTION
        // ====================================================================
        
        // Session timeout: 15 minutes (900000ms)
        const SESSION_TIMEOUT = 900000; // 15 minutes
        const WARNING_TIME = 60000; // Show warning 1 minute before timeout
        let sessionTimer;
        let warningTimer;
        let warningShown = false;

        function resetSessionTimer() {
            // Clear existing timers
            clearTimeout(sessionTimer);
            clearTimeout(warningTimer);
            warningShown = false;
            
            // Set warning timer (14 minutes)
            warningTimer = setTimeout(() => {
                if (!warningShown) {
                    warningShown = true;
                    if (confirm('Your session will expire in 1 minute due to inactivity. Click OK to stay logged in.')) {
                        // User clicked OK, reset the timer
                        resetSessionTimer();
                        // Ping server to keep session alive
                        fetch('{% url "home" %}', { method: 'HEAD' });
                    }
                }
            }, SESSION_TIMEOUT - WARNING_TIME);
            
            // Set logout timer (15 minutes)
            sessionTimer = setTimeout(() => {
                alert('Your session has expired due to inactivity. You will be logged out.');
                window.location.href = '{% url "users:logout" %}';
            }, SESSION_TIMEOUT);
        }

        // Reset timer on user activity
        ['mousedown', 'keydown', 'scroll', 'touchstart', 'click'].forEach(event => {
            document.addEventListener(event, resetSessionTimer, { passive: true });
        });

        // Start the session timer
        resetSessionTimer();

        // ====================================================================
        // BROWSER/TAB CLOSE DETECTION
        // ====================================================================
        
        // Track if user explicitly logged out or navigating within the app
        let explicitLogout = false;
        let isNavigating = false;
        
        // Mark explicit logout
        const logoutBtn = document.getElementById('btn-logout-confirm');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                explicitLogout = true;
            });
        }

        // Track internal navigation (clicking links within the app)
        document.addEventListener('click', (e) => {
            const link = e.target.closest('a');
            if (link && link.href && link.href.startsWith(window.location.origin)) {
                // Internal link - this is navigation, not closing
                isNavigating = true;
                // Reset after a short delay
                setTimeout(() => { isNavigating = false; }, 100);
            }
        });

        // Track form submissions (also internal navigation)
        document.addEventListener('submit', (e) => {
            isNavigating = true;
            setTimeout(() => { isNavigating = false; }, 100);
        });

        // Detect browser/tab close and logout
        window.addEventListener('beforeunload', (e) => {
            // Only show warning if NOT navigating within app and NOT logging out
            // Also check if we're on certain pages that handle their own navigation
            const isAnnouncementPage = window.location.pathname.includes('/announcement');
            const isMessagePage = window.location.pathname.includes('/message');
            
            if (!explicitLogout && !isNavigating && !isAnnouncementPage && !isMessagePage) {
                // Show confirmation message
                e.preventDefault();
                e.returnValue = 'You are still logged in. Are you sure you want to leave? Your session will end.';
                
                // Use sendBeacon to logout immediately (non-blocking)
                
                // This ensures logout happens even if user confirms leaving
                const logoutUrl = '{% url "users:logout" %}';
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
                
                // Send logout request using sendBeacon (works even as page unloads)
                const formData = new FormData();
                formData.append('csrfmiddlewaretoken', csrfToken);
                navigator.sendBeacon(logoutUrl, formData);
                
                return e.returnValue;
            }
        });

        // PWA visibility change detection
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // Page is hidden (tab switched or minimized)
                console.log('Page hidden - session will expire after timeout');
            } else {
                // Page is visible again - check if session is still valid
                fetch('{% url "home" %}', { method: 'HEAD' })
                    .then(response => {
                        if (response.redirected && response.url.includes('login')) {
                            alert('Your session has expired. Please log in again.');
                            window.location.href = '{% url "login" %}';
                        } else {
                            // Session still valid, reset timer
                            resetSessionTimer();
                        }
                    })
                    .catch(() => {
                        console.log('Could not verify session');
                    });
            }
        });
    </script>
    {% endif %}

    {% block extra_scripts %}{% endblock %}
</body>
</html>


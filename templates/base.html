
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>{% block title %}KoopTimizer{% endblock %}</title>
    
    <!-- Favicons -->
    <link rel="icon" type="image/png" sizes="48x48" href="{% static 'css/images/icon-48x48.png' %}">
    <link rel="icon" type="image/png" sizes="96x96" href="{% static 'css/images/icon-96x96.png' %}">
    <link rel="icon" type="image/png" sizes="192x192" href="{% static 'css/images/icon-192x192.png' %}">
    <link rel="apple-touch-icon" sizes="152x152" href="{% static 'css/images/icon-152x152.png' %}">
    <link rel="apple-touch-icon" sizes="192x192" href="{% static 'css/images/icon-192x192.png' %}">
    
    <link rel="manifest" href="{% static 'manifest.json' %}">
    <meta name="apple-mobile-web-app-status-bar-style" content="#3367D6">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link href="{% static 'frontend/base.css' %}?v=2.7.0" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css" />

    {% block extra_head %}{% endblock %}

</head>
<body>

    {% block header %}
    <header>
        <div class="logo-title">
            {% if request.session.user_id %}
                <button id="sidebar-toggle-btn" class="sidebar-toggle">
                    <i class="bi bi-list"></i>
                </button>
            {% endif %}

            <img src="{% static 'frontend/images/Logo.png' %}" alt="Kooptimizer Logo" class="logo">
            <h1>KoopTimizer</h1>
        </div>
       <nav>
            {% if request.session.user_id and not request.session.pending_verification_user_id %}
            <div class="topbar-actions" style="display:flex; align-items:center; gap:10px;">
                <!-- Notification bell (loads activity on click) -->
                <div class="notification-bell" style="position:relative;">
                    <button id="global-bell-btn" class="btn" title="Activity" style="background:transparent; border:none; color:var(--text-dark); font-size:1.25rem;">
                        <i class="bi bi-bell-fill"></i>
                        <span id="global-activity-badge" class="activity-badge" style="display:none;">0</span>
                    </button>
                    <div id="global-activity-dropdown" class="activity-dropdown" style="display:none; position:absolute; right:0; top:36px; background:white; border:1px solid #eee; border-radius:8px; box-shadow:0 8px 20px rgba(0,0,0,0.08); width:320px; z-index:120;">
                        <div style="padding:8px 12px; border-bottom:1px solid #f5f5f5; font-weight:700;">Recent Activity</div>
                        <div id="global-activity-dropdown-list" style="max-height:260px; overflow:auto;"></div>
                        <div style="padding:8px 12px; border-top:1px solid #f5f5f5; text-align:center;"><a href="#" class="small">View all</a></div>
                    </div>
                </div>

                <!-- Profile dropdown (uniform across modules) -->
                <div class="profile-dropdown" style="position:relative;">
                    <button id="global-profile-btn" class="btn" style="display:flex; align-items:center; gap:8px; background:transparent; border:none;">
                        <div class="avatar" style="width:32px; height:32px; border-radius:50%; background:var(--brand-red); color:#fff; display:flex; align-items:center; justify-content:center; font-weight:700;">{{ request.session.username|first|upper }}</div>
                        <div style="text-align:left; line-height:1;">
                            <div style="font-weight:600; font-size:0.9rem; color:var(--text-dark);">{{ request.session.username }}</div>
                            <div style="font-size:0.75rem; color:var(--text-gray);">{{ request.session.role|capfirst }}</div>
                        </div>
                    </button>

                    <div id="global-profile-dropdown" style="display:none; position:absolute; right:0; top:48px; background:white; border:1px solid #eee; border-radius:8px; box-shadow:0 12px 30px rgba(0,0,0,0.08); width:240px; z-index:120;">
                        <div style="padding:12px; border-bottom:1px solid #f5f5f5; display:flex; gap:10px; align-items:center;">
                            <div class="avatar" style="width:40px; height:40px; border-radius:50%; background:var(--brand-red); color:#fff; display:flex; align-items:center; justify-content:center; font-weight:700;">{{ request.session.username|first|upper }}</div>
                            <div>
                                <div style="font-weight:700;">{{ request.session.username }}</div>
                                <div style="font-size:0.8rem; color:#707EAE;">{{ request.session.role|capfirst }}</div>
                            </div>
                        </div>
                        <div style="padding:8px 0;">
                            <a href="{% url 'users:profile_settings' %}" class="dropdown-item" style="display:block; padding:10px 14px;">Settings</a>
                            <a href="#" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#logoutModal" style="display:block; padding:10px 14px;">Logout</a>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
                <ul>
                    <li>
                        <a href="{% url 'home' %}" class="{% if request.resolver_match.url_name == 'home' %}active{% endif %}">Home</a>
                    </li>
                    <li>
                        <a href="{% url 'login' %}" class="{% if request.resolver_match.url_name == 'login' %}active{% endif %}">Login</a>
                    </li>
                    <li><a href="{% url 'download' %}" class="{% if request.resolver_match.url_name == 'download' %}active{% endif %}">Download</a></li>
                    <li><a href="{% url 'about' %}" class="{% if request.resolver_match.url_name == 'about' %}active{% endif %}">About</a></li>
                </ul>
            {% endif %}
        </nav>
    </header>
    {% endblock %}

    {% block main_body %}
    <main>
        {% block content %}
        {% endblock %}
    </main>
    {% endblock %}

    <div id="django-messages" aria-live="polite" aria-atomic="true">
        {% if messages %}
            {% for message in messages %}
                <div class="dj-message dj-{{ message.tags }}" role="status">
                    <div class="dj-message-left">
                        <div class="dj-message-icon" aria-hidden="true">!</div>
                    </div>
                    <div class="dj-message-body">
                        <div class="dj-message-text">{{ message }}</div>
                    </div>
                    <button class="dj-message-close" aria-label="Close message">×</button>
                </div>
            {% endfor %}
        {% endif %}
    </div>

    {% block footer %}
    <footer>
        <p>&copy; {% now "Y" %} KoopTimizer. All rights reserved.</p>
    </footer>
    {% endblock %}

    <script>
        // Floating message behavior
        (function () {
            const container = document.getElementById('django-messages');
            if (!container) return;
            function dismiss(el) {
                el.style.transition = 'opacity 240ms ease, transform 240ms ease';
                el.style.opacity = '0';
                el.style.transform = 'translateX(18px)';
                setTimeout(() => { if (el.parentNode) el.parentNode.removeChild(el); }, 260);
            }
            container.querySelectorAll('.dj-message').forEach((el) => {
                const btn = el.querySelector('.dj-message-close');
                if (btn) btn.addEventListener('click', () => dismiss(el));
                setTimeout(() => { if (document.body.contains(el)) dismiss(el); }, 5000);
            });
        })();
    </script>

    {% if request.session.user_id and not request.session.pending_verification_user_id %}
    <div class="modal fade" id="logoutModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered"> 
            <div class="modal-content logout-modal-content">
                <div class="modal-header logout-modal-header">
                    <h5 class="modal-title logout-modal-title">Logout</h5>
                    <button type="button" class="btn-close logout-modal-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body logout-modal-body">Are you sure you want to log out?</div>
                <div class="modal-footer logout-modal-footer">
                    <button id="btn-logout-cancel" type="button" class="btn logout-btn-cancel" data-bs-dismiss="modal">Cancel</button>
                    <a id="btn-logout-confirm" href="{% url 'users:logout' %}" class="btn logout-btn-confirm">Continue Logout</a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script>

    <!-- Global activity/profile dropdown JS (used across modules) -->
    <script>
    document.addEventListener('DOMContentLoaded', function(){
        // Activity bell logic
        const bellBtn = document.getElementById('global-bell-btn');
        const badge = document.getElementById('global-activity-badge');
        const dropdown = document.getElementById('global-activity-dropdown');
        const list = document.getElementById('global-activity-dropdown-list');

        function setGlobalBadge(n){ if(!badge) return; if(n>0){ badge.textContent = n>99? '99+': n; badge.style.display='inline-block'; } else badge.style.display='none'; }

        function buildHtml(items){ if(!items || items.length===0) return '<div style="padding:12px;color:#A3AED0;">No recent messages</div>'; return items.map(it=>`<div style="padding:10px 12px;border-bottom:1px solid #f5f5f5;"><div style="font-weight:600;color:var(--text-dark);">${it.title}</div><div style="font-size:0.8rem;color:#707EAE;margin-top:4px;">${it.sender} · ${it.time}</div></div>`).join(''); }

        function loadActivity(){
            fetch('{% url "communications:api_recent_activity" %}')
            .then(r=>{ if(!r.ok) throw new Error('Network'); return r.json(); })
            .then(data=>{ if(data.status==='success'){ const acts=data.activities||[]; setGlobalBadge(acts.length); if(list) list.innerHTML = buildHtml(acts.slice(0,6)); }})
            .catch(e=>{ console.error('Global activity error',e); if(list) list.innerHTML = '<div style="padding:12px;color:red;">Error loading activity</div>'; setGlobalBadge(0); });
        }

        if(bellBtn && dropdown){
            bellBtn.addEventListener('click', function(e){ e.stopPropagation(); const open = dropdown.style.display==='block'; if(!open){ loadActivity(); dropdown.style.display='block'; } else dropdown.style.display='none'; });
            document.addEventListener('click', function(e){ if(!dropdown.contains(e.target) && e.target !== bellBtn && !bellBtn.contains(e.target)) dropdown.style.display='none'; });
        }

        // Profile dropdown
        const profBtn = document.getElementById('global-profile-btn');
        const profDropdown = document.getElementById('global-profile-dropdown');
        if(profBtn && profDropdown){
            profBtn.addEventListener('click', function(e){ e.stopPropagation(); profDropdown.style.display = profDropdown.style.display === 'block' ? 'none' : 'block'; });
            document.addEventListener('click', function(e){ if(!profDropdown.contains(e.target) && e.target !== profBtn && !profBtn.contains(e.target)) profDropdown.style.display='none'; });
        }
    });
    </script>

    <script>
        // NProgress Logic
        NProgress.configure({ showSpinner: true, easing: 'ease', speed: 500 });
        const allLinks = document.querySelectorAll('a[href]:not([data-bs-toggle])');
        const allForms = document.querySelectorAll('form');
        allLinks.forEach(link => link.addEventListener('click', () => NProgress.start()));
        allForms.forEach(form => form.addEventListener('submit', () => NProgress.start()));
        window.addEventListener('pageshow', (e) => { if (e.persisted) NProgress.done(); });
    </script>

    {% if request.session.user_id and not request.session.pending_verification_user_id %}
    <script>
        // ====================================================================
        // SESSION TIMEOUT & BROWSER CLOSE DETECTION
        // ====================================================================
        
        // Session timeout: 15 minutes (900000ms)
        const SESSION_TIMEOUT = 900000; // 15 minutes
        const WARNING_TIME = 60000; // Show warning 1 minute before timeout
        let sessionTimer;
        let warningTimer;
        let warningShown = false;

        function resetSessionTimer() {
            // Clear existing timers
            clearTimeout(sessionTimer);
            clearTimeout(warningTimer);
            warningShown = false;
            
            // Set warning timer (14 minutes)
            warningTimer = setTimeout(() => {
                if (!warningShown) {
                    warningShown = true;
                    if (confirm('Your session will expire in 1 minute due to inactivity. Click OK to stay logged in.')) {
                        // User clicked OK, reset the timer
                        resetSessionTimer();
                        // Ping server to keep session alive
                        fetch('{% url "home" %}', { method: 'HEAD' });
                    }
                }
            }, SESSION_TIMEOUT - WARNING_TIME);
            
            // Set logout timer (15 minutes)
            sessionTimer = setTimeout(() => {
                alert('Your session has expired due to inactivity. You will be logged out.');
                window.location.href = '{% url "users:logout" %}';
            }, SESSION_TIMEOUT);
        }

        // Reset timer on user activity
        ['mousedown', 'keydown', 'scroll', 'touchstart', 'click'].forEach(event => {
            document.addEventListener(event, resetSessionTimer, { passive: true });
        });

        // Start the session timer
        resetSessionTimer();

        // ====================================================================
        // BROWSER/TAB CLOSE DETECTION
        // ====================================================================
        
        // Track if user explicitly logged out or navigating within the app
        // Session management via Django session cookies
        // Show logout confirmation when user tries to close browser/tab
        
        let userConfirmedLogout = false;
        
        // Only show beforeunload confirmation if a form is dirty (unsaved changes)
        document.addEventListener('DOMContentLoaded', function() {
            const forms = document.querySelectorAll('form');
            forms.forEach(form => {
                let isDirty = false;
                form.addEventListener('change', () => { isDirty = true; });
                form.addEventListener('input', () => { isDirty = true; });
                window.addEventListener('beforeunload', function(e) {
                    if (isDirty) {
                        e.preventDefault();
                        e.returnValue = '';
                        return '';
                    }
                });
            });
        });
        
        // Mark explicit logout to skip confirmation
        const logoutBtn = document.getElementById('btn-logout-confirm');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                sessionStorage.setItem('explicit_logout', 'true');
            });
        }

        // No beforeunload logout - Django session cookie handles browser close
        // SESSION_EXPIRE_AT_BROWSER_CLOSE = True means session automatically expires
        // when browser/tab closes, without unreliable JavaScript detection

        // PWA visibility change detection
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // Page is hidden (tab switched or minimized)
                console.log('Page hidden - session will expire after timeout');
            } else {
                // Page is visible again - check if session is still valid
                fetch('{% url "home" %}', { method: 'HEAD' })
                    .then(response => {
                        if (response.redirected && response.url.includes('login')) {
                            alert('Your session has expired. Please log in again.');
                            window.location.href = '{% url "login" %}';
                        } else {
                            // Session still valid, reset timer
                            resetSessionTimer();
                        }
                    })
                    .catch(() => {
                        console.log('Could not verify session');
                    });
            }
        });
    </script>
    {% endif %}

    {% block extra_scripts %}{% endblock %}
</body>
</html>


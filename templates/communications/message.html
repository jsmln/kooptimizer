{% extends 'dashboard/dashboard.html' %}
{% load static %}

{% block dashboard_title %}Messages{% endblock %}

{% block extra_head %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'frontend/message.css' %}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <style>
    /* --- HIDE DASHBOARD HEADER ELEMENTS --- */
    .top-bar .page-title,
    .top-bar .search-box {
        display: none !important;
    }
    
    .top-bar .user-menu {
        display: none !important;
    }
    
    .top-bar #sidebar-toggle-btn {
        display: none !important;
    }
    
    .top-bar .top-left {
        display: none !important;
    }
    
    /* --- CUSTOM MESSAGES HEADER --- */
    .messages-header {
        position: fixed;
        top: 0;
        left: 250px;
        right: 0;
        height: 60px;
        background: white;
        border-bottom: 1px solid #edf2f7;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 30px;
        z-index: 50;
        box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }
    
    .messages-header-left {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .messages-header h1 {
        margin: 0;
        font-size: 1.3rem;
        font-weight: 700;
        color: #2B3674;
    }
    
    /* Profile Dropdown */
    .profile-dropdown {
        position: relative;
    }
    
    .profile-trigger {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 12px;
        transition: background 0.2s;
    }
    
    .profile-trigger:hover {
        background: #f7f9fc;
    }
    
    .profile-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #a91e2c;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1rem;
    }
    
    .profile-info {
        display: flex;
        flex-direction: column;
        text-align: left;
        line-height: 1.2;
    }
    
    .profile-name {
        font-weight: 600;
        font-size: 0.9rem;
        color: #2B3674;
    }
    
    .profile-role {
        font-size: 0.75rem;
        color: #A3AED0;
    }
    
    .dropdown-arrow {
        color: #A3AED0;
        font-size: 0.8rem;
        transition: transform 0.2s;
    }
    
    .profile-dropdown.active .dropdown-arrow {
        transform: rotate(180deg);
    }
    
    /* Dropdown Menu */
    .dropdown-menu-custom {
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        min-width: 200px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.2s ease;
        z-index: 1000;
    }
    
    .profile-dropdown.active .dropdown-menu-custom {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }
    
    .dropdown-item-custom {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        color: #2B3674;
        text-decoration: none;
        transition: background 0.2s;
        border-radius: 8px;
        margin: 4px;
    }
    
    .dropdown-item-custom:first-child {
        margin-top: 8px;
    }
    
    .dropdown-item-custom:last-child {
        margin-bottom: 8px;
    }
    
    .dropdown-item-custom:hover {
        background: #f7f9fc;
        color: #2B3674;
    }
    
    .dropdown-item-custom i {
        font-size: 1.1rem;
        width: 20px;
        text-align: center;
    }
    
    .dropdown-item-custom.logout {
        color: #a91e2c;
        border-top: 1px solid #f0f0f0;
        margin-top: 4px;
    }
    
    .dropdown-item-custom.logout:hover {
        background: #fff0f2;
        color: #a91e2c;
    }
    
    /* Adjust content area for fixed header */
    .content-scrollable {
        margin-top: 60px !important;
        height: calc(100% - 60px) !important;
    }
    
    /* Mobile Responsive */
    @media (max-width: 992px) {
        .messages-header {
            left: 0;
            padding: 0 15px;
        }
        
        .profile-info {
            display: none;
        }
        
        .dropdown-arrow {
            display: none;
        }
        
        .content-scrollable {
            margin-top: 60px !important;
        }
    }
    
    /* --- 1. PARENT CONTAINER (Dashboard Center Panel) --- */
    /* We turn this into a Flex container to perfectly center the message box */
    .content-scrollable {
        padding: 0 !important; 
        height: 100%;
        width: 100%;
        display: flex;
        align-items: center;     /* Center Vertically */
        justify-content: center; /* Center Horizontally */
        overflow: hidden !important;
        background-color: #F4F7FE; /* Ensure it matches dashboard bg */
        position: relative;
    }

    /* --- 2. THE LAYOUT WRAPPER (The "Container") --- */
    .message-layout { 
        display: flex; 
        /* Reduce size to create the gap you want */
        width: 96%;  
        height: 92%; 
        max-width: 1400px; /* Prevent it from getting too wide on huge screens */
        
        gap: 20px; /* Space between Contact List and Chat */
        background: transparent;
        position: relative;
        z-index: 10;
        min-height: 0;
    }

    /* --- LEFT CARD: CONVERSATION LIST --- */
    .conversation-list { 
        width: 280px; 
        min-width: 250px; 
        max-width: 300px; 
        display: flex;
        flex-direction: column;
        
        /* Card Styling */
        background: #fff;
        border-radius: 16px;
        box-shadow: 0px 4px 20px rgba(0, 0, 0, 0.03); /* Very subtle shadow */
        overflow: hidden; 
        border: none;
        position: relative;
        z-index: 11;
        min-height: 0;
        height: 100%;
    }

    /* --- RIGHT CARD: CHAT WINDOW --- */
    .chat-window { 
        flex: 1; 
        display: flex; 
        flex-direction: column; 
        
        /* Card Styling */
        background: #fff;
        border-radius: 16px;
        box-shadow: 0px 4px 20px rgba(0, 0, 0, 0.03);
        overflow: hidden;
        border: none;
        min-height: 0;
        height: 100%;
    }

    /* --- INNER CONTENT SCROLLING --- */
    .contact-list {
        flex: 1;
        overflow-y: auto;
    }

    .message-area { 
        flex: 1; 
        overflow-y: auto !important;
        overflow-x: hidden;
        padding: 20px; 
        background: #fff; 
        display: flex;
        flex-direction: column;
        gap: 12px;
        min-height: 0;
        -webkit-overflow-scrolling: touch;
    }
    
    .message-area::-webkit-scrollbar {
        width: 6px;
    }
    
    .message-area::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    
    .message-area::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 10px;
    }
    
    .message-area::-webkit-scrollbar-thumb:hover {
        background: #999;
    }

    /* --- HEADER & FOOTER STYLING --- */
    .list-header, .chat-header {
        padding: 0 20px;
        border-bottom: 1px solid #f5f5f5;
        height: 60px; /* Reduced height slightly for a cleaner look */
        display: flex;
        align-items: center;
        background: #fff;
        flex-shrink: 0;
    }
    
    .list-header {
        justify-content: space-between;
    }
    
    .chat-header {
        justify-content: flex-start;
        gap: 12px;
    }
    
    .chat-header h3 {
        font-size: 1rem;
        font-weight: 700;
        margin: 0;
        color: #000;
        line-height: 1.4;
    }
    
    .chat-header .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #555;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.1rem;
        flex-shrink: 0;
    }

    .list-header h2, .chat-header h3 {
        font-size: 1.1rem;
        font-weight: 700;
        margin: 0;
        color: #000;
        text-align: left;
    }
    
    .list-header {
        background: #fff;
        z-index: 2;
    }
    
    .list-header h2 {
        font-size: 1.2rem;
    }

    .message-input { 
        display: flex; 
        align-items: center; 
        gap: 10px; 
        padding: 15px 20px; 
        border-top: 1px solid #f5f5f5; 
        background: #fff;
        flex-shrink: 0;
        z-index: 10;
        position: relative;
    }

    .message-input input[type="text"] { 
        flex: 1; 
        padding: 10px 15px; 
        border-radius: 20px; 
        border: 1px solid #eee; 
        background: #f9f9f9;
        outline: none;
        color: #000;
        font-size: 0.9rem;
        min-width: 0;
    }
    
    .message-input input[type="text"]:focus {
        border-color: #a91e2c; /* Red border on focus */
        background: #fff;
    }

    /* --- Search Bar --- */
    .search-bar {
        padding: 15px 20px;
        border-bottom: 1px solid #f5f5f5;
        position: relative;
        background: #fff;
        z-index: 1;
    }
    .search-bar input {
        width: 100%;
        padding: 10px 15px 10px 35px;
        border-radius: 12px;
        border: none;
        background: #f5f5f5;
        outline: none;
        font-size: 0.9rem;
        color: #000;
    }
    .search-bar .bi-search {
        position: absolute;
        left: 32px;
        top: 50%;
        transform: translateY(-50%);
        color: #888;
        font-size: 0.9rem;
        pointer-events: none;
    }

    /* --- Contact Items --- */
    .contact-item {
        display: flex;
        align-items: center;
        padding: 12px 20px;
        cursor: pointer;
        transition: background 0.2s;
        border-bottom: 1px solid #fafafa;
    }
    .contact-item:hover { background-color: #fafafa; }
    .contact-item.active { 
        background-color: #fff5f5; /* Very light red */
        border-left: 3px solid #a91e2c;
    }
    
    /* Contact name and details styling */
    .contact-name {
        color: #000 !important;
        font-weight: 500;
    }
    .contact-item.unread .contact-name {
        font-weight: 700 !important;
    }
    .contact-item.unread .message-preview {
        font-weight: 600 !important;
        color: #000 !important;
    }
    .contact-item.unread .timestamp {
        font-weight: 700 !important;
        color: #000 !important;
    }
    .contact-role {
        display: block;
        font-size: 11px !important;
        color: #888 !important;
        margin-top: 2px !important;
        margin-bottom: 4px !important;
        line-height: 1.2;
    }
    .contact-item.unread .contact-role {
        font-weight: 700 !important;
        color: #000 !important;
    }
    .message-preview {
        color: #666 !important;
    }

    /* --- Chat Bubbles --- */
    .message {
        padding: 10px 15px;
        border-radius: 15px;
        max-width: 75%;
        line-height: 1.4;
        font-size: 0.95rem;
        position: relative;
    }
    .message.incoming {
        background-color: #f5f5f5;
        color: #000;
        align-self: flex-start;
        border-bottom-left-radius: 2px;
    }
    .message.outgoing {
        background-color: #a91e2c;
        color: #fff;
        align-self: flex-end;
        border-bottom-right-radius: 2px;
    }
    .message .time {
        font-size: 0.65rem;
        margin-top: 4px;
        opacity: 0.7;
        text-align: right;
    }

    /* --- Buttons --- */
    .send-btn {
        background: #a91e2c;
        border: none;
        color: #fff;
        width: 40px; 
        height: 40px;
        border-radius: 50%;
        display: flex; 
        align-items: center; 
        justify-content: center;
        cursor: pointer;
        transition: 0.2s;
        flex-shrink: 0;
        z-index: 10;
        position: relative;
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
    }
    .send-btn:hover { background: #8a1824; }
    .send-btn:active { background: #6d1420; transform: scale(0.95); }
    .send-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .attach-btn {
        background: none; 
        border: none;
        color: #666; 
        font-size: 1.3rem;
        cursor: pointer; 
        padding: 0 5px;
        flex-shrink: 0;
        z-index: 10;
        position: relative;
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
    }
    .attach-btn:hover { color: #a91e2c; }

    .new-message-btn { color: #333; font-size: 1.2rem; }
    .new-message-btn:hover { color: #a91e2c; }

    /* --- ATTACHMENTS & PREVIEW --- */
    .attachment { margin-top:6px; }
    .attachment img.thumb { max-width: 200px; border-radius:8px; cursor:pointer; }
    .preview-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:1200; }
    .preview-content { background:#fff; width:85vw; height:85vh; border-radius:12px; overflow:hidden; display:flex; flex-direction:column; }

    /* --- Back Button (Mobile Only) --- */
    .back-btn {
        display: none;
        background: none;
        border: none;
        color: #000;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        margin-right: 10px;
        align-items: center;
        justify-content: center;
    }
    .back-btn:hover {
        color: #a91e2c;
    }

    /* --- Responsive Messenger-like Behavior --- */
    @media (max-width: 900px) {
        /* Stack layout vertically, full width/height */
        .message-layout { 
            flex-direction: column; 
            gap: 0; 
            width: 100%; 
            height: 100%; 
            max-height: 100%;
        }
        
        /* Sidebar takes full width and height initially */
        .conversation-list { 
            width: 100%; 
            max-width: none; 
            height: 100%;
            position: absolute;
            left: 0;
            top: 0;
            z-index: 2;
            transition: transform 0.3s ease;
            border-radius: 0;
        }
        
        /* Chat window takes full width and height, positioned behind sidebar */
        .chat-window { 
            width: 100%;
            height: 100%;
            max-height: 100%;
            position: absolute;
            left: 0;
            top: 0;
            z-index: 1;
            border-radius: 0;
        }
        
        /* When chat is active, slide sidebar to the left (hide it) */
        .conversation-list.slide-left {
            transform: translateX(-100%);
        }
        
        /* Show back button in chat header on mobile */
        .back-btn {
            display: flex;
        }
        
        /* Adjust header spacing for back button */
        .chat-header {
            padding: 15px 20px;
            flex-shrink: 0;
        }
        
        /* Ensure message area scrolls properly on mobile */
        .message-area {
            overflow-y: auto !important;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            flex: 1;
            min-height: 0;
        }
        
        /* Message input stays at bottom on mobile */
        .message-input {
            padding: 12px 15px;
            gap: 8px;
            position: relative;
            z-index: 20;
        }
        
        /* Ensure buttons are clickable on mobile */
        .send-btn,
        .attach-btn {
            pointer-events: auto;
            touch-action: manipulation;
        }
        
        .send-btn {
            min-width: 40px;
            min-height: 40px;
        }
    }
    
    /* Desktop: hide back button, show normal layout */
    @media (min-width: 901px) {
        .back-btn {
            display: none !important;
        }
    }
</style>

{% endblock %}

{% block dashboard_content %}

<!-- Custom Messages Header -->
<div class="messages-header">
    <div class="messages-header-left">
        <button id="messages-sidebar-toggle" class="d-md-none" style="background: white; border: none; color: #2B3674; font-size: 1.5rem; padding: 8px 12px; border-radius: 10px; cursor: pointer;">
            <i class="bi bi-list"></i>
        </button>
        <h1>Messages</h1>
    </div>
    
    <div class="profile-dropdown" id="profileDropdown">
        <div class="profile-trigger">
            <div class="profile-avatar">{{ request.session.username|first|upper }}</div>
            <div class="profile-info">
                <span class="profile-name">{{ request.session.username }}</span>
                <span class="profile-role">{{ request.session.role|capfirst }}</span>
            </div>
            <i class="bi bi-chevron-down dropdown-arrow"></i>
        </div>
        
        <div class="dropdown-menu-custom">
            <a href="{% url 'users:profile_settings' %}" class="dropdown-item-custom">
                <i class="bi bi-gear"></i>
                <span>Settings</span>
            </a>
            <a href="#" data-bs-toggle="modal" data-bs-target="#logoutModal" class="dropdown-item-custom logout">
                <i class="bi bi-box-arrow-right"></i>
                <span>Logout</span>
            </a>
        </div>
    </div>
</div>

<div class="message-layout">

    <div class="conversation-list">
        <div class="list-header">
            <h2>Messages</h2>
            <a href="#" class="new-message-btn" title="New Message">
                <i class="bi bi-pencil-square"></i>
            </a>
        </div>
        <div class="search-bar">
            <i class="bi bi-search"></i>
            <input type="text" placeholder="Search">
        </div>
        <div class="contact-list" id="contact-list">
            <div class="loading-spinner">Loading contacts...</div>
        </div>
    </div>

    <div class="chat-window">
        
        <div class="chat-header" id="chat-header-section">
            <button class="back-btn" id="back-btn" title="Back to contacts">
                <i class="bi bi-arrow-left"></i>
            </button>
            <div class="avatar" id="chat-avatar">-</div>
            <h3 id="chat-name"></h3>
        </div>

        <div class="message-area" id="message-area">
            <div class="empty-state" id="empty-state-message" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; color: #888;">
                <i class="bi bi-chat-dots" style="font-size: 64px; color: #ccc; margin-bottom: 16px;"></i>
                <p style="font-size: 16px; margin: 0;">Click the <i class="bi bi-pencil-square"></i> button to start a new conversation.</p>
            </div>
        </div>

        <div class="message-input" id="message-input-section">
            <!-- keep input in DOM but move offscreen to avoid display:none browser quirks -->
            <input type="file" id="file-input" style="position: absolute; left: -9999px;" accept="image/*,application/pdf,.doc,.docx,.xls,.xlsx">
            
            <button class="attach-btn" id="attach-btn" title="Attach file">
                <i class="bi bi-paperclip"></i>
            </button>
            <span id="attached-filename" style="margin-left:8px; font-size:12px; color:#666;"></span>
            
            <input type="text" id="text-input" placeholder="Type a message..." disabled>
            
            <button class="send-btn" id="send-btn" title="Send" disabled>
                <i class="bi bi-send-fill"></i>
            </button>
        </div>

    </div>

    <!-- New Message Modal -->
    <div id="new-message-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            
            <div class="modal-header">
                <h3>New Message</h3>
                <p class="modal-instruction">Select a contact to start a conversation.</p>
            </div>
            
            <div class="modal-body">
                <div class="modal-contact-list" id="modal-contact-list">
                    <div class="loading-spinner">Loading contacts...</div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Loading spinner overlay -->
<div id="loading-overlay" class="loading-spinner-overlay" style="display:none;">
    <div class="loading-content">
        <div class="spinner"></div>
        <p id="loading-text">Converting document to PDF...</p>
    </div>
</div>

<!-- Preview modal (hidden until used) -->
<div id="preview-modal" class="preview-overlay" style="display:none;">
    <div class="preview-content" role="dialog" aria-modal="true">
        <div class="preview-header">
            <div class="preview-title" id="preview-title">Preview</div>
            <div class="preview-controls">
                <button id="zoomOut" onclick="zoomOut()">âˆ’</button>
                <span class="preview-zoom-level" id="zoomLevel">100%</span>
                <button id="zoomIn" onclick="zoomIn()">+</button>
                <div id="page-controls" style="display:none; gap:8px; align-items:center;">
                    <button id="prevPage" onclick="previousPage()" style="background:#666;">â€¹ Prev</button>
                    <span class="preview-zoom-level" id="pageCounter" style="min-width:60px;">Page 1</span>
                    <button id="nextPage" onclick="nextPage()" style="background:#666;">Next â€º</button>
                </div>
                <a id="preview-download-original" class="btn" href="#" style="text-decoration:none; background:#d32f2f;">Download</a>
                <a id="preview-download-pdf" class="btn" href="#" style="text-decoration:none; background:#d32f2f; display:none;">As PDF</a>
                <button id="preview-close" onclick="closePreview()" style="background:#666;">âœ•</button>
            </div>
        </div>
        <div class="preview-body" id="preview-body">
            <!-- content injected dynamically: <img> or <canvas> for PDF -->
        </div>
    </div>
</div>

<script>
    // ========================================
    // Configuration
    // ========================================
    const userRole = "{{ user_role }}";
    let currentConversationReceiverId = null;
    let allContacts = [];

    // ========================================
    // DOM References
    // ========================================
    const contactList = document.querySelector('.contact-list');
    const messageArea = document.getElementById('message-area');
    const chatHeaderAvatar = document.getElementById('chat-avatar');
    const chatHeaderName = document.getElementById('chat-name');
    const textInput = document.getElementById('text-input');
    const sendBtn = document.getElementById('send-btn');
    const attachBtn = document.getElementById('attach-btn');
    const fileInput = document.getElementById('file-input');
    const searchInput = document.querySelector('.search-bar input');
    const newMsgBtn = document.querySelector('.new-message-btn');
    const newMsgModal = document.getElementById('new-message-modal');
    const modalCloseBtn = newMsgModal.querySelector('.modal-close-btn');
    const modalContactList = document.getElementById('modal-contact-list');
    const backBtn = document.getElementById('back-btn');
    const conversationListEl = document.querySelector('.conversation-list');

    // ========================================
    // Mobile Responsive Behavior
    // ========================================
    function showChatWindow() {
        // On mobile, slide the sidebar to the left to reveal chat
        if (window.innerWidth <= 900) {
            conversationListEl.classList.add('slide-left');
        }
    }

    function showContactList() {
        // On mobile, slide the sidebar back to show contacts
        if (window.innerWidth <= 900) {
            conversationListEl.classList.remove('slide-left');
        }
    }

    // Back button handler
    backBtn.addEventListener('click', () => {
        showContactList();
    });

    // ========================================
    // Utility Functions
    // ========================================
    function timeAgo(isoString) {
        if (!isoString) return "";
        const date = new Date(isoString);
        if (isNaN(date)) return isoString;
        const now = new Date();
        const seconds = Math.floor((now - date) / 1000);
        if (seconds < 10) return "Just now";
        let interval = seconds / 31536000;
        if (interval > 1) return Math.floor(interval) + "y ago";
        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + "mo ago";
        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + "d ago";
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + "h ago";
        interval = seconds / 60;
        if (interval >= 1) return Math.floor(interval) + "m ago";
        return Math.floor(seconds) + "s ago";
    }

    function getInitials(name) {
        return name ? name.charAt(0).toUpperCase() : "?";
    }

    // ========================================
    // Load Contacts (Updated)
    // ========================================
    async function loadContacts() {
        try {
            const response = await fetch('/communications/api/message/contacts/', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (response.status === 401) {
                alert('Session expired. You will be redirected to the login page.');
                window.location.href = '/';
                return;
            }

            const data = await response.json();

            if (data.status !== 'success') {
                throw new Error(data.message || 'Failed to load contacts');
            }

            // The backend now returns a pre-sorted flat list with last_message data
            allContacts = data.contacts;
            
            renderContacts();
            renderModalContacts();
        } catch (error) {
            console.error('Error loading contacts:', error);
            contactList.innerHTML = '<div class="empty-state">Failed to load contacts</div>';
        }
    }

    // ========================================
    // Render Contacts in Main List (Updated: Flat List)
    // ========================================
    function renderContacts() {
        contactList.innerHTML = '';

        if (allContacts.length === 0) {
            contactList.innerHTML = '<div class="empty-state">No contacts available</div>';
            return;
        }

        // Iterate directly over the flat list (no groups)
        allContacts.forEach(contact => {
            const contactElement = createContactElement(contact);
            contactList.appendChild(contactElement);
        });
    }

    function createContactElement(contact) {
        const contactDiv = document.createElement('div');
        contactDiv.className = 'contact-item';
        contactDiv.dataset.userId = contact.user_id;
        
        // Use data directly from the backend object
        const messagePreview = contact.last_message ? contact.last_message : 'No messages yet';
        const timestamp = contact.last_time ? timeAgo(contact.last_time) : '';
        const hasUnread = contact.unread_count && contact.unread_count > 0;
        
        // Add unread class if there are unread messages
        if (hasUnread) {
            contactDiv.classList.add('unread');
        }

        // Added Cooperative Name below the contact name
        contactDiv.innerHTML = `
            <div class="avatar">${getInitials(contact.name)}</div>
            <div class="contact-details">
                <span class="contact-name">${contact.name}</span>
                <span class="contact-role">${contact.coop}</span>
                <span class="message-preview">${escapeHtml(messagePreview)}</span>
            </div>
            <span class="timestamp" data-timestamp="${contact.last_time}">${timestamp}</span>
        `;

        contactDiv.addEventListener('click', () => {
            selectContact(contact);
        });

        return contactDiv;
    }

    // ========================================
    // Render Modal Contacts (Updated: Flat List)
    // ========================================
    function renderModalContacts() {
        modalContactList.innerHTML = '';

        if (allContacts.length === 0) {
            modalContactList.innerHTML = `
                <div class="empty-state d-flex flex-column align-items-center justify-content-center py-5 text-muted">
                    <p class="mt-3 mb-0 fw-medium">No contacts available</p>
                </div>`;
            return;
        }

        allContacts.forEach(contact => {
            const modalContactDiv = document.createElement('div');
            modalContactDiv.className = 'modal-contact-item';
            modalContactDiv.innerHTML = `
                <div class="avatar">${getInitials(contact.name)}</div>
                <div style="flex: 1;">
                    <span class="contact-name">${contact.name}</span>
                    <div style="font-size: 11px; color: #999;">${contact.coop}</div>
                </div>
            `;
                    
            modalContactDiv.addEventListener('click', () => {
                selectContact(contact);
                closeNewMsgModal();
            });

            modalContactList.appendChild(modalContactDiv);
        });
    }

    // ========================================
    // Select Contact and Load Conversation (Updated)
    // ========================================
    async function selectContact(contact) {
        currentConversationReceiverId = contact.user_id;
        
        // Save last opened contact to localStorage
        localStorage.setItem('lastOpenedContact', JSON.stringify({
            user_id: contact.user_id,
            name: contact.name,
            coop: contact.coop
        }));
        
        // Update UI
        document.querySelectorAll('.contact-item').forEach(item => {
            item.classList.remove('active');
        });
        document.querySelector(`[data-user-id="${contact.user_id}"]`)?.classList.add('active');

        // Hide empty state
        const emptyState = document.getElementById('empty-state-message');
        if (emptyState) emptyState.style.display = 'none';

        // Update chat header
        chatHeaderAvatar.textContent = getInitials(contact.name);
        chatHeaderName.innerHTML = `${contact.name} <br><span style="font-size:12px;font-weight:normal;color:#ccc">${contact.coop}</span>`;

        // Enable input
        textInput.disabled = false;
        sendBtn.disabled = false;

        // Show chat window on mobile
        showChatWindow();

        // Load conversation
        await loadConversation(contact.user_id);
        
        // Start auto-refresh for this conversation
        startMessagePolling();
    }

    // ========================================
    // Load Conversation Messages
    // ========================================
    async function loadConversation(receiverId) {
        try {
            const response = await fetch(`/communications/api/message/conversation/${receiverId}/`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (response.status === 401) {
                alert('Session expired. Redirecting to login.');
                window.location.href = '/';
                return;
            }

            const data = await response.json();

            if (data.status !== 'success') {
                throw new Error(data.message || 'Failed to load conversation');
            }

            messageArea.innerHTML = '';
            
            if (data.messages.length === 0) {
                messageArea.innerHTML = '<div class="empty-state" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; color: #888;"><i class="bi bi-chat-dots" style="font-size: 64px; color: #ccc; margin-bottom: 16px;"></i><p style="font-size: 16px; margin: 0;">No messages yet. Start the conversation!</p></div>';
                lastMessageCount = 0;
                return;
            }

            data.messages.forEach(msg => {
                appendMessageElement(msg);
            });

            messageArea.scrollTop = messageArea.scrollHeight;
            
            // Initialize message count for polling
            lastMessageCount = data.messages.length;
        } catch (error) {
            console.error('Error loading conversation:', error);
            messageArea.innerHTML = `<div class="empty-state">Error loading messages</div>`;
        }
    }

    function appendMessageElement(msg) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', msg.type);
        const contentHTML = `<p>${escapeHtml(msg.text || '')}</p>`;
        let attachmentHTML = '';
        if (msg.has_attachment) {
            const fname = msg.attachment_filename || 'attachment';
            const size = msg.attachment_size ? ' (' + Math.round(msg.attachment_size / 1024) + ' KB)' : '';
            const href = `/communications/api/message/attachment/${msg.message_id}/`;

            // If content type indicates image, show thumbnail and open modal on click
            if (msg.attachment_content_type && msg.attachment_content_type.startsWith('image')) {
                attachmentHTML = `
                    <div class="attachment">
                        <img class="thumb" src="${href}" alt="${escapeHtml(fname)}" data-message-id="${msg.message_id}" />
                        <div style="font-size:12px;color:#666;margin-top:6px">${escapeHtml(fname)}${size}</div>
                    </div>`;
            } else {
                // Document/other: show doc preview box that opens iframe modal
                attachmentHTML = `
                    <div class="attachment">
                        <div class="doc-preview" data-href="${href}" data-fname="${escapeHtml(fname)}" data-content-type="${msg.attachment_content_type || ''}">ðŸ“Ž ${escapeHtml(fname)}${size} (preview)</div>
                    </div>`;
            }
        }

        messageElement.innerHTML = `
            ${contentHTML}
            ${attachmentHTML}
            <span class="time" data-timestamp="${msg.time}">${timeAgo(msg.time)}</span>
        `;

        messageArea.appendChild(messageElement);

        // Attach click handlers for dynamic preview elements
        if (msg.has_attachment) {
            // image thumbnails
            const imgEl = messageElement.querySelector('img.thumb');
            if (imgEl) {
                imgEl.addEventListener('click', () => {
                    openPreviewImage(imgEl.src, msg.attachment_filename || 'image');
                });
            }

            // document preview boxes
            const docEl = messageElement.querySelector('.doc-preview');
            if (docEl) {
                docEl.addEventListener('click', () => {
                    const src = docEl.getAttribute('data-href');
                    const fname = docEl.getAttribute('data-fname') || 'file';
                    const contentType = docEl.getAttribute('data-content-type') || '';
                    openPreviewDocument(src, fname, contentType);
                });
            }
        }
    }

    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    // ========================================
    // Send Message (Updated: Refresh Contacts)
    // ========================================
    async function sendMessage() {
        const messageText = textInput.value.trim();

        // Allow sending when either message text or an attachment exists
        const hasFile = fileInput.files && fileInput.files.length > 0;
        if ((!messageText && !hasFile) || !currentConversationReceiverId) {
            return;
        }

        try {
            // Use FormData so we can support file uploads
            const form = new FormData();
            form.append('receiver_id', currentConversationReceiverId);
            form.append('message', messageText);
            if (fileInput.files && fileInput.files[0]) {
                form.append('attachment', fileInput.files[0]);
            }

            const response = await fetch('/communications/api/message/send/', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: form
            });

            if (response.status === 401) {
                alert('Session expired. Redirecting to login.');
                window.location.href = '/';
                return;
            }

            const data = await response.json();

            if (data.status !== 'success') {
                alert('Error sending message: ' + data.message);
                return;
            }

            // Clear input and attached file
            textInput.value = '';
            fileInput.value = '';
            attachedFilenameEl.textContent = '';
            if(clientPreviewEl) {
                clientPreviewEl.remove();
                clientPreviewEl = null;
            }

            // 1. Reload conversation to show new message
            await loadConversation(currentConversationReceiverId);
            // 2. Reload contacts to update the sidebar (move to top, update timestamp/preview)
            await loadContacts();

        } catch (error) {
            console.error('Error sending message:', error);
            alert('Failed to send message');
        }
    }

    // ========================================
    // Event Listeners
    // ========================================
    sendBtn.addEventListener('click', sendMessage);
    
    // Add touch support for mobile
    sendBtn.addEventListener('touchend', (e) => {
        e.preventDefault();
        sendMessage();
    });
    
    textInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            sendMessage();
        }
    });

    // Attach button - opens file picker
    attachBtn.addEventListener('click', (e) => {
        e.preventDefault();
        fileInput.click();
    });

    // Show selected filename, client-side preview and enable send when a file is chosen
    const attachedFilenameEl = document.getElementById('attached-filename');
    let clientPreviewUrl = null;
    let clientPreviewEl = null;
    fileInput.addEventListener('change', (e) => {
        const f = fileInput.files && fileInput.files[0];
        // clean previous preview
        if (clientPreviewUrl) {
            URL.revokeObjectURL(clientPreviewUrl);
            clientPreviewUrl = null;
        }
        if (clientPreviewEl) {
            clientPreviewEl.remove();
            clientPreviewEl = null;
        }

        if (f) {
            attachedFilenameEl.textContent = f.name + ' (' + Math.round(f.size/1024) + ' KB)';
            // If image, show client-side preview
            if (f.type && f.type.startsWith('image')) {
                clientPreviewUrl = URL.createObjectURL(f);
                clientPreviewEl = document.createElement('img');
                clientPreviewEl.src = clientPreviewUrl;
                clientPreviewEl.className = 'thumb';
                clientPreviewEl.style.marginLeft = '8px';
                clientPreviewEl.style.maxHeight = '56px';
                clientPreviewEl.style.borderRadius = '6px';
                attachedFilenameEl.parentNode.insertBefore(clientPreviewEl, attachedFilenameEl.nextSibling);
                // click to open full preview (before upload, uses client preview)
                clientPreviewEl.addEventListener('click', () => openPreviewImage(clientPreviewUrl, f.name));
            }

            // Enable send button if a conversation is selected
            if (currentConversationReceiverId) sendBtn.disabled = false;
        } else {
            attachedFilenameEl.textContent = '';
        }
    });

    searchInput.addEventListener('keyup', () => {
        const searchTerm = searchInput.value.toLowerCase();
        document.querySelectorAll('.contact-item').forEach(item => {
            const contactName = item.querySelector('.contact-name').textContent.toLowerCase();
            item.style.display = contactName.includes(searchTerm) ? 'flex' : 'none';
        });
    });

    // Modal controls
    newMsgBtn.addEventListener('click', (e) => {
        e.preventDefault();
        newMsgModal.classList.add('visible');
    });

    function closeNewMsgModal() {
        newMsgModal.classList.remove('visible');
    }

    modalCloseBtn.addEventListener('click', closeNewMsgModal);
    newMsgModal.addEventListener('click', (e) => {
        if (e.target === newMsgModal) {
            closeNewMsgModal();
        }
    });

    // ========================================
    // Initialize
    // ========================================
    document.addEventListener('DOMContentLoaded', async () => {
        await loadContacts();
        
        // Auto-open last conversation if exists (but only on desktop)
        const lastContact = localStorage.getItem('lastOpenedContact');
        if (lastContact && window.innerWidth > 900) {
            try {
                const contact = JSON.parse(lastContact);
                // Find the contact in the loaded contacts list
                const foundContact = allContacts.find(c => c.user_id === contact.user_id);
                if (foundContact) {
                    await selectContact(foundContact);
                }
            } catch (e) {
                console.error('Error loading last contact:', e);
            }
        } else if (window.innerWidth <= 900) {
            // On mobile, ensure we start with contact list visible
            showContactList();
        }
    });

    // ========================================
    // PREVIEW & PDF LOGIC (UNCHANGED)
    // ========================================
    const previewModal = document.getElementById('preview-modal');
    const previewBody = document.getElementById('preview-body');
    const previewClose = document.getElementById('preview-close');
    const previewDownload = document.getElementById('preview-download');

    let currentZoom = 100;
    let pdfDoc = null;
    let currentPage = 1;
    let isPdfOpen = false;
    let totalPages = 0;
    let previewMessageId = null;
    let isConvertibleDocument = false;

    const CONVERTIBLE_TYPES = [
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document',  // .docx
        'application/msword',  // .doc
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',  // .xlsx
        'application/vnd.ms-excel',  // .xls
    ];

    function zoomIn() {
        currentZoom = Math.min(currentZoom + 10, 300);
        applyZoom();
    }

    function zoomOut() {
        currentZoom = Math.max(currentZoom - 10, 50);
        applyZoom();
    }

    function applyZoom() {
        document.getElementById('zoomLevel').textContent = currentZoom + '%';
        const img = previewBody.querySelector('img');
        if (img) {
            img.style.transform = `scale(${currentZoom / 100})`;
        }
        // For PDF, re-render at new scale
        if (isPdfOpen && pdfDoc) {
            renderPdfPage(currentPage);
        }
    }

    async function renderPdfPage(pageNum) {
        try {
            const page = await pdfDoc.getPage(pageNum);
            const viewport = page.getViewport({ scale: currentZoom / 100 });
            const canvas = previewBody.querySelector('canvas') || document.createElement('canvas');
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
            if (!previewBody.contains(canvas)) {
                previewBody.innerHTML = '';
                previewBody.appendChild(canvas);
            }
            // Update page counter
            document.getElementById('pageCounter').textContent = `Page ${pageNum} / ${totalPages}`;
        } catch (e) {
            console.error('PDF render error:', e);
        }
    }

    function previousPage() {
        if (currentPage > 1) {
            currentPage--;
            renderPdfPage(currentPage);
        }
    }

    function nextPage() {
        if (currentPage < totalPages) {
            currentPage++;
            renderPdfPage(currentPage);
        }
    }

    // Handle keyboard navigation (Arrow keys) and scroll wheel
    function setupPdfNavigation() {
        // Remove old listeners if they exist
        document.removeEventListener('keydown', handlePdfKeyboard);
        previewBody.removeEventListener('wheel', handlePdfScroll);
        
        document.addEventListener('keydown', handlePdfKeyboard);
        previewBody.addEventListener('wheel', handlePdfScroll, { passive: false });
    }

    function handlePdfKeyboard(e) {
        if (!isPdfOpen || !pdfDoc || previewModal.style.display === 'none') return;
        
        if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
            e.preventDefault();
            nextPage();
        } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
            e.preventDefault();
            previousPage();
        }
    }

    function handlePdfScroll(e) {
        if (!isPdfOpen || !pdfDoc || previewModal.style.display === 'none') return;
        
        // Only intercept scroll if content doesn't need scrolling
        const hasVerticalScroll = previewBody.scrollHeight > previewBody.clientHeight;
        const hasHorizontalScroll = previewBody.scrollWidth > previewBody.clientWidth;
        
        if (!hasVerticalScroll && !hasHorizontalScroll) {
            e.preventDefault();
            if (e.deltaY > 0) {
                nextPage();
            } else if (e.deltaY < 0) {
                previousPage();
            }
        }
    }

    function openPreviewImage(src, title) {
        currentZoom = 100;
        isPdfOpen = false;
        isConvertibleDocument = false;
        previewBody.innerHTML = `<img src="${src}" alt="${escapeHtml(title)}" style="max-width:100%; max-height:100%; object-fit:contain;" />`;
        document.getElementById('preview-title').textContent = title;
        document.getElementById('zoomLevel').textContent = '100%';
        document.getElementById('page-controls').style.display = 'none';
        document.getElementById('preview-download-pdf').style.display = 'none';
        previewModal.classList.add('show');
        previewModal.style.display = 'flex';
        
        try {
            const url = new URL(src, window.location.origin);
            url.searchParams.set('download', '1');
            document.getElementById('preview-download-original').href = url.toString();
        } catch (e) {
            document.getElementById('preview-download-original').href = src + '?download=1';
        }
    }

    function openPreviewDocument(src, title, contentType) {
        currentZoom = 100;
        isPdfOpen = true;
        isConvertibleDocument = CONVERTIBLE_TYPES.includes(contentType);
        document.getElementById('preview-title').textContent = title;
        document.getElementById('zoomLevel').textContent = '100%';
        
        // Extract message_id from src URL
        let messageId = null;
        try {
            const url = new URL(src, window.location.origin);
            const pathParts = url.pathname.split('/');
            messageId = pathParts[pathParts.length - 2];
            url.searchParams.set('download', '1');
            document.getElementById('preview-download-original').href = url.toString();
        } catch (e) {
            document.getElementById('preview-download-original').href = src + '?download=1';
        }

        previewMessageId = messageId;

        // If already PDF or is an image, load directly
        if (contentType === 'application/pdf' || contentType.startsWith('image')) {
            loadPdfPreview(src, title, contentType);
            document.getElementById('preview-download-pdf').style.display = 'none';
        } 
        // If convertible document, show loading and convert
        else if (isConvertibleDocument && messageId) {
            showLoadingOverlay('Converting document to PDF...');
            convertAndPreview(messageId, src, title);
        } 
        // Otherwise try to load directly as PDF (might be already PDF)
        else {
            loadPdfPreview(src, title, contentType);
            document.getElementById('preview-download-pdf').style.display = 'none';
        }
    }

    async function convertAndPreview(messageId, originalSrc, title) {
        try {
            const response = await fetch(`/communications/api/message/attachment/${messageId}/convert-pdf/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.message || 'Conversion failed');
            }

            // Convert response to blob and create object URL
            const blob = await response.blob();
            const pdfUrl = URL.createObjectURL(blob);

            // Hide loading and show PDF
            hideLoadingOverlay();
            previewModal.classList.add('show');
            previewModal.style.display = 'flex';

            // Show download options
            document.getElementById('preview-download-pdf').href = pdfUrl;
            document.getElementById('preview-download-pdf').download = title.rsplit('.', 1)[0] + '.pdf';
            document.getElementById('preview-download-pdf').style.display = 'inline-block';

            // Load and render the converted PDF
            loadPdfFromBlob(pdfUrl, title);
        } catch (error) {
            hideLoadingOverlay();
            previewModal.classList.add('show');
            previewModal.style.display = 'flex';
            previewBody.innerHTML = `<p style="color:#d32f2f;">Error converting document: ${error.message}</p>`;
            console.error('Conversion error:', error);
        }
    }

    function loadPdfPreview(src, title, contentType) {
        previewModal.classList.add('show');
        previewModal.style.display = 'flex';
        previewBody.innerHTML = '<p style="color:#aaa;">Loading document...</p>';

        // If convertible, show PDF download option
        if (isConvertibleDocument) {
            const pdfUrl = new URL(src, window.location.origin);
            pdfUrl.searchParams.set('format', 'pdf');
            pdfUrl.searchParams.set('download', '1');
            document.getElementById('preview-download-pdf').href = pdfUrl.toString();
            document.getElementById('preview-download-pdf').style.display = 'inline-block';
        } else {
            document.getElementById('preview-download-pdf').style.display = 'none';
        }

        // Load PDF with PDF.js
        if (window.pdfjsLib) {
            window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            window.pdfjsLib.getDocument(src).promise.then(doc => {
                pdfDoc = doc;
                currentPage = 1;
                totalPages = doc.numPages;
                document.getElementById('page-controls').style.display = totalPages > 1 ? 'flex' : 'none';
                renderPdfPage(1);
                setupPdfNavigation();
            }).catch(err => {
                previewBody.innerHTML = `<p style="color:#d32f2f;">Error loading document: ${err.message}</p>`;
                console.error('PDF load error:', err);
            });
        } else {
            previewBody.innerHTML = `<iframe src="${src}" title="${escapeHtml(title)}" style="width:100%; height:100%; border:0;"></iframe>`;
            document.getElementById('page-controls').style.display = 'none';
        }
    }

    function loadPdfFromBlob(blobUrl, title) {
        previewBody.innerHTML = '<p style="color:#aaa;">Rendering PDF...</p>';

        if (window.pdfjsLib) {
            window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            window.pdfjsLib.getDocument(blobUrl).promise.then(doc => {
                pdfDoc = doc;
                currentPage = 1;
                totalPages = doc.numPages;
                document.getElementById('page-controls').style.display = totalPages > 1 ? 'flex' : 'none';
                renderPdfPage(1);
                setupPdfNavigation();
            }).catch(err => {
                previewBody.innerHTML = `<p style="color:#d32f2f;">Error rendering PDF: ${err.message}</p>`;
                console.error('PDF render error:', err);
            });
        }
    }

    function showLoadingOverlay(message = 'Converting document to PDF...') {
        document.getElementById('loading-text').textContent = message;
        document.getElementById('loading-overlay').style.display = 'flex';
    }

    function hideLoadingOverlay() {
        document.getElementById('loading-overlay').style.display = 'none';
    }

    function closePreview() {
        previewModal.style.display = 'none';
        previewBody.innerHTML = '';
        pdfDoc = null;
        isPdfOpen = false;
        currentZoom = 100;
        previewMessageId = null;
        
        // Clean up event listeners
        document.removeEventListener('keydown', handlePdfKeyboard);
        previewBody.removeEventListener('wheel', handlePdfScroll);
    }

    previewClose.addEventListener('click', closePreview);
    previewModal.addEventListener('click', (e) => { if (e.target === previewModal) closePreview(); });

    // ========================================
    // Auto-Refresh Messages & Contacts
    // ========================================
    let lastMessageCount = 0;
    let isPolling = false;

    // Poll for new messages in the current conversation
    async function pollMessages() {
        if (isPolling || !currentConversationReceiverId) return;
        
        isPolling = true;
        try {
            const response = await fetch(`/communications/api/message/conversation/${currentConversationReceiverId}/`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (response.status === 401) {
                clearInterval(messagePollingInterval);
                clearInterval(contactPollingInterval);
                return;
            }

            const data = await response.json();

            if (data.status === 'success') {
                // Check if there are new messages
                if (data.messages.length !== lastMessageCount) {
                    // Save scroll position
                    const wasAtBottom = messageArea.scrollHeight - messageArea.scrollTop <= messageArea.clientHeight + 100;
                    
                    // Clear and re-render messages
                    messageArea.innerHTML = '';
                    
                    if (data.messages.length === 0) {
                        messageArea.innerHTML = '<div class="empty-state" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; color: #888;"><i class="bi bi-chat-dots" style="font-size: 64px; color: #ccc; margin-bottom: 16px;"></i><p style="font-size: 16px; margin: 0;">No messages yet. Start the conversation!</p></div>';
                    } else {
                        data.messages.forEach(msg => {
                            appendMessageElement(msg);
                        });
                    }
                    
                    // Auto-scroll to bottom if user was already at bottom
                    if (wasAtBottom) {
                        messageArea.scrollTop = messageArea.scrollHeight;
                    }
                    
                    lastMessageCount = data.messages.length;
                }
            }
        } catch (error) {
            console.error('Error polling messages:', error);
        } finally {
            isPolling = false;
        }
    }

    // Poll for updated contact list (new messages from others)
    async function pollContacts() {
        try {
            const response = await fetch('/communications/api/message/contacts/', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (response.status === 401) {
                clearInterval(messagePollingInterval);
                clearInterval(contactPollingInterval);
                return;
            }

            const data = await response.json();

            if (data.status === 'success') {
                // Check if contacts have changed
                const contactsChanged = JSON.stringify(data.contacts) !== JSON.stringify(allContacts);
                
                if (contactsChanged) {
                    allContacts = data.contacts;
                    
                    // Save currently selected contact
                    const selectedUserId = currentConversationReceiverId;
                    
                    // Re-render contacts
                    renderContacts();
                    renderModalContacts();
                    
                    // Re-highlight the selected contact if any
                    if (selectedUserId) {
                        document.querySelector(`[data-user-id="${selectedUserId}"]`)?.classList.add('active');
                    }
                }
            }
        } catch (error) {
            console.error('Error polling contacts:', error);
        }
    }

    // Set up polling intervals
    let messagePollingInterval = null;
    let contactPollingInterval = null;

    // Start polling when a conversation is selected
    function startMessagePolling() {
        if (messagePollingInterval) {
            clearInterval(messagePollingInterval);
        }
        messagePollingInterval = setInterval(pollMessages, 3000); // Poll every 3 seconds
    }

    // Stop message polling when no conversation is selected
    function stopMessagePolling() {
        if (messagePollingInterval) {
            clearInterval(messagePollingInterval);
            messagePollingInterval = null;
        }
        lastMessageCount = 0;
    }

    // Start contact polling on page load
    contactPollingInterval = setInterval(pollContacts, 5000); // Poll contacts every 5 seconds

    // Refresh timestamps every 10 seconds
    setInterval(() => {
        document.querySelectorAll('[data-timestamp]').forEach(el => {
            const isoString = el.getAttribute('data-timestamp');
            el.textContent = timeAgo(isoString);
        });
    }, 10000);

    // Clean up intervals when page unloads
    window.addEventListener('beforeunload', () => {
        stopMessagePolling();
        clearInterval(contactPollingInterval);
    });

    // Handle window resize to reset mobile state
    let resizeTimer;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
            if (window.innerWidth > 900) {
                // Reset to desktop view - show both panels
                conversationListEl.classList.remove('slide-left');
            } else if (!currentConversationReceiverId) {
                // On mobile with no conversation, ensure contact list is visible
                showContactList();
            }
        }, 250);
    });

    // ========================================
    // Profile Dropdown Functionality
    // ========================================
    const profileDropdown = document.getElementById('profileDropdown');
    const profileTrigger = profileDropdown?.querySelector('.profile-trigger');
    
    if (profileTrigger) {
        profileTrigger.addEventListener('click', (e) => {
            e.stopPropagation();
            profileDropdown.classList.toggle('active');
        });
    }
    
    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
        if (profileDropdown && !profileDropdown.contains(e.target)) {
            profileDropdown.classList.remove('active');
        }
    });
    
    // Messages sidebar toggle for mobile
    const messagesSidebarToggle = document.getElementById('messages-sidebar-toggle');
    if (messagesSidebarToggle) {
        messagesSidebarToggle.addEventListener('click', () => {
            document.body.classList.toggle('sidebar-open');
        });
    }

</script>{% endblock %}
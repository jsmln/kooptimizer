{% extends 'dashboard/dashboard.html' %}
{% load static %}

{% block dashboard_title %}Announcements{% endblock %}

{% block extra_head %}
    {{ block.super }}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.css" rel="stylesheet">

    <link rel="stylesheet" href="{% static 'frontend/announcement.css' %}">
{% endblock %}

{% block dashboard_content %}

<!-- Announcement Notifications Container -->
<div id="announcement-notifications" aria-live="polite" aria-atomic="true" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999;"></div>

<script>
    // Embed data from Django view into JavaScript variables
    const cooperativesData = {{ cooperatives_json|safe }};
    const officersByCoopData = {{ officers_by_coop_json|safe }};
    const currentUserRole = '{{ request.session.role }}';
    const currentUserId = {{ request.session.user_id|default:'null' }};
</script>

<style>
    .dashboard-main-content {
        padding: 0;
        overflow: hidden; /* Prevent parent from scrolling */
    }
    
    /* Notification Styles */
    .dj-message {
        display: flex;
        gap: 12px;
        align-items: flex-start;
        background: #fff;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        min-width: 320px;
        max-width: 420px;
        opacity: 1;
        transform: translateX(0);
        transition: opacity 240ms ease, transform 240ms ease;
    }
    
    .dj-message-left {
        flex-shrink: 0;
    }
    
    .dj-message-icon {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
        color: #fff;
    }
    
    .dj-success .dj-message-icon { background-color: #28a745; }
    .dj-error .dj-message-icon { background-color: #dc3545; }
    .dj-warning .dj-message-icon { background-color: #ffc107; color: #000; }
    .dj-info .dj-message-icon { background-color: #17a2b8; }
    
    .dj-message-body {
        flex: 1;
        padding-top: 2px;
    }
    
    .dj-message-text {
        color: #333;
        font-size: 14px;
        line-height: 1.5;
    }
    
    .dj-message-close {
        background: none;
        border: none;
        color: #999;
        font-size: 24px;
        line-height: 1;
        cursor: pointer;
        padding: 0;
        width: 24px;
        height: 24px;
        flex-shrink: 0;
    }
    
    .dj-message-close:hover {
        color: #333;
    }
</style>

<div class="announcement-layout">
    <div class="row g-0 h-100">
        <div class="col-md-3 border-end d-flex flex-column p-3 bg-light">
            <div class="list-header">
                <h2>Announcements</h2>
                </a>
            </div>
            <hr id="announcement-title-header">
            <button id="create-new-btn" class="btn btn-danger btn-lg w-100 mb-3">
                <i class="bi bi-plus-circle-fill me-2"></i> Create New
            </button>
            
            <ul class="nav nav-pills flex-column sidebar-nav mt-2" id="announcement-nav">
                <li class="nav-item">
                    <a class="nav-link active" href="#" data-bs-toggle="pill" data-bs-target="#sent-view">
                        <span><i class="bi bi-send-fill me-2"></i> Sent</span>
                        <span class="badge">{{ sent_announcements|length }}</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-bs-toggle="pill" data-bs-target="#draft-view">
                        <span><i class="bi bi-pencil-square me-2"></i> Draft</span>
                        <span class="badge">{{ draft_announcements|length }}</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-bs-toggle="pill" data-bs-target="#scheduled-view">
                        <span><i class="bi bi-clock-history me-2"></i> Scheduled</span>
                        <span class="badge">{{ scheduled_announcements|length }}</span>
                    </a>
                </li>
            </ul>
        </div>

        <div class="col-md-9 d-flex flex-column h-100">

            <div id="list-view-container" class="d-flex flex-column h-100">
                <div class="p-3 border-bottom">
                    <!-- Search and Filter Row -->
                    <div class="d-flex gap-2 mb-3">
                        <input type="text" id="search-input" class="form-control" placeholder="Search by title, content, recipients, or cooperative name...">
                        <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#filter-options" aria-expanded="false" style="white-space: nowrap;">
                            <i class="bi bi-funnel"></i>
                        </button>
                    </div>
                    
                    <!-- Filter indicators -->
                    <div class="d-flex gap-2 align-items-center flex-wrap mb-2">
                        <span id="active-filters-badge" class="badge bg-primary d-none">0 filters</span>
                        <button id="clear-filters-btn" class="btn btn-sm btn-link text-danger d-none p-0" type="button" style="text-decoration: none;">Clear All</button>
                    </div>
                    
                    <!-- Collapsible Filter Options -->
                    <div class="collapse" id="filter-options">
                        <div class="card card-body">
                            <div class="row g-3">
                                <!-- Type Filter -->
                                <div class="col-md-4">
                                    <label class="form-label fw-bold small">Message Type</label>
                                    <div class="form-check">
                                        <input class="form-check-input filter-type" type="checkbox" value="sms" id="filter-sms">
                                        <label class="form-check-label" for="filter-sms">
                                            <i class="bi bi-phone text-primary"></i> SMS
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input filter-type" type="checkbox" value="e-mail" id="filter-email">
                                        <label class="form-check-label" for="filter-email">
                                            <i class="bi bi-envelope text-success"></i> Email
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Date Range Filter -->
                                <div class="col-md-8">
                                    <label class="form-label fw-bold small">Date Range</label>
                                    <div class="row g-2">
                                        <div class="col-md-6">
                                            <input type="date" id="filter-date-from" class="form-control form-control-sm" placeholder="From">
                                        </div>
                                        <div class="col-md-6">
                                            <input type="date" id="filter-date-to" class="form-control form-control-sm" placeholder="To">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-content list-scroll-area">
                    
                    <div class="tab-pane fade show active" id="sent-view">
                        <div class="list-group list-group-flush">
                            {% for item in sent_announcements %}
                            <a href="#" class="list-group-item list-group-item-action py-3 announcement-item" 
                               data-modal-id="view-sent-modal" 
                               data-announcement-id="{{ item.announcement_id }}"
                               data-id="{{ item.announcement_id }}"
                               data-title="{{ item.title }}"
                               data-content="{{ item.description }}"
                               data-type="{{ item.type }}"
                               data-date="{{ item.sent_at|date:'Y-m-d' }}"
                               data-coops="{{ item.recipients_info.coop_names|join:', ' }}"
                               data-officers="{{ item.recipients_info.officer_names|join:', ' }}">
                                <div class="d-flex w-100 justify-content-between">
                                    <h5 class="mb-1">{{ item.title }}</h5>
                                    <small class="text-muted">{{ item.sent_at|date:"M d, Y" }}</small>
                                </div>
                                <p class="mb-1 text-truncate">{{ item.description }}</p>
                                <small>
                                    {% if item.type == 'sms' %}
                                        <span class="badge bg-primary"><i class="bi bi-phone me-1"></i>SMS</span>
                                    {% elif item.type == 'e-mail' or item.type == 'email' %}
                                        <span class="badge bg-success"><i class="bi bi-envelope me-1"></i>Email</span>
                                    {% endif %}
                                    {% if item.has_attachment %}
                                        <span class="badge bg-info ms-1" title="{{ item.attachment_count }} attachment{{ item.attachment_count|pluralize }}"><i class="bi bi-paperclip me-1"></i>{{ item.attachment_count }}</span>
                                    {% endif %}
                                </small>
                            </a>
                            {% empty %}
                            <div class="p-4 text-center text-muted">
                                <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                <p>No sent announcements found.</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="tab-pane fade" id="draft-view">
                        <div class="list-group list-group-flush">
                            {% for item in draft_announcements %}
                            <a href="#" class="list-group-item list-group-item-action py-3 open-draft-btn announcement-item"
                               data-id="{{ item.announcement_id }}"
                               data-title="{{ item.title }}"
                               data-content="{{ item.description }}"
                               data-type="{{ item.type }}"
                               data-date="{{ item.updated_at|date:'Y-m-d' }}"
                               data-coops="{{ item.recipients_info.coop_names|join:', ' }}"
                               data-officers="{{ item.recipients_info.officer_names|join:', ' }}">
                                <div class="d-flex w-100 justify-content-between">
                                    <h5 class="mb-1">{{ item.title }}</h5>
                                    <small class="text-muted">{{ item.updated_at|date:"M d, Y" }}</small>
                                </div>
                                <p class="mb-1 text-truncate">{{ item.description|default:"No content yet..." }}</p>
                                <small>
                                    {% if item.type == 'sms' %}
                                        <span class="badge bg-primary"><i class="bi bi-phone me-1"></i>SMS</span>
                                    {% elif item.type == 'e-mail' or item.type == 'email' %}
                                        <span class="badge bg-success"><i class="bi bi-envelope me-1"></i>Email</span>
                                    {% else %}
                                        <span class="badge bg-secondary">No Type</span>
                                    {% endif %}
                                    {% if item.has_attachment %}
                                        <span class="badge bg-info ms-1" title="{{ item.attachment_count }} attachment{{ item.attachment_count|pluralize }}"><i class="bi bi-paperclip me-1"></i>{{ item.attachment_count }}</span>
                                    {% endif %}
                                </small>
                            </a>
                            {% empty %}
                            <div class="p-4 text-center text-muted">
                                <i class="bi bi-pencil-square fs-1 d-block mb-2"></i>
                                <p>No drafts found.</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="tab-pane fade" id="scheduled-view">
                        <div class="list-group list-group-flush">
                            {% for item in scheduled_announcements %}
                            <a href="#" class="list-group-item list-group-item-action py-3 announcement-item" 
                               data-modal-id="view-scheduled-modal"
                               data-announcement-id="{{ item.announcement_id }}"
                               data-id="{{ item.announcement_id }}"
                               data-title="{{ item.title }}"
                               data-content="{{ item.description }}"
                               data-type="{{ item.type }}"
                               data-date="{{ item.sent_at|date:'Y-m-d' }}"
                               data-coops="{{ item.recipients_info.coop_names|join:', ' }}"
                               data-officers="{{ item.recipients_info.officer_names|join:', ' }}">
                                <div class="d-flex w-100 justify-content-between">
                                    <h5 class="mb-1">{{ item.title }}</h5>
                                    <small class="text-danger">
                                        Sends: {{ item.sent_at|date:"M d, Y @ g:i A" }}
                                    </small>
                                </div>
                                <p class="mb-1 text-truncate">{{ item.description }}</p>
                                <small>
                                    {% if item.type == 'sms' %}
                                        <span class="badge bg-primary"><i class="bi bi-phone me-1"></i>SMS</span>
                                    {% elif item.type == 'e-mail' or item.type == 'email' %}
                                        <span class="badge bg-success"><i class="bi bi-envelope me-1"></i>Email</span>
                                    {% endif %}
                                    {% if item.has_attachment %}
                                        <span class="badge bg-info ms-1" title="{{ item.attachment_count }} attachment{{ item.attachment_count|pluralize }}"><i class="bi bi-paperclip me-1"></i>{{ item.attachment_count }}</span>
                                    {% endif %}
                                </small>
                            </a>
                            {% empty %}
                            <div class="p-4 text-center text-muted">
                                <i class="bi bi-clock-history fs-1 d-block mb-2"></i>
                                <p>No scheduled announcements.</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <div id="create-view-container" class="d-none flex-column h-100">
                <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                    <h2 class="h4 m-0">New Announcement</h2>
                    <button id="cancel-create-btn" class="btn btn-outline-secondary">
                        <i class="bi bi-x-lg"></i> Cancel
                    </button>
                </div>

                <div class="list-scroll-area p-4">
                    <form id="main-announcement-form">
                        <div class="mb-3">
                            <label for="announcement-type" class="form-label fw-bold">Select type of announcement</label>
                            <select class="form-select" id="announcement-type">
                                <option value="" selected>Choose...</option>
                                <option value="sms">SMS</option>
                                <option value="e-mail">Email</option>
                            </select>
                        </div>

                        <div id="dynamic-form-fields" class="d-none">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Recipients</label>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-muted">Add recipients to this announcement.</span>
                                    <button class="btn btn-sm btn-outline-danger" type="button" id="add-recipient-btn">
                                        <i class="bi bi-plus-circle me-1"></i> Add Recipient
                                    </button>
                                </div>
                                
                                <div id="recipient-rows-container" class="d-flex flex-column gap-2">
                                    <div class="recipient-row d-flex align-items-center gap-2">
                                        <div class="row g-2 flex-grow-1">
                                            <div class="col-md-6">
                                                <select class="form-select coop-select" name="cooperative_name[]">
                                                    <option value="" selected>Choose Cooperative...</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <select class="officer-select" name="cooperative_officers[]" multiple disabled>
                                                    <option value="">-- Select Cooperative First --</option>
                                                </select>
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-danger remove-recipient-btn d-none">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="announcement-title" class="form-label fw-bold">Announcement Title</label>
                                <input type="text" class="form-control" id="announcement-title" placeholder="Enter title">
                            </div>

                            <div class="mb-3">
                                <label for="announcement-content" class="form-label fw-bold">Announcement Content</label>
                                <textarea class="form-control" id="announcement-content" rows="8" placeholder="Type your message..."></textarea>
                            </div>

                            <div id="email-fields" class="d-none">
                                <div class="mb-3">
                                    <label for="formFile" class="form-label fw-bold">Attachment/s</label>
                                    <input class="form-control" type="file" id="formFile" multiple 
                                           accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png,.gif">
                                    <div class="form-text">
                                        <i class="bi bi-info-circle"></i> Maximum total size: 4MB for all files combined (Brevo API limit). 
                                        Allowed: PDF, DOC, DOCX, XLS, XLSX, PPT, PPTX, Images
                                    </div>
                                    <div id="attachment-preview" class="mt-2"></div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div> 
                
                <div class="mt-auto p-3 border-top">
                    <div class="d-flex justify-content-end align-items-center gap-2">
                        <button type="button" class="btn btn-secondary" id="save-draft-btn">Save Draft</button>
                        <button type="button" class="btn btn-primary d-none" id="save-changes-btn" style="background-color: #0d6efd; border-color: #0d6efd;">Save Changes</button>
                        
                        <div class="btn-group" id="send-button-group">
                            <button type="button" class="btn btn-danger" id="send-btn-main" style="background-color: #b71c1c;">
                                Send
                            </button>
                            <button type="button" class="btn btn-danger dropdown-toggle dropdown-toggle-split btn-split-dropdown" data-bs-toggle="dropdown" aria-expanded="false" style="background-color: #b71c1c;">
                                <span class="visually-hidden">Toggle Dropdown</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#" id="schedule-send-link">
                                    <i class="bi bi-clock me-2"></i>Schedule Send
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <template id="recipient-row-template">
                    <div class="recipient-row d-flex align-items-center gap-2">
                        <div class="row g-2 flex-grow-1">
                            <div class="col-md-6">
                                <select class="form-select coop-select" name="cooperative_name[]">
                                    <option value="" selected>Choose Cooperative...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <select class="officer-select" name="cooperative_officers[]" multiple disabled>
                                    <option value="">-- Select Cooperative First --</option>
                                </select>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger remove-recipient-btn">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                </template>

            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="view-sent-modal" tabindex="-1" aria-labelledby="view-sent-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-lg" style="max-width: 900px;">
        <div class="modal-content" style="height: 600px; display: flex; flex-direction: column; background-color: #ffffff;">
            <div class="modal-header" style="background-color: #f8f9fa; border-bottom: 1px solid #dee2e6; padding: 20px 24px; flex-shrink: 0;">
                <div class="w-100">
                    <h4 class="modal-title fw-bold mb-2" id="view-sent-modal-title" style="color: #202124; font-size: 22px;"></h4>
                    <div id="view-sent-modal-meta" style="color: #5f6368; font-size: 13px;"></div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 24px; background-color: #ffffff;">
                <div id="view-sent-modal-content">
                    <p style="color: #5f6368;">Loading...</p>
                </div>
            </div>
            <div class="modal-footer" style="background-color: #f8f9fa; border-top: 1px solid #dee2e6; padding: 16px 24px; flex-shrink: 0;">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="view-scheduled-modal" tabindex="-1" aria-labelledby="view-scheduled-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-lg" style="max-width: 900px;">
        <div class="modal-content" style="height: 600px; display: flex; flex-direction: column; background-color: #ffffff;">
            <div class="modal-header" style="background-color: #fff3cd; border-bottom: 1px solid #ffc107; padding: 20px 24px; flex-shrink: 0;">
                <div class="w-100">
                    <h4 class="modal-title fw-bold mb-2" id="view-scheduled-modal-title" style="color: #202124; font-size: 22px;"></h4>
                    <div id="view-scheduled-modal-meta" style="color: #856404; font-size: 13px; font-weight: 500;"></div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 24px; background-color: #ffffff;">
                <div id="view-scheduled-modal-content">
                    <p style="color: #5f6368;">Loading...</p>
                </div>
            </div>
            <div class="modal-footer" style="background-color: #f8f9fa; border-top: 1px solid #dee2e6; padding: 16px 24px; flex-shrink: 0;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" id="edit-scheduled-btn" style="display: none;">
                    <i class="bi bi-pencil"></i> Edit
                </button>
                <button type="button" class="btn btn-danger" id="cancel-scheduled-btn" style="display: none;">
                    <i class="bi bi-x-circle"></i> Cancel Schedule
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="schedule-send-modal" tabindex="-1" aria-labelledby="schedule-send-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="schedule-send-modal-label">Schedule Send</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Choose a date and time to send this announcement.</p>
                <div class="mb-2">
                    <label for="schedule-date" class="form-label">Date</label>
                    <input type="date" class="form-control" id="schedule-date">
                </div>
                <div>
                    <label for="schedule-time" class="form-label">Time</label>
                    <input type="time" class="form-control" id="schedule-time">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary">Save Schedule</button>
            </div>
        </div>
    </div>
</div>

<!-- Attachment Preview Modal -->
<div id="attachment-preview-modal" class="modal fade" tabindex="-1" style="z-index: 1060;">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content" style="height: 90vh;">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="attachment-preview-title">Attachment Preview</h5>
                <div class="d-flex gap-2 align-items-center">
                    <button type="button" class="btn btn-sm btn-outline-light" id="preview-zoom-out">
                        <i class="bi bi-dash"></i>
                    </button>
                    <span class="text-white" id="preview-zoom-level">100%</span>
                    <button type="button" class="btn btn-sm btn-outline-light" id="preview-zoom-in">
                        <i class="bi bi-plus"></i>
                    </button>
                    <a id="preview-download-link" class="btn btn-sm btn-danger" href="#" download>
                        <i class="bi bi-download"></i> Download
                    </a>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
            </div>
            <div class="modal-body p-0 bg-dark d-flex align-items-center justify-content-center" style="overflow: auto;">
                <div id="attachment-preview-content" style="transform-origin: center center;"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirm-cancel-modal" tabindex="-1" aria-labelledby="confirm-cancel-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirm-cancel-modal-label">Unsaved Changes</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to cancel announcement creation?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">No, Stay</button>
                <button type="button" class="btn btn-danger" id="confirm-cancel-btn">Yes, Cancel</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirm-cancel-schedule-modal" tabindex="-1" aria-labelledby="confirm-cancel-schedule-label" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirm-cancel-schedule-label" style="color: #b71c1c; font-weight: 700;">Cancel Scheduled Announcement</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="color: #333; font-size: 1rem;">
                Are you sure you want to cancel this scheduled announcement? It will be reverted to a draft.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No, Keep Schedule</button>
                <button type="button" class="btn btn-danger" id="confirm-cancel-schedule-btn" style="background-color: #b71c1c; border-color: #b71c1c;">Yes, Cancel Schedule</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirm-logout-modal" tabindex="-1" aria-labelledby="confirm-logout-label" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirm-logout-label" style="color: #b71c1c; font-weight: 700;">Logout</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to log out?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-logout-btn" style="background-color: #b71c1c; border-color: #b71c1c;">Continue Logout</button>
            </div>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0rPoDGiZ5JvBDDGa6hXoVl7kwkxa6UYTRzC8iYhFdaYh0lH4PfPmUAmkG" crossorigin="anonymous"></script>

<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

{% comment %} // Replace the ENTIRE <script> section at the bottom of announcement_form.html
// Everything from <script> to </script> {% endcomment %}

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- Global Variables ---
    let currentDraftId = null;  // Track if editing a draft
    let currentScheduledTime = null;  // Track scheduled time when editing scheduled announcements
    let isEditingScheduled = false;  // Track if we're editing a scheduled announcement

    // --- Get Elements ---
    const listView = document.getElementById('list-view-container');
    const createView = document.getElementById('create-view-container');
    const createBtn = document.getElementById('create-new-btn');
    const cancelBtn = document.getElementById('cancel-create-btn');
    const draftButtons = document.querySelectorAll('.open-draft-btn');
    const announcementType = document.getElementById('announcement-type');
    const dynamicFields = document.getElementById('dynamic-form-fields');
    const emailFields = document.getElementById('email-fields');
    const sendBtnMain = document.getElementById('send-btn-main');
    const addRecipientBtn = document.getElementById('add-recipient-btn');
    const recipientRowsContainer = document.getElementById('recipient-rows-container');
    const recipientRowTemplate = document.getElementById('recipient-row-template');
    const saveDraftBtn = document.getElementById('save-draft-btn');
    const saveChangesBtn = document.getElementById('save-changes-btn');
    const mainForm = document.getElementById('main-announcement-form');
    const fileInput = document.getElementById('formFile');
    const attachmentPreview = document.getElementById('attachment-preview');
    
    // File size limit (4MB - Brevo API limit)
    const MAX_FILE_SIZE = 4 * 1024 * 1024;

    // --- Modal Logic ---
    const viewSentModal = new bootstrap.Modal(document.getElementById('view-sent-modal'));
    const viewScheduledModal = new bootstrap.Modal(document.getElementById('view-scheduled-modal'));
    const scheduleSendModal = new bootstrap.Modal(document.getElementById('schedule-send-modal'));
    const confirmCancelModal = new bootstrap.Modal(document.getElementById('confirm-cancel-modal'));
    
    // Notification function
    function showNotification(message, type = 'info') {
        const container = document.getElementById('announcement-notifications');
        const notification = document.createElement('div');
        notification.className = `dj-message dj-${type}`;
        
        notification.innerHTML = `
            <div class="dj-message-left">
                <div class="dj-message-icon" aria-hidden="true">!</div>
            </div>
            <div class="dj-message-body">
                <div class="dj-message-text">${message}</div>
            </div>
            <button class="dj-message-close" aria-label="Close message">×</button>
        `;
        
        container.appendChild(notification);
        
        // Close button handler
        const closeBtn = notification.querySelector('.dj-message-close');
        closeBtn.addEventListener('click', () => dismissNotification(notification));
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            if (document.body.contains(notification)) {
                dismissNotification(notification);
            }
        }, 5000);
    }
    
    function dismissNotification(el) {
        el.style.opacity = '0';
        el.style.transform = 'translateX(18px)';
        setTimeout(() => {
            if (el.parentNode) el.parentNode.removeChild(el);
        }, 260);
    }
    
    // Function to format date/time
    function formatDateTime(isoString) {
        if (!isoString) return 'N/A';
        const date = new Date(isoString);
        const options = { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit'
        };
        return date.toLocaleDateString('en-US', options);
    }
    
    // Function to format file size
    function formatFileSize(bytes) {
        if (!bytes) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
    
    // Function to validate file size
    function validateFileSize(file) {
        if (file.size > MAX_FILE_SIZE) {
            showNotification(`File "${file.name}" exceeds the 4MB limit (${formatFileSize(file.size)})`, 'error');
            return false;
        }
        return true;
    }
    
    // Function to validate total file size
    function validateTotalFileSize(files) {
        let totalSize = 0;
        Array.from(files).forEach(file => {
            totalSize += file.size;
        });
        
        if (totalSize > MAX_FILE_SIZE) {
            showNotification(
                `Total file size exceeds 4MB limit. Current total: ${formatFileSize(totalSize)}. Please remove some files.`, 
                'error'
            );
            return false;
        }
        return true;
    }
    
    // Function to get file icon based on type
    function getFileIcon(fileName) {
        const ext = fileName.split('.').pop().toLowerCase();
        const icons = {
            'pdf': 'bi-file-earmark-pdf text-danger',
            'doc': 'bi-file-earmark-word text-primary',
            'docx': 'bi-file-earmark-word text-primary',
            'xls': 'bi-file-earmark-excel text-success',
            'xlsx': 'bi-file-earmark-excel text-success',
            'ppt': 'bi-file-earmark-ppt text-warning',
            'pptx': 'bi-file-earmark-ppt text-warning',
            'jpg': 'bi-file-earmark-image text-info',
            'jpeg': 'bi-file-earmark-image text-info',
            'png': 'bi-file-earmark-image text-info',
            'gif': 'bi-file-earmark-image text-info'
        };
        return icons[ext] || 'bi-file-earmark text-secondary';
    }
    
    // Function to render attachment preview
    function renderAttachmentPreview(files) {
        if (!files || files.length === 0) {
            attachmentPreview.innerHTML = '';
            return;
        }
        
        let totalSize = 0;
        Array.from(files).forEach(file => {
            totalSize += file.size;
        });
        
        const totalValid = totalSize <= MAX_FILE_SIZE;
        const totalClass = totalValid ? 'text-success' : 'text-danger';
        
        let html = `
            <div class="mt-2">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="small fw-bold text-muted">
                        <i class="bi bi-paperclip"></i> ${files.length} file${files.length > 1 ? 's' : ''} selected
                    </div>
                    <div class="small ${totalClass} fw-bold">
                        ${formatFileSize(totalSize)} / 4MB
                    </div>
                </div>
                <div class="d-flex flex-wrap gap-2" id="file-items-container">
        `;
        
        Array.from(files).forEach((file, index) => {
            html += `
                <div class="file-item" data-index="${index}" style="display: inline-flex; align-items: center; gap: 8px; padding: 6px 12px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; font-size: 14px;">
                    <i class="${getFileIcon(file.name)}" style="font-size: 16px;"></i>
                    <span class="text-truncate" style="max-width: 200px;" title="${file.name}">${file.name}</span>
                    <span class="text-muted small">(${formatFileSize(file.size)})</span>
                    <button type="button" class="btn-close-file" data-index="${index}" style="background: none; border: none; color: #6c757d; cursor: pointer; padding: 0; margin-left: 4px; font-size: 18px; line-height: 1;" title="Remove file">
                        ×
                    </button>
                </div>
            `;
        });
        
        html += '</div>';
        
        if (!totalValid) {
            html += `
                <div class="alert alert-danger p-2 mt-2 mb-0 small">
                    <i class="bi bi-exclamation-triangle"></i> Total size exceeds 4MB limit. Please remove some files.
                </div>
            `;
        }
        
        html += '</div>';
        attachmentPreview.innerHTML = html;
        
        // Add event listeners to remove buttons
        document.querySelectorAll('.btn-close-file').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const indexToRemove = parseInt(this.dataset.index);
                removeFile(indexToRemove);
            });
        });
    }
    
    // Function to remove a specific file
    function removeFile(index) {
        if (!fileInput.files || fileInput.files.length === 0) return;
        
        // Create a new FileList without the removed file
        const dt = new DataTransfer();
        const files = Array.from(fileInput.files);
        
        files.forEach((file, i) => {
            if (i !== index) {
                dt.items.add(file);
            }
        });
        
        fileInput.files = dt.files;
        
        // Re-render preview
        if (dt.files.length > 0) {
            renderAttachmentPreview(dt.files);
        } else {
            renderAttachmentPreview(null);
        }
        
        // Re-validate
        if (dt.files.length > 0) {
            validateTotalFileSize(dt.files);
        }
    }
    
    // Function to display existing attachments (read-only, from database)
    function displayExistingAttachments(data) {
        if (!data.attachment_filename) {
            attachmentPreview.innerHTML = '';
            return;
        }
        
        // Parse semicolon-separated filenames
        const filenames = data.attachment_filename.split(';').filter(f => f.trim());
        const totalSize = data.attachment_size || 0;
        
        let html = `
            <div class="mt-2">
                <div class="alert alert-info p-2 mb-2 small">
                    <i class="bi bi-info-circle"></i> Existing attachments (from saved draft). Upload new files to replace them.
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="small fw-bold text-muted">
                        <i class="bi bi-paperclip"></i> ${filenames.length} file${filenames.length > 1 ? 's' : ''} attached
                    </div>
                    <div class="small text-success fw-bold">
                        ${formatFileSize(totalSize)}
                    </div>
                </div>
                <div class="d-flex flex-wrap gap-2" id="file-items-container">
        `;
        
        filenames.forEach((filename, index) => {
            html += `
                <div class="file-item" style="display: inline-flex; align-items: center; gap: 8px; padding: 6px 12px; background: #e7f1ff; border: 1px solid #b3d7ff; border-radius: 4px; font-size: 14px;">
                    <i class="${getFileIcon(filename)}" style="font-size: 16px;"></i>
                    <span class="text-truncate" style="max-width: 200px;" title="${filename}">${filename}</span>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
        
        attachmentPreview.innerHTML = html;
    }
    
    // File input change handler
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const files = e.target.files;
            if (files.length === 0) {
                renderAttachmentPreview(null);
                return;
            }
            
            // Validate individual files
            let allValid = true;
            Array.from(files).forEach(file => {
                if (!validateFileSize(file)) {
                    allValid = false;
                }
            });
            
            // Validate total size
            const totalValid = validateTotalFileSize(files);
            
            // Render preview
            renderAttachmentPreview(files);
            
            // If individual files are invalid, clear all
            if (!allValid) {
                setTimeout(() => {
                    fileInput.value = '';
                    renderAttachmentPreview(null);
                }, 4000);
            }
        });
    }
    
    // Function to load and display announcement details
    async function loadAnnouncementDetails(announcementId, modalType) {
        try {
            const response = await fetch(`/communications/api/announcement/${announcementId}/`);
            const result = await response.json();
            
            if (result.status === 'success') {
                const data = result.data;
                
                // Determine which modal to populate
                const titleEl = document.getElementById(`view-${modalType}-modal-title`);
                const metaEl = document.getElementById(`view-${modalType}-modal-meta`);
                const contentEl = document.getElementById(`view-${modalType}-modal-content`);
                
                // Set title
                titleEl.textContent = data.title;
                
                // Set metadata
                const timestamp = modalType === 'sent' ? data.sent_at : data.created_at;
                const timestampLabel = modalType === 'sent' ? 'Sent' : 'Scheduled';
                metaEl.innerHTML = `
                    <span class="badge bg-${data.type === 'sms' ? 'primary' : 'info'} me-2">${data.type.toUpperCase()}</span>
                    ${timestampLabel}: ${formatDateTime(timestamp)} by ${data.sender_name}
                `;
                
                // Build content HTML with Gmail-like styling
                let contentHTML = `
                    <div class="mb-4" style="padding-bottom: 20px; border-bottom: 1px solid #e8eaed;">
                        <div style="color: #202124; font-size: 15px; line-height: 1.6; white-space: pre-wrap;">${data.description}</div>
                    </div>
                `;
                
                // Add attachment info and preview if exists
                if (data.has_attachment && data.attachment_filename) {
                    // Parse semicolon-separated filenames
                    const filenames = data.attachment_filename.split(';').map(f => f.trim()).filter(f => f);
                    const fileCount = filenames.length;
                    
                    contentHTML += `
                        <div class="mb-4" style="padding: 16px; background-color: #f1f3f4; border-radius: 8px; border-left: 4px solid #1a73e8;">
                            <div style="color: #202124; font-size: 14px; margin-bottom: 12px; font-weight: 600;">
                                <i class="bi bi-paperclip me-2" style="color: #1a73e8;"></i>
                                ${fileCount} Attachment${fileCount > 1 ? 's' : ''} (${formatFileSize(data.attachment_size)})
                            </div>
                    `;
                    
                    // Display each file with preview capability
                    filenames.forEach((filename, index) => {
                        const iconClass = getFileIcon(filename);
                        const fileExt = filename.split('.').pop().toLowerCase();
                        const canPreview = ['pdf', 'png', 'jpg', 'jpeg', 'gif', 'bmp', 'svg'].includes(fileExt);
                        
                        contentHTML += `
                            <div class="d-flex align-items-center gap-3 p-2 bg-white rounded border mb-2">
                                <i class="${iconClass} fs-3"></i>
                                <div class="flex-grow-1">
                                    <div class="fw-semibold text-truncate" style="max-width: 400px;" title="${filename}">${filename}</div>
                                </div>
                                ${canPreview ? `
                                    <button class="btn btn-sm btn-outline-info preview-attachment-btn" 
                                            data-announcement-id="${announcementId}"
                                            data-filename="${filename}"
                                            title="Preview">
                                        <i class="bi bi-eye"></i> Preview
                                    </button>
                                ` : ''}
                                <a href="/communications/api/announcement/${announcementId}/attachment/" 
                                   class="btn btn-sm btn-outline-primary" 
                                   download="${filename}"
                                   title="Download">
                                    <i class="bi bi-download"></i>
                                </a>
                            </div>
                        `;
                    });
                    
                    contentHTML += `
                        </div>
                    `;
                }
                
                // Add recipients info with Gmail-like styling
                contentHTML += `
                    <div class="mb-3">
                        <div style="color: #5f6368; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 12px;">
                            Recipients
                        </div>
                `;
                
                if (data.scope === 'cooperative' && data.coop_recipients.length > 0) {
                    contentHTML += '<div style="background-color: #f8f9fa; padding: 16px; border-radius: 8px;">';
                    data.coop_recipients.forEach(coop => {
                        contentHTML += `
                            <div style="padding: 8px 0; color: #202124; font-size: 14px;">
                                <i class="bi bi-building me-2" style="color: #1a73e8;"></i>
                                <strong>${coop.coop_name}</strong>
                                <span style="color: #5f6368; font-size: 13px; margin-left: 8px;">(All Officers)</span>
                            </div>
                        `;
                    });
                    contentHTML += '</div>';
                } else if (data.scope === 'officer' && data.officer_recipients.length > 0) {
                    // Group by cooperative
                    const groupedByCoopMap = {};
                    data.officer_recipients.forEach(officer => {
                        if (!groupedByCoopMap[officer.coop_name]) {
                            groupedByCoopMap[officer.coop_name] = [];
                        }
                        groupedByCoopMap[officer.coop_name].push(officer.officer_name);
                    });
                    
                    contentHTML += '<div style="background-color: #f8f9fa; padding: 16px; border-radius: 8px;">';
                    for (const [coopName, officers] of Object.entries(groupedByCoopMap)) {
                        contentHTML += `
                            <div style="margin-bottom: 16px;">
                                <div style="color: #202124; font-size: 14px; font-weight: 600; margin-bottom: 8px;">
                                    <i class="bi bi-building me-2" style="color: #1a73e8;"></i>${coopName}
                                </div>
                                <div style="margin-left: 28px;">
                        `;
                        officers.forEach(name => {
                            contentHTML += `
                                <div style="padding: 4px 0; color: #5f6368; font-size: 14px;">
                                    <i class="bi bi-person me-2"></i>${name}
                                </div>
                            `;
                        });
                        contentHTML += `</div></div>`;
                    }
                    contentHTML += '</div>';
                } else {
                    contentHTML += '<p style="color: #5f6368; font-size: 14px; font-style: italic;">No recipients specified</p>';
                }
                
                contentHTML += '</div>';
                
                contentEl.innerHTML = contentHTML;
                
                // Add event listeners for preview buttons
                document.querySelectorAll('.preview-attachment-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        const announcementId = this.dataset.announcementId;
                        const filename = this.dataset.filename;
                        previewAnnouncementAttachment(announcementId, filename);
                    });
                });
                
                // For scheduled announcements, handle edit/cancel buttons
                if (modalType === 'scheduled') {
                    handleScheduledAnnouncementButtons(data);
                }
            } else {
                console.error('Failed to load announcement:', result.message);
                showNotification('Failed to load announcement details', 'error');
            }
        } catch (error) {
            console.error('Error loading announcement:', error);
            showNotification('An error occurred while loading announcement details', 'error');
        }
    }
    
    // Preview announcement attachment
    let currentZoom = 1;
    const attachmentPreviewModal = new bootstrap.Modal(document.getElementById('attachment-preview-modal'));
    
    async function previewAnnouncementAttachment(announcementId, filename) {
        const previewContent = document.getElementById('attachment-preview-content');
        const previewTitle = document.getElementById('attachment-preview-title');
        const downloadLink = document.getElementById('preview-download-link');
        
        previewTitle.textContent = filename;
        previewContent.innerHTML = '<div class="spinner-border text-light" role="status"><span class="visually-hidden">Loading...</span></div>';
        
        currentZoom = 1;
        document.getElementById('preview-zoom-level').textContent = '100%';
        
        const fileExt = filename.split('.').pop().toLowerCase();
        const isImage = ['png', 'jpg', 'jpeg', 'gif', 'bmp', 'svg'].includes(fileExt);
        const isPdf = fileExt === 'pdf';
        
        // Set download link
        downloadLink.href = `/communications/api/announcement/${announcementId}/attachment/`;
        downloadLink.download = filename;
        
        attachmentPreviewModal.show();
        
        try {
            if (isImage || isPdf) {
                // Preview image or PDF directly
                const previewUrl = `/communications/api/announcement/${announcementId}/attachment/?preview=true`;
                
                if (isImage) {
                    previewContent.innerHTML = `<img src="${previewUrl}" alt="${filename}" style="max-width: 100%; height: auto;" id="preview-img">`;
                } else if (isPdf) {
                    previewContent.innerHTML = `<iframe src="${previewUrl}" style="width: 100%; height: 80vh; border: none;"></iframe>`;
                }
            } else {
                // Try to convert to PDF
                const convertUrl = `/communications/api/announcement/${announcementId}/attachment/convert-pdf/`;
                previewContent.innerHTML = `<iframe src="${convertUrl}" style="width: 100%; height: 80vh; border: none;"></iframe>`;
            }
        } catch (error) {
            previewContent.innerHTML = `<div class="text-light p-4">Failed to load preview: ${error.message}</div>`;
        }
    }
    
    // Zoom controls
    document.getElementById('preview-zoom-in').addEventListener('click', () => {
        currentZoom = Math.min(currentZoom + 0.25, 3);
        updateZoom();
    });
    
    document.getElementById('preview-zoom-out').addEventListener('click', () => {
        currentZoom = Math.max(currentZoom - 0.25, 0.5);
        updateZoom();
    });
    
    function updateZoom() {
        const img = document.getElementById('preview-img');
        if (img) {
            img.style.transform = `scale(${currentZoom})`;
        }
        document.getElementById('preview-zoom-level').textContent = Math.round(currentZoom * 100) + '%';
    }
    
    // Handle scheduled announcement edit/cancel functionality
    function handleScheduledAnnouncementButtons(data) {
        const editBtn = document.getElementById('edit-scheduled-btn');
        const cancelBtn = document.getElementById('cancel-scheduled-btn');
        
        if (!editBtn || !cancelBtn) return;
        
        // Calculate time until scheduled send
        const scheduledTime = new Date(data.sent_at);
        const now = new Date();
        const minutesUntilSend = (scheduledTime - now) / 1000 / 60;
        
        // Check if announcement was already sent
        if (data.status === 'sent') {
            editBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
            return;
        }
        
        // Show buttons for scheduled announcements
        editBtn.style.display = 'inline-block';
        cancelBtn.style.display = 'inline-block';
        
        // Store announcement ID on buttons
        editBtn.dataset.announcementId = data.announcement_id;
        cancelBtn.dataset.announcementId = data.announcement_id;
        
        // Remove old event listeners
        editBtn.replaceWith(editBtn.cloneNode(true));
        cancelBtn.replaceWith(cancelBtn.cloneNode(true));
        
        // Get new references
        const newEditBtn = document.getElementById('edit-scheduled-btn');
        const newCancelBtn = document.getElementById('cancel-scheduled-btn');
        
        // Edit button click handler
        newEditBtn.addEventListener('click', async () => {
            const minutesNow = (scheduledTime - new Date()) / 1000 / 60;
            
            // 5-minute lockout to prevent race conditions
            if (minutesNow < 5 && minutesNow > 0) {
                showNotification(
                    `This announcement is scheduled to send in less than 5 minutes and cannot be edited. Please "Cancel Schedule" first if you wish to make changes.`,
                    'warning'
                );
                return;
            }
            
            // Check if already sent (race condition check)
            if (minutesNow < 0) {
                showNotification(
                    'This announcement has already been sent and cannot be edited.',
                    'error'
                );
                viewScheduledModal.hide();
                setTimeout(() => location.reload(), 1500);
                return;
            }
            
            // Load draft for editing
            try {
                const response = await fetch(`/communications/api/announcement/draft/${data.announcement_id}/`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    loadDraftData(result.data);
                    viewScheduledModal.hide();
                    showCreateView();
                    
                    // Show notification about scheduled status
                    if (result.data.status === 'scheduled') {
                        showNotification(
                            'Editing scheduled announcement. Click "Send SMS" to save changes and keep the schedule, or use "Schedule Send" to change the time.',
                            'info'
                        );
                    } else {
                        showNotification('Editing scheduled announcement. Changes will be sent at the scheduled time.', 'info');
                    }
                } else {
                    showNotification(result.message || 'Failed to load announcement for editing', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('An error occurred while loading the announcement', 'error');
            }
        });
        
        // Cancel schedule button click handler
        newCancelBtn.addEventListener('click', () => {
            // Show confirmation modal
            const confirmCancelScheduleModal = new bootstrap.Modal(document.getElementById('confirm-cancel-schedule-modal'));
            confirmCancelScheduleModal.show();
            
            // Set up the confirm button handler
            const confirmBtn = document.getElementById('confirm-cancel-schedule-btn');
            confirmBtn.onclick = async () => {
                confirmCancelScheduleModal.hide();
            
            try {
                const response = await fetch(`/communications/api/announcement/cancel-schedule/${data.announcement_id}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    }
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showNotification('Schedule cancelled. Announcement reverted to draft.', 'success');
                    viewScheduledModal.hide();
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showNotification(result.message || 'Failed to cancel schedule', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('An error occurred while cancelling the schedule', 'error');
            }
            };
        });
    }
    
    // Helper function to get CSRF token
    function getCsrfToken() {
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    document.body.addEventListener('click', function(e) {
        const viewTrigger = e.target.closest('a[data-modal-id]');
        if (viewTrigger) {
            e.preventDefault();
            const modalId = viewTrigger.getAttribute('data-modal-id');
            const announcementId = viewTrigger.getAttribute('data-announcement-id');
            
            if (modalId === 'view-sent-modal' && announcementId) {
                loadAnnouncementDetails(announcementId, 'sent');
                viewSentModal.show();
            } else if (modalId === 'view-scheduled-modal' && announcementId) {
                loadAnnouncementDetails(announcementId, 'scheduled');
                viewScheduledModal.show();
            }
        }
    });

    const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
    let pendingTabTrigger = null; 
    if(confirmCancelBtn) {
        confirmCancelBtn.addEventListener('click', () => {
            confirmCancelModal.hide();
            showListView(); 
            if (pendingTabTrigger) {
                pendingTabTrigger.show();
                pendingTabTrigger = null; 
            }
        });
    }

    var triggerTabList = [].slice.call(document.querySelectorAll('#announcement-nav a'));
    triggerTabList.forEach(function (triggerEl) {
        var tabTrigger = new bootstrap.Tab(triggerEl);
        triggerEl.addEventListener('click', function (event) {
            event.preventDefault();
            const isCreateViewVisible = createView.classList.contains('d-flex');
            if (isCreateViewVisible) {
                pendingTabTrigger = tabTrigger; 
                confirmCancelModal.show(); 
            } else {
                tabTrigger.show();
            }
        });
    });

    // ========================================================
    // ===== COOPERATIVE & OFFICER LOGIC                =====
    // ========================================================

    function getCurrentlySelectedCoops() {
        const selectedCoops = [];
        recipientRowsContainer.querySelectorAll('.coop-select').forEach(select => {
            if (select.value) {
                selectedCoops.push(select.value);
            }
        });
        return selectedCoops;
    }

    function updateAvailableCooperatives() {
        const selectedCoopIds = getCurrentlySelectedCoops();
        
        recipientRowsContainer.querySelectorAll('.coop-select').forEach(select => {
            const currentSelectValue = select.value;
            const options = Array.from(select.querySelectorAll('option'));
            const specialOptions = [];
            const availableOptions = [];
            const unavailableOptions = [];

            options.forEach(option => {
                const value = option.value;
                const isSelectedElsewhere = selectedCoopIds.includes(value);

                if (!value) {
                    specialOptions.push(option);
                } else if (value === currentSelectValue) {
                    option.disabled = false;
                    specialOptions.push(option);
                } else if (isSelectedElsewhere) {
                    option.disabled = true;
                    unavailableOptions.push(option);
                } else {
                    option.disabled = false;
                    availableOptions.push(option);
                }
            });

            select.innerHTML = '';
            [...specialOptions, ...availableOptions, ...unavailableOptions].forEach(option => {
                select.appendChild(option);
            });
        });
    }

    function initializeTomSelect(selectElement, placeholderText) {
        if (selectElement.tomselect) {
            selectElement.tomselect.destroy();
        }
        new TomSelect(selectElement, {
            plugins: ['remove_button'],
            placeholder: placeholderText,
            
            onItemAdd: function(value, $item) {
                const tomSelect = this;
                const totalIndividuals = tomSelect.individualOfficerCount || 0;
                let currentSelection = tomSelect.getValue(); 

                if (value === 'all') {
                    if (currentSelection.length > 1) {
                        tomSelect.setValue(['all']);
                    }
                    return;
                }

                if (currentSelection.includes('all')) {
                    const newSelection = currentSelection.filter(v => v !== 'all');
                    tomSelect.setValue(newSelection);
                    return;
                }
                
                if (totalIndividuals > 0 && currentSelection.length === totalIndividuals) {
                    tomSelect.setValue(['all']);
                }
            }
        });
    }

    function populateCooperatives(coopSelect) {
        coopSelect.innerHTML = '<option value="" selected>Choose Cooperative...</option>';
        cooperativesData.forEach(coop => {
            const option = new Option(coop.name, coop.id);
            coopSelect.add(option);
        });
    }

    function populateOfficers(officerSelect, coopId) {
        const tomSelect = officerSelect.tomselect;
        if (!tomSelect) return; 

        tomSelect.clear();
        tomSelect.clearOptions();
        tomSelect.individualOfficerCount = 0;

        if (!coopId) {
            tomSelect.addOption({value: '', text: '-- Select Cooperative First --'});
            tomSelect.settings.placeholder = '-- Select Cooperative First --';
            tomSelect.disable();
        } else {
            const officers = officersByCoopData[coopId];
            if (officers && officers.length > 0) {
                tomSelect.addOption({value: 'all', text: 'All Officers'});
                officers.forEach(officer => {
                    tomSelect.addOption({value: officer.id, text: officer.name});
                });
                tomSelect.individualOfficerCount = officers.length;
                tomSelect.settings.placeholder = 'Select officer(s)...';
            } else {
                tomSelect.settings.placeholder = '-- No Officers Found --';
            }
            tomSelect.enable();
        }
        tomSelect.refreshPlaceholder();
    }

    // --- Event Listener for Adding New Rows ---
    if (addRecipientBtn) {
        addRecipientBtn.addEventListener('click', () => {
            const newRow = recipientRowTemplate.content.cloneNode(true);
            const newCoopSelect = newRow.querySelector('.coop-select');
            populateCooperatives(newCoopSelect); 
            
            const newOfficerSelect = newRow.querySelector('.officer-select');
            initializeTomSelect(newOfficerSelect, '-- Select Cooperative First --');
            
            recipientRowsContainer.appendChild(newRow);
            updateRecipientRemoveButtons();
            updateAvailableCooperatives();
        });
    }

    // --- Event Listener for Removing Rows ---
    if (recipientRowsContainer) {
        recipientRowsContainer.addEventListener('click', (e) => {
            const removeBtn = e.target.closest('.remove-recipient-btn');
            if (removeBtn) {
                const rowToRemove = removeBtn.closest('.recipient-row');
                if (rowToRemove) {
                    const officerSelect = rowToRemove.querySelector('.officer-select');
                    if (officerSelect && officerSelect.tomselect) {
                        officerSelect.tomselect.destroy();
                    }
                    rowToRemove.remove();
                    updateRecipientRemoveButtons();
                    updateAvailableCooperatives();
                }
            }
        });
    }
    
    // --- Event Listener for changing a Cooperative ---
    if (recipientRowsContainer) {
        recipientRowsContainer.addEventListener('change', (e) => {
            if (e.target && e.target.classList.contains('coop-select')) {
                const selectedCoopId = e.target.value;
                const recipientRow = e.target.closest('.recipient-row');
                const officerSelect = recipientRow.querySelector('.officer-select');
                
                populateOfficers(officerSelect, selectedCoopId);
                updateAvailableCooperatives();
            }
        });
    }

    function updateRecipientRemoveButtons() {
        const rows = recipientRowsContainer.querySelectorAll('.recipient-row');
        rows.forEach((row, index) => {
            const removeBtn = row.querySelector('.remove-recipient-btn');
            if (index > 0) {
                removeBtn.classList.remove('d-none');
            } else {
                removeBtn.classList.add('d-none');
            }
        });
    }
    
    // --- Populate the very first row on page load ---
    try {
        const firstCoopSelect = recipientRowsContainer.querySelector('.coop-select');
        if (firstCoopSelect) {
            populateCooperatives(firstCoopSelect);
            
            const firstOfficerSelect = recipientRowsContainer.querySelector('.officer-select');
            if (firstOfficerSelect) {
                initializeTomSelect(firstOfficerSelect, '-- Select Cooperative First --');
            }
        }
        updateRecipientRemoveButtons();
        updateAvailableCooperatives();

    } catch (e) {
        console.error('CRITICAL ERROR: Failed to load cooperative data.', e);
    }

    // ===========================================
    // ===== DRAFT EDITING LOGIC            =====
    // ===========================================
    
    draftButtons.forEach(btn => {
        btn.addEventListener('click', async (e) => {
            e.preventDefault();
            const draftId = btn.getAttribute('data-id');
            
            try {
                const response = await fetch(`/communications/api/announcement/draft/${draftId}/`);
                const result = await response.json();
                
                if (result.status === 'success') {
                    loadDraftData(result.data);
                    showCreateView();
                } else {
                    showNotification(result.message || 'Failed to load draft', 'error');
                }
            } catch (error) {
                console.error('Error loading draft:', error);
                showNotification('An error occurred while loading the draft', 'error');
            }
        });
    });

    function loadDraftData(data) {
        currentDraftId = data.announcement_id;
        
        // Check if this is a scheduled announcement being edited
        if (data.status === 'scheduled' && data.sent_at) {
            isEditingScheduled = true;
            currentScheduledTime = data.sent_at;
            
            // Update button visibility and text
            if (saveDraftBtn) saveDraftBtn.textContent = 'Save to Draft';
            if (saveChangesBtn) saveChangesBtn.classList.remove('d-none');
        } else {
            isEditingScheduled = false;
            currentScheduledTime = null;
            
            // Reset button visibility and text
            if (saveDraftBtn) saveDraftBtn.textContent = 'Save Draft';
            if (saveChangesBtn) saveChangesBtn.classList.add('d-none');
        }
        
        // Set basic fields
        document.getElementById('announcement-title').value = data.title || '';
        document.getElementById('announcement-content').value = data.description || '';
        document.getElementById('announcement-type').value = data.type || '';
        
        // Trigger type change to show appropriate fields
        const typeChangeEvent = new Event('change');
        document.getElementById('announcement-type').dispatchEvent(typeChangeEvent);
        
        // Clear existing recipient rows
        recipientRowsContainer.innerHTML = '';
        
        // Process recipients based on scope
        if (data.scope === 'cooperative' && data.coop_recipients) {
            // Check if already parsed or needs parsing
            const coopRecipients = typeof data.coop_recipients === 'string' 
                ? JSON.parse(data.coop_recipients) 
                : data.coop_recipients;
            coopRecipients.forEach(coop => {
                addRecipientRow(coop.coop_id, 'all');
            });
        } else if (data.scope === 'officer' && data.officer_recipients) {
            // Check if already parsed or needs parsing
            const officerRecipients = typeof data.officer_recipients === 'string'
                ? JSON.parse(data.officer_recipients)
                : data.officer_recipients;
            
            // Group officers by coop
            const groupedByCoop = {};
            officerRecipients.forEach(officer => {
                const coopId = officer.coop_id;
                if (!groupedByCoop[coopId]) {
                    groupedByCoop[coopId] = [];
                }
                groupedByCoop[coopId].push(officer.officer_id);
            });
            
            // Add rows for each coop
            for (const [coopId, officerIds] of Object.entries(groupedByCoop)) {
                addRecipientRow(parseInt(coopId), officerIds);
            }
        }
        
        // If no recipients, add empty row
        if (recipientRowsContainer.children.length === 0) {
            addRecipientRow(null, null);
        }
        
        updateRecipientRemoveButtons();
        updateAvailableCooperatives();
        
        // Display existing attachments if present
        if (data.has_attachment && data.attachment_filename) {
            displayExistingAttachments(data);
        } else {
            attachmentPreview.innerHTML = '';
        }
    }

    function addRecipientRow(coopId, officerIds) {
        const newRow = recipientRowTemplate.content.cloneNode(true);
        const newCoopSelect = newRow.querySelector('.coop-select');
        populateCooperatives(newCoopSelect);
        
        const newOfficerSelect = newRow.querySelector('.officer-select');
        initializeTomSelect(newOfficerSelect, '-- Select Cooperative First --');
        
        recipientRowsContainer.appendChild(newRow);
        
        // Set values after row is added to DOM
        if (coopId) {
            const addedRow = recipientRowsContainer.lastElementChild;
            const coopSelect = addedRow.querySelector('.coop-select');
            const officerSelect = addedRow.querySelector('.officer-select');
            
            coopSelect.value = coopId;
            
            // Trigger change to populate officers
            const changeEvent = new Event('change', { bubbles: true });
            coopSelect.dispatchEvent(changeEvent);
            
            // Wait for officers to populate, then set selection
            setTimeout(() => {
                if (officerSelect.tomselect) {
                    if (officerIds === 'all') {
                        officerSelect.tomselect.setValue(['all']);
                    } else if (Array.isArray(officerIds)) {
                        officerSelect.tomselect.setValue(officerIds.map(String));
                    }
                }
            }, 100);
        }
    }

    // ===========================================
    // ===== SCHEDULE SEND VALIDATION        =====
    // ===========================================
    
    const scheduleDateInput = document.getElementById('schedule-date');
    const scheduleTimeInput = document.getElementById('schedule-time');
    const saveScheduleBtn = document.querySelector('#schedule-send-modal .btn-primary');

    function setMinDateTime() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        
        scheduleDateInput.min = `${year}-${month}-${day}`;
        scheduleDateInput.value = '';
        scheduleTimeInput.value = '';
    }

    function validateScheduleDateTime() {
        const selectedDate = scheduleDateInput.value;
        const selectedTime = scheduleTimeInput.value;
        
        if (!selectedDate || !selectedTime) {
            showNotification('Please select both date and time', 'warning');
            return false;
        }
        
        const selectedDateTime = new Date(`${selectedDate}T${selectedTime}`);
        const now = new Date();
        
        if (selectedDateTime <= now) {
            showNotification('Scheduled time must be in the future', 'error');
            return false;
        }
        
        return true;
    }

    document.getElementById('schedule-send-link').addEventListener('click', (e) => {
        e.preventDefault();
        setMinDateTime();
        scheduleSendModal.show();
    });

    if (saveScheduleBtn) {
        saveScheduleBtn.addEventListener('click', () => {
            if (validateScheduleDateTime()) {
                const selectedDate = scheduleDateInput.value;
                const selectedTime = scheduleTimeInput.value;
                
                // Create a Date object from the selected date/time (assumes local timezone)
                const localDateTime = new Date(`${selectedDate}T${selectedTime}:00`);
                
                // Convert to ISO string with timezone offset (e.g., "2025-11-19T22:30:00+08:00")
                const year = localDateTime.getFullYear();
                const month = String(localDateTime.getMonth() + 1).padStart(2, '0');
                const day = String(localDateTime.getDate()).padStart(2, '0');
                const hours = String(localDateTime.getHours()).padStart(2, '0');
                const minutes = String(localDateTime.getMinutes()).padStart(2, '0');
                const seconds = String(localDateTime.getSeconds()).padStart(2, '0');
                
                // Get timezone offset in hours and minutes
                const tzOffset = -localDateTime.getTimezoneOffset();
                const tzHours = String(Math.floor(Math.abs(tzOffset) / 60)).padStart(2, '0');
                const tzMinutes = String(Math.abs(tzOffset) % 60).padStart(2, '0');
                const tzSign = tzOffset >= 0 ? '+' : '-';
                
                const scheduledDateTime = `${year}-${month}-${day}T${hours}:${minutes}:${seconds}${tzSign}${tzHours}:${tzMinutes}`;
                
                submitAnnouncement('schedule_send', scheduledDateTime);
                scheduleSendModal.hide();
            }
        });
    }

    // ===========================================
    // ===== VIEW SWITCHING LOGIC            =====
    // ===========================================
    
    function showCreateView() {
        listView.classList.remove('d-flex');
        listView.classList.add('d-none');
        createView.classList.remove('d-none');
        createView.classList.add('d-flex');
        const currentActive = document.querySelector('.sidebar-nav .nav-link.active');
        if (currentActive) currentActive.classList.remove('active');
    }

    function showListView() {
        createView.classList.remove('d-flex');
        createView.classList.add('d-none');
        listView.classList.remove('d-none');
        listView.classList.add('d-flex');
        resetForm();
        
        // Restore the active tab or default to 'sent'
        const activeTab = document.querySelector('#announcement-nav .nav-link.active');
        if (!activeTab) {
            // Default to first tab (sent)
            const firstTab = document.querySelector('#announcement-nav .nav-link');
            if (firstTab) {
                const tabTrigger = new bootstrap.Tab(firstTab);
                tabTrigger.show();
            }
        }
    }
    
    function resetForm() {
        currentDraftId = null;
        currentScheduledTime = null;
        isEditingScheduled = false;
        
        // Reset button visibility and text
        if (saveDraftBtn) saveDraftBtn.textContent = 'Save Draft';
        if (saveChangesBtn) saveChangesBtn.classList.add('d-none');
        mainForm.reset();
        dynamicFields.classList.add('d-none');
        emailFields.classList.add('d-none');
        
        recipientRowsContainer.querySelectorAll('.officer-select').forEach(select => {
            if (select.tomselect) {
                select.tomselect.destroy();
            }
        });

        recipientRowsContainer.innerHTML = ''; 
        
        const newRow = recipientRowTemplate.content.cloneNode(true); 
        const newCoopSelect = newRow.querySelector('.coop-select');
        populateCooperatives(newCoopSelect);
        
        const newOfficerSelect = newRow.querySelector('.officer-select');
        initializeTomSelect(newOfficerSelect, '-- Select Cooperative First --');
        
        recipientRowsContainer.appendChild(newRow);
        updateRecipientRemoveButtons();
        updateAvailableCooperatives();
    }

    if(createBtn) createBtn.addEventListener('click', showCreateView);
    
    if(cancelBtn) {
        cancelBtn.addEventListener('click', () => {
            pendingTabTrigger = null;
            confirmCancelModal.show();
        });
    }

    if(announcementType) {
        announcementType.addEventListener('change', () => {
            const selectedType = announcementType.value;
            if (selectedType === 'sms' || selectedType === 'e-mail') {
                dynamicFields.classList.remove('d-none');
                if (selectedType === 'e-mail') {
                    emailFields.classList.remove('d-none');
                    sendBtnMain.textContent = 'Send Email';
                } else {
                    emailFields.classList.add('d-none');
                    sendBtnMain.textContent = 'Send SMS';
                }
            } else {
                dynamicFields.classList.add('d-none');
            }
        });
    }

    // ===========================================
    // ===== FORM SUBMISSION LOGIC           =====
    // ===========================================
    
    if (sendBtnMain) {
        sendBtnMain.addEventListener('click', (e) => {
            e.preventDefault();
            const type = announcementType.value;
            
            // If editing a scheduled announcement, preserve the schedule
            if (isEditingScheduled && currentScheduledTime) {
                submitAnnouncement('schedule_send', currentScheduledTime);
            } else if (type === 'sms') {
                submitAnnouncement('send_sms');
            } else if (type === 'e-mail') {
                submitAnnouncement('send_email');
            }
        });
    }

    if (saveDraftBtn) {
        saveDraftBtn.addEventListener('click', (e) => {
            e.preventDefault();
            submitAnnouncement('save_draft');
        });
    }

    if (saveChangesBtn) {
        saveChangesBtn.addEventListener('click', (e) => {
            e.preventDefault();
            // Save changes while preserving scheduled status
            if (isEditingScheduled && currentScheduledTime) {
                submitAnnouncement('schedule_send', currentScheduledTime);
            } else {
                submitAnnouncement('save_draft');
            }
        });
    }

    function collectFormData(action, scheduledTime = null) {
        const title = document.getElementById('announcement-title').value;
        const content = document.getElementById('announcement-content').value;
        const type = announcementType.value;
        
        const recipientRows = recipientRowsContainer.querySelectorAll('.recipient-row');
        const recipients = [];
        
        recipientRows.forEach(row => {
            const coopSelect = row.querySelector('.coop-select');
            const officerSelect = row.querySelector('.officer-select');
            
            if (coopSelect && coopSelect.value && officerSelect && officerSelect.tomselect) {
                const selectedOfficerValues = officerSelect.tomselect.getValue(); 
                
                if (selectedOfficerValues.includes('all')) {
                    recipients.push({
                        coop_id: coopSelect.value,
                        officer_id: 'all'
                    });
                } else {
                    selectedOfficerValues.forEach(officerId => {
                        if (officerId) {
                            recipients.push({
                                coop_id: coopSelect.value,
                                officer_id: officerId
                            });
                        }
                    });
                }
            }
        });

        if (!type) {
            showNotification('Please select an announcement type (SMS or Email)', 'warning');
            return null;
        }
        if (!title || !content) {
            showNotification('Please fill in the Title and Content', 'warning');
            return null;
        }
        if (recipients.length === 0 && action !== 'save_draft') {
            showNotification('Please add at least one valid recipient to send', 'warning');
            return null;
        }

        // Use FormData for file upload support
        const formData = new FormData();
        formData.append('action', action);
        formData.append('title', title);
        formData.append('content', content);
        formData.append('type', type);
        formData.append('recipients', JSON.stringify(recipients));
        
        if (currentDraftId) {
            formData.append('announcement_id', currentDraftId);
        }
        
        // Use provided scheduledTime, or preserve existing scheduled time if editing a scheduled announcement
        if (scheduledTime) {
            formData.append('scheduled_time', scheduledTime);
        } else if (isEditingScheduled && currentScheduledTime && action !== 'save_draft') {
            // Preserve the scheduled time when sending an edited scheduled announcement
            formData.append('scheduled_time', currentScheduledTime);
        }
        
        // Add attachments if any (for email type)
        if (type === 'e-mail' && fileInput && fileInput.files.length > 0) {
            Array.from(fileInput.files).forEach((file, index) => {
                formData.append('attachments', file);
            });
        }
        
        return formData;
    }

    async function submitAnnouncement(action, scheduledTime = null) {
        const data = collectFormData(action, scheduledTime);
        if (!data) return;
        
        console.log('Sending data with attachments');

        // Show loading overlay
        const loadingOverlay = document.createElement('div');
        loadingOverlay.id = 'sending-overlay';
        loadingOverlay.innerHTML = `
            <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                <div class="spinner-border text-light" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div class="text-light mt-3 fw-bold" style="font-size: 18px;">
                    ${action === 'send_email' ? 'Sending Email...' : action === 'send_sms' ? 'Sending SMS...' : action === 'schedule_send' ? 'Scheduling...' : 'Saving...'}
                </div>
                <div class="text-light mt-2" style="font-size: 14px;">Please wait, this may take a moment</div>
            </div>
        `;
        document.body.appendChild(loadingOverlay);

        try {
            const response = await fetch("{% url 'communications:handle_announcement' %}", {
                method: 'POST',
                // Don't set Content-Type header - browser will set it automatically with boundary for FormData
                body: data
            });

            const result = await response.json();

            // Remove loading overlay
            const overlay = document.getElementById('sending-overlay');
            if (overlay) overlay.remove();

            if (response.ok && result.status === 'success') {
                showNotification(result.message || 'Announcement processed successfully', 'success');
                currentDraftId = null;
                currentScheduledTime = null;
                isEditingScheduled = false;
                showListView();
                setTimeout(() => location.reload(), 1500);
            } else {
                showNotification(result.message || 'Failed to process announcement', 'error');
            }

        } catch (error) {
            // Remove loading overlay on error
            const overlay = document.getElementById('sending-overlay');
            if (overlay) overlay.remove();
            
            console.error('Fetch Error:', error);
            showNotification('An error occurred while communicating with the server', 'error');
        }
    }

    // ============================================
    // SEARCH AND FILTER FUNCTIONALITY
    // ============================================
    
    const searchInput = document.getElementById('search-input');
    const filterTypes = document.querySelectorAll('.filter-type');
    const filterDateFrom = document.getElementById('filter-date-from');
    const filterDateTo = document.getElementById('filter-date-to');
    const activeFiltersBadge = document.getElementById('active-filters-badge');
    const clearFiltersBtn = document.getElementById('clear-filters-btn');
    
    // Get all announcement items across all tabs
    function getAllAnnouncementItems() {
        return document.querySelectorAll('.announcement-item');
    }
    
    // Count active filters
    function countActiveFilters() {
        let count = 0;
        
        // Count type filters
        filterTypes.forEach(checkbox => {
            if (checkbox.checked) count++;
        });
        
        // Count date filters
        if (filterDateFrom.value) count++;
        if (filterDateTo.value) count++;
        
        return count;
    }
    
    // Update filter badge
    function updateFilterBadge() {
        const count = countActiveFilters();
        if (count > 0) {
            activeFiltersBadge.textContent = `${count} filter${count > 1 ? 's' : ''}`;
            activeFiltersBadge.classList.remove('d-none');
            clearFiltersBtn.classList.remove('d-none');
        } else {
            activeFiltersBadge.classList.add('d-none');
            clearFiltersBtn.classList.add('d-none');
        }
    }
    
    // Main filter function
    function applyFilters() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const selectedTypes = Array.from(filterTypes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);
        const dateFrom = filterDateFrom.value;
        const dateTo = filterDateTo.value;
        
        const items = getAllAnnouncementItems();
        let visibleCount = 0;
        
        items.forEach(item => {
            let show = true;
            
            // Search filter (title, content, recipients, cooperatives)
            if (searchTerm) {
                const title = (item.dataset.title || '').toLowerCase();
                const content = (item.dataset.content || '').toLowerCase();
                const coops = (item.dataset.coops || '').toLowerCase();
                const officers = (item.dataset.officers || '').toLowerCase();
                
                const matchesSearch = title.includes(searchTerm) ||
                                    content.includes(searchTerm) ||
                                    coops.includes(searchTerm) ||
                                    officers.includes(searchTerm);
                
                if (!matchesSearch) show = false;
            }
            
            // Type filter
            if (selectedTypes.length > 0 && show) {
                const itemType = item.dataset.type;
                if (!selectedTypes.includes(itemType)) {
                    show = false;
                }
            }
            
            // Date range filter
            if ((dateFrom || dateTo) && show) {
                const itemDate = item.dataset.date;
                
                if (dateFrom && itemDate < dateFrom) {
                    show = false;
                }
                
                if (dateTo && itemDate > dateTo) {
                    show = false;
                }
            }
            
            // Show/hide item
            if (show) {
                item.style.display = '';
                visibleCount++;
            } else {
                item.style.display = 'none';
            }
        });
        
        // Show "no results" message if needed
        updateNoResultsMessage(visibleCount);
        updateFilterBadge();
    }
    
    // Update "no results" messages for each tab
    function updateNoResultsMessage(visibleCount) {
        const activeTab = document.querySelector('.tab-pane.active');
        if (!activeTab) return;
        
        const listGroup = activeTab.querySelector('.list-group');
        if (!listGroup) return;
        
        const items = activeTab.querySelectorAll('.announcement-item');
        const visibleItems = Array.from(items).filter(item => item.style.display !== 'none');
        
        // Remove existing no results message
        const existingMsg = activeTab.querySelector('.no-results-message');
        if (existingMsg) existingMsg.remove();
        
        // Add no results message if needed
        if (items.length > 0 && visibleItems.length === 0) {
            const noResultsDiv = document.createElement('div');
            noResultsDiv.className = 'p-4 text-center text-muted no-results-message';
            noResultsDiv.innerHTML = `
                <i class="bi bi-search fs-1 d-block mb-2"></i>
                <p>No announcements match your filters.</p>
            `;
            listGroup.appendChild(noResultsDiv);
        }
    }
    
    // Clear all filters
    function clearAllFilters() {
        searchInput.value = '';
        filterTypes.forEach(cb => cb.checked = false);
        filterDateFrom.value = '';
        filterDateTo.value = '';
        applyFilters();
    }
    
    // Event listeners for real-time filtering
    if (searchInput) {
        searchInput.addEventListener('input', applyFilters);
    }
    
    if (filterTypes.length > 0) {
        filterTypes.forEach(checkbox => {
            checkbox.addEventListener('change', applyFilters);
        });
    }
    
    if (filterDateFrom) {
        filterDateFrom.addEventListener('change', applyFilters);
    }
    
    if (filterDateTo) {
        filterDateTo.addEventListener('change', applyFilters);
    }
    
    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', clearAllFilters);
    }
    
    // Re-apply filters when switching tabs
    const tabButtons = document.querySelectorAll('[data-bs-toggle="pill"]');
    tabButtons.forEach(button => {
        button.addEventListener('shown.bs.tab', () => {
            applyFilters();
        });
    });
    
    // Initialize on page load
    updateFilterBadge();
});
</script>
{% endblock %}
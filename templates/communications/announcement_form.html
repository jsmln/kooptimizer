{% extends 'dashboard/dashboard.html' %}
{% load static %}

{% block dashboard_title %}Announcements{% endblock %}
{% block page_header %}Announcements{% endblock %}

{% block extra_head %}
{{ block.super }}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.css" rel="stylesheet">

<link rel="stylesheet" href="{% static 'frontend/announcement.css' %}">

<!-- PDF.js library for document preview -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
    /* Profile Dropdown */
    .profile-dropdown {
        position: relative;
    }

    .profile-trigger {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 12px;
        transition: background 0.2s;
    }

    .profile-trigger:hover {
        background: #f7f9fc;
    }

    .profile-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #a91e2c;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1rem;
    }

    .profile-info {
        display: flex;
        flex-direction: column;
        text-align: left;
        line-height: 1.2;
    }

    .profile-name {
        font-weight: 600;
        font-size: 0.9rem;
        color: #2B3674;
    }

    .profile-role {
        font-size: 0.75rem;
        color: #A3AED0;
    }

    .dropdown-arrow {
        color: #A3AED0;
        font-size: 0.8rem;
        transition: transform 0.2s;
    }

    .profile-dropdown.active .dropdown-arrow {
        transform: rotate(180deg);
    }

    /* Dropdown Menu */
    .dropdown-menu-custom {
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        min-width: 200px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.2s ease;
        z-index: 1000;
    }

    .profile-dropdown.active .dropdown-menu-custom {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .dropdown-item-custom {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        color: #2B3674;
        text-decoration: none;
        transition: background 0.2s;
        border-radius: 8px;
        margin: 4px;
    }

    .dropdown-item-custom:first-child {
        margin-top: 8px;
    }

    .dropdown-item-custom:last-child {
        margin-bottom: 8px;
    }

    .dropdown-item-custom:hover {
        background: #f7f9fc;
        color: #2B3674;
    }

    .dropdown-item-custom i {
        font-size: 1.1rem;
        width: 20px;
        text-align: center;
    }

    .dropdown-item-custom.logout {
        color: #a91e2c;
        border-top: 1px solid #f0f0f0;
        margin-top: 4px;
    }

    .dropdown-item-custom.logout:hover {
        background: #fff0f2;
        color: #a91e2c;
    }

    /* Adjust content area for top-bar */
    .content-scrollable {
        margin-top: 56px !important;
        height: calc(100vh - 56px) !important;
        width: 100%;
        display: flex;
        align-items: flex-start !important;
        justify-content: center;
        overflow: hidden !important;
        background-color: #F4F7FE;
        padding: 0 !important;
        margin-bottom: 0 !important;
    }

    /* Adjust layout height to fit within the new alignment */
    .announcement-layout {
        display: flex;
        width: 96%;
        height: 100%;
        max-width: 1400px;
        gap: 20px;
        background: transparent;
        overflow: hidden;
        padding-top: 0;
        margin-top: 0;
    }

    /* --- 2. LEFT CARD: NAVIGATION SIDEBAR --- */
    .announcement-sidebar {
        width: 260px;
        flex-shrink: 0;
        background: #fff;
        border-radius: 16px;
        box-shadow: 0px 4px 20px rgba(0, 0, 0, 0.03);
        display: flex;
        flex-direction: column;
    }

    /* Create New Button */
    #create-new-btn {
        background-color: #b71c1c;
        border: none;
        font-weight: 600;
        border-radius: 12px;
        padding: 12px;
        transition: 0.2s;
    }

    #create-new-btn:hover {
        background-color: #8a1515;
    }

    /* Navigation Links (Gmail Style) */
    .sidebar-nav .nav-item {
        margin-bottom: 4px;
        padding-right: 15px;
    }

    .sidebar-nav .nav-link {
        color: #555;
        font-weight: 500;
        padding: 10px 20px;
        border-radius: 0 25px 25px 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s;
    }

    .sidebar-nav .nav-link i {
        font-size: 1.1rem;
        color: #888;
    }

    .sidebar-nav .nav-link:hover {
        background-color: #f5f5f5;
        color: #000;
    }

    .sidebar-nav .nav-link.active {
        background-color: #fff0f2;
        color: #b71c1c;
    }

    .sidebar-nav .nav-link.active i {
        color: #b71c1c;
    }

    .sidebar-nav .badge {
        background-color: #f0f0f0;
        color: #333;
        font-weight: 600;
        border-radius: 10px;
    }

    .sidebar-nav .nav-link.active .badge {
        background-color: #b71c1c;
        color: #fff;
    }

    /* --- 3. RIGHT CARD: CONTENT AREA --- */
    .announcement-content {
        flex: 1;
        background: #fff;
        border-radius: 16px;
        box-shadow: 0px 4px 20px rgba(0, 0, 0, 0.03);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* Content Header */
    .content-header {
        height: 70px;
        padding: 0 25px;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        align-items: center;
        flex-shrink: 0;
        background: #fff;
    }

    /* Search Input */
    .search-wrapper {
        position: relative;
        width: 100%;
        max-width: 400px;
    }

    .search-wrapper input {
        width: 100%;
        padding: 10px 15px 10px 40px;
        background: #f9f9f9;
        border: 1px solid transparent;
        border-radius: 20px;
        color: #000;
    }

    .search-wrapper input:focus {
        background: #fff;
        border-color: #b71c1c;
        outline: none;
    }

    .search-wrapper i {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #999;
    }

    /* Scrollable List Area */
    .list-scroll-area {
        flex: 1;
        overflow-y: auto;
        background: #fff;
    }

    /* List Items */
    .list-group-item {
        border: none;
        border-bottom: 1px solid #f9f9f9;
        padding: 18px 25px;
        transition: background 0.1s;
    }

    .list-group-item:hover {
        background-color: #fafafa;
        cursor: pointer;
    }

    /* Badges in List */
    .badge-type {
        font-size: 0.75rem;
        padding: 4px 8px;
        border-radius: 6px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .badge-type.badge-sms {
        background-color: #e3f2fd;
        color: #0d47a1;
    }

    .badge-type.badge-email {
        background-color: #e8f5e9;
        color: #1b5e20;
    }

    .badge-type.badge-attachment {
        background-color: #fff3e0;
        color: #e65100;
    }

    /* Empty State */
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #999;
        padding: 40px;
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 10px;
        opacity: 0.5;
    }

    /* --- FORM STYLES --- */
    .form-label {
        font-size: 0.9rem;
        color: #333;
    }

    .form-control,
    .form-select {
        padding: 10px 15px;
        border-radius: 8px;
        border: 1px solid #eee;
        background: #fcfcfc;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: #b71c1c;
        box-shadow: 0 0 0 3px rgba(183, 28, 28, 0.1);
        background: #fff;
    }

    /* Tom Select Customization */
    .ts-control {
        border-radius: 8px;
        border: 1px solid #eee;
        padding: 10px;
    }

    .ts-control.focus {
        border-color: #b71c1c;
        box-shadow: none;
    }

    /* ========================================
       PREVIEW MODAL STYLES (from message.html)
       ======================================== */

    /* Preview Modal - Meta Messenger style */
    .preview-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.92);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1200;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .preview-overlay.show {
        opacity: 1;
    }

    .preview-content {
        background: #fff;
        width: 90vw;
        max-width: 1200px;
        height: 85vh;
        border-radius: 16px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
    }

    .preview-main-container {
        display: flex;
        flex: 1;
        overflow: hidden;
    }

    .preview-sidebar {
        width: 180px;
        background: #2b2b2b;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border-right: 1px solid #444;
        flex-shrink: 0;
    }

    .preview-sidebar-header {
        padding: 10px;
        background: #1a1a1a;
        color: #fff;
        font-size: 0.8rem;
        font-weight: 600;
        text-align: center;
        border-bottom: 1px solid #444;
    }

    .preview-thumbnails {
        flex: 1;
        overflow-y: auto;
        padding: 8px;
    }

    .preview-thumbnail {
        margin-bottom: 8px;
        cursor: pointer;
        border: 2px solid transparent;
        border-radius: 4px;
        overflow: hidden;
        background: #333;
        transition: border-color 0.2s;
        position: relative;
    }

    .preview-thumbnail:hover {
        border-color: #666;
    }

    .preview-thumbnail.active {
        border-color: #d32f2f;
    }

    .preview-thumbnail canvas {
        width: 100%;
        display: block;
    }

    .preview-thumbnail-label {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0, 0, 0, 0.7);
        color: #fff;
        text-align: center;
        font-size: 0.7rem;
        padding: 2px 4px;
    }

    .preview-content-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .preview-header {
        background: #f8f9fa;
        padding: 12px 16px;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
    }

    .preview-title {
        font-weight: 600;
        font-size: 0.95rem;
        color: #2B3674;
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        margin-right: 15px;
    }

    .preview-controls {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-shrink: 0;
    }

    .preview-controls button,
    .preview-controls .btn {
        padding: 6px 12px;
        border: none;
        border-radius: 8px;
        background: #6c757d;
        color: white;
        cursor: pointer;
        font-size: 0.85rem;
        transition: background 0.2s;
        white-space: nowrap;
    }

    .preview-controls button[title] {
        padding: 6px 10px;
        font-size: 1rem;
    }

    .preview-controls button:hover,
    .preview-controls .btn:hover {
        background: #5a6268;
    }

    /* Download button group */
    .preview-download-group {
        display: inline-flex;
        position: relative;
    }

    .preview-download-group .btn-download-main {
        background: #d32f2f;
        border-radius: 8px 0 0 8px;
        padding: 6px 12px;
        border: none;
        color: white;
        text-decoration: none;
        font-size: 0.85rem;
        cursor: pointer;
        transition: background 0.2s;
    }

    .preview-download-group .btn-download-main:hover {
        background: #b71c1c;
    }

    .preview-download-group .btn-download-toggle {
        background: #d32f2f;
        border-radius: 0 8px 8px 0;
        border-left: 1px solid rgba(255, 255, 255, 0.2);
        padding: 6px 8px;
        border: none;
        color: white;
        cursor: pointer;
        transition: background 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .preview-download-group .btn-download-toggle:hover {
        background: #b71c1c;
    }

    .preview-download-group .btn-download-toggle::after {
        content: '';
        border: solid white;
        border-width: 0 2px 2px 0;
        display: inline-block;
        padding: 3px;
        transform: rotate(45deg);
        transition: transform 0.2s;
    }

    .preview-download-group .btn-download-toggle[aria-expanded="true"]::after {
        transform: rotate(-135deg);
        margin-bottom: -3px;
    }

    .preview-download-dropdown {
        position: absolute;
        top: calc(100% + 4px);
        right: 0;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        min-width: 160px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.2s ease;
        z-index: 1000;
        overflow: hidden;
    }

    .preview-download-dropdown.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .preview-download-dropdown a {
        display: block;
        padding: 10px 16px;
        color: #2B3674;
        text-decoration: none;
        font-size: 0.85rem;
        transition: background 0.2s;
    }

    .preview-download-dropdown a:hover {
        background: #f7f9fc;
    }

    .preview-download-dropdown a i {
        margin-right: 8px;
        width: 16px;
        text-align: center;
    }

    .preview-zoom-level {
        font-size: 0.85rem;
        color: #6c757d;
        font-weight: 500;
        min-width: 45px;
        text-align: center;
    }

    .preview-body {
        flex: 1;
        overflow: auto;
        display: flex;
        align-items: flex-start;
        justify-content: center;
        background: #f8f9fa;
        padding: 20px;
    }

    .preview-body img {
        max-width: none;
        max-height: none;
        width: auto;
        height: auto;
        object-fit: contain;
        transition: width 0.2s, height 0.2s;
        margin: auto;
    }

    .preview-body canvas {
        display: block;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    /* Loading overlay */
    .loading-spinner-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1300;
    }

    .loading-content {
        text-align: center;
        color: white;
    }

    .spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top: 4px solid white;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>
{% endblock %}

{% block dashboard_content %}

<!-- Announcement Notifications Container -->
<div id="announcement-notifications" aria-live="polite" aria-atomic="true"
    style="position: fixed; bottom: 20px; right: 20px; z-index: 9999;"></div>

<script>
    // Embed data from Django view into JavaScript variables
    const cooperativesData = {{ cooperatives_json|safe }};
    const officersByCoopData = {{ officers_by_coop_json|safe }};
    const currentUserRole = '{{ request.session.role }}';
    const currentUserId = {% if request.session.user_id %}{{ request.session.user_id }}{% else %}null{% endif %};
    
    // Debug: Log data to verify it's loaded correctly
    console.log('Cooperatives Data:', cooperativesData);
    console.log('Officers by Coop Data:', officersByCoopData);
    console.log('User Role:', currentUserRole);
    console.log('User ID:', currentUserId);
</script>

<div class="announcement-layout">

    <div class="announcement-sidebar">
        <div class="p-3" style="padding-top: 8px !important;">
            <h2 class="h5 fw-bold mb-4 px-2" style="color:#000;">Announcements</h2>

            <button id="create-new-btn"
                class="btn btn-danger w-100 mb-4 d-flex align-items-center justify-content-center gap-2 shadow-sm">
                <i class="bi bi-plus-lg"></i> <span>Create New</span>
            </button>

            <ul class="nav nav-pills flex-column sidebar-nav" id="announcement-nav">
                <li class="nav-item">
                    <a class="nav-link active" href="#" data-bs-toggle="pill" data-bs-target="#sent-view">
                        <div class="d-flex align-items-center gap-3">
                            <i class="bi bi-send"></i> <span>Sent</span>
                        </div>
                        <span class="badge">{{ sent_announcements|length }}</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-bs-toggle="pill" data-bs-target="#draft-view">
                        <div class="d-flex align-items-center gap-3">
                            <i class="bi bi-file-earmark"></i> <span>Drafts</span>
                        </div>
                        <span class="badge">{{ draft_announcements|length }}</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-bs-toggle="pill" data-bs-target="#scheduled-view">
                        <div class="d-flex align-items-center gap-3">
                            <i class="bi bi-clock"></i> <span>Scheduled</span>
                        </div>
                        <span class="badge">{{ scheduled_announcements|length }}</span>
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <div class="announcement-content">

        <div id="list-view-container" class="d-flex flex-column h-100">
            <div class="content-header" style="position: relative;">
                <div style="display:flex; width:100%; align-items:center; justify-content:space-between; gap:12px;">
                    <div class="search-wrapper">
                        <i class="bi bi-search"></i>
                        <input type="text" id="search-input" placeholder="Search announcements...">
                    </div>

                    <!-- Filter toggle + active-filters badge (top-right) -->
                    <div style="display:flex; align-items:center; gap:8px;">
                        <button id="delete-mode-btn" class="btn btn-danger" title="Delete announcements">
                            <i class="bi bi-trash"></i>
                        </button>
                        <button id="done-delete-btn" class="btn btn-success d-none" title="Done deleting">
                            Done
                        </button>
                        <button id="filterToggleTop" class="filter-toggle-btn btn btn-sm btn-outline-secondary"
                            title="Filters" aria-expanded="false">
                            <i class="bi bi-funnel"></i>
                        </button>
                        <span id="active-filters-badge" class="badge bg-danger d-none"
                            style="font-weight:600; font-size:0.85rem;"></span>
                    </div>
                </div>

                <!-- Filter panel (hidden by default) -->
                <div id="filter-panel" class="d-none"
                    style="position:absolute; right:16px; top:70px; width:320px; background:#fff; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,0.12); padding:12px; z-index:1100;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong>Filters</strong>
                        <button id="closeFilterPanel" class="btn-close" aria-label="Close"></button>
                    </div>

                    <div class="mb-2">
                        <label class="form-label small mb-1">Type</label>
                        <div class="form-check">
                            <input class="form-check-input filter-type" type="checkbox" value="sms" id="filterTypeSms">
                            <label class="form-check-label small" for="filterTypeSms">SMS</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input filter-type" type="checkbox" value="e-mail"
                                id="filterTypeEmail">
                            <label class="form-check-label small" for="filterTypeEmail">Email</label>
                        </div>
                    </div>

                    <div class="mb-2">
                        <label class="form-label small mb-1">Date From</label>
                        <input type="date" id="filter-date-from" class="form-control form-control-sm">
                    </div>

                    <div class="mb-2">
                        <label class="form-label small mb-1">Date To</label>
                        <input type="date" id="filter-date-to" class="form-control form-control-sm">
                    </div>

                    <div class="d-flex justify-content-between mt-2">
                        <button id="clear-filters-btn" class="btn btn-sm btn-outline-secondary">Clear</button>
                        <button id="apply-filters-btn" class="btn btn-sm btn-danger">Apply</button>
                    </div>
                </div>
            </div>

            <div class="tab-content list-scroll-area">

                <div class="tab-pane fade show active" id="sent-view">
                    <div class="list-group list-group-flush">
                        {% for item in sent_announcements %}
                        <a href="#" class="list-group-item list-group-item-action py-3 announcement-item"
                            data-modal-id="view-sent-modal" data-announcement-id="{{ item.announcement_id }}"
                            data-id="{{ item.announcement_id }}" data-title="{{ item.title }}"
                            data-content="{{ item.description }}" data-type="{{ item.type }}"
                            data-date="{{ item.sent_at|date:'Y-m-d' }}"
                            data-coops="{{ item.recipients_info.coop_names|join:', ' }}"
                            data-officers="{{ item.recipients_info.officer_names|join:', ' }}"
                            onclick="event.target.closest('.announcement-checkbox') ? event.stopPropagation() : true;">
                            <div class="d-flex w-100 align-items-start">
                                <input type="checkbox" class="announcement-checkbox d-none me-3"
                                    style="margin-top:8px; cursor:pointer;"
                                    data-announcement-id="{{ item.announcement_id }}"
                                    onclick="event.stopPropagation();">
                                <div class="flex-grow-1">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h5 class="mb-1">{{ item.title }}</h5>
                                        <small class="text-muted">{{ item.sent_at|date:"M d, Y" }}</small>
                                    </div>
                                    <p class="mb-1 text-truncate">{{ item.description }}</p>
                                    <small>
                                        {% if item.type == 'sms' %}
                                        <span class="badge-type badge-sms"><i class="bi bi-phone me-1"></i>SMS</span>
                                        {% elif item.type == 'e-mail' or item.type == 'email' %}
                                        <span class="badge-type badge-email"><i
                                                class="bi bi-envelope me-1"></i>Email</span>
                                        {% endif %}
                                        {% if item.has_attachment %}
                                        <span class="badge-type badge-attachment ms-1"
                                            title="{{ item.attachment_count }} attachment{{ item.attachment_count|pluralize }}"><i
                                                class="bi bi-paperclip me-1"></i>{{ item.attachment_count }}</span>
                                        {% endif %}
                                    </small>
                                </div>
                            </div>
                            {% empty %}
                            <div class="p-4 text-center text-muted">
                                <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                <p>No sent announcements found.</p>
                            </div>
                            {% endfor %}
                    </div>
                </div>

                <div class="tab-pane fade" id="draft-view">
                    <div class="list-group list-group-flush">
                        {% for item in draft_announcements %}
                        <a href="#" class="list-group-item list-group-item-action py-3 open-draft-btn announcement-item"
                            data-id="{{ item.announcement_id }}" data-title="{{ item.title }}"
                            data-content="{{ item.description }}" data-type="{{ item.type }}"
                            data-date="{{ item.updated_at|date:'Y-m-d' }}"
                            data-coops="{{ item.recipients_info.coop_names|join:', ' }}"
                            data-officers="{{ item.recipients_info.officer_names|join:', ' }}"
                            onclick="event.target.closest('.announcement-checkbox') ? event.stopPropagation() : true;">
                            <div class="d-flex w-100 align-items-start">
                                <input type="checkbox" class="announcement-checkbox d-none me-3"
                                    style="margin-top:8px; cursor:pointer;"
                                    data-announcement-id="{{ item.announcement_id }}"
                                    onclick="event.stopPropagation();">
                                <div class="flex-grow-1">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h5 class="mb-1">{{ item.title }}</h5>
                                        <small class="text-muted">{{ item.updated_at|date:"M d, Y" }}</small>
                                    </div>
                                    <p class="mb-1 text-truncate">{{ item.description|default:"No content yet..." }}</p>
                                    <small>
                                        {% if item.type == 'sms' %}
                                        <span class="badge-type badge-sms"><i class="bi bi-phone me-1"></i>SMS</span>
                                        {% elif item.type == 'e-mail' or item.type == 'email' %}
                                        <span class="badge-type badge-email"><i
                                                class="bi bi-envelope me-1"></i>Email</span>
                                        {% else %}
                                        <span class="badge-type" style="background-color: #6c757d; color: white;">No
                                            Type</span>
                                        {% endif %}
                                        {% if item.has_attachment %}
                                        <span class="badge-type badge-attachment ms-1"
                                            title="{{ item.attachment_count }} attachment{{ item.attachment_count|pluralize }}"><i
                                                class="bi bi-paperclip me-1"></i>{{ item.attachment_count }}</span>
                                        {% endif %}
                                    </small>
                                </div>
                            </div>
                        </a>
                        {% empty %}
                        <div class="p-4 text-center text-muted">
                            <i class="bi bi-pencil-square fs-1 d-block mb-2"></i>
                            <p>No drafts found.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="tab-pane fade" id="scheduled-view">
                    <div class="list-group list-group-flush">
                        {% for item in scheduled_announcements %}
                        <a href="#" class="list-group-item list-group-item-action py-3 announcement-item"
                            data-modal-id="view-scheduled-modal" data-announcement-id="{{ item.announcement_id }}"
                            data-id="{{ item.announcement_id }}" data-title="{{ item.title }}"
                            data-content="{{ item.description }}" data-type="{{ item.type }}"
                            data-date="{{ item.sent_at|date:'Y-m-d' }}"
                            data-coops="{{ item.recipients_info.coop_names|join:', ' }}"
                            data-officers="{{ item.recipients_info.officer_names|join:', ' }}"
                            onclick="event.target.closest('.announcement-checkbox') ? event.stopPropagation() : true;">
                            <div class="d-flex w-100 align-items-start">
                                <input type="checkbox" class="announcement-checkbox d-none me-3"
                                    style="margin-top:8px; cursor:pointer;"
                                    data-announcement-id="{{ item.announcement_id }}"
                                    onclick="event.stopPropagation();">
                                <div class="flex-grow-1">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h5 class="mb-1">{{ item.title }}</h5>
                                        <small class="text-danger">
                                            Sends: {{ item.sent_at|date:"M d, Y @ g:i A" }}
                                        </small>
                                    </div>
                                    <p class="mb-1 text-truncate">{{ item.description }}</p>
                                    <small>
                                        {% if item.type == 'sms' %}
                                        <span class="badge-type badge-sms"><i class="bi bi-phone me-1"></i>SMS</span>
                                        {% elif item.type == 'e-mail' or item.type == 'email' %}
                                        <span class="badge-type badge-email"><i
                                                class="bi bi-envelope me-1"></i>Email</span>
                                        {% endif %}
                                        {% if item.has_attachment %}
                                        <span class="badge-type badge-attachment ms-1"
                                            title="{{ item.attachment_count }} attachment{{ item.attachment_count|pluralize }}"><i
                                                class="bi bi-paperclip me-1"></i>{{ item.attachment_count }}</span>
                                        {% endif %}
                                    </small>
                                </div>
                            </div>
                        </a>
                        {% empty %}
                        <div class="p-4 text-center text-muted">
                            <i class="bi bi-clock-history fs-1 d-block mb-2"></i>
                            <p>No scheduled announcements.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div id="create-view-container" class="d-none flex-column h-100">
            <div class="content-header">
                <h2 class="h4 m-0">New Announcement</h2>
                <button id="cancel-create-btn" class="btn btn-outline-secondary">
                    <i class="bi bi-x-lg"></i> Cancel
                </button>
            </div>

            <div class="list-scroll-area p-4">
                <form id="main-announcement-form">
                    <div class="mb-3">
                        <label for="announcement-type" class="form-label fw-bold">Select type of announcement</label>
                        <select class="form-select" id="announcement-type">
                            <option value="" selected>Choose...</option>
                            <option value="sms">SMS</option>
                            <option value="e-mail">Email</option>
                        </select>
                    </div>

                    <div id="dynamic-form-fields" class="d-none">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Recipients</label>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted">Add recipients to this announcement.</span>
                                <button class="btn btn-sm btn-outline-danger" type="button" id="add-recipient-btn">
                                    <i class="bi bi-plus-circle me-1"></i> Add Recipient
                                </button>
                            </div>

                            <div id="recipient-rows-container" class="d-flex flex-column gap-2">
                                <div class="recipient-row d-flex align-items-center gap-2">
                                    <div class="row g-2 flex-grow-1">
                                        <div class="col-md-6">
                                            <select class="form-select coop-select" name="cooperative_name[]">
                                                <option value="" selected>Choose Cooperative...</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <select class="officer-select" name="cooperative_officers[]" multiple
                                                disabled>
                                                <option value="">-- Select Cooperative First --</option>
                                            </select>
                                        </div>
                                    </div>
                                    <button type="button"
                                        class="btn btn-sm btn-outline-danger remove-recipient-btn d-none">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="announcement-title" class="form-label fw-bold">Announcement Title</label>
                            <input type="text" class="form-control" id="announcement-title" placeholder="Enter title">
                        </div>

                        <div class="mb-3">
                            <label for="announcement-content" class="form-label fw-bold">Announcement Content</label>
                            <textarea class="form-control" id="announcement-content" rows="8"
                                placeholder="Type your message..."></textarea>
                        </div>

                        <div id="email-fields" class="d-none">
                            <div class="mb-3">
                                <label for="formFile" class="form-label fw-bold">Attachment/s</label>
                                <input class="form-control" type="file" id="formFile" multiple
                                    accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png,.gif">
                                <div class="form-text">
                                    <i class="bi bi-info-circle"></i> Maximum total size: 4MB for all files combined
                                    (Brevo API limit).
                                    Allowed: PDF, DOC, DOCX, XLS, XLSX, PPT, PPTX, Images
                                </div>
                                <div id="attachment-preview" class="mt-2"></div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="mt-auto p-3 border-top">
                <div class="d-flex justify-content-end align-items-center gap-2">
                    <button type="button" class="btn btn-secondary" id="save-draft-btn">Save Draft</button>
                    <button type="button" class="btn btn-primary d-none" id="save-changes-btn"
                        style="background-color: #0d6efd; border-color: #0d6efd;">Save Changes</button>

                    <div class="btn-group" id="send-button-group">
                        <button type="button" class="btn btn-danger" id="send-btn-main"
                            style="background-color: #b71c1c;">
                            Send
                        </button>
                        <button type="button"
                            class="btn btn-danger dropdown-toggle dropdown-toggle-split btn-split-dropdown"
                            data-bs-toggle="dropdown" aria-expanded="false" style="background-color: #b71c1c;">
                            <span class="visually-hidden">Toggle Dropdown</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" id="schedule-send-link">
                                    <i class="bi bi-clock me-2"></i>Schedule Send
                                </a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <template id="recipient-row-template">
                <div class="recipient-row d-flex align-items-center gap-2">
                    <div class="row g-2 flex-grow-1">
                        <div class="col-md-6">
                            <select class="form-select coop-select" name="cooperative_name[]">
                                <option value="" selected>Choose Cooperative...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <select class="officer-select" name="cooperative_officers[]" multiple disabled>
                                <option value="">-- Select Cooperative First --</option>
                            </select>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger remove-recipient-btn">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </template>

        </div>
    </div>
</div>
</div>


<div class="modal fade" id="view-sent-modal" tabindex="-1" aria-labelledby="view-sent-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-lg" style="max-width: 900px;">
        <div class="modal-content"
            style="height: 600px; display: flex; flex-direction: column; background-color: #ffffff;">
            <div class="modal-header"
                style="background-color: #f8f9fa; border-bottom: 1px solid #dee2e6; padding: 20px 24px; flex-shrink: 0;">
                <div class="w-100">
                    <h4 class="modal-title fw-bold mb-2" id="view-sent-modal-title"
                        style="color: #202124; font-size: 22px;"></h4>
                    <div id="view-sent-modal-meta" style="color: #5f6368; font-size: 13px;"></div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 24px; background-color: #ffffff;">
                <div id="view-sent-modal-content">
                    <p style="color: #5f6368;">Loading...</p>
                </div>
            </div>
            <div class="modal-footer"
                style="background-color: #f8f9fa; border-top: 1px solid #dee2e6; padding: 16px 24px; flex-shrink: 0;">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="view-scheduled-modal" tabindex="-1" aria-labelledby="view-scheduled-modal-label"
    aria-hidden="true">
    <div class="modal-dialog modal-lg" style="max-width: 900px;">
        <div class="modal-content"
            style="height: 600px; display: flex; flex-direction: column; background-color: #ffffff;">
            <div class="modal-header"
                style="background-color: #fff3cd; border-bottom: 1px solid #ffc107; padding: 20px 24px; flex-shrink: 0;">
                <div class="w-100">
                    <h4 class="modal-title fw-bold mb-2" id="view-scheduled-modal-title"
                        style="color: #202124; font-size: 22px;"></h4>
                    <div id="view-scheduled-modal-meta" style="color: #856404; font-size: 13px; font-weight: 500;">
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 24px; background-color: #ffffff;">
                <div id="view-scheduled-modal-content">
                    <p style="color: #5f6368;">Loading...</p>
                </div>
            </div>
            <div class="modal-footer"
                style="background-color: #f8f9fa; border-top: 1px solid #dee2e6; padding: 16px 24px; flex-shrink: 0;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" id="edit-scheduled-btn" style="display: none;">
                    <i class="bi bi-pencil"></i> Edit
                </button>
                <button type="button" class="btn btn-danger" id="cancel-scheduled-btn" style="display: none;">
                    <i class="bi bi-x-circle"></i> Cancel Schedule
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="schedule-send-modal" tabindex="-1" aria-labelledby="schedule-send-modal-label"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="schedule-send-modal-label">Schedule Send</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Choose a date and time to send this announcement.</p>
                <div class="mb-2">
                    <label for="schedule-date" class="form-label">Date</label>
                    <input type="date" class="form-control" id="schedule-date">
                </div>
                <div>
                    <label for="schedule-time" class="form-label">Time</label>
                    <input type="time" class="form-control" id="schedule-time">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary">Save Schedule</button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay for PDF Conversion -->
<div id="loading-overlay" class="loading-spinner-overlay" style="display:none;">
    <div class="loading-content">
        <div class="spinner"></div>
        <p id="loading-text">Converting document to PDF...</p>
    </div>
</div>

<!-- Advanced Preview Modal (from message.html) -->
<div id="preview-modal" class="preview-overlay" style="display:none;">
    <div class="preview-content" role="dialog" aria-modal="true">
        <div class="preview-header">
            <div style="display:flex; align-items:center; gap:10px; flex:1;">
                <button id="toggleSidebar" title="Toggle thumbnails" style="border:none;"><i
                        class="bi bi-layout-sidebar" style="font-size:1.25rem;"></i></button>
                <div class="preview-title" id="preview-title">Preview</div>
            </div>
            <div class="preview-controls">
                <button id="rotateLeft" title="Rotate left"><i class="bi bi-arrow-counterclockwise"></i></button>
                <button id="rotateRight" title="Rotate right"><i class="bi bi-arrow-clockwise"></i></button>
                <button id="fitWidth" title="Fit to width"><i class="bi bi-arrows-expand"></i></button>
                <button id="fitHeight" title="Fit to height"><i class="bi bi-arrows-expand-vertical"></i></button>
                <button id="zoomOut">−</button>
                <span class="preview-zoom-level" id="zoomLevel">100%</span>
                <button id="zoomIn">+</button>
                <div id="page-controls" style="display:none; gap:8px; align-items:center;">
                    <button id="prevPage" style="background:#666;">‹</button>
                    <input type="number" id="pageInput" min="1"
                        style="width:50px; padding:4px 6px; border:1px solid #ccc; border-radius:4px; text-align:center; font-size:0.85rem;" />
                    <span class="preview-zoom-level" style="min-width:auto;">of <span id="totalPages">1</span></span>
                    <button id="nextPage" style="background:#666;">›</button>
                </div>

                <div class="preview-download-group">
                    <a id="preview-download-main" class="btn-download-main" href="#" download>Download</a>
                    <button id="preview-download-toggle" class="btn-download-toggle" type="button"
                        aria-expanded="false"></button>
                    <div id="preview-download-dropdown" class="preview-download-dropdown">
                        <a id="preview-download-original" href="#" download>
                            <i class="bi bi-file-earmark"></i>Original File
                        </a>
                        <a id="preview-download-pdf" href="#" download style="display:none;">
                            <i class="bi bi-file-earmark-pdf"></i>As PDF
                        </a>
                    </div>
                </div>

                <button id="preview-close" style="background:#666;">✕</button>
            </div>
        </div>
        <div class="preview-main-container">
            <div class="preview-sidebar" id="preview-sidebar" style="display:none;">
                <div class="preview-sidebar-header">Pages</div>
                <div class="preview-thumbnails" id="preview-thumbnails">
                    <!-- Thumbnails will be generated here -->
                </div>
            </div>
            <div class="preview-content-wrapper">
                <div class="preview-body" id="preview-body">
                    <!-- content injected dynamically: <img> or <canvas> for PDF -->
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirm-cancel-modal" tabindex="-1" aria-labelledby="confirm-cancel-modal-label"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirm-cancel-modal-label">Unsaved Changes</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to cancel announcement creation?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">No, Stay</button>
                <button type="button" class="btn btn-danger" id="confirm-cancel-btn">Yes, Cancel</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirm-cancel-schedule-modal" tabindex="-1" aria-labelledby="confirm-cancel-schedule-label"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirm-cancel-schedule-label" style="color: #b71c1c; font-weight: 700;">
                    Cancel Scheduled Announcement</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="color: #333; font-size: 1rem;">
                Are you sure you want to cancel this scheduled announcement? It will be reverted to a draft.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No, Keep Schedule</button>
                <button type="button" class="btn btn-danger" id="confirm-cancel-schedule-btn"
                    style="background-color: #b71c1c; border-color: #b71c1c;">Yes, Cancel Schedule</button>
            </div>
        </div>
    </div>
</div>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0rPoDGiZ5JvBDDGa6hXoVl7kwkxa6UYTRzC8iYhFdaYh0lH4PfPmUAmkG"
    crossorigin="anonymous"></script>

<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

<!-- PDF.js Library for Advanced Preview -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<!-- {% comment %} // Replace the ENTIRE <script> section at the bottom of announcement_form.html
// Everything from <script> to </script> {% endcomment %} -->

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Prevent annoying beforeunload warning after successful save/send/schedule
        window.onbeforeunload = function (e) {
            if (window.isNavigating) return;
            const title = document.getElementById('announcement-title')?.value;
            const content = document.getElementById('announcement-content')?.value;
            const recipientRows = document.querySelectorAll('.recipient-row');
            if ((title && title.trim()) || (content && content.trim()) || recipientRows.length > 0) {
                e.preventDefault();
                e.returnValue = '';
            }
        };

        // --- Global Variables ---
        let currentDraftId = null;  // Track if editing a draft
        let currentScheduledTime = null;  // Track scheduled time when editing scheduled announcements
        let isEditingScheduled = false;  // Track if we're editing a scheduled announcement

        // --- Get Elements ---
        const listView = document.getElementById('list-view-container');
        const createView = document.getElementById('create-view-container');
        const createBtn = document.getElementById('create-new-btn');
        const cancelBtn = document.getElementById('cancel-create-btn');
        const draftButtons = document.querySelectorAll('.open-draft-btn');
        const announcementType = document.getElementById('announcement-type');
        const dynamicFields = document.getElementById('dynamic-form-fields');
        const emailFields = document.getElementById('email-fields');
        const sendBtnMain = document.getElementById('send-btn-main');
        const addRecipientBtn = document.getElementById('add-recipient-btn');
        const recipientRowsContainer = document.getElementById('recipient-rows-container');
        const recipientRowTemplate = document.getElementById('recipient-row-template');
        const saveDraftBtn = document.getElementById('save-draft-btn');
        const saveChangesBtn = document.getElementById('save-changes-btn');
        const mainForm = document.getElementById('main-announcement-form');
        const fileInput = document.getElementById('formFile');
        const attachmentPreview = document.getElementById('attachment-preview');

        // File size limit (4MB - Brevo API limit)
        const MAX_FILE_SIZE = 4 * 1024 * 1024;

        // --- Modal Logic ---
        const viewSentModal = new bootstrap.Modal(document.getElementById('view-sent-modal'));
        const viewScheduledModal = new bootstrap.Modal(document.getElementById('view-scheduled-modal'));
        const scheduleSendModal = new bootstrap.Modal(document.getElementById('schedule-send-modal'));
        const confirmCancelModal = new bootstrap.Modal(document.getElementById('confirm-cancel-modal'));

        // Delete mode state
        let deleteMode = false;
        const deleteModeBtn = document.getElementById('delete-mode-btn');
        const doneModeBtn = document.getElementById('done-delete-btn');

        // Toggle delete mode
        deleteModeBtn.addEventListener('click', function () {
            deleteMode = !deleteMode;
            const checkboxes = document.querySelectorAll('.announcement-checkbox');
            checkboxes.forEach(cb => {
                cb.classList.toggle('d-none');
                cb.checked = false;
            });
            deleteModeBtn.classList.toggle('active');
            doneModeBtn.classList.toggle('d-none');
        });

        // Done button: delete all checked announcements
        doneModeBtn.addEventListener('click', async function () {
            const checkedBoxes = document.querySelectorAll('.announcement-checkbox:checked');
            if (checkedBoxes.length === 0) {
                showNotification('Please select at least one announcement to delete', 'warning');
                return;
            }

            const announcementIds = Array.from(checkedBoxes).map(cb => cb.dataset.announcementId);

            if (!confirm(`Delete ${announcementIds.length} announcement(s)? This cannot be undone.`)) return;

            let successCount = 0;
            let failureCount = 0;

            for (const id of announcementIds) {
                try {
                    const resp = await fetch(`/communications/api/announcement/${id}/delete/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken()
                        }
                    });
                    const result = await resp.json();
                    if (result.status === 'success') {
                        successCount++;
                    } else {
                        console.error(`Failed to delete announcement ${id}:`, result.message);
                        failureCount++;
                    }
                } catch (err) {
                    console.error(`Error deleting announcement ${id}:`, err);
                    failureCount++;
                }
            }

            if (successCount > 0) {
                showNotification(`Deleted ${successCount} announcement(s)`, 'success');
            }
            if (failureCount > 0) {
                showNotification(`Failed to delete ${failureCount} announcement(s)`, 'error');
            }

            // Exit delete mode and reload
            deleteMode = false;
            const checkboxes = document.querySelectorAll('.announcement-checkbox');
            checkboxes.forEach(cb => {
                cb.classList.add('d-none');
                cb.checked = false;
            });
            deleteModeBtn.classList.remove('active');
            doneModeBtn.classList.add('d-none');

            setTimeout(() => location.reload(), 1000);
        });


        // Notification function
        function showNotification(message, type = 'info') {
            const container = document.getElementById('announcement-notifications');
            const notification = document.createElement('div');
            notification.className = `dj-message dj-${type}`;

            notification.innerHTML = `
            <div class="dj-message-left">
                <div class="dj-message-icon" aria-hidden="true">!</div>
            </div>
            <div class="dj-message-body">
                <div class="dj-message-text">${message}</div>
            </div>
            <button class="dj-message-close" aria-label="Close message">×</button>
        `;

            container.appendChild(notification);

            // Close button handler
            const closeBtn = notification.querySelector('.dj-message-close');
            closeBtn.addEventListener('click', () => dismissNotification(notification));

            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    dismissNotification(notification);
                }
            }, 5000);
        }

        function dismissNotification(el) {
            el.style.opacity = '0';
            el.style.transform = 'translateX(18px)';
            setTimeout(() => {
                if (el.parentNode) el.parentNode.removeChild(el);
            }, 260);
        }

        // Function to format date/time
        function formatDateTime(isoString) {
            if (!isoString) return 'N/A';
            const date = new Date(isoString);
            const options = {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            return date.toLocaleDateString('en-US', options);
        }

        // Function to format file size
        function formatFileSize(bytes) {
            if (!bytes) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Function to validate file size
        function validateFileSize(file) {
            if (file.size > MAX_FILE_SIZE) {
                showNotification(`File "${file.name}" exceeds the 4MB limit (${formatFileSize(file.size)})`, 'error');
                return false;
            }
            return true;
        }

        // Function to validate total file size
        function validateTotalFileSize(files) {
            let totalSize = 0;
            Array.from(files).forEach(file => {
                totalSize += file.size;
            });

            if (totalSize > MAX_FILE_SIZE) {
                showNotification(
                    `Total file size exceeds 4MB limit. Current total: ${formatFileSize(totalSize)}. Please remove some files.`,
                    'error'
                );
                return false;
            }
            return true;
        }

        // Function to get file icon based on type
        function getFileIcon(fileName) {
            const ext = fileName.split('.').pop().toLowerCase();
            const icons = {
                'pdf': 'bi-file-earmark-pdf text-danger',
                'doc': 'bi-file-earmark-word text-primary',
                'docx': 'bi-file-earmark-word text-primary',
                'xls': 'bi-file-earmark-excel text-success',
                'xlsx': 'bi-file-earmark-excel text-success',
                'xlsm': 'bi-file-earmark-excel text-success',
                'xlsb': 'bi-file-earmark-excel text-success',
                'csv': 'bi-file-earmark-spreadsheet text-success',
                'ppt': 'bi-file-earmark-ppt text-warning',
                'pptx': 'bi-file-earmark-ppt text-warning',
                'jpg': 'bi-file-earmark-image text-info',
                'jpeg': 'bi-file-earmark-image text-info',
                'png': 'bi-file-earmark-image text-info',
                'gif': 'bi-file-earmark-image text-info',
                'txt': 'bi-file-earmark-text text-muted'
            };
            // Special handling for .csv.gz and .pdf.gz files
            if (ext === 'gz') {
                if (fileName.toLowerCase().endsWith('.csv.gz')) {
                    return 'bi-file-earmark-spreadsheet text-success';
                } else if (fileName.toLowerCase().endsWith('.pdf.gz')) {
                    return 'bi-file-earmark-pdf text-danger';
                }
            }
            return icons[ext] || 'bi-file-earmark text-secondary';
        }

        // Function to render attachment preview
        function renderAttachmentPreview(files) {
            if (!files || files.length === 0) {
                attachmentPreview.innerHTML = '';
                return;
            }

            let totalSize = 0;
            Array.from(files).forEach(file => {
                totalSize += file.size;
            });

            const totalValid = totalSize <= MAX_FILE_SIZE;
            const totalClass = totalValid ? 'text-success' : 'text-danger';

            let html = `
            <div class="mt-2">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="small fw-bold text-muted">
                        <i class="bi bi-paperclip"></i> ${files.length} file${files.length > 1 ? 's' : ''} selected
                    </div>
                    <div class="small ${totalClass} fw-bold">
                        ${formatFileSize(totalSize)} / 4MB
                    </div>
                </div>
                <div class="d-flex flex-wrap gap-2" id="file-items-container">
        `;

            Array.from(files).forEach((file, index) => {
                html += `
                <div class="file-item" data-index="${index}" style="display: inline-flex; align-items: center; gap: 8px; padding: 6px 12px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; font-size: 14px;">
                    <i class="${getFileIcon(file.name)}" style="font-size: 16px;"></i>
                    <span class="text-truncate" style="max-width: 200px;" title="${file.name}">${file.name}</span>
                    <span class="text-muted small">(${formatFileSize(file.size)})</span>
                    <button type="button" class="btn-close-file" data-index="${index}" style="background: none; border: none; color: #6c757d; cursor: pointer; padding: 0; margin-left: 4px; font-size: 18px; line-height: 1;" title="Remove file">
                        ×
                    </button>
                </div>
            `;
            });

            html += '</div>';

            if (!totalValid) {
                html += `
                <div class="alert alert-danger p-2 mt-2 mb-0 small">
                    <i class="bi bi-exclamation-triangle"></i> Total size exceeds 4MB limit. Please remove some files.
                </div>
            `;
            }

            html += '</div>';
            attachmentPreview.innerHTML = html;

            // Add event listeners to remove buttons
            document.querySelectorAll('.btn-close-file').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.preventDefault();
                    const indexToRemove = parseInt(this.dataset.index);
                    removeFile(indexToRemove);
                });
            });
        }

        // Function to remove a specific file
        function removeFile(index) {
            if (!fileInput.files || fileInput.files.length === 0) return;

            // Create a new FileList without the removed file
            const dt = new DataTransfer();
            const files = Array.from(fileInput.files);

            files.forEach((file, i) => {
                if (i !== index) {
                    dt.items.add(file);
                }
            });

            fileInput.files = dt.files;

            // Re-render preview
            if (dt.files.length > 0) {
                renderAttachmentPreview(dt.files);
            } else {
                renderAttachmentPreview(null);
            }

            // Re-validate
            if (dt.files.length > 0) {
                validateTotalFileSize(dt.files);
            }
        }

        // Function to display existing attachments (read-only, from database)
        function displayExistingAttachments(data) {
            if (!data.attachment_filename) {
                attachmentPreview.innerHTML = '';
                return;
            }

            // Parse semicolon-separated filenames
            const filenames = data.attachment_filename.split(';').filter(f => f.trim());
            const totalSize = data.attachment_size || 0;

            let html = `
            <div class="mt-2">
                <div class="alert alert-info p-2 mb-2 small">
                    <i class="bi bi-info-circle"></i> Existing attachments (from saved draft). Upload new files to replace them.
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="small fw-bold text-muted">
                        <i class="bi bi-paperclip"></i> ${filenames.length} file${filenames.length > 1 ? 's' : ''} attached
                    </div>
                    <div class="small text-success fw-bold">
                        ${formatFileSize(totalSize)}
                    </div>
                </div>
                <div class="d-flex flex-wrap gap-2" id="file-items-container">
        `;

            filenames.forEach((filename, index) => {
                html += `
                <div class="file-item" style="display: inline-flex; align-items: center; gap: 8px; padding: 6px 12px; background: #e7f1ff; border: 1px solid #b3d7ff; border-radius: 4px; font-size: 14px;">
                    <i class="${getFileIcon(filename)}" style="font-size: 16px;"></i>
                    <span class="text-truncate" style="max-width: 200px;" title="${filename}">${filename}</span>
                </div>
            `;
            });

            html += `
                </div>
            </div>
        `;

            attachmentPreview.innerHTML = html;
        }

        // File input change handler
        if (fileInput) {
            fileInput.addEventListener('change', function (e) {
                const files = e.target.files;
                if (files.length === 0) {
                    renderAttachmentPreview(null);
                    return;
                }

                // Validate individual files
                let allValid = true;
                Array.from(files).forEach(file => {
                    if (!validateFileSize(file)) {
                        allValid = false;
                    }
                });

                // Validate total size
                const totalValid = validateTotalFileSize(files);

                // Render preview
                renderAttachmentPreview(files);

                // If individual files are invalid, clear all
                if (!allValid) {
                    setTimeout(() => {
                        fileInput.value = '';
                        renderAttachmentPreview(null);
                    }, 4000);
                }
            });
        }

        // Function to load and display announcement details
        async function loadAnnouncementDetails(announcementId, modalType) {
            try {
                const response = await fetch(`/communications/api/announcement/${announcementId}/`);

                // Log response for debugging
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                console.log('Response headers:', response.headers.get('content-type'));

                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Response is not JSON. Content type:', contentType);
                    console.error('Response text (first 500 chars):', text.substring(0, 500));
                    showNotification('Server returned an invalid response (not JSON)', 'error');
                    return;
                }

                const result = await response.json();
                console.log('Response data:', result);

                if (result.status === 'success') {
                    const data = result.data;

                    // Determine which modal to populate
                    const titleEl = document.getElementById(`view-${modalType}-modal-title`);
                    const metaEl = document.getElementById(`view-${modalType}-modal-meta`);
                    const contentEl = document.getElementById(`view-${modalType}-modal-content`);

                    // Set title
                    titleEl.textContent = data.title;

                    // Set metadata
                    const timestamp = modalType === 'sent' ? data.sent_at : data.created_at;
                    const timestampLabel = modalType === 'sent' ? 'Sent' : 'Scheduled';
                    metaEl.innerHTML = `
                    <span class="badge bg-${data.type === 'sms' ? 'primary' : 'info'} me-2">${data.type.toUpperCase()}</span>
                    ${timestampLabel}: ${formatDateTime(timestamp)} by ${data.sender_name}
                `;

                    // Build content HTML with Gmail-like styling
                    let contentHTML = `
                    <div class="mb-4" style="padding-bottom: 20px; border-bottom: 1px solid #e8eaed;">
                        <div style="color: #202124; font-size: 15px; line-height: 1.6; white-space: pre-wrap;">${data.description}</div>
                    </div>
                `;

                    // Add attachment info and preview if exists
                    if (data.has_attachment && data.attachment_filename) {
                        // Parse semicolon-separated filenames
                        const filenames = data.attachment_filename.split(';').map(f => f.trim()).filter(f => f);
                        const fileCount = filenames.length;

                        contentHTML += `
                        <div class="mb-4" style="padding: 16px; background-color: #f1f3f4; border-radius: 8px; border-left: 4px solid #1a73e8;">
                            <div style="color: #202124; font-size: 14px; margin-bottom: 12px; font-weight: 600;">
                                <i class="bi bi-paperclip me-2" style="color: #1a73e8;"></i>
                                ${fileCount} Attachment${fileCount > 1 ? 's' : ''} (${formatFileSize(data.attachment_size)})
                            </div>
                    `;

                        // Display each file with preview capability
                        filenames.forEach((filename, index) => {
                            const iconClass = getFileIcon(filename);
                            const fileExt = filename.split('.').pop().toLowerCase();
                            // Check for .csv.gz files (double extension)
                            const isCsvGz = filename.toLowerCase().endsWith('.csv.gz');
                            const isPdfGz = filename.toLowerCase().endsWith('.pdf.gz');
                            // All file types can be previewed now (images, PDFs, and convertible documents)
                            const canPreview = ['pdf', 'png', 'jpg', 'jpeg', 'gif', 'bmp', 'svg', 'webp',
                                'docx', 'doc', 'xlsx', 'xls', 'xlsm', 'xlsb', 'pptx', 'ppt',
                                'txt', 'csv'].includes(fileExt) || isCsvGz || isPdfGz;

                            contentHTML += `
                            <div class="d-flex align-items-center gap-3 p-2 bg-white rounded border mb-2">
                                <i class="${iconClass} fs-3"></i>
                                <div class="flex-grow-1">
                                    <div class="fw-semibold text-truncate" style="max-width: 400px;" title="${filename}">${filename}</div>
                                </div>
                                ${canPreview ? `
                                    <button class="btn btn-sm btn-outline-info preview-attachment-btn" 
                                            data-announcement-id="${announcementId}"
                                            data-filename="${filename}"
                                            title="Preview">
                                        <i class="bi bi-eye"></i> Preview
                                    </button>
                                ` : ''}
                                <a href="/communications/api/announcement/${announcementId}/attachment/" 
                                   class="btn btn-sm btn-outline-primary" 
                                   download="${filename}"
                                   title="Download">
                                    <i class="bi bi-download"></i>
                                </a>
                            </div>
                        `;
                        });

                        contentHTML += `
                        </div>
                    `;
                    }

                    // Add recipients info with Gmail-like styling
                    contentHTML += `
                    <div class="mb-3">
                        <div style="color: #5f6368; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 12px;">
                            Recipients
                        </div>
                `;

                    if (data.scope === 'cooperative' && data.coop_recipients.length > 0) {
                        contentHTML += '<div style="background-color: #f8f9fa; padding: 16px; border-radius: 8px;">';
                        data.coop_recipients.forEach(coop => {
                            contentHTML += `
                            <div style="padding: 8px 0; color: #202124; font-size: 14px;">
                                <i class="bi bi-building me-2" style="color: #1a73e8;"></i>
                                <strong>${coop.coop_name}</strong>
                                <span style="color: #5f6368; font-size: 13px; margin-left: 8px;">(All Officers)</span>
                            </div>
                        `;
                        });
                        contentHTML += '</div>';
                    } else if (data.scope === 'officer' && data.officer_recipients.length > 0) {
                        // Group by cooperative
                        const groupedByCoopMap = {};
                        data.officer_recipients.forEach(officer => {
                            if (!groupedByCoopMap[officer.coop_name]) {
                                groupedByCoopMap[officer.coop_name] = [];
                            }
                            groupedByCoopMap[officer.coop_name].push(officer.officer_name);
                        });

                        contentHTML += '<div style="background-color: #f8f9fa; padding: 16px; border-radius: 8px;">';
                        for (const [coopName, officers] of Object.entries(groupedByCoopMap)) {
                            contentHTML += `
                            <div style="margin-bottom: 16px;">
                                <div style="color: #202124; font-size: 14px; font-weight: 600; margin-bottom: 8px;">
                                    <i class="bi bi-building me-2" style="color: #1a73e8;"></i>${coopName}
                                </div>
                                <div style="margin-left: 28px;">
                        `;
                            officers.forEach(name => {
                                contentHTML += `
                                <div style="padding: 4px 0; color: #5f6368; font-size: 14px;">
                                    <i class="bi bi-person me-2"></i>${name}
                                </div>
                            `;
                            });
                            contentHTML += `</div></div>`;
                        }
                        contentHTML += '</div>';
                    } else {
                        contentHTML += '<p style="color: #5f6368; font-size: 14px; font-style: italic;">No recipients specified</p>';
                    }

                    contentHTML += '</div>';

                    contentEl.innerHTML = contentHTML;

                    // Add event listeners for preview buttons
                    document.querySelectorAll('.preview-attachment-btn').forEach(btn => {
                        btn.addEventListener('click', function (e) {
                            e.preventDefault();
                            const announcementId = this.dataset.announcementId;
                            const filename = this.dataset.filename;
                            previewAnnouncementAttachment(announcementId, filename);
                        });
                    });

                    // For scheduled announcements, handle edit/cancel buttons
                    if (modalType === 'scheduled') {
                        handleScheduledAnnouncementButtons(data);
                    }
                } else {
                    console.error('Failed to load announcement:', result);
                    showNotification(result.message || 'Failed to load announcement details', 'error');
                }
            } catch (error) {
                console.error('Error loading announcement:', error);
                console.error('Error stack:', error.stack);
                showNotification('An error occurred while loading announcement details: ' + error.message, 'error');
            }
        }

        // ========================================
        // ADVANCED PREVIEW & PDF LOGIC (from message.html)
        // ========================================
        const previewModal = document.getElementById('preview-modal');
        const previewBody = document.getElementById('preview-body');
        const previewCloseBtn = document.getElementById('preview-close');
        const previewSidebar = document.getElementById('preview-sidebar');
        const previewThumbnails = document.getElementById('preview-thumbnails');

        let currentZoom = 100;
        let pdfDoc = null;
        let currentPage = 1;
        let isPdfOpen = false;
        let totalPages = 0;
        let previewAnnouncementId = null;
        let isConvertibleDocument = false;
        let currentRotation = 0;  // Track rotation state (0, 90, 180, 270)
        let continuousScrollMode = true;  // Render all pages continuously
        let pageCache = new Map();  // Cache rendered pages

        const CONVERTIBLE_TYPES = [
            'application/vnd.openxmlformats-officedocument.wordprocessingml.document',  // .docx
            'application/msword',  // .doc
            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',  // .xlsx
            'application/vnd.ms-excel',  // .xls
            'application/vnd.ms-excel.sheet.macroEnabled.12',  // .xlsm
            'application/vnd.ms-excel.sheet.binary.macroEnabled.12',  // .xlsb
            'application/vnd.openxmlformats-officedocument.presentationml.presentation',  // .pptx
            'application/vnd.ms-powerpoint',  // .ppt
            'text/plain',  // .txt
            'text/csv',  // .csv
            'application/csv',  // .csv (alternative MIME)
            'text/x-csv',  // .csv (alternative MIME)
            'application/gzip',  // .gz (for .csv.gz files)
        ];

        // Helper function to escape HTML
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // Setup preview control buttons
        const downloadToggle = document.getElementById('preview-download-toggle');
        const downloadDropdown = document.getElementById('preview-download-dropdown');
        const zoomInBtn = document.getElementById('zoomIn');
        const zoomOutBtn = document.getElementById('zoomOut');
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');
        const pageInput = document.getElementById('pageInput');
        const toggleSidebarBtn = document.getElementById('toggleSidebar');
        const rotateLeftBtn = document.getElementById('rotateLeft');
        const rotateRightBtn = document.getElementById('rotateRight');
        const fitWidthBtn = document.getElementById('fitWidth');
        const fitHeightBtn = document.getElementById('fitHeight');

        if (downloadToggle && downloadDropdown) {
            downloadToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                const isExpanded = downloadToggle.getAttribute('aria-expanded') === 'true';
                downloadToggle.setAttribute('aria-expanded', !isExpanded);
                downloadDropdown.classList.toggle('show');
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.preview-download-group')) {
                    downloadToggle.setAttribute('aria-expanded', 'false');
                    downloadDropdown.classList.remove('show');
                }
            });

            downloadDropdown.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', () => {
                    downloadToggle.setAttribute('aria-expanded', 'false');
                    downloadDropdown.classList.remove('show');
                });
            });
        }

        if (zoomInBtn) {
            zoomInBtn.addEventListener('click', () => {
                currentZoom = Math.min(currentZoom + 10, 300);
                applyZoom();
            });
        }

        if (zoomOutBtn) {
            zoomOutBtn.addEventListener('click', () => {
                currentZoom = Math.max(currentZoom - 10, 10);
                applyZoom();
            });
        }

        if (toggleSidebarBtn) {
            toggleSidebarBtn.addEventListener('click', () => {
                const icon = toggleSidebarBtn.querySelector('i');
                if (previewSidebar.style.display === 'none') {
                    previewSidebar.style.display = 'flex';
                    icon.className = 'bi bi-layout-sidebar-inset';
                } else {
                    previewSidebar.style.display = 'none';
                    icon.className = 'bi bi-layout-sidebar';
                }
            });
        }

        if (rotateLeftBtn) {
            rotateLeftBtn.addEventListener('click', () => {
                currentRotation = (currentRotation - 90 + 360) % 360;
                applyZoom();
            });
        }

        if (rotateRightBtn) {
            rotateRightBtn.addEventListener('click', () => {
                currentRotation = (currentRotation + 90) % 360;
                applyZoom();
            });
        }

        if (fitWidthBtn) {
            fitWidthBtn.addEventListener('click', () => {
                fitToWidth();
            });
        }

        if (fitHeightBtn) {
            fitHeightBtn.addEventListener('click', () => {
                fitToHeight();
            });
        }

        if (prevPageBtn) {
            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderPdfPage(currentPage);
                    updatePageInput();
                    updateThumbnailActive();
                }
            });
        }

        if (nextPageBtn) {
            nextPageBtn.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderPdfPage(currentPage);
                    updatePageInput();
                    updateThumbnailActive();
                }
            });
        }

        if (pageInput) {
            pageInput.addEventListener('change', () => {
                let page = parseInt(pageInput.value);
                if (page >= 1 && page <= totalPages) {
                    currentPage = page;
                    renderPdfPage(currentPage);
                    updateThumbnailActive();
                } else {
                    pageInput.value = currentPage;
                }
            });
        }

        function updatePageInput() {
            if (pageInput) {
                pageInput.value = currentPage;
                pageInput.max = totalPages;
            }
            document.getElementById('totalPages').textContent = totalPages;
        }

        function applyZoom() {
            document.getElementById('zoomLevel').textContent = currentZoom + '%';
            const img = previewBody.querySelector('img');
            if (img) {
                applyRotation(img);
                const naturalWidth = img.naturalWidth;
                const naturalHeight = img.naturalHeight;

                if (currentZoom === 100) {
                    img.style.width = 'auto';
                    img.style.height = 'auto';
                    img.style.maxWidth = '100%';
                    img.style.maxHeight = '100%';
                    img.style.margin = 'auto';
                } else {
                    const containerWidth = previewBody.clientWidth - 40;
                    const containerHeight = previewBody.clientHeight - 40;
                    const scaleToFit = Math.min(
                        containerWidth / naturalWidth,
                        containerHeight / naturalHeight
                    );
                    const finalWidth = naturalWidth * scaleToFit * (currentZoom / 100);
                    const finalHeight = naturalHeight * scaleToFit * (currentZoom / 100);

                    img.style.width = finalWidth + 'px';
                    img.style.height = finalHeight + 'px';
                    img.style.maxWidth = 'none';
                    img.style.maxHeight = 'none';

                    if (finalWidth < previewBody.clientWidth && finalHeight < previewBody.clientHeight) {
                        img.style.margin = 'auto';
                    } else {
                        img.style.margin = '0';
                    }
                }
            }
            if (isPdfOpen && pdfDoc) {
                if (continuousScrollMode) {
                    renderAllPages();
                } else {
                    renderPdfPage(currentPage);
                }
            }
        }

        function applyRotation(element) {
            if (element) {
                element.style.transform = `rotate(${currentRotation}deg)`;
            }
        }

        async function fitToWidth() {
            const img = previewBody.querySelector('img');

            if (img) {
                const containerWidth = previewBody.clientWidth - 40;
                let elementWidth = img.naturalWidth;

                if (currentRotation === 90 || currentRotation === 270) {
                    elementWidth = img.naturalHeight;
                }

                const scaleToFit = containerWidth / elementWidth;
                currentZoom = Math.round(scaleToFit * 100);
                currentZoom = Math.max(10, Math.min(300, currentZoom));
                applyZoom();
            } else if (isPdfOpen && pdfDoc) {
                const page = await pdfDoc.getPage(1);
                const viewport = page.getViewport({ scale: 1, rotation: currentRotation });
                const containerWidth = previewBody.clientWidth - 40;

                const scaleToFit = containerWidth / viewport.width;
                currentZoom = Math.round(scaleToFit * 100);
                currentZoom = Math.max(10, Math.min(300, currentZoom));

                if (continuousScrollMode) {
                    renderAllPages();
                } else {
                    applyZoom();
                }
            }
        }

        async function fitToHeight() {
            const img = previewBody.querySelector('img');

            if (img) {
                const containerHeight = previewBody.clientHeight - 40;
                let elementHeight = img.naturalHeight;

                if (currentRotation === 90 || currentRotation === 270) {
                    elementHeight = img.naturalWidth;
                }

                const scaleToFit = containerHeight / elementHeight;
                currentZoom = Math.round(scaleToFit * 100);
                currentZoom = Math.max(10, Math.min(300, currentZoom));
                applyZoom();
            } else if (isPdfOpen && pdfDoc) {
                const page = await pdfDoc.getPage(1);
                const viewport = page.getViewport({ scale: 1, rotation: currentRotation });
                const containerHeight = previewBody.clientHeight - 40;

                const scaleToFit = containerHeight / viewport.height;
                currentZoom = Math.round(scaleToFit * 100);
                currentZoom = Math.max(10, Math.min(300, currentZoom));

                if (continuousScrollMode) {
                    renderAllPages();
                } else {
                    applyZoom();
                }
            }
        }

        async function renderPdfPage(pageNum) {
            if (continuousScrollMode) {
                scrollToPage(pageNum);
                return;
            }

            try {
                const page = await pdfDoc.getPage(pageNum);
                const finalScale = (currentZoom / 100);
                const viewport = page.getViewport({ scale: finalScale, rotation: currentRotation });

                let canvas = previewBody.querySelector('canvas');
                if (!canvas) {
                    canvas = document.createElement('canvas');
                    previewBody.innerHTML = '';
                    previewBody.appendChild(canvas);
                }

                canvas.width = viewport.width;
                canvas.height = viewport.height;
                canvas.style.display = 'block';
                canvas.style.maxWidth = 'none';
                canvas.style.maxHeight = 'none';

                const renderContext = {
                    canvasContext: canvas.getContext('2d'),
                    viewport: viewport
                };

                await page.render(renderContext).promise;
                previewBody.scrollTop = 0;
                previewBody.scrollLeft = 0;
                updatePageInput();
                updateThumbnailActive();
            } catch (e) {
                console.error('PDF render error:', e);
            }
        }

        async function renderAllPages() {
            if (!pdfDoc) return;

            const scrollRatio = previewBody.scrollHeight > 0
                ? previewBody.scrollTop / previewBody.scrollHeight
                : 0;

            previewBody.innerHTML = '';
            const finalScale = (currentZoom / 100);

            const pagesContainer = document.createElement('div');
            pagesContainer.style.width = '100%';
            pagesContainer.style.display = 'flex';
            pagesContainer.style.flexDirection = 'column';
            pagesContainer.style.alignItems = 'center';
            pagesContainer.style.gap = '10px';
            pagesContainer.style.padding = '20px 0';

            previewBody.appendChild(pagesContainer);

            for (let i = 1; i <= totalPages; i++) {
                const pageWrapper = document.createElement('div');
                pageWrapper.className = 'pdf-page-wrapper';
                pageWrapper.dataset.pageNum = i;
                pageWrapper.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
                pageWrapper.style.marginBottom = '10px';
                pageWrapper.style.background = '#fff';

                const canvas = document.createElement('canvas');
                canvas.style.display = 'block';
                pageWrapper.appendChild(canvas);
                pagesContainer.appendChild(pageWrapper);

                try {
                    const page = await pdfDoc.getPage(i);
                    const viewport = page.getViewport({ scale: finalScale, rotation: currentRotation });

                    canvas.width = viewport.width;
                    canvas.height = viewport.height;

                    const renderContext = {
                        canvasContext: canvas.getContext('2d'),
                        viewport: viewport
                    };

                    await page.render(renderContext).promise;
                } catch (e) {
                    console.error('Error rendering page', i, e);
                }
            }

            if (scrollRatio > 0) {
                setTimeout(() => {
                    previewBody.scrollTop = previewBody.scrollHeight * scrollRatio;
                }, 50);
            } else {
                previewBody.scrollTop = 0;
                previewBody.scrollLeft = 0;
            }

            if (!currentPage || currentPage < 1) {
                currentPage = 1;
            }
            updatePageInput();
            setupScrollTracking();
        }

        function scrollToPage(pageNum) {
            const pageWrapper = previewBody.querySelector(`[data-page-num="${pageNum}"]`);
            if (pageWrapper) {
                pageWrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function setupScrollTracking() {
            let scrollTimeout;
            previewBody.addEventListener('scroll', () => {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    const pageWrappers = previewBody.querySelectorAll('.pdf-page-wrapper');
                    const scrollTop = previewBody.scrollTop;
                    const containerTop = previewBody.getBoundingClientRect().top;

                    for (let i = 0; i < pageWrappers.length; i++) {
                        const wrapper = pageWrappers[i];
                        const rect = wrapper.getBoundingClientRect();
                        const wrapperTop = rect.top - containerTop + scrollTop;
                        const wrapperBottom = wrapperTop + rect.height;

                        if (wrapperTop <= scrollTop + 100 && wrapperBottom > scrollTop + 100) {
                            const newPage = parseInt(wrapper.dataset.pageNum);
                            if (newPage !== currentPage) {
                                currentPage = newPage;
                                updatePageInput();
                                updateThumbnailActive();
                            }
                            break;
                        }
                    }
                }, 100);
            });
        }

        async function generateThumbnails() {
            if (!pdfDoc) return;

            previewThumbnails.innerHTML = '';

            for (let i = 1; i <= totalPages; i++) {
                try {
                    const page = await pdfDoc.getPage(i);
                    const scale = 0.3;
                    const viewport = page.getViewport({ scale });

                    const canvas = document.createElement('canvas');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;

                    const renderContext = {
                        canvasContext: canvas.getContext('2d'),
                        viewport: viewport
                    };

                    await page.render(renderContext).promise;

                    const thumbDiv = document.createElement('div');
                    thumbDiv.className = 'preview-thumbnail';
                    thumbDiv.dataset.page = i;
                    if (i === currentPage) {
                        thumbDiv.classList.add('active');
                    }

                    thumbDiv.appendChild(canvas);

                    const label = document.createElement('div');
                    label.className = 'preview-thumbnail-label';
                    label.textContent = i;
                    thumbDiv.appendChild(label);

                    thumbDiv.addEventListener('click', () => {
                        currentPage = i;
                        renderPdfPage(currentPage);
                        updateThumbnailActive();
                    });

                    previewThumbnails.appendChild(thumbDiv);
                } catch (e) {
                    console.error('Thumbnail generation error for page', i, e);
                }
            }
        }

        function updateThumbnailActive() {
            const thumbnails = previewThumbnails.querySelectorAll('.preview-thumbnail');
            thumbnails.forEach(thumb => {
                const pageNum = parseInt(thumb.dataset.page);
                if (pageNum === currentPage) {
                    thumb.classList.add('active');
                    thumb.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                } else {
                    thumb.classList.remove('active');
                }
            });
        }

        function setupPdfNavigation() {
            document.removeEventListener('keydown', handlePdfKeyboard);
            previewBody.removeEventListener('wheel', handlePdfScroll);

            document.addEventListener('keydown', handlePdfKeyboard);
            previewBody.addEventListener('wheel', handlePdfScroll, { passive: false });
        }

        function handlePdfKeyboard(e) {
            if (!isPdfOpen || !pdfDoc || previewModal.style.display === 'none') return;

            if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                e.preventDefault();
                if (currentPage < totalPages) {
                    currentPage++;
                    renderPdfPage(currentPage);
                    updateThumbnailActive();
                }
            } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                e.preventDefault();
                if (currentPage > 1) {
                    currentPage--;
                    renderPdfPage(currentPage);
                    updateThumbnailActive();
                }
            }
        }

        function handlePdfScroll(e) {
            if (continuousScrollMode) return;
            if (!isPdfOpen || !pdfDoc || previewModal.style.display === 'none') return;

            const hasVerticalScroll = previewBody.scrollHeight > previewBody.clientHeight;
            const hasHorizontalScroll = previewBody.scrollWidth > previewBody.clientWidth;

            if (hasVerticalScroll || hasHorizontalScroll) {
                const atBottom = previewBody.scrollTop + previewBody.clientHeight >= previewBody.scrollHeight - 5;
                const atTop = previewBody.scrollTop <= 5;

                if (e.deltaY > 0 && atBottom && currentPage < totalPages) {
                    e.preventDefault();
                    currentPage++;
                    renderPdfPage(currentPage);
                } else if (e.deltaY < 0 && atTop && currentPage > 1) {
                    e.preventDefault();
                    currentPage--;
                    renderPdfPage(currentPage);
                }
            } else {
                e.preventDefault();
                if (e.deltaY > 0 && currentPage < totalPages) {
                    currentPage++;
                    renderPdfPage(currentPage);
                } else if (e.deltaY < 0 && currentPage > 1) {
                    currentPage--;
                    renderPdfPage(currentPage);
                }
            }
        }

        function openPreviewImage(src, title, announcementId) {
            currentZoom = 100;
            currentRotation = 0;
            isPdfOpen = false;
            isConvertibleDocument = false;

            previewSidebar.style.display = 'none';
            document.getElementById('toggleSidebar').style.display = 'none';
            document.getElementById('fitWidth').style.display = 'none';
            document.getElementById('fitHeight').style.display = 'none';

            previewBody.innerHTML = `
            <img src="${src}" 
                 alt="${escapeHtml(title)}" 
                 style="max-width:100%; max-height:100%; object-fit:contain; cursor: zoom-in;" 
                 id="preview-image" />`;

            document.getElementById('preview-title').textContent = title || 'Image';
            document.getElementById('zoomLevel').textContent = '100%';
            document.getElementById('page-controls').style.display = 'none';
            document.getElementById('preview-download-pdf').style.display = 'none';
            document.getElementById('preview-download-toggle').style.display = 'none';
            document.getElementById('preview-download-main').style.borderRadius = '6px';

            previewModal.style.display = 'flex';
            setTimeout(() => previewModal.classList.add('show'), 10);

            try {
                const url = new URL(src, window.location.origin);
                url.searchParams.set('download', '1');
                const downloadUrl = url.toString();
                document.getElementById('preview-download-main').href = downloadUrl;
                document.getElementById('preview-download-main').download = title || 'image';
                document.getElementById('preview-download-main').textContent = 'Download';
                document.getElementById('preview-download-original').href = downloadUrl;
                document.getElementById('preview-download-original').download = title || 'image';
            } catch (e) {
                const downloadUrl = src + '?download=1';
                document.getElementById('preview-download-main').href = downloadUrl;
                document.getElementById('preview-download-main').download = title || 'image';
                document.getElementById('preview-download-main').textContent = 'Download';
                document.getElementById('preview-download-original').href = downloadUrl;
                document.getElementById('preview-download-original').download = title || 'image';
            }

            const img = document.getElementById('preview-image');
            if (img) {
                img.addEventListener('load', () => {
                    fitToHeight();
                });

                img.addEventListener('click', () => {
                    if (currentZoom === 100) {
                        currentZoom = 150;
                        img.style.cursor = 'zoom-out';
                    } else {
                        currentZoom = 100;
                        img.style.cursor = 'zoom-in';
                    }
                    applyZoom();
                });
            }
        }

        function openPreviewDocument(src, title, contentType) {
            currentZoom = 100;
            currentRotation = 0;
            isPdfOpen = true;
            isConvertibleDocument = CONVERTIBLE_TYPES.includes(contentType);
            document.getElementById('preview-title').textContent = title;
            document.getElementById('zoomLevel').textContent = '100%';

            document.getElementById('toggleSidebar').style.display = 'inline-flex';
            document.getElementById('fitWidth').style.display = 'inline-flex';
            document.getElementById('fitHeight').style.display = 'inline-flex';

            let announcementId = null;
            try {
                const url = new URL(src, window.location.origin);
                const pathParts = url.pathname.split('/');
                announcementId = pathParts[pathParts.length - 2];
                url.searchParams.set('download', '1');
                const downloadUrl = url.toString();
                document.getElementById('preview-download-main').href = downloadUrl;
                document.getElementById('preview-download-main').download = title;
                document.getElementById('preview-download-original').href = downloadUrl;
                document.getElementById('preview-download-original').download = title;
            } catch (e) {
                const downloadUrl = src + '?download=1';
                document.getElementById('preview-download-main').href = downloadUrl;
                document.getElementById('preview-download-main').download = title;
                document.getElementById('preview-download-original').href = downloadUrl;
                document.getElementById('preview-download-original').download = title;
            }

            previewAnnouncementId = announcementId;

            // Check if file is .pdf.gz or .csv.gz by filename
            const isPdfGz = title && title.toLowerCase().endsWith('.pdf.gz');
            const isCsvGz = title && title.toLowerCase().endsWith('.csv.gz');
            if (isCsvGz) {
                isConvertibleDocument = true;
            }

            // If .pdf.gz, decompress and load directly
            if (isPdfGz && announcementId) {
                showLoadingOverlay('Decompressing PDF...');
                convertAndPreviewAnnouncement(announcementId, src, title);
            }
            else if (contentType === 'application/pdf' || contentType.startsWith('image')) {
                loadPdfPreview(src, title, contentType);
                document.getElementById('preview-download-pdf').style.display = 'none';
                document.getElementById('preview-download-toggle').style.display = 'none';
                document.getElementById('preview-download-main').style.borderRadius = '6px';
                document.getElementById('preview-download-main').textContent = 'Download';
            }
            else if ((isConvertibleDocument || isCsvGz) && announcementId) {
                document.getElementById('preview-download-toggle').style.display = 'flex';
                document.getElementById('preview-download-main').style.borderRadius = '6px 0 0 6px';
                const loadingMsg = isCsvGz ? 'Decompressing and converting CSV to PDF...' : 'Converting document to PDF...';
                showLoadingOverlay(loadingMsg);
                convertAndPreviewAnnouncement(announcementId, src, title);
            }
            else {
                loadPdfPreview(src, title, contentType);
                document.getElementById('preview-download-pdf').style.display = 'none';
                document.getElementById('preview-download-toggle').style.display = 'none';
                document.getElementById('preview-download-main').style.borderRadius = '6px';
                document.getElementById('preview-download-main').textContent = 'Download';
            }
        }

        async function convertAndPreviewAnnouncement(announcementId, originalSrc, title) {
            try {
                const response = await fetch(`/communications/api/announcement/${announcementId}/attachment/convert-pdf/`, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (!response.ok) {
                    let errorMsg = 'Conversion failed';
                    try {
                        const data = await response.json();
                        errorMsg = data.message || errorMsg;
                    } catch (e) {
                        errorMsg = `Server error: ${response.status}`;
                    }
                    throw new Error(errorMsg);
                }

                const conversionStatus = response.headers.get('X-Conversion-Status');
                const contentType = response.headers.get('Content-Type') || 'application/pdf';
                const blob = await response.blob();
                const blobUrl = URL.createObjectURL(blob);

                // Check if it's a decompressed PDF.GZ
                const isPdfGz = title && title.toLowerCase().endsWith('.pdf.gz');
                const isDecompressedPdf = conversionStatus === 'decompressed' || isPdfGz;

                hideLoadingOverlay();
                previewModal.classList.add('show');
                previewModal.style.display = 'flex';

                // If it's a decompressed PDF.GZ, load it as PDF directly
                if (isDecompressedPdf && contentType.includes('pdf')) {
                    const pdfFilename = title.replace(/\.gz$/i, ''); // Remove .gz extension
                    document.getElementById('preview-download-main').href = blobUrl;
                    document.getElementById('preview-download-main').download = pdfFilename;
                    document.getElementById('preview-download-main').textContent = 'Download';
                    document.getElementById('preview-download-toggle').style.display = 'none';
                    document.getElementById('preview-download-main').style.borderRadius = '6px';
                    document.getElementById('preview-download-pdf').style.display = 'none';
                    loadPdfFromBlob(blobUrl, pdfFilename);
                    return;
                }

                // If conversion failed, show original file with download option
                if (conversionStatus === 'failed' || !contentType.includes('pdf')) {
                    previewBody.innerHTML = `
                    <div style="padding: 40px; text-align: center;">
                        <i class="bi bi-file-earmark" style="font-size: 4rem; color: #6c757d; margin-bottom: 20px;"></i>
                        <h4 style="color: #495057; margin-bottom: 10px;">${escapeHtml(title)}</h4>
                        <p style="color: #6c757d; margin-bottom: 20px;">This file cannot be previewed in the browser.</p>
                        <p style="color: #6c757d; font-size: 0.9rem;">Please download the file to view it.</p>
                    </div>
                `;
                    document.getElementById('preview-title').textContent = title;
                    document.getElementById('preview-download-main').href = originalSrc + '?download=1';
                    document.getElementById('preview-download-main').download = title;
                    document.getElementById('preview-download-main').textContent = 'Download';
                    document.getElementById('preview-download-toggle').style.display = 'none';
                    document.getElementById('preview-download-main').style.borderRadius = '6px';
                    document.getElementById('preview-download-pdf').style.display = 'none';
                    return;
                }

                // Conversion successful - show PDF
                const pdfFilename = title.split('.').slice(0, -1).join('.') + '.pdf';

                document.getElementById('preview-download-main').href = blobUrl;
                document.getElementById('preview-download-main').download = pdfFilename;
                document.getElementById('preview-download-main').textContent = 'Download PDF';

                document.getElementById('preview-download-pdf').href = blobUrl;
                document.getElementById('preview-download-pdf').download = pdfFilename;
                document.getElementById('preview-download-pdf').style.display = 'block';

                loadPdfFromBlob(blobUrl, title);
            } catch (error) {
                hideLoadingOverlay();
                previewModal.classList.add('show');
                previewModal.style.display = 'flex';
                previewBody.innerHTML = `
                <div style="padding: 40px; text-align: center;">
                    <i class="bi bi-exclamation-triangle" style="font-size: 4rem; color: #dc3545; margin-bottom: 20px;"></i>
                    <h4 style="color: #495057; margin-bottom: 10px;">Preview Unavailable</h4>
                    <p style="color: #6c757d; margin-bottom: 20px;">${escapeHtml(error.message)}</p>
                    <a href="${originalSrc}?download=1" class="btn btn-primary" download="${title}">
                        <i class="bi bi-download"></i> Download File
                    </a>
                </div>
            `;
                document.getElementById('preview-title').textContent = title;
                document.getElementById('preview-download-main').href = originalSrc + '?download=1';
                document.getElementById('preview-download-main').download = title;
                document.getElementById('preview-download-main').textContent = 'Download';
                document.getElementById('preview-download-toggle').style.display = 'none';
                document.getElementById('preview-download-main').style.borderRadius = '6px';
                console.error('Conversion error:', error);
            }
        }

        async function loadPdfPreview(src, title, contentType) {
            previewModal.style.display = 'flex';
            setTimeout(() => previewModal.classList.add('show'), 10);

            previewBody.innerHTML = '<p style="color:#6c757d; font-size:1rem;">Loading document...</p>';

            if (isConvertibleDocument) {
                const pdfUrl = new URL(src, window.location.origin);
                pdfUrl.searchParams.set('format', 'pdf');
                pdfUrl.searchParams.set('download', '1');
                document.getElementById('preview-download-pdf').href = pdfUrl.toString();
                document.getElementById('preview-download-pdf').style.display = 'inline-block';
            } else {
                document.getElementById('preview-download-pdf').style.display = 'none';
            }

            if (window.pdfjsLib) {
                window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                try {
                    const doc = await window.pdfjsLib.getDocument(src).promise;
                    pdfDoc = doc;
                    currentPage = 1;
                    totalPages = doc.numPages;
                    document.getElementById('page-controls').style.display = totalPages > 1 ? 'flex' : 'none';

                    if (totalPages > 1) {
                        previewSidebar.style.display = 'flex';
                        const toggleIcon = document.querySelector('#toggleSidebar i');
                        if (toggleIcon) toggleIcon.className = 'bi bi-layout-sidebar-inset';
                        generateThumbnails();
                    } else {
                        previewSidebar.style.display = 'none';
                        const toggleIcon = document.querySelector('#toggleSidebar i');
                        if (toggleIcon) toggleIcon.className = 'bi bi-layout-sidebar';
                    }

                    await fitToHeight();
                    setupPdfNavigation();
                } catch (err) {
                    previewBody.innerHTML = `<p style="color:#d32f2f; font-size:0.95rem;">Error loading document: ${err.message}</p>`;
                    console.error('PDF load error:', err);
                }
            } else {
                previewBody.innerHTML = `<iframe src="${src}" title="${escapeHtml(title)}" style="width:100%; height:100%; border:0;"></iframe>`;
                document.getElementById('page-controls').style.display = 'none';
                previewSidebar.style.display = 'none';
            }
        }

        async function loadPdfFromBlob(blobUrl, title) {
            previewBody.innerHTML = '<p style="color:#aaa;">Rendering PDF...</p>';

            if (window.pdfjsLib) {
                window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                try {
                    const doc = await window.pdfjsLib.getDocument(blobUrl).promise;
                    pdfDoc = doc;
                    currentPage = 1;
                    totalPages = doc.numPages;
                    document.getElementById('page-controls').style.display = totalPages > 1 ? 'flex' : 'none';

                    if (totalPages > 1) {
                        previewSidebar.style.display = 'flex';
                        const toggleIcon = document.querySelector('#toggleSidebar i');
                        if (toggleIcon) toggleIcon.className = 'bi bi-layout-sidebar-inset';
                        generateThumbnails();
                    } else {
                        previewSidebar.style.display = 'none';
                        const toggleIcon = document.querySelector('#toggleSidebar i');
                        if (toggleIcon) toggleIcon.className = 'bi bi-layout-sidebar';
                    }

                    await fitToHeight();
                    setupPdfNavigation();
                } catch (err) {
                    previewBody.innerHTML = `<p style="color:#d32f2f;">Error rendering PDF: ${err.message}</p>`;
                    console.error('PDF render error:', err);
                }
            }
        }

        function showLoadingOverlay(message = 'Converting document to PDF...') {
            document.getElementById('loading-text').textContent = message;
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        function hideLoadingOverlay() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        function closePreview() {
            previewModal.classList.remove('show');
            setTimeout(() => {
                previewModal.style.display = 'none';
                previewBody.innerHTML = '';
                previewThumbnails.innerHTML = '';
            }, 300);

            pdfDoc = null;
            isPdfOpen = false;
            currentZoom = 100;
            currentRotation = 0;
            previewAnnouncementId = null;

            document.removeEventListener('keydown', handlePdfKeyboard);
            previewBody.removeEventListener('wheel', handlePdfScroll);
        }

        if (previewCloseBtn) {
            previewCloseBtn.addEventListener('click', closePreview);
        }
        if (previewModal) {
            previewModal.addEventListener('click', (e) => { if (e.target === previewModal) closePreview(); });
        }

        // Updated preview function for announcements
        async function previewAnnouncementAttachment(announcementId, filename) {
            const fileExt = filename.split('.').pop().toLowerCase();
            const isImage = ['png', 'jpg', 'jpeg', 'gif', 'bmp', 'svg', 'webp'].includes(fileExt);
            const isPdf = fileExt === 'pdf';

            const baseUrl = `/communications/api/announcement/${announcementId}/attachment/`;
            const previewUrl = baseUrl + '?preview=true';

            // Determine content type
            let contentType = 'application/octet-stream';
            if (isImage) {
                contentType = `image/${fileExt === 'svg' ? 'svg+xml' : fileExt}`;
            } else if (isPdf) {
                contentType = 'application/pdf';
            } else if (fileExt === 'docx') {
                contentType = 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';
            } else if (fileExt === 'doc') {
                contentType = 'application/msword';
            } else if (fileExt === 'xlsx') {
                contentType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
            } else if (fileExt === 'xls') {
                contentType = 'application/vnd.ms-excel';
            } else if (fileExt === 'pptx') {
                contentType = 'application/vnd.openxmlformats-officedocument.presentationml.presentation';
            } else if (fileExt === 'ppt') {
                contentType = 'application/vnd.ms-powerpoint';
            } else if (fileExt === 'txt') {
                contentType = 'text/plain';
            } else if (fileExt === 'csv') {
                contentType = 'text/csv';
            }

            if (isImage) {
                openPreviewImage(previewUrl, filename, announcementId);
            } else {
                openPreviewDocument(previewUrl, filename, contentType);
            }
        }

        // Handle scheduled announcement edit/cancel functionality
        function handleScheduledAnnouncementButtons(data) {
            const editBtn = document.getElementById('edit-scheduled-btn');
            const cancelBtn = document.getElementById('cancel-scheduled-btn');

            if (!editBtn || !cancelBtn) return;

            // Calculate time until scheduled send
            const scheduledTime = new Date(data.sent_at);
            const now = new Date();
            const minutesUntilSend = (scheduledTime - now) / 1000 / 60;

            // Check if announcement was already sent
            if (data.status === 'sent') {
                editBtn.style.display = 'none';
                cancelBtn.style.display = 'none';
                return;
            }

            // Show buttons for scheduled announcements
            editBtn.style.display = 'inline-block';
            cancelBtn.style.display = 'inline-block';

            // Store announcement ID on buttons
            editBtn.dataset.announcementId = data.announcement_id;
            cancelBtn.dataset.announcementId = data.announcement_id;

            // Remove old event listeners
            editBtn.replaceWith(editBtn.cloneNode(true));
            cancelBtn.replaceWith(cancelBtn.cloneNode(true));

            // Get new references
            const newEditBtn = document.getElementById('edit-scheduled-btn');
            const newCancelBtn = document.getElementById('cancel-scheduled-btn');

            // Edit button click handler
            newEditBtn.addEventListener('click', async () => {
                const minutesNow = (scheduledTime - new Date()) / 1000 / 60;

                // 5-minute lockout to prevent race conditions
                if (minutesNow < 5 && minutesNow > 0) {
                    showNotification(
                        `This announcement is scheduled to send in less than 5 minutes and cannot be edited. Please "Cancel Schedule" first if you wish to make changes.`,
                        'warning'
                    );
                    return;
                }

                // Check if already sent (race condition check)
                if (minutesNow < 0) {
                    showNotification(
                        'This announcement has already been sent and cannot be edited.',
                        'error'
                    );
                    viewScheduledModal.hide();
                    setTimeout(() => location.reload(), 1500);
                    return;
                }

                // Load draft for editing
                try {
                    const response = await fetch(`/communications/api/announcement/draft/${data.announcement_id}/`);
                    const result = await response.json();

                    if (result.status === 'success') {
                        loadDraftData(result.data);
                        viewScheduledModal.hide();
                        showCreateView();

                        // Show notification about scheduled status
                        if (result.data.status === 'scheduled') {
                            showNotification(
                                'Editing scheduled announcement. Click "Send SMS" to save changes and keep the schedule, or use "Schedule Send" to change the time.',
                                'info'
                            );
                        } else {
                            showNotification('Editing scheduled announcement. Changes will be sent at the scheduled time.', 'info');
                        }
                    } else {
                        showNotification(result.message || 'Failed to load announcement for editing', 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showNotification('An error occurred while loading the announcement', 'error');
                }
            });

            // Cancel schedule button click handler
            newCancelBtn.addEventListener('click', () => {
                // Show confirmation modal
                const confirmCancelScheduleModal = new bootstrap.Modal(document.getElementById('confirm-cancel-schedule-modal'));
                confirmCancelScheduleModal.show();

                // Set up the confirm button handler
                const confirmBtn = document.getElementById('confirm-cancel-schedule-btn');
                confirmBtn.onclick = async () => {
                    confirmCancelScheduleModal.hide();

                    try {
                        const response = await fetch(`/communications/api/announcement/cancel-schedule/${data.announcement_id}/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCsrfToken()
                            }
                        });

                        const result = await response.json();

                        if (result.status === 'success') {
                            showNotification('Schedule cancelled. Announcement reverted to draft.', 'success');
                            viewScheduledModal.hide();
                            setTimeout(() => location.reload(), 1500);
                        } else {
                            showNotification(result.message || 'Failed to cancel schedule', 'error');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        showNotification('An error occurred while cancelling the schedule', 'error');
                    }
                };
            });
        }

        // Helper function to get CSRF token
        function getCsrfToken() {
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        document.body.addEventListener('click', function (e) {
            const viewTrigger = e.target.closest('a[data-modal-id]');
            if (viewTrigger) {
                e.preventDefault();
                const modalId = viewTrigger.getAttribute('data-modal-id');
                const announcementId = viewTrigger.getAttribute('data-announcement-id');

                if (modalId === 'view-sent-modal' && announcementId) {
                    loadAnnouncementDetails(announcementId, 'sent');
                    viewSentModal.show();
                } else if (modalId === 'view-scheduled-modal' && announcementId) {
                    loadAnnouncementDetails(announcementId, 'scheduled');
                    viewScheduledModal.show();
                }
            }
        });

        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        let pendingTabTrigger = null;
        if (confirmCancelBtn) {
            confirmCancelBtn.addEventListener('click', () => {
                confirmCancelModal.hide();
                showListView();
                if (pendingTabTrigger) {
                    pendingTabTrigger.show();
                    pendingTabTrigger = null;
                }
            });
        }

        var triggerTabList = [].slice.call(document.querySelectorAll('#announcement-nav a'));
        triggerTabList.forEach(function (triggerEl) {
            var tabTrigger = new bootstrap.Tab(triggerEl);
            triggerEl.addEventListener('click', function (event) {
                event.preventDefault();
                const isCreateViewVisible = createView.classList.contains('d-flex');
                if (isCreateViewVisible) {
                    pendingTabTrigger = tabTrigger;
                    confirmCancelModal.show();
                } else {
                    tabTrigger.show();
                }
            });
        });

        // ========================================================
        // ===== COOPERATIVE & OFFICER LOGIC                =====
        // ========================================================

        function getCurrentlySelectedCoops() {
            const selectedCoops = [];
            recipientRowsContainer.querySelectorAll('.coop-select').forEach(select => {
                if (select.value) {
                    selectedCoops.push(select.value);
                }
            });
            return selectedCoops;
        }

        function updateAvailableCooperatives() {
            const selectedCoopIds = getCurrentlySelectedCoops();

            recipientRowsContainer.querySelectorAll('.coop-select').forEach(select => {
                const currentSelectValue = select.value;
                const options = Array.from(select.querySelectorAll('option'));
                const specialOptions = [];
                const availableOptions = [];
                const unavailableOptions = [];

                options.forEach(option => {
                    const value = option.value;
                    const isSelectedElsewhere = selectedCoopIds.includes(value);

                    if (!value) {
                        specialOptions.push(option);
                    } else if (value === currentSelectValue) {
                        option.disabled = false;
                        specialOptions.push(option);
                    } else if (isSelectedElsewhere) {
                        option.disabled = true;
                        unavailableOptions.push(option);
                    } else {
                        option.disabled = false;
                        availableOptions.push(option);
                    }
                });

                select.innerHTML = '';
                [...specialOptions, ...availableOptions, ...unavailableOptions].forEach(option => {
                    select.appendChild(option);
                });
            });
        }

        function initializeTomSelect(selectElement, placeholderText) {
            if (selectElement.tomselect) {
                selectElement.tomselect.destroy();
            }
            new TomSelect(selectElement, {
                plugins: ['remove_button'],
                placeholder: placeholderText,

                onItemAdd: function (value, $item) {
                    const tomSelect = this;
                    const totalIndividuals = tomSelect.individualOfficerCount || 0;
                    let currentSelection = tomSelect.getValue();

                    if (value === 'all') {
                        if (currentSelection.length > 1) {
                            tomSelect.setValue(['all']);
                        }
                        return;
                    }

                    if (currentSelection.includes('all')) {
                        const newSelection = currentSelection.filter(v => v !== 'all');
                        tomSelect.setValue(newSelection);
                        return;
                    }

                    if (totalIndividuals > 0 && currentSelection.length === totalIndividuals) {
                        tomSelect.setValue(['all']);
                    }
                }
            });
        }

        function populateCooperatives(coopSelect) {
            coopSelect.innerHTML = '<option value="" selected>Choose Cooperative...</option>';
            cooperativesData.forEach(coop => {
                const option = new Option(coop.name, coop.id);
                coopSelect.add(option);
            });
        }

        function populateOfficers(officerSelect, coopId) {
            const tomSelect = officerSelect.tomselect;
            if (!tomSelect) return;

            tomSelect.clear();
            tomSelect.clearOptions();
            tomSelect.individualOfficerCount = 0;

            if (!coopId) {
                tomSelect.addOption({ value: '', text: '-- Select Cooperative First --' });
                tomSelect.settings.placeholder = '-- Select Cooperative First --';
                tomSelect.disable();
            } else {
                const officers = officersByCoopData[coopId];
                if (officers && officers.length > 0) {
                    tomSelect.addOption({ value: 'all', text: 'All Officers' });
                    officers.forEach(officer => {
                        tomSelect.addOption({ value: officer.id, text: officer.name });
                    });
                    tomSelect.individualOfficerCount = officers.length;
                    tomSelect.settings.placeholder = 'Select officer(s)...';
                } else {
                    tomSelect.settings.placeholder = '-- No Officers Found --';
                }
                tomSelect.enable();
            }
            tomSelect.refreshPlaceholder();
        }

        // --- Event Listener for Adding New Rows ---
        if (addRecipientBtn) {
            addRecipientBtn.addEventListener('click', () => {
                const newRow = recipientRowTemplate.content.cloneNode(true);
                const newCoopSelect = newRow.querySelector('.coop-select');
                populateCooperatives(newCoopSelect);

                const newOfficerSelect = newRow.querySelector('.officer-select');
                initializeTomSelect(newOfficerSelect, '-- Select Cooperative First --');

                recipientRowsContainer.appendChild(newRow);
                updateRecipientRemoveButtons();
                updateAvailableCooperatives();
            });
        }

        // --- Event Listener for Removing Rows ---
        if (recipientRowsContainer) {
            recipientRowsContainer.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-recipient-btn');
                if (removeBtn) {
                    const rowToRemove = removeBtn.closest('.recipient-row');
                    if (rowToRemove) {
                        const officerSelect = rowToRemove.querySelector('.officer-select');
                        if (officerSelect && officerSelect.tomselect) {
                            officerSelect.tomselect.destroy();
                        }
                        rowToRemove.remove();
                        updateRecipientRemoveButtons();
                        updateAvailableCooperatives();
                    }
                }
            });
        }

        // --- Event Listener for changing a Cooperative ---
        if (recipientRowsContainer) {
            recipientRowsContainer.addEventListener('change', (e) => {
                if (e.target && e.target.classList.contains('coop-select')) {
                    const selectedCoopId = e.target.value;
                    const recipientRow = e.target.closest('.recipient-row');
                    const officerSelect = recipientRow.querySelector('.officer-select');

                    populateOfficers(officerSelect, selectedCoopId);
                    updateAvailableCooperatives();
                }
            });
        }

        function updateRecipientRemoveButtons() {
            const rows = recipientRowsContainer.querySelectorAll('.recipient-row');
            rows.forEach((row, index) => {
                const removeBtn = row.querySelector('.remove-recipient-btn');
                if (index > 0) {
                    removeBtn.classList.remove('d-none');
                } else {
                    removeBtn.classList.add('d-none');
                }
            });
        }

        // --- Populate the very first row on page load ---
        try {
            const firstCoopSelect = recipientRowsContainer.querySelector('.coop-select');
            if (firstCoopSelect) {
                populateCooperatives(firstCoopSelect);

                const firstOfficerSelect = recipientRowsContainer.querySelector('.officer-select');
                if (firstOfficerSelect) {
                    initializeTomSelect(firstOfficerSelect, '-- Select Cooperative First --');
                }
            }
            updateRecipientRemoveButtons();
            updateAvailableCooperatives();

        } catch (e) {
            console.error('CRITICAL ERROR: Failed to load cooperative data.', e);
        }

        // ===========================================
        // ===== DRAFT EDITING LOGIC            =====
        // ===========================================

        draftButtons.forEach(btn => {
            btn.addEventListener('click', async (e) => {
                e.preventDefault();
                const draftId = btn.getAttribute('data-id');

                console.log('Loading draft:', draftId);

                try {
                    const response = await fetch(`/communications/api/announcement/draft/${draftId}/`);

                    console.log('Draft response status:', response.status);
                    console.log('Draft response ok:', response.ok);
                    console.log('Draft response headers:', response.headers.get('content-type'));

                    // Check if response is JSON
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        const text = await response.text();
                        console.error('Draft response is not JSON. Content type:', contentType);
                        console.error('Draft response text (first 500 chars):', text.substring(0, 500));
                        showNotification('Server returned an invalid response for draft (not JSON)', 'error');
                        return;
                    }

                    const result = await response.json();
                    console.log('Draft response data:', result);

                    if (result.status === 'success') {
                        loadDraftData(result.data);
                        showCreateView();
                    } else {
                        console.error('Draft load failed:', result);
                        showNotification(result.message || 'Failed to load draft', 'error');
                    }
                } catch (error) {
                    console.error('Error loading draft:', error);
                    console.error('Error stack:', error.stack);
                    showNotification('An error occurred while loading the draft: ' + error.message, 'error');
                }
            });
        });

        function loadDraftData(data) {
            currentDraftId = data.announcement_id;

            // Check if this is a scheduled announcement being edited
            if (data.status === 'scheduled' && data.sent_at) {
                isEditingScheduled = true;
                currentScheduledTime = data.sent_at;

                // Update button visibility and text
                if (saveDraftBtn) saveDraftBtn.textContent = 'Save to Draft';
                if (saveChangesBtn) saveChangesBtn.classList.remove('d-none');
            } else {
                isEditingScheduled = false;
                currentScheduledTime = null;

                // Reset button visibility and text
                if (saveDraftBtn) saveDraftBtn.textContent = 'Save Draft';
                if (saveChangesBtn) saveChangesBtn.classList.add('d-none');
            }

            // Set basic fields
            document.getElementById('announcement-title').value = data.title || '';
            document.getElementById('announcement-content').value = data.description || '';
            document.getElementById('announcement-type').value = data.type || '';

            // Trigger type change to show appropriate fields
            const typeChangeEvent = new Event('change');
            document.getElementById('announcement-type').dispatchEvent(typeChangeEvent);

            // Clear existing recipient rows
            recipientRowsContainer.innerHTML = '';

            // Process recipients based on scope
            if (data.scope === 'cooperative' && data.coop_recipients) {
                // Check if already parsed or needs parsing
                const coopRecipients = typeof data.coop_recipients === 'string'
                    ? JSON.parse(data.coop_recipients)
                    : data.coop_recipients;
                coopRecipients.forEach(coop => {
                    addRecipientRow(coop.coop_id, 'all');
                });
            } else if (data.scope === 'officer' && data.officer_recipients) {
                // Check if already parsed or needs parsing
                const officerRecipients = typeof data.officer_recipients === 'string'
                    ? JSON.parse(data.officer_recipients)
                    : data.officer_recipients;

                // Group officers by coop
                const groupedByCoop = {};
                officerRecipients.forEach(officer => {
                    const coopId = officer.coop_id;
                    if (!groupedByCoop[coopId]) {
                        groupedByCoop[coopId] = [];
                    }
                    groupedByCoop[coopId].push(officer.officer_id);
                });

                // Add rows for each coop
                for (const [coopId, officerIds] of Object.entries(groupedByCoop)) {
                    addRecipientRow(parseInt(coopId), officerIds);
                }
            }

            // If no recipients, add empty row
            if (recipientRowsContainer.children.length === 0) {
                addRecipientRow(null, null);
            }

            updateRecipientRemoveButtons();
            updateAvailableCooperatives();

            // Display existing attachments if present
            if (data.has_attachment && data.attachment_filename) {
                displayExistingAttachments(data);
            } else {
                attachmentPreview.innerHTML = '';
            }
        }

        function addRecipientRow(coopId, officerIds) {
            const newRow = recipientRowTemplate.content.cloneNode(true);
            const newCoopSelect = newRow.querySelector('.coop-select');
            populateCooperatives(newCoopSelect);

            const newOfficerSelect = newRow.querySelector('.officer-select');
            initializeTomSelect(newOfficerSelect, '-- Select Cooperative First --');

            recipientRowsContainer.appendChild(newRow);

            // Set values after row is added to DOM
            if (coopId) {
                const addedRow = recipientRowsContainer.lastElementChild;
                const coopSelect = addedRow.querySelector('.coop-select');
                const officerSelect = addedRow.querySelector('.officer-select');

                coopSelect.value = coopId;

                // Trigger change to populate officers
                const changeEvent = new Event('change', { bubbles: true });
                coopSelect.dispatchEvent(changeEvent);

                // Wait for officers to populate, then set selection
                setTimeout(() => {
                    if (officerSelect.tomselect) {
                        if (officerIds === 'all') {
                            officerSelect.tomselect.setValue(['all']);
                        } else if (Array.isArray(officerIds)) {
                            officerSelect.tomselect.setValue(officerIds.map(String));
                        }
                    }
                }, 100);
            }
        }

        // ===========================================
        // ===== SCHEDULE SEND VALIDATION        =====
        // ===========================================

        const scheduleDateInput = document.getElementById('schedule-date');
        const scheduleTimeInput = document.getElementById('schedule-time');
        const saveScheduleBtn = document.querySelector('#schedule-send-modal .btn-primary');

        function setMinDateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');

            scheduleDateInput.min = `${year}-${month}-${day}`;
            scheduleDateInput.value = '';
            scheduleTimeInput.value = '';
        }

        function validateScheduleDateTime() {
            const selectedDate = scheduleDateInput.value;
            const selectedTime = scheduleTimeInput.value;

            if (!selectedDate || !selectedTime) {
                showNotification('Please select both date and time', 'warning');
                return false;
            }

            const selectedDateTime = new Date(`${selectedDate}T${selectedTime}`);
            const now = new Date();

            if (selectedDateTime <= now) {
                showNotification('Scheduled time must be in the future', 'error');
                return false;
            }

            return true;
        }

        document.getElementById('schedule-send-link').addEventListener('click', (e) => {
            e.preventDefault();
            setMinDateTime();
            scheduleSendModal.show();
        });

        if (saveScheduleBtn) {
            saveScheduleBtn.addEventListener('click', () => {
                if (validateScheduleDateTime()) {
                    const selectedDate = scheduleDateInput.value;
                    const selectedTime = scheduleTimeInput.value;

                    // Create a Date object from the selected date/time (assumes local timezone)
                    const localDateTime = new Date(`${selectedDate}T${selectedTime}:00`);

                    // Convert to ISO string with timezone offset (e.g., "2025-11-19T22:30:00+08:00")
                    const year = localDateTime.getFullYear();
                    const month = String(localDateTime.getMonth() + 1).padStart(2, '0');
                    const day = String(localDateTime.getDate()).padStart(2, '0');
                    const hours = String(localDateTime.getHours()).padStart(2, '0');
                    const minutes = String(localDateTime.getMinutes()).padStart(2, '0');
                    const seconds = String(localDateTime.getSeconds()).padStart(2, '0');

                    // Get timezone offset in hours and minutes
                    const tzOffset = -localDateTime.getTimezoneOffset();
                    const tzHours = String(Math.floor(Math.abs(tzOffset) / 60)).padStart(2, '0');
                    const tzMinutes = String(Math.abs(tzOffset) % 60).padStart(2, '0');
                    const tzSign = tzOffset >= 0 ? '+' : '-';

                    const scheduledDateTime = `${year}-${month}-${day}T${hours}:${minutes}:${seconds}${tzSign}${tzHours}:${tzMinutes}`;

                    submitAnnouncement('schedule_send', scheduledDateTime);
                    scheduleSendModal.hide();
                }
            });
        }

        // ===========================================
        // ===== VIEW SWITCHING LOGIC            =====
        // ===========================================

        function showCreateView() {
            listView.classList.remove('d-flex');
            listView.classList.add('d-none');
            createView.classList.remove('d-none');
            createView.classList.add('d-flex');
            const currentActive = document.querySelector('.sidebar-nav .nav-link.active');
            if (currentActive) currentActive.classList.remove('active');
        }

        function showListView() {
            createView.classList.remove('d-flex');
            createView.classList.add('d-none');
            listView.classList.remove('d-none');
            listView.classList.add('d-flex');
            resetForm();

            // Restore the active tab or default to 'sent'
            const activeTab = document.querySelector('#announcement-nav .nav-link.active');
            if (!activeTab) {
                // Default to first tab (sent)
                const firstTab = document.querySelector('#announcement-nav .nav-link');
                if (firstTab) {
                    const tabTrigger = new bootstrap.Tab(firstTab);
                    tabTrigger.show();
                }
            }
        }

        function resetForm() {
            currentDraftId = null;
            currentScheduledTime = null;
            isEditingScheduled = false;

            // Reset button visibility and text
            if (saveDraftBtn) saveDraftBtn.textContent = 'Save Draft';
            if (saveChangesBtn) saveChangesBtn.classList.add('d-none');
            mainForm.reset();
            dynamicFields.classList.add('d-none');
            emailFields.classList.add('d-none');

            recipientRowsContainer.querySelectorAll('.officer-select').forEach(select => {
                if (select.tomselect) {
                    select.tomselect.destroy();
                }
            });

            recipientRowsContainer.innerHTML = '';

            const newRow = recipientRowTemplate.content.cloneNode(true);
            const newCoopSelect = newRow.querySelector('.coop-select');
            populateCooperatives(newCoopSelect);

            const newOfficerSelect = newRow.querySelector('.officer-select');
            initializeTomSelect(newOfficerSelect, '-- Select Cooperative First --');

            recipientRowsContainer.appendChild(newRow);
            updateRecipientRemoveButtons();
            updateAvailableCooperatives();
        }

        if (createBtn) createBtn.addEventListener('click', showCreateView);

        if (cancelBtn) {
            cancelBtn.addEventListener('click', () => {
                pendingTabTrigger = null;
                confirmCancelModal.show();
            });
        }

        if (announcementType) {
            announcementType.addEventListener('change', () => {
                const selectedType = announcementType.value;
                if (selectedType === 'sms' || selectedType === 'e-mail') {
                    dynamicFields.classList.remove('d-none');
                    if (selectedType === 'e-mail') {
                        emailFields.classList.remove('d-none');
                        sendBtnMain.textContent = 'Send Email';
                    } else {
                        emailFields.classList.add('d-none');
                        sendBtnMain.textContent = 'Send SMS';
                    }
                } else {
                    dynamicFields.classList.add('d-none');
                }
            });
        }

        // ===========================================
        // ===== FORM SUBMISSION LOGIC           =====
        // ===========================================

        if (sendBtnMain) {
            sendBtnMain.addEventListener('click', (e) => {
                e.preventDefault();
                const type = announcementType.value;

                // If editing a scheduled announcement, preserve the schedule
                if (isEditingScheduled && currentScheduledTime) {
                    submitAnnouncement('schedule_send', currentScheduledTime);
                } else if (type === 'sms') {
                    submitAnnouncement('send_sms');
                } else if (type === 'e-mail') {
                    submitAnnouncement('send_email');
                }
            });
        }

        if (saveDraftBtn) {
            saveDraftBtn.addEventListener('click', (e) => {
                e.preventDefault();
                submitAnnouncement('save_draft');
            });
        }

        if (saveChangesBtn) {
            saveChangesBtn.addEventListener('click', (e) => {
                e.preventDefault();
                // Save changes while preserving scheduled status
                if (isEditingScheduled && currentScheduledTime) {
                    submitAnnouncement('schedule_send', currentScheduledTime);
                } else {
                    submitAnnouncement('save_draft');
                }
            });
        }

        function collectFormData(action, scheduledTime = null) {
            const title = document.getElementById('announcement-title').value;
            const content = document.getElementById('announcement-content').value;
            const type = announcementType.value;

            const recipientRows = recipientRowsContainer.querySelectorAll('.recipient-row');
            const recipients = [];

            recipientRows.forEach(row => {
                const coopSelect = row.querySelector('.coop-select');
                const officerSelect = row.querySelector('.officer-select');

                if (coopSelect && coopSelect.value && officerSelect && officerSelect.tomselect) {
                    const selectedOfficerValues = officerSelect.tomselect.getValue();

                    if (selectedOfficerValues.includes('all')) {
                        recipients.push({
                            coop_id: coopSelect.value,
                            officer_id: 'all'
                        });
                    } else {
                        selectedOfficerValues.forEach(officerId => {
                            if (officerId) {
                                recipients.push({
                                    coop_id: coopSelect.value,
                                    officer_id: officerId
                                });
                            }
                        });
                    }
                }
            });

            if (!type) {
                showNotification('Please select an announcement type (SMS or Email)', 'warning');
                return null;
            }
            if (!title || !content) {
                showNotification('Please fill in the Title and Content', 'warning');
                return null;
            }
            if (recipients.length === 0 && action !== 'save_draft') {
                showNotification('Please add at least one valid recipient to send', 'warning');
                return null;
            }

            // Use FormData for file upload support
            const formData = new FormData();
            formData.append('action', action);
            formData.append('title', title);
            formData.append('content', content);
            formData.append('type', type);
            formData.append('recipients', JSON.stringify(recipients));

            if (currentDraftId) {
                formData.append('announcement_id', currentDraftId);
            }

            // Use provided scheduledTime, or preserve existing scheduled time if editing a scheduled announcement
            if (scheduledTime) {
                formData.append('scheduled_time', scheduledTime);
            } else if (isEditingScheduled && currentScheduledTime && action !== 'save_draft') {
                // Preserve the scheduled time when sending an edited scheduled announcement
                formData.append('scheduled_time', currentScheduledTime);
            }

            // Add attachments if any (for email type)
            if (type === 'e-mail' && fileInput && fileInput.files.length > 0) {
                Array.from(fileInput.files).forEach((file, index) => {
                    formData.append('attachments', file);
                });
            }

            return formData;
        }

        async function submitAnnouncement(action, scheduledTime = null) {
            const data = collectFormData(action, scheduledTime);
            if (!data) return;

            console.log('Sending data with attachments');

            // Show loading overlay
            const loadingOverlay = document.createElement('div');
            loadingOverlay.id = 'sending-overlay';
            loadingOverlay.innerHTML = `
            <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                <div class="spinner-border text-light" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div class="text-light mt-3 fw-bold" style="font-size: 18px;">
                    ${action === 'send_email' ? 'Sending Email...' : action === 'send_sms' ? 'Sending SMS...' : action === 'schedule_send' ? 'Scheduling...' : 'Saving...'}
                </div>
                <div class="text-light mt-2" style="font-size: 14px;">Please wait, this may take a moment</div>
            </div>
        `;
            document.body.appendChild(loadingOverlay);

            try {
                const response = await fetch("{% url 'communications:handle_announcement' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCsrfToken()
                    },
                    // Don't set Content-Type header - browser will set it automatically with boundary for FormData
                    body: data
                });

                const result = await response.json();

                // Remove loading overlay
                const overlay = document.getElementById('sending-overlay');
                if (overlay) overlay.remove();

                if (response.ok && result.status === 'success') {
                    showNotification(result.message || 'Announcement processed successfully', 'success');
                    currentDraftId = null;
                    currentScheduledTime = null;
                    isEditingScheduled = false;

                    // Clear form data to prevent "unsaved changes" warning
                    const titleInput = document.getElementById('announcement-title');
                    const contentInput = document.getElementById('announcement-content');
                    const fileInput = document.getElementById('announcement-files');

                    if (titleInput) titleInput.value = '';
                    if (contentInput) contentInput.value = '';
                    if (fileInput) fileInput.value = '';

                    // Clear recipient selections
                    document.querySelectorAll('.recipient-row').forEach(row => row.remove());

                    // Mark as navigating to prevent beforeunload warning
                    window.isNavigating = true;
                    window.onbeforeunload = null; // Remove handler before reload
                    // Use replace instead of reload to avoid confirmation dialog
                    setTimeout(() => {
                        window.location.replace(window.location.href);
                    }, 1500);
                } else {
                    showNotification(result.message || 'Failed to process announcement', 'error');
                }

            } catch (error) {
                // Remove loading overlay on error
                const overlay = document.getElementById('sending-overlay');
                if (overlay) overlay.remove();

                console.error('Fetch Error:', error);
                showNotification('An error occurred while communicating with the server', 'error');
            }
        }

        // ============================================
        // SEARCH AND FILTER FUNCTIONALITY (updated)
        // ============================================

        const searchInput = document.getElementById('search-input');
        const filterTypes = document.querySelectorAll('.filter-type');
        const filterDateFrom = document.getElementById('filter-date-from');
        const filterDateTo = document.getElementById('filter-date-to');
        const activeFiltersBadge = document.getElementById('active-filters-badge');
        const clearFiltersBtn = document.getElementById('clear-filters-btn');

        // Filter panel controls (top-right)
        const filterToggleTop = document.getElementById('filterToggleTop');
        const filterPanel = document.getElementById('filter-panel');
        const closeFilterPanel = document.getElementById('closeFilterPanel');
        const applyFiltersBtn = document.getElementById('apply-filters-btn');

        function normalizeType(t) {
            return (t || '').toString().toLowerCase().replace(/[^a-z0-9]/g, '');
        }

        function getAllAnnouncementItems() {
            return document.querySelectorAll('.announcement-item');
        }

        function countActiveFilters() {
            let count = 0;
            Array.from(filterTypes).forEach(checkbox => { if (checkbox.checked) count++; });
            if (filterDateFrom && filterDateFrom.value) count++;
            if (filterDateTo && filterDateTo.value) count++;
            if (searchInput && searchInput.value.trim() !== '') count++;
            return count;
        }

        function updateFilterBadge() {
            const count = countActiveFilters();
            if (count > 0) {
                activeFiltersBadge.textContent = `${count} filter${count > 1 ? 's' : ''}`;
                activeFiltersBadge.classList.remove('d-none');
                clearFiltersBtn.classList.remove('d-none');
            } else {
                activeFiltersBadge.classList.add('d-none');
                clearFiltersBtn.classList.add('d-none');
            }
        }

        // Update "no results" message for the currently active tab
        function updateNoResultsMessage() {
            const activeTab = document.querySelector('.tab-pane.active');
            if (!activeTab) return;
            const listGroup = activeTab.querySelector('.list-group');
            if (!listGroup) return;

            const items = Array.from(activeTab.querySelectorAll('.announcement-item'));
            const visibleItems = items.filter(item => getComputedStyle(item).display !== 'none');

            const existingMsg = activeTab.querySelector('.no-results-message');
            if (items.length > 0 && visibleItems.length === 0) {
                if (!existingMsg) {
                    const noResultsDiv = document.createElement('div');
                    noResultsDiv.className = 'p-4 text-center text-muted no-results-message';
                    noResultsDiv.innerHTML = `
                    <i class="bi bi-search fs-1 d-block mb-2"></i>
                    <p>No announcements match your filters.</p>
                `;
                    listGroup.appendChild(noResultsDiv);
                }
            } else {
                if (existingMsg) existingMsg.remove();
            }
        }

        function applyFilters() {
            const searchTerm = (searchInput?.value || '').toLowerCase().trim();
            const selectedTypes = Array.from(filterTypes)
                .filter(cb => cb.checked)
                .map(cb => normalizeType(cb.value));
            const dateFrom = filterDateFrom?.value;
            const dateTo = filterDateTo?.value;

            const items = getAllAnnouncementItems();
            items.forEach(item => {
                let show = true;

                if (searchTerm) {
                    const title = (item.dataset.title || '').toLowerCase();
                    const content = (item.dataset.content || '').toLowerCase();
                    const coops = (item.dataset.coops || '').toLowerCase();
                    const officers = (item.dataset.officers || '').toLowerCase();

                    const matchesSearch = title.includes(searchTerm) ||
                        content.includes(searchTerm) ||
                        coops.includes(searchTerm) ||
                        officers.includes(searchTerm);

                    if (!matchesSearch) show = false;
                }

                if (selectedTypes.length > 0 && show) {
                    const itemType = normalizeType(item.dataset.type || '');
                    if (!itemType || !selectedTypes.includes(itemType)) {
                        show = false;
                    }
                }

                if ((dateFrom || dateTo) && show) {
                    const itemDate = item.dataset.date || '';
                    if (dateFrom && itemDate < dateFrom) show = false;
                    if (dateTo && itemDate > dateTo) show = false;
                }

                item.style.display = show ? '' : 'none';
            });

            updateNoResultsMessage();
            updateFilterBadge();
        }

        function clearAllFilters() {
            if (searchInput) searchInput.value = '';
            filterTypes.forEach(cb => cb.checked = false);
            if (filterDateFrom) filterDateFrom.value = '';
            if (filterDateTo) filterDateTo.value = '';
            applyFilters();
        }

        // Wire up UI controls for the filter panel
        if (filterToggleTop && filterPanel) {
            filterToggleTop.addEventListener('click', (e) => {
                e.stopPropagation();
                filterPanel.classList.toggle('d-none');
                const expanded = !filterPanel.classList.contains('d-none');
                filterToggleTop.setAttribute('aria-expanded', String(expanded));
            });

            // X (close) button: clear filters then hide panel
            closeFilterPanel?.addEventListener('click', (e) => {
                e.stopPropagation();
                clearAllFilters();
                filterPanel.classList.add('d-none');
                filterToggleTop.setAttribute('aria-expanded', 'false');
            });

            // Apply button: run filters, hide panel, scroll to results
            applyFiltersBtn?.addEventListener('click', (e) => {
                e.stopPropagation();
                applyFilters();
                filterPanel.classList.add('d-none');
                filterToggleTop.setAttribute('aria-expanded', 'false');

                // Scroll first visible item in active tab into view for immediate feedback
                const activeTab = document.querySelector('.tab-pane.active');
                if (activeTab) {
                    const firstVisible = Array.from(activeTab.querySelectorAll('.announcement-item'))
                        .find(item => getComputedStyle(item).display !== 'none');
                    if (firstVisible) {
                        firstVisible.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        // briefly highlight for user's attention
                        firstVisible.classList.add('filter-highlight');
                        setTimeout(() => firstVisible.classList.remove('filter-highlight'), 900);
                    } else {
                        // if none visible, scroll list container to top so "no results" is visible
                        const listGroup = activeTab.querySelector('.list-group');
                        if (listGroup) listGroup.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }
            });

            // Clicking outside: just hide panel (do not clear filters)
            document.addEventListener('click', (ev) => {
                if (!filterPanel.contains(ev.target) && !filterToggleTop.contains(ev.target)) {
                    if (!filterPanel.classList.contains('d-none')) {
                        filterPanel.classList.add('d-none');
                        filterToggleTop.setAttribute('aria-expanded', 'false');
                    }
                }
            });
        }

        // Small visual highlight class (CSS injected if not present)
        (function ensureHighlightStyle() {
            if (!document.getElementById('filter-highlight-style')) {
                const s = document.createElement('style');
                s.id = 'filter-highlight-style';
                s.textContent = `.filter-highlight{box-shadow:0 0 0 4px rgba(183,28,28,0.12);transition:box-shadow .3s;}`;
                document.head.appendChild(s);
            }
        })();

        // Event listeners for real-time filtering (keeps Apply available)
        if (searchInput) searchInput.addEventListener('input', applyFilters);
        if (filterTypes.length > 0) filterTypes.forEach(cb => cb.addEventListener('change', applyFilters));
        if (filterDateFrom) filterDateFrom.addEventListener('change', applyFilters);
        if (filterDateTo) filterDateTo.addEventListener('change', applyFilters);
        if (clearFiltersBtn) clearFiltersBtn.addEventListener('click', clearAllFilters);

        // Re-apply filters when switching tabs so the active tab reflects current controls
        const tabButtons = document.querySelectorAll('[data-bs-toggle="pill"]');
        tabButtons.forEach(button => button.addEventListener('shown.bs.tab', applyFilters));

        // Initialize on page load
        updateFilterBadge();
        applyFilters();

    });
</script>

{% endblock %}
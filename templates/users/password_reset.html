{% extends 'base.html' %}
{% load static %}

{% block title %}Reset Password - KoopTimizer{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'frontend/first_login.css' %}">
<style>
    /* Custom override to center card cleanly */
    body {
        display: flex; align-items: center; justify-content: center; min-height: 100vh;
        background: linear-gradient(100deg, rgb(129, 12, 12), rgb(58, 6, 6), rgb(0, 0, 0));
    }
    .reset-card {
        background: #fff; padding: 40px; border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        width: 100%; max-width: 450px; text-align: center;
        animation: slideUp 0.4s ease-out;
    }
    @keyframes slideUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
    .icon-circle {
        width: 80px; height: 80px; background: #fff0f2; color: #b71c1c;
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        font-size: 2.5rem; margin: 0 auto 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="reset-card">
    
    {% if step == 'otp' %}
    <div class="icon-circle"><i class="bi bi-phone"></i></div>
    <h2 class="fw-bold mb-2" style="color:#b71c1c;">Verify it's you</h2>
    <p class="text-muted mb-4">Enter the 4-digit code sent to <strong class="text-dark">{{ masked_mobile }}</strong></p>

    {% if messages %}
        {% for message in messages %}
            <div class="alert {% if message.tags == 'error' %}alert-danger{% else %}alert-success{% endif %} p-2 small mb-3">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="step" value="verify_otp">
        <div class="otp-inputs d-flex justify-content-center gap-2 mb-4">
            {% for i in "1234" %}
            <input type="text" name="otp_{{i}}" maxlength="1" class="form-control text-center fw-bold fs-4" style="width:50px; height:50px;" required>
            {% endfor %}
        </div>
        <button type="submit" class="btn btn-danger w-100 py-2 fw-bold" style="background: #b71c1c;">Verify Code</button>
    </form>
    <a href="{% url 'login' %}" class="d-block mt-3 text-decoration-none text-secondary small">Cancel</a>

    {% elif step == 'password' %}
    <div class="icon-circle"><i class="bi bi-shield-lock"></i></div>
    <h2 class="fw-bold mb-2" style="color:#b71c1c;">New Password</h2>
    <p class="text-muted mb-4">Create a strong password for your account.</p>

    {% if messages %}
        {% for message in messages %}
            <div class="alert {% if message.tags == 'error' %}alert-danger{% else %}alert-success{% endif %} p-2 small mb-3">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <form method="post" class="text-start">
        {% csrf_token %}
        <input type="hidden" name="step" value="set_password">

        <div class="mb-3">
            <label class="form-label fw-bold small text-muted">New Password</label>
            <input type="password" name="new_password" class="form-control p-2" required minlength="8" placeholder="Min. 8 characters">
        </div>

        <div class="mb-4">
            <label class="form-label fw-bold small text-muted">Confirm Password</label>
            <input type="password" name="confirm_password" class="form-control p-2" required placeholder="Re-enter password">
        </div>

        <button type="submit" class="btn btn-danger w-100 py-2 fw-bold" style="background: #b71c1c;">Reset Password</button>
    </form>
    {% endif %}
</div>

<script>
    // Auto-focus logic for OTP
    const inputs = document.querySelectorAll('.otp-inputs input');
    if(inputs.length > 0) {
        inputs[0].focus();
        inputs.forEach((input, index) => {
            input.addEventListener('input', (e) => {
                if (e.target.value.length === 1 && index < inputs.length - 1) {
                    inputs[index + 1].focus();
                }
            });
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && !e.target.value && index > 0) {
                    inputs[index - 1].focus();
                }
            });
        });
    }
</script>
{% endblock %}
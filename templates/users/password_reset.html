{% extends 'base.html' %}
{% load static %}

{% block title %}Reset Password - KoopTimizer{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'frontend/first_login.css' %}">
{% endblock %}

{% block content %}
<div class="first-login-setup">
    <h1 style="color: #b71c1c;">Reset Password</h1>

    {% if messages %}
        {% for message in messages %}
            <div class="alert {% if message.tags == 'error' %}alert-danger{% else %}alert-info{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    {% if step == 'otp' %}
    <div class="otp-verification">
        <div style="font-size: 3rem; margin-bottom: 15px;">ðŸ“±</div>
        <p>We found your account. Please enter the 4-digit code sent to <strong>{{ masked_mobile }}</strong>.</p>
        
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="step" value="verify_otp">
            <div class="otp-inputs" style="display: flex; justify-content: center; gap: 10px; margin: 20px 0;">
                <input type="text" name="otp_1" maxlength="1" required style="width: 50px; height: 50px; text-align: center; font-size: 1.5rem; border-radius: 8px; border: 1px solid #ccc;">
                <input type="text" name="otp_2" maxlength="1" required style="width: 50px; height: 50px; text-align: center; font-size: 1.5rem; border-radius: 8px; border: 1px solid #ccc;">
                <input type="text" name="otp_3" maxlength="1" required style="width: 50px; height: 50px; text-align: center; font-size: 1.5rem; border-radius: 8px; border: 1px solid #ccc;">
                <input type="text" name="otp_4" maxlength="1" required style="width: 50px; height: 50px; text-align: center; font-size: 1.5rem; border-radius: 8px; border: 1px solid #ccc;">
            </div>
            <button type="submit" style="background: linear-gradient(90deg, #b71c1c, #a00000); color: white; border: none; padding: 12px 30px; border-radius: 8px; font-weight: bold; cursor: pointer;">Verify Code</button>
        </form>
        
        <div style="margin-top: 15px;">
            <a href="{% url 'login' %}" style="text-decoration: none; color: #666;">Cancel</a>
        </div>
    </div>

    {% elif step == 'password' %}
    <div class="password-setup">
        <div style="font-size: 3rem; margin-bottom: 15px;">ðŸ”‘</div>
        <p>Identity verified. Please set your new password.</p>
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="step" value="set_password">

            <div class="form-group" style="text-align: left; margin-bottom: 15px;">
                <label>New password</label>
                <input type="password" name="new_password" required minlength="8" class="form-control" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc;">
            </div>

            <div class="form-group" style="text-align: left; margin-bottom: 20px;">
                <label>Confirm password</label>
                <input type="password" name="confirm_password" required minlength="8" class="form-control" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc;">
            </div>

            <button type="submit" style="background: linear-gradient(90deg, #b71c1c, #a00000); color: white; border: none; padding: 12px 30px; border-radius: 8px; font-weight: bold; cursor: pointer;">Reset Password</button>
        </form>
    </div>
    {% endif %}
</div>

<script>
    // Auto-focus logic
    const inputs = document.querySelectorAll('.otp-inputs input');
    inputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
            if (e.target.value.length === 1 && index < inputs.length - 1) {
                inputs[index + 1].focus();
            }
        });
    });
</script>
{% endblock %}
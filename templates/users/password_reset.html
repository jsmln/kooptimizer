{% extends 'base.html' %}
{% load static %}

{% block title %}Reset Password - KoopTimizer{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'frontend/first_login.css' %}">
<style>
    /* Modern Card Layout */
    body {
        background: linear-gradient(135deg, #800000, #2b0000) !important;
        min-height: 100vh; display: flex; align-items: center; justify-content: center;
    }
    .reset-card {
        background: #fff; width: 100%; max-width: 450px;
        padding: 40px; border-radius: 16px; box-shadow: 0 15px 35px rgba(0,0,0,0.3);
        text-align: center; animation: fadeInUp 0.4s ease;
    }
    @keyframes fadeInUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
    
    .icon-circle {
        width: 80px; height: 80px; background: #fff0f2; color: #b71c1c;
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        font-size: 2.5rem; margin: 0 auto 20px;
    }
    .otp-input {
        width: 50px; height: 50px; font-size: 1.5rem; text-align: center;
        border: 2px solid #eee; border-radius: 8px; transition: 0.2s;
    }
    .otp-input:focus { border-color: #b71c1c; outline: none; box-shadow: 0 0 0 3px rgba(183,28,28,0.1); }
</style>
{% endblock %}

{% block content %}
<div class="reset-card">
    
    {% if step == 'otp' %}
    <div class="icon-circle"><i class="bi bi-phone"></i></div>
    <h3 class="fw-bold mb-2" style="color:#2B3674;">Verification</h3>
    <p class="text-muted mb-4 small">We sent a code to <strong class="text-dark">{{ masked_mobile }}</strong></p>

    {% if messages %}
        {% for message in messages %}
            <div class="alert {% if message.tags == 'error' %}alert-danger{% else %}alert-success{% endif %} p-2 small">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="step" value="verify_otp">
        <div class="otp-inputs d-flex justify-content-center gap-2 mb-4">
            {% for i in "1234" %}
            <input type="text" name="otp_{{i}}" maxlength="1" class="otp-input" required autocomplete="off">
            {% endfor %}
        </div>
        <button type="submit" class="btn w-100 py-2 fw-bold text-white" style="background: #b71c1c;">Verify Code</button>
    </form>
    <a href="{% url 'login' %}" class="d-block mt-3 text-secondary small text-decoration-none">Cancel</a>

    {% elif step == 'password' %}
    <div class="icon-circle"><i class="bi bi-shield-lock-fill"></i></div>
    <h3 class="fw-bold mb-2" style="color:#2B3674;">New Password</h3>
    <p class="text-muted mb-4 small">Create a strong password for your account.</p>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-danger p-2 small">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <form method="post" class="text-start">
        {% csrf_token %}
        <input type="hidden" name="step" value="set_password">

        <div class="mb-3">
            <label class="form-label fw-bold small text-muted">New Password</label>
            <div class="position-relative">
                <input type="password" name="new_password" id="new_pass" class="form-control p-2" required minlength="8">
                <i class="bi bi-eye-slash position-absolute top-50 end-0 translate-middle-y me-3 cursor-pointer" 
                   style="cursor:pointer; color:#777;" onclick="togglePass('new_pass', this)"></i>
            </div>
        </div>

        <div class="mb-4">
            <label class="form-label fw-bold small text-muted">Confirm Password</label>
            <div class="position-relative">
                <input type="password" name="confirm_password" id="confirm_pass" class="form-control p-2" required>
                <i class="bi bi-eye-slash position-absolute top-50 end-0 translate-middle-y me-3 cursor-pointer" 
                   style="cursor:pointer; color:#777;" onclick="togglePass('confirm_pass', this)"></i>
            </div>
        </div>

        <button type="submit" class="btn w-100 py-2 fw-bold text-white" style="background: #b71c1c;">Reset Password</button>
    </form>
    {% endif %}
</div>

<script>
    // Auto-focus OTP
    const inputs = document.querySelectorAll('.otp-input');
    if(inputs.length > 0) {
        inputs[0].focus();
        inputs.forEach((input, index) => {
            input.addEventListener('input', (e) => {
                if (e.target.value && index < inputs.length - 1) inputs[index + 1].focus();
            });
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && !e.target.value && index > 0) inputs[index - 1].focus();
            });
        });
    }

    // Toggle Password
    function togglePass(id, icon) {
        const input = document.getElementById(id);
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.replace('bi-eye-slash', 'bi-eye');
        } else {
            input.type = 'password';
            icon.classList.replace('bi-eye', 'bi-eye-slash');
        }
    }
</script>
{% endblock %}
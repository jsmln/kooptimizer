{% extends "base.html" %}

{% load static %}

{% block title %}Login - KoopTimizer{% endblock %}
{% block extra_head %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{% static 'frontend/login.css' %}">
    <link rel="manifest" href="{% static 'manifest.json' %}">
    <meta name="apple-mobile-web-app-status-bar-style" content="#3367D6">
{% endblock %}

{% block content%}
{% comment %} Per-app templates should not render Django messages directly; the base template provides a floating message UI. {% endcomment %}
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    <link rel="stylesheet" href="{% static 'frontend/login.css' %}">
    <link rel="stylesheet" href="{% static 'path/to/bootstrap-icons.css' %}">

    {% if show_verification_flow %}
    <!-- VERIFICATION FLOW SECTION -->
    <section id="verification-flow" class="verification-container">
        <div class="verification-header">
            <h2>Account Verification</h2>
            <button type="button" class="btn-back" onclick="window.location.href='{% url 'login' %}'">
                <i class="bi bi-arrow-left"></i> Back to Login
            </button>
            
            <!-- Progress Bar -->
            {% if verification_step != 'success' %}
            <div class="progress-section">
                <div class="step-indicator">
                    {% if verification_step == 'start' %}
                    <span class="step-label">Step 1 of 3</span>
                    {% elif verification_step == 'otp' %}
                    <span class="step-label">Step 2 of 3</span>
                    {% elif verification_step == 'password' %}
                    <span class="step-label">Step 3 of 3</span>
                    {% endif %}
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" style="
                        {% if verification_step == 'start' %}width: 33.33%;
                        {% elif verification_step == 'otp' %}width: 66.66%;
                        {% elif verification_step == 'password' %}width: 100%;
                        {% endif %}
                    "></div>
                </div>
                <div class="step-dots">
                    <span class="dot {% if verification_step == 'start' or verification_step == 'otp' or verification_step == 'password' %}active{% endif %}" data-step="1">
                        <i class="bi bi-shield-lock"></i>
                    </span>
                    <span class="dot {% if verification_step == 'otp' or verification_step == 'password' %}active{% endif %}" data-step="2">
                        <i class="bi bi-phone"></i>
                    </span>
                    <span class="dot {% if verification_step == 'password' %}active{% endif %}" data-step="3">
                        <i class="bi bi-key"></i>
                    </span>
                </div>
            </div>
            {% endif %}
        </div>

        {% if verification_step == 'start' %}
        <!-- Step 1: Send OTP -->
        <div class="verification-step">
            <div class="step-title">Verify Your Phone Number</div>
            <div class="step-icon">
                <i class="bi bi-shield-lock"></i>
            </div>
            <p>To secure your account and comply with the <strong>Data Privacy Act of 2012 (Republic Act No. 10173)</strong>, we need to verify your phone number.</p>
            <p class="phone-number"><strong>Phone: {{ masked_mobile_number }}</strong></p>
            <form method="post" action="{% url 'users:first_login_setup' %}">
                {% csrf_token %}
                <input type="hidden" name="action" value="send_otp">
                <button type="submit" class="btn-primary">Send Verification Code</button>
            </form>
        </div>
        {% elif verification_step == 'otp' %}
        <!-- Step 2: Verify OTP -->
        <div class="verification-step">
            <div class="step-title">Enter Verification Code</div>
            <div class="step-icon">
                <i class="bi bi-phone"></i>
            </div>
            <p>Enter the 4-digit code sent to <strong>{{ masked_mobile_number }}</strong></p>
            <form method="post" action="{% url 'users:first_login_setup' %}">
                {% csrf_token %}
                <input type="hidden" name="action" value="verify_otp">
                <div class="otp-inputs">
                    <input type="text" name="otp_1" maxlength="1" pattern="[0-9]" required autofocus>
                    <input type="text" name="otp_2" maxlength="1" pattern="[0-9]" required>
                    <input type="text" name="otp_3" maxlength="1" pattern="[0-9]" required>
                    <input type="text" name="otp_4" maxlength="1" pattern="[0-9]" required>
                </div>
                <button type="submit" class="btn-primary">Verify Code</button>
            </form>
            <form method="post" action="{% url 'users:first_login_setup' %}" style="margin-top: 15px;">
                {% csrf_token %}
                <input type="hidden" name="action" value="send_otp">
                <button type="submit" class="btn-secondary">Resend Code</button>
            </form>
        </div>
        {% elif verification_step == 'password' %}
        <!-- Step 3: Set Password & Accept Terms -->
        <div class="verification-step">
            <div class="step-title">Create Your Password</div>
            <div class="step-icon">
                <i class="bi bi-key"></i>
            </div>
            <p>Set a strong password for your account (minimum 8 characters)</p>
            <form method="post" action="{% url 'users:first_login_setup' %}" id="password-form">
                {% csrf_token %}
                <input type="hidden" name="action" value="change_password">
                
                <div class="form-group">
                    <label for="new_password">New Password</label>
                    <div class="password-input-wrapper">
                        <input type="password" name="new_password" id="new_password" required minlength="8" class="form-control">
                        <i class="bi bi-eye-slash toggle-password" data-target="new_password"></i>
                    </div>
                </div>

                <div class="form-group">
                    <label for="confirm_password">Confirm Password</label>
                    <div class="password-input-wrapper">
                        <input type="password" name="confirm_password" id="confirm_password" required minlength="8" class="form-control">
                        <i class="bi bi-eye-slash toggle-password" data-target="confirm_password"></i>
                    </div>
                </div>

                <!-- Terms & Privacy Policy Checkbox -->
                <div class="form-group terms-acceptance">
                    <label class="checkbox-container">
                        <input type="checkbox" name="accept_terms" id="accept_terms" required>
                        <span class="checkmark"></span>
                        <span class="terms-text">
                            I agree to the <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal" onclick="event.preventDefault()" data-bs-toggle="modal" data-bs-target="#termsModal">Terms & Conditions</a> 
                            and <a href="#" onclick="event.preventDefault()" data-bs-toggle="modal" data-bs-target="#privacyModal">Privacy Policy</a> 
                            in accordance with the <strong>Data Privacy Act of 2012</strong> (Republic Act No. 10173)
                        </span>
                    </label>
                </div>

                <button type="submit" class="btn-primary" id="submit-btn">Complete Setup</button>
            </form>
        </div>
        
        <!-- Footer -->
        <div class="verification-footer">
            <p>Need help? <a href="{% url 'contact' %}">Contact Support</a></p>
        </div>
        {% elif verification_step == 'success' %}
        <!-- Step 4: Success - Redirect to Login -->
        <div class="verification-step success-step">
            <div class="step-icon success-icon">
                <i class="bi bi-check-circle-fill"></i>
            </div>
            <h3>Account Verified Successfully!</h3>
            <p>Your account has been set up and is ready to use.</p>
            <p class="redirect-message">You will be redirected to login in <span id="countdown">5</span> seconds...</p>
            
            <button type="button" class="btn-primary" onclick="window.location.href='{% url 'login' %}'">
                <i class="bi bi-box-arrow-in-right"></i> Login Now
            </button>
        </div>
        
        <!-- Footer -->
        <div class="verification-footer">
            <p>Successfully verified! Welcome to KoopTimizer</p>
        </div>
        {% endif %}
    </section>

    <!-- Terms & Conditions Modal -->
    <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="termsModalLabel">Terms & Conditions</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6>1. Acceptance of Terms</h6>
                    <p>By accessing and using KoopTimizer, you accept and agree to be bound by these Terms & Conditions.</p>
                    
                    <h6>2. User Responsibilities</h6>
                    <p>You are responsible for maintaining the confidentiality of your account credentials and for all activities under your account.</p>
                    
                    <h6>3. Data Usage</h6>
                    <p>Your data will be used solely for the purposes of cooperative management and compliance with applicable Philippine laws.</p>
                    
                    <!-- Add more terms as needed -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Privacy Policy Modal -->
    <div class="modal fade" id="privacyModal" tabindex="-1" aria-labelledby="privacyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="privacyModalLabel">Privacy Policy - Data Privacy Act of 2012</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6>Data Privacy Act of 2012 Compliance</h6>
                    <p>KoopTimizer is committed to protecting your personal information in accordance with the Data Privacy Act of 2012 (Republic Act No. 10173).</p>
                    
                    <h6>Information We Collect</h6>
                    <ul>
                        <li>Personal identification information (name, contact details)</li>
                        <li>Cooperative membership information</li>
                        <li>Transaction and communication records</li>
                    </ul>
                    
                    <h6>How We Use Your Information</h6>
                    <ul>
                        <li>To provide cooperative management services</li>
                        <li>To communicate important announcements</li>
                        <li>To comply with legal and regulatory requirements</li>
                    </ul>
                    
                    <h6>Your Rights</h6>
                    <p>Under the Data Privacy Act, you have the right to:</p>
                    <ul>
                        <li>Access your personal data</li>
                        <li>Correct inaccurate data</li>
                        <li>Request data portability</li>
                        <li>Object to processing</li>
                        <li>Request erasure (subject to legal requirements)</li>
                    </ul>
                    
                    <h6>Data Security</h6>
                    <p>We implement appropriate technical and organizational measures to protect your personal information.</p>
                    
                    <!-- Add more privacy policy content as needed -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- NORMAL LOGIN SECTION -->
    <section id="login">
        <h2>Login</h2>
{% comment %}         
        {% if messages %}
            {% for message in messages %}
                <div class="alert {% if message.tags == 'error' %}alert-danger{% else %}alert-info{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %} {% endcomment %}

        <form id="login-form" method="POST">
            {% csrf_token %} 
            
            <div>
                <label for="username">Username or Email:</label>
                <input type="text" id="username" name="username" placeholder="Enter your username" required>
            </div>

            <div class="password-wrapper">
                <label for="password">Password:</label>
                <input type="password" id="password" name="password" placeholder="Enter your password" required>
                <i class="bi bi-eye-slash" id="togglePassword"></i>
                
                <a href="#" class="forgot-password-link" data-bs-toggle="modal" data-bs-target="#forgotPasswordModal">
                    Forgot Password?
                </a>
            </div>

            <div id="recaptcha-placeholder" class="g-recaptcha" data-sitekey="6LeepvErAAAAAP3XNLdmBipdELXOuZqfo13T6lYE">
            </div>

            <button type="submit">Login</button>

            <div class="contact-support">
                <p>Need help? <a href="{% url 'contact' %}">Contact Support</a></p>
            </div>

        </form>
        </section>

    <div class="modal fade" id="forgotPasswordModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 16px; overflow: hidden; border: none;">
            
            <div class="modal-header" style="background-color: #b71c1c; color: white; padding: 15px 25px; border: none;">
                <h5 class="modal-title fw-bold" style="font-size: 1.2rem;">Reset Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
            </div>
            
            <div class="modal-body" style="padding: 30px;">
                <p style="color: #666; margin-bottom: 20px;">Choose how you want to reset your password.</p>
                
                <form action="{% url 'users:initiate_password_reset' %}" method="POST">
                    {% csrf_token %}
                    
                    <div class="d-flex gap-3 mb-4">
                        <div style="flex: 1;">
                            <input type="radio" class="btn-check" name="reset_method" id="method_email" value="email" checked onchange="toggleResetInput()">
                            <label class="btn btn-outline-danger w-100 p-3 d-flex flex-column align-items-center justify-content-center" for="method_email" style="height: 100px; border: 2px solid #eee; border-radius: 12px; color: #b71c1c; transition: 0.2s;">
                                <i class="bi bi-envelope-fill" style="font-size: 1.8rem; margin-bottom: 5px;"></i>
                                <span style="font-weight: 600;">Email Link</span>
                            </label>
                        </div>

                        <div style="flex: 1;">
                            <input type="radio" class="btn-check" name="reset_method" id="method_sms" value="sms" onchange="toggleResetInput()">
                            <label class="btn btn-outline-danger w-100 p-3 d-flex flex-column align-items-center justify-content-center" for="method_sms" style="height: 100px; border: 2px solid #eee; border-radius: 12px; color: #b71c1c; transition: 0.2s;">
                                <i class="bi bi-chat-dots-fill" style="font-size: 1.8rem; margin-bottom: 5px;"></i>
                                <span style="font-weight: 600;">SMS Code</span>
                            </label>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div id="input-email-group">
                            <label class="fw-bold" style="font-size: 0.85rem; color: #333; margin-bottom: 5px; display: block;">Email Address</label>
                            <input type="email" name="identifier" id="input-email" class="form-control" placeholder="name@example.com" style="padding: 12px; border-radius: 8px;">
                        </div>
                        <div id="input-sms-group" style="display: none;">
                            <label class="fw-bold" style="font-size: 0.85rem; color: #333; margin-bottom: 5px; display: block;">Mobile Number or Username</label>
                            <input type="text" name="identifier" id="input-sms" class="form-control" placeholder="09123456789" disabled style="padding: 12px; border-radius: 8px;">
                        </div>
                    </div>
                    
                    <button type="submit" class="btn w-100 py-2 fw-bold text-white" style="background: #b71c1c; border-radius: 8px; padding: 12px;">
                        Continue <i class="bi bi-arrow-right ms-2"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .btn-check:checked + label {
        background-color: #fff0f2 !important;
        border-color: #b71c1c !important;
        color: #b71c1c !important;
        box-shadow: 0 0 0 2px #b71c1c inset;
    }
    .btn-check + label:hover {
        background-color: #f9f9f9;
    }
</style>

    
    {% endif %}

       <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        function toggleResetInput() {
            const isEmail = document.getElementById('method_email').checked;
            document.getElementById('input-email-group').style.display = isEmail ? 'block' : 'none';
            document.getElementById('input-sms-group').style.display = isEmail ? 'none' : 'block';
            document.getElementById('input-email').disabled = !isEmail;
            document.getElementById('input-sms').disabled = isEmail;
            
            // Visual update for active state
            const labels = document.querySelectorAll('.btn-outline-danger');
            labels.forEach(l => {
                l.style.backgroundColor = 'white';
                l.style.color = '#b71c1c';
            });
            const activeId = isEmail ? 'method_email' : 'method_sms';
            const activeLabel = document.querySelector(`label[for="${activeId}"]`);
            if(activeLabel) {
                activeLabel.style.backgroundColor = '#b71c1c';
                activeLabel.style.color = 'white';
            }
        }
        // Init state
        document.addEventListener('DOMContentLoaded', toggleResetInput);
    </script>

    <script>
        const togglePassword = document.querySelector('#togglePassword');
        const password = document.querySelector('#password');

        if (togglePassword && password) {
            togglePassword.addEventListener('click', function (e) {
                const type = password.getAttribute('type') === 'password' ? 'text' : 'password';
                password.setAttribute('type', type);
                this.classList.toggle('bi-eye');
                this.classList.toggle('bi-eye-slash');
            });
        }

        // OTP input auto-focus
        const otpInputs = document.querySelectorAll('.otp-inputs input');
        if (otpInputs.length > 0) {
            otpInputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    if (e.target.value.length === 1 && index < otpInputs.length - 1) {
                        otpInputs[index + 1].focus();
                    }
                });
                
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && e.target.value === '' && index > 0) {
                        otpInputs[index - 1].focus();
                    }
                });
            });
        }

        // Password form validation - prevent submission without terms acceptance
        const passwordForm = document.getElementById('password-form');
        const acceptTermsCheckbox = document.getElementById('accept_terms');
        const submitBtn = document.getElementById('submit-btn');

        if (passwordForm && acceptTermsCheckbox) {
            passwordForm.addEventListener('submit', function(e) {
                if (!acceptTermsCheckbox.checked) {
                    e.preventDefault();
                    alert('You must accept the Terms & Conditions and Privacy Policy to continue.');
                    acceptTermsCheckbox.focus();
                    return false;
                }
            });
        }

        // Toggle password visibility for verification flow
        const togglePasswordBtns = document.querySelectorAll('.toggle-password');
        togglePasswordBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const targetId = this.getAttribute('data-target');
                const targetInput = document.getElementById(targetId);
                
                if (targetInput) {
                    const type = targetInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    targetInput.setAttribute('type', type);
                    this.classList.toggle('bi-eye');
                    this.classList.toggle('bi-eye-slash');
                }
            });
        });

        // Success page countdown and auto-redirect
        const countdownElement = document.getElementById('countdown');
        if (countdownElement) {
            let seconds = 5;
            const countdownInterval = setInterval(() => {
                seconds--;
                countdownElement.textContent = seconds;
                
                if (seconds <= 0) {
                    clearInterval(countdownInterval);
                    window.location.href = '{% url "login" %}';
                }
            }, 1000);
        }

        // Protect OTP send forms from double-submission
        const otpForms = document.querySelectorAll('form[action*="first_login_setup"]');
        otpForms.forEach(form => {
            const action = form.querySelector('input[name="action"]');
            if (action && action.value === 'send_otp') {
                const submitBtn = form.querySelector('button[type="submit"]');
                
                if (submitBtn) {
                    form.addEventListener('submit', function(e) {
                        // Check if already submitting
                        if (submitBtn.disabled) {
                            e.preventDefault();
                            return false;
                        }
                        
                        // Disable button and show loading state
                        submitBtn.disabled = true;
                        const originalText = submitBtn.textContent;
                        submitBtn.innerHTML = '<span class="spinner-border-sm"></span> Sending...';
                        submitBtn.style.opacity = '0.6';
                        submitBtn.style.cursor = 'not-allowed';
                        
                        // Re-enable after 5 seconds (in case of error, user can retry)
                        setTimeout(() => {
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalText;
                            submitBtn.style.opacity = '1';
                            submitBtn.style.cursor = 'pointer';
                        }, 5000);
                    });
                }
            }
        });

        // Protect password reset form from double-submission
        const passwordResetForm = document.querySelector('form[action*="password-reset/init"]');
        if (passwordResetForm) {
            const submitBtn = passwordResetForm.querySelector('button[type="submit"]');
            
            if (submitBtn) {
                passwordResetForm.addEventListener('submit', function(e) {
                    // Check if already submitting
                    if (submitBtn.disabled) {
                        e.preventDefault();
                        return false;
                    }
                    
                    // Disable button and show loading state
                    submitBtn.disabled = true;
                    const originalText = submitBtn.textContent;
                    submitBtn.innerHTML = '<span class="spinner-border-sm"></span> Searching...';
                    submitBtn.style.opacity = '0.6';
                    submitBtn.style.cursor = 'not-allowed';
                    
                    // Re-enable after 5 seconds (in case of error, user can retry)
                    setTimeout(() => {
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                        submitBtn.style.opacity = '1';
                        submitBtn.style.cursor = 'pointer';
                    }, 5000);
                });
            }
        }
    </script>

    <style>
        /* Spinner for OTP button loading state */
        .spinner-border-sm {
            display: inline-block;
            width: 0.875rem;
            height: 0.875rem;
            vertical-align: text-bottom;
            border: 0.125em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border 0.75s linear infinite;
        }

        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }
    </style>

{% endblock %}
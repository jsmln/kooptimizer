{% extends 'dashboard/dashboard.html' %}
{% load static %}

{% block dashboard_title %}Profile Management{% endblock %}

{% block extra_head %}
    {{ block.super }}
    {# You can move this CSS to a separate file if you prefer #}
    <link rel="stylesheet" href="{% static 'frontend/profile_form.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.10.0/dist/css/bootstrap-datepicker.min.css">
{% endblock %}

{% block dashboard_content %}
<div class="profile-list-container">
    <div class="page-header">
        <div>
            <h2><i class="bi bi-building"></i> Cooperative Profile</h2>
            <p class="text-muted mb-0">View and manage your cooperative's information</p>
        </div>
        {# Show Create button only if profile does not exist #}
        {% if not profile %}
        <button type="button" class="create-profile-btn" data-bs-toggle="modal" data-bs-target="#createProfileModal">
            <i class="bi bi-plus-circle"></i> Create Profile
        </button>
        {% endif %}
    </div>

    {# --- DISPLAY SECTION --- #}
    {% if profile %}
    <div class="profile-details-card">
        <div class="profile-header">
            <div class="header-left">
                <h3>{{ profile.coop_name|default:coop_name }}</h3>
                <div class="status-badge status-{{ profile.approval_status|lower }}">
                    <i class="bi bi-circle-fill"></i> {{ profile.approval_status|default:"Pending"|title }}
                </div>
            </div>
            <div class="header-right">
                <button type="button" class="btn-edit" data-bs-toggle="modal" data-bs-target="#createProfileModal">
                    <i class="bi bi-pencil"></i> Edit Profile
                </button>
            </div>
        </div>

        <div class="info-section">
            <h4 class="section-title"><i class="bi bi-info-circle"></i> General Information</h4>
            <div class="info-grid">
                <div class="info-item">
                    <label>Cooperative Name</label>
                    <p>{{ profile.coop_name|default:coop_name }}</p>
                </div>
                <div class="info-item">
                    <label>Address</label>
                    <p>{{ profile.address|default:"N/A" }}</p>
                </div>
                <div class="info-item">
                    <label>Area of Operation</label>
                    <p>{{ profile.operation_area|title|default:"N/A" }}</p>
                </div>
                <div class="info-item">
                    <label>Contact Number</label>
                    <p>{{ profile.mobile_number|default:"N/A" }}</p>
                </div>
                <div class="info-item">
                    <label>Email Address</label>
                    <p>{{ profile.email_address|default:"N/A" }}</p>
                </div>
                <div class="info-item">
                    <label>CDA Registration No.</label>
                    <p>{{ profile.cda_registration_number|default:"N/A" }}</p>
                </div>
                <div class="info-item">
                    <label>CDA Registration Date</label>
                    <p>{{ profile.cda_registration_date|date:"M d, Y"|default:"N/A" }}</p>
                </div>
                <div class="info-item">
                    <label>LCCDC Membership</label>
                    <p>
                        {% if profile.lccdc_membership %}
                            <span class="badge bg-success">Yes</span>
                            {% if profile.lccdc_membership_date %}
                                ({{ profile.lccdc_membership_date|date:"M d, Y" }})
                            {% endif %}
                        {% else %}
                            <span class="badge bg-secondary">No</span>
                        {% endif %}
                    </p>
                </div>
                <div class="info-item">
                    <label>Business Activity</label>
                    <p>{{ profile.business_activity|default:"N/A" }}</p>
                </div>
                <div class="info-item">
                    <label>No. of Board Directors</label>
                    <p>{{ profile.board_of_directors_count|default:"0" }}</p>
                </div>
                <div class="info-item">
                    <label>No. of Salaried Employees</label>
                    <p>{{ profile.salaried_employees_count|default:"0" }}</p>
                </div>
                <div class="info-item">
                    <label>Last Reporting Year</label>
                    <p>{{ profile.report_year|default:"N/A" }}</p>
                </div>
            </div>
        </div>

        <div class="info-section">
            <h4 class="section-title"><i class="bi bi-file-earmark-check"></i> Certificates</h4>
            <div class="info-grid">
                <div class="info-item">
                    <label>Certificate of Compliance</label>
                    <p>
                        {% if profile.coc_renewal %}
                            <span class="badge bg-success"><i class="bi bi-check-circle"></i> Available</span>
                            {% if profile.coc_attachment %}
                                <a href="{% url 'cooperatives:download_attachment' profile.coop_id 'coc' %}" class="download-link">
                                    <i class="bi bi-download"></i> Download
                                </a>
                            {% endif %}
                        {% else %}
                            <span class="badge bg-warning">Not Available</span>
                        {% endif %}
                    </p>
                </div>
                <div class="info-item">
                    <label>Certificate of Tax Exemption</label>
                    <p>
                        {% if profile.cote_renewal %}
                            <span class="badge bg-success"><i class="bi bi-check-circle"></i> Available</span>
                            {% if profile.cote_attachment %}
                                <a href="{% url 'cooperatives:download_attachment' profile.coop_id 'cte' %}" class="download-link">
                                    <i class="bi bi-download"></i> Download
                                </a>
                            {% endif %}
                        {% else %}
                            <span class="badge bg-warning">Not Available</span>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>

        <div class="info-section">
            <h4 class="section-title"><i class="bi bi-currency-dollar"></i> Financial Information</h4>
            <div class="info-grid">
                <div class="info-item">
                    <label>Assets (PHP)</label>
                    <p class="financial-value">₱ {{ profile.assets|floatformat:2|default:"0.00" }}</p>
                </div>
                <div class="info-item">
                    <label>Paid Up Capital (PHP)</label>
                    <p class="financial-value">₱ {{ profile.paid_up_capital|floatformat:2|default:"0.00" }}</p>
                </div>
                <div class="info-item">
                    <label>Net Surplus (PHP)</label>
                    <p class="financial-value">₱ {{ profile.net_surplus|floatformat:2|default:"0.00" }}</p>
                </div>
                <div class="info-item full-width">
                    <label>Financial Documents</label>
                    <p>
                        {% if profile.financial_attachments_exist %}
                            <a href="{% url 'cooperatives:download_attachment' profile.coop_id 'financial' %}" class="download-link">
                                <i class="bi bi-download"></i> Download Documents
                            </a>
                        {% else %}
                            <span class="text-muted">No documents attached</span>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>

        {% if officers %}
        <div class="info-section">
            <h4 class="section-title"><i class="bi bi-people"></i> Cooperative Officers</h4>
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Position</th>
                            <th>Gender</th>
                            <th>Mobile Number</th>
                            <th>Email</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for officer in officers %}
                        <tr>
                            <td>{{ officer.fullname }}</td>
                            <td>{{ officer.position }}</td>
                            <td>{{ officer.gender }}</td>
                            <td>{{ officer.mobile_number|default:"N/A" }}</td>
                            <td>{{ officer.email|default:"N/A" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        {% if members %}
        <div class="info-section">
            <h4 class="section-title"><i class="bi bi-person-badge"></i> Cooperative Members</h4>
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Gender</th>
                            <th>Mobile Number</th>
                            <th>Email</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for member in members %}
                        <tr>
                            <td>{{ member.fullname }}</td>
                            <td>{{ member.gender|default:"N/A" }}</td>
                            <td>{{ member.mobile_number|default:"N/A" }}</td>
                            <td>{{ member.email|default:"N/A" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </div>
    {% else %}
    <div class="empty-state">
        <i class="bi bi-inbox"></i>
        <h3>No Profile Found</h3>
        <p>Create your cooperative profile to get started.</p>
        <button type="button" class="create-profile-btn" data-bs-toggle="modal" data-bs-target="#createProfileModal">
            <i class="bi bi-plus-circle"></i> Create Profile Now
        </button>
    </div>
    {% endif %}
</div>

{# --- MODAL SECTION --- #}
<div class="modal fade" id="createProfileModal" tabindex="-1" aria-labelledby="createProfileLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createProfileLabel">
                    {% if profile %}Edit{% else %}Create{% endif %} Cooperative Profile
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body bg-light p-0">
                <div class="profile-form-container">
                    <form method="POST" enctype="multipart/form-data" id="profileForm" action="{% url 'cooperatives:create_profile' %}">
                        {% csrf_token %}
                        
                        <fieldset>
                            <legend>General Information</legend>

                            <div class="form-group">
                                <label for="coop-name" class="required">Name of Cooperative</label>
                                <input type="text" id="coop-name" name="coop_name" value="{{ profile.coop_name|default:coop_name|default:'' }}" readonly style="background-color: #f8f9fa;">
                            </div>

                            <div class="form-group">
                                <label for="coop-address" class="required">Cooperative Address</label>
                                <input type="text" id="coop-address" name="coop_address" value="{{ profile.address|default:'' }}" placeholder="Enter Cooperative Address" required>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="area-operation" class="required">Area of Operation</label>
                                    <select id="area-operation" name="area_operation" required>
                                        <option value="">Select area</option>
                                        <option value="city" {% if profile.operation_area == 'city' %}selected{% endif %}>City</option>
                                        <option value="municipal" {% if profile.operation_area == 'municipal' %}selected{% endif %}>Municipal</option>
                                        <option value="provincial" {% if profile.operation_area == 'provincial' %}selected{% endif %}>Provincial</option>
                                        <option value="regional" {% if profile.operation_area == 'regional' %}selected{% endif %}>Regional</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="business-activity" class="required">Business Activity</label>
                                    <input type="text" id="business-activity" name="business_activity" value="{{ profile.business_activity|default:'' }}" placeholder="e.g. Transport, Service" required>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="coop-contact" class="required">Contact Number</label>
                                    <input type="tel" id="coop-contact" name="coop_contact" value="{{ profile.mobile_number|default:'' }}" placeholder="09*********" required>
                                </div>
                                <div class="form-group">
                                    <label for="coop-email" class="required">Email Address</label>
                                    <input type="email" id="coop-email" name="coop_email" value="{{ profile.email_address|default:'' }}" placeholder="sample@gmail.com" required>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="cda-reg-num" class="required">CDA Registration No.</label>
                                    <input type="text" id="cda-reg-num" name="cda_reg_num" value="{{ profile.cda_registration_number|default:'' }}" placeholder="****-*********" required>
                                </div>
                                <div class="form-group">
                                    <label for="cda-reg-date" class="required">Registration Date</label>
                                    <input type="date" id="cda-reg-date" name="cda_reg_date" value="{{ profile.cda_registration_date|date:'Y-m-d' }}" required>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="required">LCCDC Membership</label>
                                    <div class="form-check-group">
                                        <label class="radio-container">Yes
                                            <input type="radio" name="lccdc_membership" value="yes" {% if profile.lccdc_membership %}checked{% endif %} required>
                                            <span class="checkmark"></span>
                                        </label>
                                        <label class="radio-container">No
                                            <input type="radio" name="lccdc_membership" value="no" {% if not profile.lccdc_membership %}checked{% endif %} required>
                                            <span class="checkmark"></span>
                                        </label>
                                    </div>
                                </div>

                                <div class="form-group lccdc-membership-date" style="display: {% if profile.lccdc_membership %}block{% else %}none{% endif %};">
                                    <label for="lccdc-membership-date" class="required">LCCDC Membership Date</label>
                                    <input type="date" id="lccdc-membership-date" name="lccdc_membership_date" value="{{ profile.lccdc_membership_date|date:'Y-m-d' }}">
                                </div>

                                <div class="form-group lccdc-not-member" style="display: {% if not profile.lccdc_membership %}block{% else %}none{% endif %};">
                                    <p style="font-size:0.9rem; font-style:italic; margin:0;">Not an LCCDC member.</p>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="num-bod" class="required">No. of Board Directors</label>
                                    <input type="number" id="num-bod" name="num_bod" value="{{ profile.board_of_directors_count }}" placeholder="0" required>
                                </div>
                                <div class="form-group">
                                    <label for="num-se" class="required">No. of Salaried Employees</label>
                                    <input type="number" id="num-se" name="num_se" value="{{ profile.salaried_employees_count }}" placeholder="0" required>
                                </div>
                            </div>

                            <div class="form-row checkbox-row">
                                <div class="form-group">
                                    <label class="required">Certificate of Compliance</label>
                                    <div class="form-check-group">
                                        <label class="radio-container">Yes
                                            <input type="radio" name="coc" value="yes" {% if profile.coc_renewal %}checked{% endif %} required>
                                            <span class="checkmark"></span>
                                        </label>
                                        <label class="radio-container">No
                                            <input type="radio" name="coc" value="no" {% if not profile.coc_renewal %}checked{% endif %} required>
                                            <span class="checkmark"></span>
                                        </label>
                                    </div>

                                    <div class="file-upload-single coc-file-group" style="display: {% if profile.coc_renewal %}block{% else %}none{% endif %}; margin-top: .5rem;">
                                        <label for="coc-file" class="file-label"><i class="bi bi-cloud-upload"></i> Upload CoC</label>
                                        {# data-has-file attribute prevents 'required' on edit if file exists #}
                                        <input type="file" id="coc-file" name="coc_file" accept=".pdf,image/*,.doc,.docx,.xls,.xlsx" {% if profile.coc_attachment %}data-has-file="true"{% endif %}>
                                        <div class="file-name" id="coc-file-name" style="margin-top:.25rem;color:#333;">
                                            {% if profile.coc_attachment %}File already uploaded (upload new to replace){% endif %}
                                        </div>
                                    </div>
                                    <div class="not-available coc-not-available" style="display: {% if not profile.coc_renewal %}block{% else %}none{% endif %}; margin-top:.5rem;">
                                        <p style="font-size:0.9rem; font-style:italic; margin:0;">Please upload renewed certificate ASAP.</p>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="required">Certificate of Tax Exemption</label>
                                    <div class="form-check-group">
                                        <label class="radio-container">Yes
                                            <input type="radio" name="cte" value="yes" {% if profile.cote_renewal %}checked{% endif %} required>
                                            <span class="checkmark"></span>
                                        </label>
                                        <label class="radio-container">No
                                            <input type="radio" name="cte" value="no" {% if not profile.cote_renewal %}checked{% endif %} required>
                                            <span class="checkmark"></span>
                                        </label>
                                    </div>

                                    <div class="file-upload-single cte-file-group" style="display: {% if profile.cote_renewal %}block{% else %}none{% endif %}; margin-top: .5rem;">
                                        <label for="cte-file" class="file-label"><i class="bi bi-cloud-upload"></i> Upload CTE</label>
                                        <input type="file" id="cte-file" name="cte_file" accept=".pdf,image/*,.doc,.docx,.xls,.xlsx" {% if profile.cote_attachment %}data-has-file="true"{% endif %}>
                                        <div class="file-name" id="cte-file-name" style="margin-top:.25rem;color:#333;">
                                            {% if profile.cote_attachment %}File already uploaded (upload new to replace){% endif %}
                                        </div>
                                    </div>
                                    <div class="not-available cte-not-available" style="display: {% if not profile.cote_renewal %}block{% else %}none{% endif %}; margin-top:.5rem;">
                                        <p style="font-size:0.9rem; font-style:italic; margin:0;">Please upload renewed certificate ASAP.</p>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                        
                        <fieldset>
                            <legend>Financial Records</legend>
                            
                            <div class="form-group">
                                <label class="required">Please upload documents for Assets, Net Surplus, and Paid Up Capital AND enter the amounts below.</label>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="assets-value" class="required">Assets (PHP)</label>
                                        <input type="text" id="assets-value" name="assets_value" value="{{ profile.assets|default:'0.00' }}" inputmode="decimal" placeholder="0.00" required>
                                    </div>

                                    <div class="form-group">
                                        <label for="paid-up-capital-value" class="required">Paid Up Capital (PHP)</label>
                                        <input type="text" id="paid-up-capital-value" name="paid_up_capital_value" value="{{ profile.paid_up_capital|default:'0.00' }}" inputmode="decimal" placeholder="0.00" required>
                                    </div>

                                    <div class="form-group">
                                        <label for="net-surplus-value" class="required">Net Surplus (PHP)</label>
                                        <input type="text" id="net-surplus-value" name="net_surplus_value" value="{{ profile.net_surplus|default:'0.00' }}" inputmode="decimal" placeholder="0.00" required>
                                    </div>
                                </div>

                                <div class="file-upload-wrapper">
                                    <label for="financial-docs" class="file-label"><i class="bi bi-cloud-upload"></i> Choose Files</label>
                                    {# Required only if no profile exists (fresh create), otherwise optional on edit #}
                                    <input type="file" id="financial-docs" name="financial_documents" class="file-input" multiple accept=".pdf,image/*,.doc,.docx,.xls,.xlsx" {% if not profile %}required{% endif %}>
                                </div>

                                <div id="file-preview-container" class="file-preview-container">
                                    <div class="no-files">
                                        {% if profile.financial_attachments_exist %}
                                            Previous documents exist. Uploading new files will append to the record.
                                        {% else %}
                                            No files selected
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </fieldset>

                        <fieldset>
                            <legend>Cooperative Officers</legend>
                            <p class="input-instruction">These officers are already registered. (Read-only)</p>
                            <div class="input-table-container">
                                <table class="input-table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Position</th>
                                            <th>Gender</th>
                                            <th>Mobile Number</th>
                                            <th>Email</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for officer in officers %}
                                        <tr>
                                            <td><input type="text" value="{{ officer.fullname }}" readonly style="background-color: #f8f9fa;"></td>
                                            <td><input type="text" value="{{ officer.position }}" readonly style="background-color: #f8f9fa;"></td>
                                            <td><input type="text" value="{{ officer.gender }}" readonly style="background-color: #f8f9fa;"></td>
                                            <td><input type="text" value="{{ officer.mobile_number }}" readonly style="background-color: #f8f9fa;"></td>
                                            <td><input type="email" value="{{ officer.email }}" readonly style="background-color: #f8f9fa;"></td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="5" style="text-align: center; color: #A3AED0;">No officers found in database</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </fieldset>

                        <fieldset>
                            <legend>Cooperative Members</legend>
                            <p class="input-instruction">List of members. (At least one entry required)</p>
                            
                            <div class="input-table-container">
                                <table class="input-table">
                                    <thead>
                                        <tr>
                                            <th class="required">Name</th>
                                            <th class="required">Gender</th>
                                            <th class="required">Mobile Number</th>
                                            <th class="required">Email</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {# Edit Mode: Populate existing members #}
                                        {% if members %}
                                            {% for member in members %}
                                            <tr>
                                                <td><input type="text" name="member_name[]" value="{{ member.fullname }}" placeholder="Full Name" required></td>
                                                <td>
                                                    <select name="member_gender[]" required>
                                                        <option value="">Select</option>
                                                        <option value="Male" {% if member.gender == 'Male' %}selected{% endif %}>Male</option>
                                                        <option value="Female" {% if member.gender == 'Female' %}selected{% endif %}>Female</option>
                                                    </select>
                                                </td>
                                                <td><input type="text" name="member_mobile[]" value="{{ member.mobile_number }}" placeholder="09xxxxxxxxx" required></td>
                                                <td><input type="email" name="member_email[]" value="{{ member.email }}" placeholder="Email" required></td>
                                            </tr>
                                            {% endfor %}
                                        {# Create Mode: Show empty rows #}
                                        {% else %}
                                            <tr>
                                                <td><input type="text" name="member_name[]" placeholder="Full Name" required></td>
                                                <td>
                                                    <select name="member_gender[]" required>
                                                        <option value="">Select</option>
                                                        <option value="Male">Male</option>
                                                        <option value="Female">Female</option>
                                                    </select>
                                                </td>
                                                <td><input type="text" name="member_mobile[]" placeholder="09xxxxxxxxx" required></td>
                                                <td><input type="email" name="member_email[]" placeholder="Email" required></td>
                                            </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                                <button type="button" class="add-row-btn"><i class="bi bi-plus-circle"></i> Add Row</button>
                            </div>
                        </fieldset>

                        <div class="form-group">
                            <label for="reporting-year" class="required">Reporting Year</label>
                            <input type="text" id="reporting-year" name="reporting_year" value="{{ profile.report_year }}" class="form-control" required autocomplete="off" placeholder="YYYY">
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="submit-btn" id="saveProfileBtn">
                                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                <i class="bi bi-save"></i> Save Profile
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.10.0/dist/js/bootstrap-datepicker.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    
    // --- AJAX FORM SUBMISSION ---
    const profileForm = document.getElementById('profileForm');
    const saveBtn = document.getElementById('saveProfileBtn');
    const spinner = saveBtn ? saveBtn.querySelector('.spinner-border') : null;
    
    if (profileForm) {
        profileForm.addEventListener('submit', function(e) {
            e.preventDefault(); 
            
            if(saveBtn) {
                saveBtn.disabled = true;
                if(spinner) spinner.classList.remove('d-none');
                saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
            }

            const formData = new FormData(profileForm);

            // If using the custom file uploader logic below, we need to manually ensure files are attached
            // Note: standard FormData(form) usually grabs inputs, but if 'allSelectedFiles' logic modifies inputs dynamically,
            // verify the backend receives it. The logic below updates the file input .files property so FormData should catch it.

            fetch(profileForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Profile saved successfully!');
                    location.reload(); 
                } else {
                    alert('Error: ' + (data.error || 'Unknown error occurred'));
                    if(saveBtn) {
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = '<i class="bi bi-save"></i> Save Profile';
                        if(spinner) spinner.classList.add('d-none');
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while communicating with the server.');
                if(saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="bi bi-save"></i> Save Profile';
                    if(spinner) spinner.classList.add('d-none');
                }
            });
            .then(data => {
                if (data.success) {
                    alert('Profile saved successfully!');
                    location.reload(); 
                } else {
                    // IMPROVED ERROR LOGGING
                    console.error("Server Error Detail:", data.error);
                    alert('Error saving data: ' + (data.error || 'Check console for details'));
                    
                    if(saveBtn) {
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = '<i class="bi bi-save"></i> Save Profile';
                        if(spinner) spinner.classList.add('d-none');
                    }
                }
            })
        });
    }

    // --- LCCDC membership visibility ---
    (function() {
        const radios = document.querySelectorAll('input[name="lccdc_membership"]');
        const dateGroup = document.querySelector('.lccdc-membership-date');
        const dateInput = dateGroup ? dateGroup.querySelector('input[type="date"]') : null;
        const notMember = document.querySelector('.lccdc-not-member');

        function updateLccdcVisibility() {
            const checked = Array.from(radios).find(r => r.checked);
            if (!checked) return;
            
            if (checked.value === 'yes') {
                if (dateGroup) dateGroup.style.display = '';
                if (notMember) notMember.style.display = 'none';
                if (dateInput) dateInput.setAttribute('required', 'required');
            } else {
                if (dateGroup) dateGroup.style.display = 'none';
                if (notMember) notMember.style.display = '';
                if (dateInput) dateInput.removeAttribute('required');
            }
        }

        radios.forEach(r => r.addEventListener('change', updateLccdcVisibility));
        updateLccdcVisibility(); // Initial check
    })();

    // --- Certificate toggles (CoC and CTE) ---
    (function () {
        function setupToggle(name, fileGroupSelector, fileInputId, notAvailSelector) {
            const radios = document.querySelectorAll('input[name="' + name + '"]');
            const fileGroup = document.querySelector(fileGroupSelector);
            const fileInput = document.getElementById(fileInputId);
            const notAvail = document.querySelector(notAvailSelector);

            function update() {
                const checked = Array.from(radios).find(r => r.checked);
                if (!checked) return;

                if (checked.value === 'yes') {
                    if (fileGroup) fileGroup.style.display = '';
                    if (notAvail) notAvail.style.display = 'none';
                    
                    // Only require file if it's NOT already uploaded (edit mode check)
                    if (fileInput && !fileInput.hasAttribute('data-has-file')) {
                         fileInput.setAttribute('required', 'required');
                    } else if (fileInput) {
                        fileInput.removeAttribute('required'); // If has file, not required
                    }
                } else {
                    if (fileGroup) fileGroup.style.display = 'none';
                    if (notAvail) notAvail.style.display = '';
                    if (fileInput) fileInput.removeAttribute('required');
                }
            }

            radios.forEach(r => r.addEventListener('change', update));

            if (fileInput) {
                fileInput.addEventListener('change', function () {
                    const display = document.getElementById(fileInputId + '-name');
                    if (this.files && this.files.length > 0) {
                        display.textContent = this.files[0].name;
                    } else {
                        // If we are in edit mode and have a file, show that text, else empty
                        if (this.hasAttribute('data-has-file')) {
                            display.textContent = 'File already uploaded (upload new to replace)';
                        } else {
                            display.textContent = '';
                        }
                    }
                });
            }
            update();
        }

        setupToggle('coc', '.coc-file-group', 'coc-file', '.coc-not-available');
        setupToggle('cte', '.cte-file-group', 'cte-file', '.cte-not-available');
    })();

    // --- Numeric formatting for financial inputs ---
    (function() {
        function unformatNumber(str) {
            if (!str) return '';
            return String(str).replace(/,/g, '').trim();
        }

        function formatWithCommas(value) {
            if (value === null || value === undefined) return '';
            const original = String(value);
            let s = original.replace(/[^\d.-]/g, '');
            if (s === '') return '';
            const isNegative = s[0] === '-';
            if (isNegative) s = s.slice(1);
            const parts = s.split('.');
            let intPart = parts[0] || '0';
            const decPart = parts.slice(1).join('');
            intPart = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            return (isNegative ? '-' : '') + intPart + (parts.length > 1 || original.endsWith('.') ? '.' + decPart : '');
        }

        function attachCommaFormatting(el) {
            if (!el) return;
            // Initial Format
            el.value = formatWithCommas(el.value);

            el.addEventListener('input', function() {
                const oldVal = el.value;
                const unformatted = unformatNumber(oldVal);
                const formatted = formatWithCommas(unformatted + (oldVal.endsWith('.') ? '.' : ''));
                el.value = formatted;
            });

            el.addEventListener('blur', function() {
                const un = unformatNumber(el.value);
                if (un && un !== '.' && un !== '-') {
                     el.value = formatWithCommas(parseFloat(un).toFixed(2));
                }
            });
        }

        attachCommaFormatting(document.getElementById('assets-value'));
        attachCommaFormatting(document.getElementById('paid-up-capital-value'));
        attachCommaFormatting(document.getElementById('net-surplus-value'));
    })();

    // --- Dynamic row addition for tables ---
    (function() {
        document.querySelectorAll('.add-row-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tableBody = this.previousElementSibling.querySelector('tbody');
                const firstRow = tableBody.querySelector('tr');
                if (!firstRow) return; 
                
                const newRow = firstRow.cloneNode(true);
                newRow.querySelectorAll('input').forEach(input => {
                    input.value = '';
                });
                newRow.querySelectorAll('select').forEach(select => {
                    select.selectedIndex = 0;
                });
                tableBody.appendChild(newRow);
            });
        });
    })();

    // --- File upload additive + preview for financial docs ---
    (function() {
        const fileInput = document.getElementById('financial-docs');
        const previewContainer = document.getElementById('file-preview-container');
        if (!fileInput || !previewContainer) return;

        let allSelectedFiles = [];

        function renderPreviews() {
            // Do not clear if editing and no new files selected yet? 
            // Actually better to just show current selection.
            previewContainer.innerHTML = '';
            if (allSelectedFiles.length === 0) {
                previewContainer.innerHTML = '<div class="no-files">No new files selected</div>';
                return;
            }
            allSelectedFiles.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'file-preview-item';
                item.innerHTML = `
                    <div class="file-info-wrapper">
                        <i class="bi bi-file-earmark-text"></i>
                        <span class="file-name">${file.name}</span>
                    </div>
                    <i class="bi bi-x-lg remove-file-btn" data-index="${index}" title="Remove file"></i>
                `;
                previewContainer.appendChild(item);
            });
            
            // Re-attach listeners to new X buttons
            document.querySelectorAll('.remove-file-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const idx = parseInt(this.getAttribute('data-index'));
                    allSelectedFiles.splice(idx, 1);
                    updateFileInput();
                    renderPreviews();
                });
            });
        }

        function updateFileInput() {
            const dataTransfer = new DataTransfer();
            allSelectedFiles.forEach(file => dataTransfer.items.add(file));
            fileInput.files = dataTransfer.files;
        }

        fileInput.addEventListener('change', function() {
            const newFiles = Array.from(this.files);
            newFiles.forEach(file => {
                // simple duplicate check
                if (!allSelectedFiles.some(f => f.name === file.name && f.size === file.size)) {
                    allSelectedFiles.push(file);
                }
            });
            updateFileInput();
            renderPreviews();
        });
    })();

    // --- Reporting year datepicker ---
    try {
        $('#reporting-year').datepicker({
            format: "yyyy",
            viewMode: "years",
            minViewMode: "years",
            autoclose: true,
            endDate: new Date().getFullYear().toString()
        });
    } catch (e) { console.log('Datepicker not loaded'); }
});
</script>
{% endblock %}